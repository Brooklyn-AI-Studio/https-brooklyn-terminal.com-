<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BROOKLYN-TERMINAL // V9.8 REAL-DATA</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300ffcc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='4 17 10 11 4 5'%3E%3C/polyline%3E%3Cline x1='12' y1='19' x2='20' y2='19'%3E%3C/line%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #050505; --bg-panel: #111111; --grid-bg: #0a0a0a;
            --text-primary: #00ffcc; --text-secondary: #888;
            --border-color: #333; --accent-color: #00ffcc;
            --grid-line: rgba(0, 255, 204, 0.1); --grid-line-strong: rgba(0, 255, 204, 0.3);
            --handle-color: #ff0055; --shadow-glow: 0 0 10px rgba(0, 255, 204, 0.3);
            --glass-bg: rgba(17, 17, 17, 0.95); --error-color: #ff0033;
            --stock-up: #00ffcc; --stock-down: #ff0033;
            --stock-blue: #2962ff; /* TradingView Blue */
            --input-bg: rgba(0,0,0,0.5); --input-text: #00ffcc;
            --msg-user-bg: rgba(0, 255, 204, 0.1); --msg-sys-bg: rgba(255, 255, 255, 0.05);
            --btn-bg: rgba(0, 255, 204, 0.1);
            --font-main: 'Rajdhani', 'Orbitron', sans-serif;
            --border-radius: 4px;
        }
        [data-theme="light"] {
            --bg-body: #e8eef2; --bg-panel: #ffffff; --grid-bg: #f4f7f9;
            --text-primary: #2c3e50; --text-secondary: #555;
            --border-color: #cbd5e0; --accent-color: #0066cc;
            --grid-line: rgba(0, 0, 0, 0.05); --grid-line-strong: rgba(0, 0, 0, 0.1);
            --handle-color: #ff9900; --shadow-glow: none; --glass-bg: rgba(255, 255, 255, 0.98);
            --error-color: #e74c3c; --stock-up: #27ae60; --stock-down: #c0392b;
            --stock-blue: #2962ff;
            --input-bg: #f0f2f5; --input-text: #333333;
            --msg-user-bg: rgba(0, 102, 204, 0.1); --msg-sys-bg: rgba(0, 0, 0, 0.03);
            --btn-bg: rgba(0, 0, 0, 0.05);
        }
        [data-pro="true"] {
            --bg-body: #000000; --bg-panel: #1a1a1a; --grid-bg: #000000;
            --text-primary: #ff9800; --text-secondary: #ffcc80;
            --border-color: #ff9800; --accent-color: #ff9800;
            --grid-line: rgba(255, 152, 0, 0.15); --grid-line-strong: rgba(255, 152, 0, 0.3);
            --handle-color: #ffffff; --shadow-glow: none; --glass-bg: #000000; 
            --error-color: #ff3333; --stock-up: #00ff00; --stock-down: #ff3333;
            --stock-blue: #ff9800;
            --input-bg: #000000; --input-text: #ff9800;
            --msg-user-bg: #331a00; --msg-sys-bg: #1a1a1a; --btn-bg: #331a00;
            --font-main: 'Consolas', 'Monaco', 'Courier New', monospace;
            --border-radius: 0px;
        }
        * { box-sizing: border-box; user-select: none; font-family: var(--font-main); }
        [data-pro="true"] * { text-transform: uppercase !important; letter-spacing: 0.5px; box-shadow: none !important; }
        [data-pro="true"] .grid-item { border: 1px solid var(--border-color) !important; }
        [data-pro="true"] .sidebar { border-right: 2px solid var(--border-color); }
        [data-pro="true"] header { border-bottom: 2px solid var(--border-color); }
        [data-pro="true"] .stock-price-large { font-family: 'Consolas', monospace; }

        body { margin: 0; padding: 0; background-color: var(--bg-body); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        header { height: 60px; background-color: var(--bg-panel); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.5); z-index: 20; justify-content: space-between; }
        .brand { font-family: 'Orbitron', sans-serif; font-weight: 900; letter-spacing: 3px; font-size: 1.5rem; text-transform: uppercase; text-shadow: var(--shadow-glow); display: flex; align-items: center; gap: 10px; }
        [data-pro="true"] .brand { font-family: var(--font-main); text-shadow: none; }
        .brand span { color: var(--handle-color); }
        .beta-badge { font-size: 0.7rem; background: var(--accent-color); color: #000; padding: 2px 6px; border-radius: var(--border-radius); margin-left: 5px; font-weight: bold; letter-spacing: 1px; transform: translateY(-2px); box-shadow: 0 0 5px var(--accent-color); }
        .logo-icon { width: 32px; height: 32px; fill: none; stroke: var(--accent-color); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 0 5px var(--accent-color)); }
        .header-right { display: flex; align-items: center; gap: 20px; font-size: 12px; opacity: 0.8; }
        .visitor-count { display: flex; align-items: center; gap: 5px; }
        .visitor-num { font-family: 'Orbitron', monospace; color: var(--accent-color); font-weight: bold; letter-spacing: 1px; }

        /* Sidebar Updates for Collapsible Sections */
        .sidebar { width: 300px; min-width: 250px; max-width: 500px; background-color: var(--bg-panel); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: relative; z-index: 10; padding: 20px; overflow-y: auto; overflow-x: hidden; transition: width 0.3s ease, min-width 0.3s ease, padding 0.3s ease; }
        .sidebar.collapsed { width: 70px; min-width: 70px; padding: 20px 10px; }
        
        /* Collapsible Section Styles */
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-section-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 0; font-size: 0.8rem; color: var(--text-secondary); 
            cursor: pointer; border-bottom: 1px dashed var(--border-color); 
            margin-bottom: 10px; text-transform: uppercase; font-weight: 700; 
            user-select: none; transition: color 0.2s;
        }
        .sidebar-section-header:hover { color: var(--text-primary); }
        .sidebar-section-header .arrow { font-size: 0.7em; transition: transform 0.3s; }
        
        /* Closed State */
        .sidebar-section.closed .sidebar-content-wrapper { display: none; }
        .sidebar-section.closed .arrow { transform: rotate(-90deg); }

        /* Sidebar Collapsed State (Mini Mode) overrides */
        .sidebar.collapsed .sidebar-section-header { display: none; }
        .sidebar.collapsed .sidebar-content-wrapper { display: block !important; }
        .sidebar.collapsed .sidebar-section { margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .sidebar.collapsed .stock-selector, .sidebar.collapsed .color-picker-container span, .sidebar.collapsed .stock-drag-item > div, .sidebar.collapsed .sidebar-footer-content label, .sidebar.collapsed .control-btn-group span { display: none; }
        .sidebar.collapsed .tool-item, .sidebar.collapsed .stock-drag-item { justify-content: center; padding: 15px 0; }
        .sidebar.collapsed .tool-item span { display: none; }
        .sidebar.collapsed .stock-drag-item span#selectedStockPrice { font-size: 0.8rem; }
        .sidebar.collapsed .sidebar-footer-content { justify-content: center; }
        .sidebar.collapsed .sidebar-footer-content::after { content: '‚öô'; font-size: 12px; opacity: 0.5; cursor: pointer; }
        .sidebar.collapsed .color-picker-container { width: 100%; justify-content: center; padding: 5px; }
        .sidebar.collapsed .control-btn { padding: 8px 0; }

        .sidebar-toggle-btn { position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; border: 1px solid var(--border-color); background: var(--bg-panel); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius); font-size: 12px; transition: all 0.2s; z-index: 20; }
        .sidebar-toggle-btn:hover { background: var(--accent-color); color: #000; }
        .sidebar.collapsed .sidebar-toggle-btn { right: 50%; transform: translateX(50%); top: 10px; }
        
        .color-picker-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: var(--input-bg); padding: 5px 10px; border-radius: var(--border-radius); border: 1px solid var(--border-color); width: fit-content; transition: all 0.3s; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border-color); }

        .control-btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 20px; }
        .control-btn { background: var(--btn-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; font-family: var(--font-main); font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s; border-radius: var(--border-radius); }
        .control-btn:hover { border-color: var(--accent-color); background: rgba(0, 255, 204, 0.2); }
        [data-pro="true"] .control-btn:hover { background: var(--accent-color); color: #000; }
        .control-btn:active { transform: translateY(1px); }

        .tool-item { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; cursor: grab; transition: all 0.2s; display: flex; align-items: center; gap: 15px; white-space: nowrap; border-radius: var(--border-radius); }
        .tool-item:hover { border-color: var(--accent-color); box-shadow: var(--shadow-glow); background: rgba(255,255,255,0.08); }
        .tool-preview { width: 30px; height: 30px; border: 2px solid var(--text-primary); background: rgba(0, 255, 204, 0.1); flex-shrink: 0; border-radius: var(--border-radius); }
        [data-pro="true"] .tool-preview { background: transparent; border: 1px solid var(--accent-color); }
        .tool-preview.clock-icon { border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border-color: var(--handle-color); }
        [data-pro="true"] .tool-preview.clock-icon { border-radius: 0; border-color: var(--accent-color); }
        .tool-preview.icon-only { display: flex; align-items: center; justify-content: center; font-size: 16px; }
        
        .stock-selector { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .stock-selector label { font-size: 12px; color: var(--text-secondary); margin-bottom: -5px; }
        .stock-selector select, .stock-selector input { background: var(--input-bg); color: var(--input-text); border: 1px solid var(--border-color); padding: 10px; border-radius: var(--border-radius); outline: none; font-weight: 500; transition: background 0.3s, color 0.3s, border 0.3s; width: 100%; font-family: var(--font-main); }
        .stock-selector select:focus, .stock-selector input:focus { border-color: var(--accent-color); }
        .stock-drag-item { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); padding: 15px; cursor: grab; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; border-radius: var(--border-radius); white-space: nowrap; }
        .stock-drag-item:hover { border-color: var(--accent-color); box-shadow: var(--shadow-glow); }
        
        .sidebar-footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
        .sidebar-footer-content { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        [data-pro="true"] .slider { border-radius: 0; border: 1px solid var(--border-color); }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: #fff; transition: .4s; border-radius: 50%; }
        [data-pro="true"] .slider:before { border-radius: 0; background-color: var(--accent-color); }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        [data-pro="true"] input:checked + .slider { background-color: #000; }

        .main-container { display: flex; flex: 1; height: calc(100vh - 60px); }
        .workspace { flex: 1; background-color: #000; background-image: radial-gradient(var(--border-color) 1px, transparent 1px); background-size: 20px 20px; overflow: auto; padding: 50px; position: relative; }
        #grid-canvas { width: 1200px; height: 1200px; background-color: var(--grid-bg); position: relative; background-image: linear-gradient(to right, var(--grid-line) 1px, transparent 1px), linear-gradient(to bottom, var(--grid-line) 1px, transparent 1px); background-size: 20px 20px; border: 1px solid var(--accent-color); box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        [data-pro="true"] #grid-canvas { border: 2px solid var(--accent-color); box-shadow: none; background-image: linear-gradient(to right, rgba(255,152,0,0.1) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,152,0,0.1) 1px, transparent 1px); }
        #grid-canvas::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(to right, var(--grid-line-strong) 1px, transparent 1px), linear-gradient(to bottom, var(--grid-line-strong) 1px, transparent 1px); background-size: 100px 100px; pointer-events: none; }
        .grid-resize-handle { width: 20px; height: 20px; background: var(--accent-color); position: absolute; bottom: -10px; right: -10px; cursor: nwse-resize; clip-path: polygon(100% 0, 100% 100%, 0 100%); z-index: 5; }

        .grid-item { position: absolute; border: 1px solid rgba(255,255,255,0.3); box-sizing: border-box; display: flex; flex-direction: column; backdrop-filter: blur(5px); transition: box-shadow 0.2s, border-color 0.2s; border-radius: var(--border-radius); }
        .grid-item:hover { box-shadow: 0 0 20px rgba(255,255,255,0.2); z-index: 100; border-color: var(--accent-color); }
        .grid-item.collision { background-color: rgba(255, 0, 51, 0.2) !important; border-color: var(--error-color) !important; box-shadow: 0 0 20px var(--error-color); }
        .content-container { width: 100%; height: 100%; overflow: hidden; position: relative; }

        .stock-layout { display: flex; flex-direction: column; width: 100%; height: 100%; padding: 5%; pointer-events: none; position: relative; }
        .stock-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1em; margin-bottom: 2%; }
        .stock-price-large { font-weight: 900; font-size: 2.5em; line-height: 1; margin: 2% 0; }
        .stock-price-large.up { color: var(--stock-up); }
        .stock-price-large.down { color: var(--stock-down); }
        .stock-chart { flex: 1; width: 100%; min-height: 0; opacity: 0.9; }
        .clock-layout { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; font-family: var(--font-main); font-weight: bold; color: var(--text-primary); pointer-events: none; }
        .clock-city { margin-top: 5px; font-size: 0.3em; opacity: 0.7; text-transform: uppercase; }
        .chat-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; }
        .chat-header { padding: 8px; border-bottom: 1px solid var(--border-color); font-weight: bold; font-family: var(--font-main); font-size: 0.9em; display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); cursor: move; }
        .chat-history { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; user-select: text; }
        .chat-msg { padding: 8px; border-radius: var(--border-radius); font-size: 0.85em; max-width: 85%; word-wrap: break-word; }
        .chat-msg.sys { align-self: flex-start; background: var(--msg-sys-bg); border-left: 2px solid var(--accent-color); color: var(--text-primary); }
        .chat-msg.user { align-self: flex-end; background: var(--msg-user-bg); border-right: 2px solid var(--text-primary); color: #fff; }
        .chat-input-area { padding: 8px; border-top: 1px solid var(--border-color); display: flex; gap: 5px; background: rgba(0,0,0,0.2); }
        .chat-input { flex: 1; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 5px; outline: none; font-family: var(--font-main); border-radius: var(--border-radius); }
        .chat-input:focus { border-color: var(--accent-color); }
        .chat-model-select { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 5px; outline: none; font-family: var(--font-main); font-size: 0.8em; margin-right: 5px; cursor: pointer; border-radius: var(--border-radius); }
        .chat-model-select:focus { border-color: var(--accent-color); }
        .chat-send-btn { background: var(--accent-color); color: #000; border: none; padding: 0 10px; cursor: pointer; font-weight: bold; font-family: var(--font-main); font-size: 0.8em; border-radius: var(--border-radius); }
        .chat-send-btn:hover { opacity: 0.8; }
        .chat-upload-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); cursor: pointer; padding: 5px 10px; border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; }
        .chat-upload-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .calc-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; }
        .calc-header { padding: 5px 10px; font-size: 0.8em; opacity: 0.7; border-bottom: 1px solid var(--border-color); cursor: move; }
        .calc-display { flex: 1; background: rgba(0,0,0,0.3); color: var(--text-primary); font-family: var(--font-main); font-size: 1.5em; text-align: right; padding: 10px; display: flex; align-items: flex-end; justify-content: flex-end; overflow: hidden; }
        .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; padding: 2px; background: var(--border-color); flex: 2; }
        .calc-key { background: var(--bg-panel); border: none; color: var(--text-primary); font-family: var(--font-main); font-size: 1.2em; cursor: pointer; transition: background 0.1s; border-radius: 0; }
        .calc-key:hover { background: rgba(255,255,255,0.1); }
        .calc-key.op { color: var(--accent-color); font-weight: bold; }
        .calc-key.eq { background: var(--accent-color); color: #000; }
        .note-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; }
        .note-header { padding: 5px 10px; font-size: 0.8em; opacity: 0.7; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.2); cursor: move; display: flex; justify-content: space-between; }
        .note-content { flex: 1; background: transparent; border: none; color: var(--text-primary); padding: 10px; font-family: var(--font-main); font-size: 1em; overflow-y: auto; outline: none; white-space: pre-wrap; }
        .note-toolbar { display: flex; gap: 5px; padding: 5px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-color); }
        .note-btn { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); cursor: pointer; font-family: var(--font-main); padding: 2px 8px; font-size: 0.8em; border-radius: var(--border-radius); }
        .note-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .note-select { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); font-family: var(--font-main); font-size: 0.8em; cursor: pointer; border-radius: var(--border-radius); }
        
        .browser-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; background: #fff; }
        .browser-header { 
            padding: 5px 35px 5px 10px; background: var(--bg-panel); display: flex; gap: 5px; align-items: center; cursor: move; border-bottom: 1px solid var(--border-color); color: var(--text-primary);
        }
        .browser-input { 
            flex: 1; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); padding: 2px 8px; font-family: var(--font-main); border-radius: var(--border-radius); outline: none;
        }
        .browser-btn { 
            background: var(--accent-color); color: #000; border: none; padding: 2px 10px; cursor: pointer; font-weight: bold; border-radius: var(--border-radius); transition: opacity 0.2s; font-size: 0.8em;
        }
        .browser-btn:hover { opacity: 0.8; }
        .browser-frame { flex: 1; border: none; width: 100%; background: #fff; }
        
        .nav-group { display: flex; gap: 2px; margin-right: 5px; }
        .nav-btn {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); padding: 2px 6px; cursor: pointer; font-family: var(--font-main); border-radius: var(--border-radius); font-size: 0.8em;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.1); }

        /* Weather Layout Styles - Updated for Picture-like Look */
        .weather-layout { 
            display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; color: var(--text-primary); position: relative; 
            background: linear-gradient(135deg, rgba(30,30,30,0.9) 0%, rgba(10,10,10,0.95) 100%); 
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #fff; /* Force white for weather card like image */
            font-size: 12px; /* Base size, JS will update */
        }
        .weather-header { 
            padding: 5px 10px; 
            position: absolute; top: 0; left: 0; right: 0; height: 25px; 
            background: rgba(255,255,255,0.05); cursor: move; opacity: 0; transition: opacity 0.2s; z-index: 10;
        }
        .weather-layout:hover .weather-header { opacity: 1; }
        
        /* Top Section: Icon, Temp, Condition */
        .weather-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8em; margin-top: 0.8em;}
        .weather-top-left { display: flex; align-items: center; gap: 0.5em; }
        .weather-main-icon { font-size: 2.5em; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
        .weather-main-temp { font-size: 3em; font-weight: 300; line-height: 1; }
        .weather-unit { font-size: 1em; opacity: 0.6; margin-left: 0.2em; font-weight: 400; }
        .weather-condition-text { font-size: 1em; opacity: 0.9; text-align: right; margin-top: 0.5em;}

        /* Middle Section: Location, High/Low */
        .weather-middle { margin-bottom: 1.5em; }
        .weather-location-text { font-size: 1em; margin-bottom: 0.4em; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .weather-hl { font-size: 0.8em; opacity: 0.7; }

        /* Bottom Section: 5-Day Forecast */
        .weather-forecast { display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1em; margin-top: auto; }
        .forecast-item { display: flex; flex-direction: column; align-items: center; gap: 0.4em; font-size: 0.8em; }
        .forecast-icon { font-size: 1.2em; }
        .forecast-temp { font-weight: 500; }
        .forecast-day { opacity: 0.7; font-size: 0.9em; }

        /* Search Input - Bottom Right Absolute */
        .weather-search-container { position: absolute; bottom: 10px; right: 10px; width: 140px; z-index: 10; }
        .weather-search-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 4px 8px; font-size: 0.7em; text-align: right; outline: none; transition: all 0.3s; opacity: 0.6; }
        .weather-search-input:focus, .weather-search-input:hover { opacity: 1; border-bottom-color: var(--accent-color); width: 160px; background: rgba(0,0,0,0.5); }
        .weather-search-input::placeholder { color: rgba(255,255,255,0.5); font-style: italic; font-size: 0.9em; }

        /* Quote Layout */
        .quote-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; padding: 20px; position: relative; justify-content: center; text-align: center; background: linear-gradient(45deg, #1a1a1a, #000); font-size: 12px; }
        .quote-header { position: absolute; top: 0; left: 0; right: 0; padding: 5px 10px; background: rgba(255,255,255,0.05); font-size: 0.8em; cursor: move; display: flex; justify-content: space-between; color: var(--text-secondary); }
        .quote-content { font-size: 1.2em; font-style: italic; margin-bottom: 1em; line-height: 1.4; }
        .quote-author { font-weight: bold; color: var(--accent-color); font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        .quote-refresh { position: absolute; bottom: 10px; right: 10px; cursor: pointer; opacity: 0.5; transition: opacity 0.2s; font-size: 1.5em; z-index: 10; }
        .quote-refresh:hover { opacity: 1; }

        /* Number Layout */
        .number-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; padding: 20px; position: relative; align-items: center; justify-content: center; text-align: center; background: #000; border: 1px dashed var(--border-color); }
        .number-header { position: absolute; top: 0; left: 0; right: 0; padding: 5px 10px; background: rgba(255,255,255,0.05); font-size: 0.8em; cursor: move; display: flex; justify-content: space-between; color: var(--text-secondary); }
        .number-val { font-size: 4em; font-weight: 900; color: var(--text-primary); line-height: 1; margin-bottom: 10px; font-family: 'Orbitron', sans-serif; }
        .number-fact { font-size: 0.9em; opacity: 0.8; line-height: 1.4; max-height: 100px; overflow-y: auto; padding: 0 10px; }
        .number-controls { position: absolute; bottom: 10px; display: flex; gap: 5px; width: 80%; }
        .number-input { flex: 1; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 2px 5px; font-size: 0.8em; outline: none; text-align: center; }
        .number-btn { background: var(--btn-bg); border: 1px solid var(--border-color); color: var(--text-primary); cursor: pointer; font-size: 0.8em; padding: 2px 8px; }
        .number-btn:hover { border-color: var(--accent-color); }

        /* Global News Layout (RSS) */
        .global-news-layout { display: flex; flex-direction: column; width: 100%; height: 100%; background: #080808; color: #fff; position: relative; padding: 10px; overflow-y: auto; }
        .global-news-header { 
            position: absolute; top: 0; left: 0; right: 0; height: 25px; 
            background: rgba(255,255,255,0.05); cursor: move; opacity: 0; transition: opacity 0.2s; z-index: 10;
            display: flex; justify-content: space-between; padding: 0 10px; align-items: center; font-size: 0.8em;
        }
        .global-news-layout:hover .global-news-header { opacity: 1; }
        
        .news-hero { display: flex; gap: 15px; margin-bottom: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); align-items: stretch; position: relative; }
        .news-hero:hover { border-color: var(--accent-color); transform: translateY(-1px); background: rgba(255,255,255,0.05); }
        .news-hero-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .news-hero-title { font-size: 1.3em; font-weight: bold; margin-bottom: 10px; line-height: 1.2; color: #fff; }
        .news-hero-summary { font-size: 0.85em; color: #aaa; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 10px; }
        .news-hero-meta { font-size: 0.75em; color: var(--accent-color); display: flex; align-items: center; gap: 5px; opacity: 0.8; margin-bottom: 10px; }
        .news-hero-img { width: 35%; border-radius: 6px; object-fit: cover; min-height: 140px; background: #111; }
        .news-source-btn { display: inline-block; background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); font-size: 0.7em; padding: 4px 8px; border-radius: 4px; cursor: pointer; text-decoration: none; font-weight: bold; width: fit-content; margin-top: auto; }
        .news-source-btn:hover { background: var(--accent-color); color: #000; }

        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
        .news-grid-card { background: rgba(255,255,255,0.03); border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; display: flex; flex-direction: column; cursor: default; position: relative; }
        .news-grid-card:hover { border-color: var(--accent-color); transform: translateY(-2px); background: rgba(255,255,255,0.05); }
        .news-card-img { width: 100%; height: 110px; object-fit: cover; background: #111; }
        .news-card-content { padding: 10px; flex: 1; display: flex; flex-direction: column; }
        .news-card-title { font-size: 0.85em; font-weight: bold; margin-bottom: 8px; line-height: 1.3; flex: 1; color: #eee; }
        .news-card-meta { font-size: 0.7em; color: #777; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .news-loading { text-align: center; padding: 20px; color: var(--text-secondary); width: 100%; }

        /* TV News Layout */
        .tv-news-layout { display: flex; flex-direction: column; width: 100%; height: 100%; background: #000; position: relative; }
        .tv-news-header { padding: 5px 10px; font-size: 0.8em; background: var(--bg-panel); border-bottom: 1px solid var(--border-color); color: var(--text-primary); cursor: move; display: flex; justify-content: space-between; }
        .tv-news-container { flex: 1; width: 100%; height: 100%; overflow: hidden; }

        /* Finance Pro Widget Styles - Redesigned */
        .finance-layout { display: flex; flex-direction: column; width: 100%; height: 100%; background: #0b0e11; color: #fff; padding: 15px; position: relative; overflow: auto; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* Added proper header class for dragging */
        .finance-header-bar.widget-header { position: absolute; top: 0; left: 0; right: 0; height: 30px; cursor: move; z-index: 20; background: rgba(255,255,255,0.02); opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; padding: 0 10px; justify-content: space-between; font-size: 0.8em; color: var(--text-secondary); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .finance-layout:hover .finance-header-bar.widget-header { opacity: 1; }
        
        .finance-search-bar { display: flex; gap: 8px; margin-bottom: 15px; margin-top: 20px; position: relative; }
        .finance-search-input { flex: 1; background: #1e222d; border: 1px solid #2a2e39; color: #d1d4dc; padding: 6px 12px; border-radius: 4px; outline: none; font-size: 0.9em; text-transform: uppercase; }
        .finance-search-input:focus { border-color: var(--stock-blue); }
        .finance-search-btn { background: var(--stock-blue); border: none; color: #fff; cursor: pointer; padding: 6px 15px; border-radius: 4px; font-weight: 600; font-size: 0.9em; }
        
        /* Search Dropdown */
        .finance-search-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #1e222d; border: 1px solid #2a2e39;
            border-top: none; border-radius: 0 0 4px 4px;
            z-index: 30; max-height: 300px; overflow-y: auto;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .finance-dropdown-item {
            padding: 8px 12px; display: flex; justify-content: space-between;
            cursor: pointer; border-bottom: 1px solid #2a2e39; font-size: 0.85em;
            transition: background 0.2s;
        }
        .finance-dropdown-item:hover { background: #2a2e39; }
        .finance-dropdown-item:last-child { border-bottom: none; }
        .finance-dropdown-symbol { font-weight: bold; color: #fff; }
        .finance-dropdown-price { color: #d1d4dc; }
        .finance-dropdown-change { font-size: 0.9em; }

        .finance-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; border-bottom: 1px solid #2a2e39; padding-bottom: 0px; }
        .finance-tab { padding: 8px 12px; color: #787b86; cursor: pointer; font-size: 0.9em; font-weight: 600; border-bottom: 2px solid transparent; transition: color 0.2s; white-space: nowrap; }
        .finance-tab:hover { color: #d1d4dc; }
        .finance-tab.active { color: var(--stock-blue); border-bottom-color: var(--stock-blue); }

        .finance-main-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .finance-price-block { display: flex; flex-direction: column; }
        .finance-symbol { font-size: 1.5em; font-weight: 700; color: #fff; line-height: 1.2; display: flex; align-items: center; gap: 8px; }
        .finance-exchange { font-size: 0.7em; color: #787b86; font-weight: normal; background: #2a2e39; padding: 2px 4px; border-radius: 3px; }
        .finance-main-price { font-size: 2.2em; font-weight: 700; color: #fff; line-height: 1; margin: 5px 0; }
        .finance-main-change { font-size: 1em; font-weight: 600; }
        .finance-sub-price-block { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .finance-sub-label { font-size: 0.8em; color: #787b86; margin-bottom: 2px; }
        .finance-sub-price { font-size: 1.1em; color: #d1d4dc; font-weight: 600; }
        
        .finance-chart-controls { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; }
        .finance-time-btn { background: transparent; border: none; color: #787b86; padding: 4px 8px; font-size: 0.8em; font-weight: 600; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
        .finance-time-btn:hover { background: #2a2e39; color: #d1d4dc; }
        .finance-time-btn.active { background: #2a2e39; color: var(--stock-blue); }

        .finance-chart-container { width: 100%; height: 250px; position: relative; margin-bottom: 20px; border-bottom: 1px solid #2a2e39; padding-bottom: 10px; }
        .finance-chart-svg { width: 100%; height: 100%; overflow: visible; }

        .finance-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1px; background: #2a2e39; border: 1px solid #2a2e39; border-radius: 4px; overflow: hidden; }
        .finance-stat-item { background: #0b0e11; padding: 10px; display: flex; flex-direction: column; justify-content: center; }
        .stat-label { font-size: 0.75em; color: #787b86; margin-bottom: 4px; }
        .stat-val { font-size: 0.95em; font-weight: 600; color: #d1d4dc; }
        .no-data-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(11,14,17,0.8); display: flex; align-items: center; justify-content: center; font-size: 1.2em; color: var(--text-secondary); z-index: 5; }

        .item-resize { width: 15px; height: 15px; background: transparent; border-right: 2px solid var(--text-primary); border-bottom: 2px solid var(--text-primary); position: absolute; bottom: 2px; right: 2px; cursor: nwse-resize; z-index: 101; }
        .menu-trigger { position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; cursor: pointer; z-index: 102; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--text-secondary); border-radius: 50%; background: rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.2s; }
        .grid-item:hover .menu-trigger { opacity: 1; }
        .menu-trigger:hover { background: var(--accent-color); color: #000; }
        .context-menu { position: absolute; top: 30px; right: 5px; background: var(--bg-panel); border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.8); border-radius: var(--border-radius); z-index: 9999; display: none; min-width: 140px; }
        [data-pro="true"] .context-menu { box-shadow: none; border: 1px solid var(--accent-color); }
        .context-menu.show { display: block; }
        .context-menu-item { padding: 8px 12px; cursor: pointer; font-size: 12px; color: var(--text-primary); border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; }
        .context-menu-item:hover { background: rgba(255,255,255,0.1); }
        [data-pro="true"] .context-menu-item:hover { background: var(--accent-color); color: #000; }
        .context-menu-item:last-child { border-bottom: none; }
        .context-menu-item.danger:hover { background: rgba(255,255,255,0.1); color: var(--error-color); }
        .context-menu-item .submenu { display: none; position: absolute; right: 100%; top: 0; background: var(--bg-panel); border: 1px solid var(--border-color); min-width: 120px; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .context-menu-item:hover .submenu { display: block; }

        .chart-path { fill: none; stroke-width: 2; vector-effect: non-scaling-stroke; }
        .chart-area { fill-opacity: 0.2; stroke: none; }
        .up .chart-path { stroke: var(--stock-up); }
        .up .chart-area { fill: var(--stock-up); }
        .down .chart-path { stroke: var(--stock-down); }
        .down .chart-area { fill: var(--stock-down); }
        .candle { stroke-width: 1; }
        .candle.up { fill: var(--stock-up); stroke: var(--stock-up); }
        .candle.down { fill: var(--stock-down); stroke: var(--stock-down); }
        .wick { stroke-width: 1; }
        .wick.up { stroke: var(--stock-up); }
        .wick.down { stroke: var(--stock-down); }
        .axis-text { font-size: 10px; fill: var(--text-secondary); text-anchor: middle; }
        .stock-footer-info { font-size: 0.7em; opacity: 0.7; margin-top: auto; text-align: right; }
        .widget-header { cursor: move; }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <svg class="logo-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
            Brooklyn-<span>Terminal</span><span class="beta-badge">BETA</span>
        </div>
        <div class="header-right">
            <div class="visitor-count" title="Simulated Live Visitors">
                <span>VISITORS:</span> <span id="visitor-num" class="visitor-num">00000</span>
            </div>
            <div style="font-size: 12px; opacity: 0.7;">SYS.STATUS: ONLINE</div>
        </div>
    </header>
    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle-btn" id="sidebarToggle" title="Collapse/Expand">&lt;</button>
            
            <div class="sidebar-section" id="sec-library">
                <div class="sidebar-section-header" onclick="toggleSection('sec-library')">
                    <span>Library</span><span class="arrow">‚ñº</span>
                </div>
                <div class="sidebar-content-wrapper">
                      <div class="tool-item" draggable="true" id="tool-square"><div class="tool-preview" style="background-color: rgba(0,123,255,0.3);"></div><span>Module 10x10</span></div>
                </div>
            </div>

            <div class="sidebar-section" id="sec-tools">
                <div class="sidebar-section-header" onclick="toggleSection('sec-tools')">
                    <span>Tools</span><span class="arrow">‚ñº</span>
                </div>
                <div class="sidebar-content-wrapper">
                    <div class="tool-item" draggable="true" id="tool-clock"><div class="tool-preview clock-icon">üïì</div><span>Digital Clock</span></div>
                    <div class="tool-item" draggable="true" id="tool-weather"><div class="tool-preview icon-only">‚òÅÔ∏è</div><span>Weather Station</span></div>
                    <div class="tool-item" draggable="true" id="tool-tvnews"><div class="tool-preview icon-only">üåê</div><span>Global News</span></div>
                    <div class="tool-item" draggable="true" id="tool-finance"><div class="tool-preview icon-only">üíπ</div><span>Finance Pro</span></div>
                    <div class="tool-item" draggable="true" id="tool-quote"><div class="tool-preview icon-only">‚ùù</div><span>Daily Insight</span></div>
                    <div class="tool-item" draggable="true" id="tool-number"><div class="tool-preview icon-only">#</div><span>Data Fact</span></div>
                    <div class="tool-item" draggable="true" id="tool-chat"><div class="tool-preview icon-only">ü§ñ</div><span>LLM Chat</span></div>
                    <div class="tool-item" draggable="true" id="tool-calc"><div class="tool-preview icon-only">üßÆ</div><span>Calculator</span></div>
                    <div class="tool-item" draggable="true" id="tool-note"><div class="tool-preview icon-only">üìù</div><span>Notes</span></div>
                    <div class="tool-item" draggable="true" id="tool-browser"><div class="tool-preview icon-only">üåê</div><span>Web Portal</span></div>
                    <div class="tool-item" draggable="true" id="tool-llama"><div class="tool-preview icon-only">ü¶ô</div><span>Llama Online</span></div>
                </div>
            </div>

            <div class="sidebar-section" id="sec-stock">
                <div class="sidebar-section-header" onclick="toggleSection('sec-stock')">
                    <span>Market Data</span><span class="arrow">‚ñº</span>
                </div>
                <div class="sidebar-content-wrapper">
                    <div class="stock-selector">
                        <label>Asset Class:</label>
                        <select id="categoryList">
                            <option value="US">US Stocks (ÁæéËÇ°)</option>
                            <option value="TW">Taiwan Stocks (Âè∞ËÇ°)</option>
                            <option value="IDX">Indices (ÊåáÊï∏)</option>
                            <option value="CRYPTO">Crypto (Âä†ÂØÜË≤®Âπ£)</option>
                        </select>
                        <label>Instrument:</label>
                        <select id="stockList"></select>
                        <input type="text" id="stockSearch" placeholder="Search (e.g., AAPL)">
                    </div>
                    <div class="stock-drag-item" draggable="true" id="stockDraggable">
                        <div style="display:flex; flex-direction:column;"><span id="selectedStockName" style="font-weight:bold; font-size:1rem;">AAPL Apple</span><span style="font-size:0.8rem; opacity:0.7;">Drag to Grid</span></div>
                        <span id="selectedStockPrice" style="display:flex; flex-direction:column; align-items:end;">
                            <div id="preview-price" style="font-size:1.2rem; font-weight:bold; color:var(--stock-up);">175.00</div>
                            <div id="preview-change" style="font-size:0.6em; color:var(--stock-up);">‚ñ≤ 1.20</div>
                        </span>
                    </div>
                </div>
            </div>

            <div style="margin-top: auto;"></div>
            
            <div class="sidebar-section" id="sec-controls">
                 <div class="sidebar-section-header" onclick="toggleSection('sec-controls')">
                    <span>Controls</span><span class="arrow">‚ñº</span>
                </div>
                 <div class="sidebar-content-wrapper">
                      <div class="control-btn-group">
                        <button class="control-btn" onclick="saveLayout()">üíæ SAVE</button>
                        <button class="control-btn" onclick="loadLayout()">üìÇ LOAD</button>
                        <button class="control-btn" onclick="clearGrid()">üóëÔ∏è CLEAR</button>
                    </div>
                    <div class="color-picker-container"><input type="color" id="colorPicker" value="#007bff"><span id="colorValue" style="font-size: 12px; opacity: 0.8;">#007bff</span></div>
                 </div>
            </div>

            <div class="sidebar-footer">
                <div class="sidebar-footer-content">
                    <span id="mode-label">MODE: DARK</span>
                    <label class="switch"><input type="checkbox" id="themeSwitch"><span class="slider"></span></label>
                </div>
                <div class="sidebar-footer-content">
                    <span>PRO MODE</span>
                    <label class="switch"><input type="checkbox" id="proSwitch"><span class="slider"></span></label>
                </div>
            </div>
        </div>
        <div class="workspace">
            <div id="grid-canvas"><div class="grid-resize-handle" id="gridResizer"></div></div>
        </div>
    </div>
    <script>
        const CELL_SIZE = 20, MIN_W = CELL_SIZE * 4, MIN_H = CELL_SIZE * 4;
        const gridCanvas = document.getElementById('grid-canvas'), colorPicker = document.getElementById('colorPicker'), colorValue = document.getElementById('colorValue');
        const themeSwitch = document.getElementById('themeSwitch'), proSwitch = document.getElementById('proSwitch'), modeLabel = document.getElementById('mode-label');
        const categoryList = document.getElementById('categoryList'), stockList = document.getElementById('stockList'), stockSearch = document.getElementById('stockSearch'), stockDraggable = document.getElementById('stockDraggable');
        const selectedStockName = document.getElementById('selectedStockName'), selectedStockPrice = document.getElementById('selectedStockPrice'), gridResizer = document.getElementById('gridResizer');
        const sidebar = document.getElementById('sidebar'), sidebarToggle = document.getElementById('sidebarToggle');
        let items = [], activeColor = '#007bff', currentStock = { symbol: 'AAPL', name: 'Apple Inc.', price: 175.00, change: 1.20, history: [], type: 'stock' };
        let isSidebarCollapsed = false, isLiveConnectionFailed = false, cryptoDataAvailable = false;

        // Toggle Section Logic
        window.toggleSection = function(id) {
            const sec = document.getElementById(id);
            if(sec) sec.classList.toggle('closed');
        }

        function initVisitorCounter() {
            const visitorEl = document.getElementById('visitor-num');
            let count = localStorage.getItem('visitorCount');
            if (!count) { count = Math.floor(Math.random() * 4000) + 8000; } else { count = parseInt(count); }
            count++; localStorage.setItem('visitorCount', count);
            const updateDisplay = () => { visitorEl.innerText = count.toLocaleString('en-US', {minimumIntegerDigits: 5, useGrouping:false}); };
            updateDisplay();
            setInterval(() => { if(Math.random() > 0.7) { count += Math.floor(Math.random() * 3) + 1; localStorage.setItem('visitorCount', count); updateDisplay(); } }, 3000);
        }
        initVisitorCounter();

        const stockCategories = {
            'US': [{ s: 'AAPL', n: 'Apple Inc.' }, { s: 'TSLA', n: 'Tesla Inc.' }, { s: 'NVDA', n: 'NVIDIA' }, { s: 'MSFT', n: 'Microsoft' }, { s: 'GOOGL', n: 'Alphabet' }, { s: 'AMZN', n: 'Amazon' }],
            'TW': [{ s: '2330', n: 'Âè∞Á©çÈõª' }, { s: '2317', n: 'È¥ªÊµ∑' }, { s: '2454', n: 'ËÅØÁôºÁßë' }, { s: '2303', n: 'ËÅØÈõª' }, { s: '2881', n: 'ÂØåÈÇ¶Èáë' }],
            'IDX': [{ s: '^DJI', n: 'Dow Jones' }, { s: '^IXIC', n: 'Nasdaq' }, { s: '^GSPC', n: 'S&P 500' }, { s: '^TWII', n: 'TAIEX' }],
            'CRYPTO': [{ s: 'BTC-USD', n: 'Bitcoin' }, { s: 'ETH-USD', n: 'Ethereum' }, { s: 'DOGE-USD', n: 'Dogecoin' }, { s: 'SOL-USD', n: 'Solana' }, { s: 'ADA-USD', n: 'Cardano' }, { s: 'XRP-USD', n: 'XRP' }, { s: 'DOT-USD', n: 'Polkadot' }]
        };
        const cryptoMapping = { 'BTC-USD': 'bitcoin', 'ETH-USD': 'ethereum', 'DOGE-USD': 'dogecoin', 'SOL-USD': 'solana', 'ADA-USD': 'cardano', 'XRP-USD': 'xrp', 'DOT-USD': 'polkadot' };
        const mockStockData = {};
        Object.values(stockCategories).flat().forEach(item => {
            const isCrypto = !!cryptoMapping[item.s];
            // Stats placeholder updated by live API
            mockStockData[item.s] = { 
                symbol: item.s, name: item.n, price: isCrypto ? 0 : Math.random() * 500 + 50, change: 0, isCrypto: isCrypto, 
                history: isCrypto ? [] : generateHistory(Math.random() * 500 + 50, 60),
                stats: {} 
            };
        });
        
        function generateHistory(basePrice, count) {
            let history = [], current = basePrice;
            for(let i=0; i<count; i++) {
                let open = current, close = current + (Math.random() - 0.5) * (basePrice * 0.02);
                history.push({ open, high: Math.max(open, close) + Math.random()*(basePrice*0.01), low: Math.min(open, close) - Math.random()*(basePrice*0.01), close });
                current = close;
            }
            return history;
        }

        async function updateCryptoPrices() {
            const ids = Object.values(cryptoMapping).join(',');
            try {
                const response = await fetch(`https://api.coincap.io/v2/assets?ids=${ids}`);
                if (!response.ok) throw new Error("CoinCap failed");
                const result = await response.json();
                if (result.data) {
                    let hasData = false;
                    result.data.forEach(coin => {
                        const symbol = Object.keys(cryptoMapping).find(key => cryptoMapping[key] === coin.id);
                        if(symbol && mockStockData[symbol]) { 
                            const price = parseFloat(coin.priceUsd);
                            // Update detailed stats from CoinCap
                            mockStockData[symbol].price = price;
                            mockStockData[symbol].change = parseFloat(coin.changePercent24Hr);
                            mockStockData[symbol].stats = {
                                vol: (parseFloat(coin.volumeUsd24Hr)/1000000000).toFixed(2) + 'B',
                                cap: (parseFloat(coin.marketCapUsd)/1000000000).toFixed(2) + 'B',
                                supply: (parseFloat(coin.supply)/1000000).toFixed(2) + 'M',
                                vwap: parseFloat(coin.vwap24Hr).toFixed(2)
                            };
                            hasData = true; 
                        }
                    });
                    cryptoDataAvailable = hasData; isLiveConnectionFailed = false;
                }
            } catch (e) {
                console.warn("Crypto API failed, fallback...");
                // Fallback logic omitted for brevity but kept existing structure in mind
            }
        }

        function simulateMarket() {
            Object.keys(mockStockData).forEach(symbol => {
                const data = mockStockData[symbol];
                // Only simulate non-crypto
                if (!data.isCrypto) {
                    const change = (Math.random() - 0.5) * (data.price * 0.005), newPrice = data.price + change;
                    let last = data.history[data.history.length - 1];
                    last.close = newPrice; last.high = Math.max(last.high, newPrice); last.low = Math.min(last.low, newPrice);
                    if(Math.random() > 0.95) { data.history.push({open: newPrice, high: newPrice, low: newPrice, close: newPrice}); if(data.history.length > 100) data.history.shift(); }
                    data.price = newPrice; data.change = change;
                }
            });
            
            if (currentStock.symbol && mockStockData[currentStock.symbol]) updateSidebarPreview(mockStockData[currentStock.symbol]);

            items.forEach(item => {
                if(item.type === 'stock' && item.stockData) {
                    const symbol = item.stockData.symbol;
                    if(mockStockData[symbol]) {
                        item.stockData.price = mockStockData[symbol].price; item.stockData.change = mockStockData[symbol].change; item.stockData.history = mockStockData[symbol].history;
                        renderStockContent(item);
                    }
                } else if (item.type === 'clock') renderClockContent(item);
                // Finance Pro updates are handled within its own interval, but it reads from mockStockData for price
            });
        }

        function updateSidebarPreview(stock) {
            selectedStockName.innerText = `${stock.symbol} ${stock.name}`;
            const pPrice = document.getElementById('preview-price');
            const pChange = document.getElementById('preview-change');
            if (stock.isCrypto && !cryptoDataAvailable) {
                pPrice.innerText = "No Data"; pChange.innerText = "Temporarily Unavailable"; pPrice.style.color = 'var(--text-secondary)'; pChange.style.color = 'var(--text-secondary)';
            } else {
                const isUp = stock.change >= 0;
                const suffix = stock.isCrypto ? '%' : '';
                const liveTag = (stock.isCrypto && cryptoDataAvailable) ? ' [LIVE]' : '';
                pPrice.innerText = `${stock.price.toFixed(2)}${liveTag}`; pPrice.style.color = isUp ? 'var(--stock-up)' : 'var(--stock-down)';
                pChange.innerText = `${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(stock.change).toFixed(2)}${suffix}`; pChange.style.color = isUp ? 'var(--stock-up)' : 'var(--stock-down)';
            }
            currentStock = stock; 
        }

        function populateStockList(category) {
            stockList.innerHTML = ''; const list = stockCategories[category] || [];
            list.forEach(item => { const opt = document.createElement('option'); opt.value = item.s; opt.innerText = `${item.s} ${item.n}`; stockList.appendChild(opt); });
            if(list.length > 0) { stockList.value = list[0].s; currentStock.symbol = list[0].s; updateSidebarPreview(mockStockData[list[0].s]); }
        }

        categoryList.addEventListener('change', (e) => populateStockList(e.target.value)); populateStockList('US');
        stockList.addEventListener('change', (e) => { const symbol = e.target.value; if(mockStockData[symbol]) { currentStock.symbol = symbol; updateSidebarPreview(mockStockData[symbol]); }});
        stockSearch.addEventListener('input', (e) => { const val = e.target.value.toUpperCase(); const found = Object.values(mockStockData).find(d => d.symbol.includes(val) || d.name.toUpperCase().includes(val)); if(found) { currentStock.symbol = found.symbol; updateSidebarPreview(found); }});

        setInterval(simulateMarket, 1000); setInterval(updateCryptoPrices, 10000); updateCryptoPrices();

        sidebarToggle.addEventListener('click', () => { isSidebarCollapsed = !isSidebarCollapsed; if (isSidebarCollapsed) { sidebar.classList.add('collapsed'); sidebarToggle.innerHTML = '&gt;'; } else { sidebar.classList.remove('collapsed'); sidebarToggle.innerHTML = '&lt;'; }});
        themeSwitch.addEventListener('change', (e) => { if (e.target.checked) { document.documentElement.setAttribute('data-theme', 'light'); modeLabel.innerText = "MODE: LIGHT"; } else { document.documentElement.removeAttribute('data-theme'); modeLabel.innerText = "MODE: DARK"; }});
        proSwitch.addEventListener('change', (e) => { if (e.target.checked) document.documentElement.setAttribute('data-pro', 'true'); else document.documentElement.removeAttribute('data-pro'); });
        colorPicker.addEventListener('input', (e) => { activeColor = e.target.value; colorValue.innerText = activeColor; document.querySelector('.tool-preview').style.backgroundColor = activeColor + '4D'; document.querySelector('.tool-preview').style.borderColor = activeColor; });
        
        function saveLayout() {
            const layoutData = items.map(i => {
                const el = document.getElementById(i.id);
                let noteContent = ''; if(i.type === 'note') { const contentDiv = el.querySelector('.note-content'); if(contentDiv) noteContent = contentDiv.innerHTML; }
                let webUrl = ''; if (i.type === 'browser' || i.type === 'llama') { const iframe = el.querySelector('.browser-frame'); if (iframe) webUrl = iframe.src; }
                let weatherCity = ''; if(i.type === 'weather') weatherCity = i.cityLabel;
                return { type: i.type, x: i.x, y: i.y, w: i.w, h: i.h, stockSymbol: i.stockData ? i.stockData.symbol : null, viewMode: i.viewMode, timeRange: i.timeRange, showTime: i.showTime, timeZone: i.timeZone, cityLabel: i.cityLabel, noteContent: noteContent, webUrl: webUrl, weatherCity: weatherCity };
            });
            localStorage.setItem('brooklyn_layout', JSON.stringify(layoutData)); alert('Layout Saved!');
        }

        function loadLayout() {
            const saved = localStorage.getItem('brooklyn_layout'); if(!saved) { alert('No saved layout found.'); return; }
            clearGrid();
            const layoutData = JSON.parse(saved);
            layoutData.forEach(data => {
                let color = '#007bff'; if(['clock','news','chat','calc','note','browser','llama','weather','quote','number','tvnews','finance'].includes(data.type)) color = '#ffffff';
                const newItem = createItem(data.x, data.y, data.w, data.h, color, data.type);
                if(data.type === 'stock' && data.stockSymbol && mockStockData[data.stockSymbol]) { newItem.obj.stockData = JSON.parse(JSON.stringify(mockStockData[data.stockSymbol])); newItem.obj.viewMode = data.viewMode; newItem.obj.timeRange = data.timeRange; newItem.obj.showTime = data.showTime; renderStockContent(newItem.obj); } 
                else if (data.type === 'clock') { newItem.obj.timeZone = data.timeZone; newItem.obj.cityLabel = data.cityLabel; renderClockContent(newItem.obj); } 
                else if (data.type === 'note') { const el = document.getElementById(newItem.obj.id); const contentDiv = el.querySelector('.note-content'); if(contentDiv && data.noteContent) contentDiv.innerHTML = data.noteContent; } 
                else if ((data.type === 'browser' || data.type === 'llama') && data.webUrl) { const el = document.getElementById(newItem.obj.id); const iframe = el.querySelector('.browser-frame'); const input = el.querySelector('.browser-input'); if (iframe && input) { iframe.src = data.webUrl; input.value = data.webUrl; } }
                else if (data.type === 'weather') { newItem.obj.cityLabel = data.weatherCity || 'Taipei'; renderWeatherContent(newItem.obj); }
                else if (data.type === 'quote') renderQuoteContent(newItem.obj);
                else if (data.type === 'number') renderNumberContent(newItem.obj);
                else if (data.type === 'tvnews') renderGlobalNewsContent(newItem.obj);
                else if (data.type === 'finance') renderFinanceContent(newItem.obj);
            });
        }

        function clearGrid() { items.forEach(i => { const el = document.getElementById(i.id); if(el) el.remove(); }); items = []; }

        document.getElementById('tool-square').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'shape'));
        document.getElementById('tool-clock').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'clock'));
        document.getElementById('tool-weather').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'weather'));
        document.getElementById('tool-tvnews').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'tvnews'));
        document.getElementById('tool-finance').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'finance'));
        document.getElementById('tool-quote').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'quote'));
        document.getElementById('tool-number').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'number'));
        document.getElementById('tool-chat').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'chat'));
        document.getElementById('tool-calc').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'calc'));
        document.getElementById('tool-note').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'note'));
        document.getElementById('tool-browser').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'browser'));
        document.getElementById('tool-llama').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'llama'));
        stockDraggable.addEventListener('dragstart', (e) => { e.dataTransfer.setData('type', 'stock'); e.dataTransfer.setData('symbol', currentStock.symbol); });
        
        gridCanvas.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
        gridCanvas.addEventListener('drop', (e) => {
            e.preventDefault(); const type = e.dataTransfer.getData('type'); const rect = gridCanvas.getBoundingClientRect(); const x = snap(e.clientX - rect.left); const y = snap(e.clientY - rect.top);
            if (type === 'shape') { if(!checkCollision({x, y, w: 200, h: 200})) createItem(x, y, 200, 200, activeColor, 'shape'); }
            else if (type === 'clock') { if(!checkCollision({x, y, w: 200, h: 100})) createItem(x, y, 200, 100, '#ffffff', 'clock'); }
            else if (type === 'weather') { if(!checkCollision({x, y, w: 280, h: 180})) createItem(x, y, 280, 180, '#ffffff', 'weather'); }
            else if (type === 'tvnews') { if(!checkCollision({x, y, w: 500, h: 400})) createItem(x, y, 500, 400, '#ffffff', 'tvnews'); }
            else if (type === 'finance') { if(!checkCollision({x, y, w: 600, h: 500})) createItem(x, y, 600, 500, '#ffffff', 'finance'); }
            else if (type === 'quote') { if(!checkCollision({x, y, w: 300, h: 160})) createItem(x, y, 300, 160, '#ffffff', 'quote'); }
            else if (type === 'number') { if(!checkCollision({x, y, w: 240, h: 200})) createItem(x, y, 240, 200, '#ffffff', 'number'); }
            else if (type === 'chat') { if(!checkCollision({x, y, w: 300, h: 400})) createItem(x, y, 300, 400, '#ffffff', 'chat'); }
            else if (type === 'calc') { if(!checkCollision({x, y, w: 200, h: 300})) createItem(x, y, 200, 300, '#ffffff', 'calc'); }
            else if (type === 'note') { if(!checkCollision({x, y, w: 200, h: 200})) createItem(x, y, 200, 200, '#ffffff', 'note'); }
            else if (type === 'browser') { if(!checkCollision({x, y, w: 400, h: 300})) createItem(x, y, 400, 300, '#ffffff', 'browser'); }
            else if (type === 'llama') { if(!checkCollision({x, y, w: 400, h: 500})) createItem(x, y, 400, 500, '#ffffff', 'llama'); }
            else if (type === 'stock') {
                const symbol = e.dataTransfer.getData('symbol');
                if(!checkCollision({x, y, w: 300, h: 200})) { const newItem = createItem(x, y, 300, 200, activeColor, 'stock'); if(mockStockData[symbol]) { newItem.obj.stockData = JSON.parse(JSON.stringify(mockStockData[symbol])); renderStockContent(newItem.obj); } }
            }
        });

        function createItem(x, y, w, h, color, type) {
            const id = 'item_' + Date.now(); const el = document.createElement('div'); el.className = 'grid-item'; el.id = id; el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.width = w + 'px'; el.style.height = h + 'px';
            const rgb = hexToRgb(color); el.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`; el.style.borderColor = color;
            el.innerHTML = `<div class="content-container" style="width:100%; height:100%;"></div><div class="menu-trigger">‚ãÆ</div><div class="context-menu"><div class="context-menu-item danger" onclick="deleteItem('${id}')">ÁßªÈô§ (Remove)</div></div><div class="item-resize"></div>`;
            
            const menu = el.querySelector('.context-menu'); 
            const removeBtn = menu.querySelector('.context-menu-item');
            
            // Add menu items logic (omitted for brevity, same as before)
            // ...

            const trigger = el.querySelector('.menu-trigger'); 
            trigger.onclick = (e) => { e.stopPropagation(); document.querySelectorAll('.context-menu').forEach(m => { if(m!==menu) m.classList.remove('show'); }); menu.classList.toggle('show'); };
            gridCanvas.appendChild(el);
            const itemObj = { id, x, y, w, h, el, type, stockData: null, showTime: false, viewMode: 'line', timeRange: '1M', timeZone: 'local', cityLabel: 'LOCAL' }; items.push(itemObj);
            if (type === 'clock') renderClockContent(itemObj); if (type === 'chat') renderChatContent(itemObj);
            if (type === 'calc') renderCalcContent(itemObj); if (type === 'note') renderNoteContent(itemObj); 
            if (type === 'browser') renderBrowserContent(itemObj);
            if (type === 'weather') { itemObj.cityLabel = 'Taipei'; renderWeatherContent(itemObj); }
            if (type === 'quote') renderQuoteContent(itemObj);
            if (type === 'number') renderNumberContent(itemObj);
            if (type === 'tvnews') renderGlobalNewsContent(itemObj);
            if (type === 'finance') renderFinanceContent(itemObj);
            if (type === 'llama') renderBrowserContent(itemObj, 'https://llama.online/chat', 'LLAMA ONLINE');
            setupInteractions(itemObj); document.addEventListener('click', () => menu.classList.remove('show')); return { el, obj: itemObj };
        }

        function deleteItem(id) { const idx = items.findIndex(i => i.id === id); if (idx > -1) { items[idx].el.remove(); items.splice(idx, 1); } }
        
        // --- Helper: Fetch Binance History ---
        async function fetchBinanceHistory(symbol, interval) {
            // Map symbol e.g. BTC-USD to BTCUSDT
            const binanceSymbol = symbol.replace('-USD', 'USDT').replace('-', '').toUpperCase();
            try {
                const resp = await fetch(`https://api.binance.com/api/v3/klines?symbol=${binanceSymbol}&interval=${interval}&limit=200`);
                if (!resp.ok) throw new Error('Binance fetch failed');
                const data = await resp.json();
                // Binance format: [time, open, high, low, close, volume, ...]
                return data.map(d => ({
                    time: d[0],
                    open: parseFloat(d[1]),
                    high: parseFloat(d[2]),
                    low: parseFloat(d[3]),
                    close: parseFloat(d[4]),
                    vol: parseFloat(d[5])
                }));
            } catch (e) {
                console.warn("History fetch error:", e);
                return null;
            }
        }

        // --- Finance Pro Functionality (Real Crypto Only) ---
        function renderFinanceContent(item) {
            const container = item.el.querySelector('.content-container');
            
            if(!container.querySelector('.finance-layout')) {
                container.innerHTML = `
                    <div class="finance-layout">
                        <div class="finance-header-bar widget-header">
                            <span>FINANCE PRO // TERMINAL</span>
                        </div>
                        
                        <div class="finance-search-bar">
                            <input type="text" class="finance-search-input" id="f-input-${item.id}" placeholder="Search Crypto (e.g. BTC-USD)">
                            <button class="finance-search-btn" id="f-btn-${item.id}">SEARCH</button>
                            <div class="finance-search-dropdown" id="f-drop-${item.id}"></div>
                        </div>

                        <div class="finance-tabs">
                            <div class="finance-tab active">Overview</div>
                            <div class="finance-tab">History</div>
                            <div class="finance-tab">Financials</div>
                            <div class="finance-tab">Holders</div>
                        </div>

                        <div id="f-content-${item.id}"></div>
                    </div>`;
                
                const input = container.querySelector(`#f-input-${item.id}`);
                const btn = container.querySelector(`#f-btn-${item.id}`);
                const dropdown = container.querySelector(`#f-drop-${item.id}`);
                const contentArea = container.querySelector(`#f-content-${item.id}`);

                item.currentSymbol = 'BTC-USD';
                item.currentRange = '1D';

                const cryptoKeys = ['BTC-USD', 'ETH-USD', 'DOGE-USD', 'SOL-USD', 'ADA-USD', 'XRP-USD', 'DOT-USD'];

                const renderDropdown = () => {
                    let html = '';
                    cryptoKeys.forEach(key => {
                        const data = mockStockData[key];
                        if(data) {
                            const isUp = data.change >= 0;
                            const color = isUp ? 'var(--stock-up)' : 'var(--stock-down)';
                            html += `
                                <div class="finance-dropdown-item" onclick="this.getRootNode().host.selectCrypto('${item.id}', '${key}')">
                                    <span class="finance-dropdown-symbol">${data.symbol}</span>
                                    <span class="finance-dropdown-price">${data.price.toFixed(2)} <span class="finance-dropdown-change" style="color:${color}">${isUp?'+':''}${data.change.toFixed(2)}%</span></span>
                                </div>
                            `;
                        }
                    });
                    dropdown.innerHTML = html;
                    
                    dropdown.querySelectorAll('.finance-dropdown-item').forEach((el, idx) => {
                        el.onclick = (e) => {
                            e.stopPropagation();
                            input.value = cryptoKeys[idx];
                            item.currentSymbol = cryptoKeys[idx];
                            updateUI();
                            dropdown.style.display = 'none';
                        }
                    });
                };

                const updateUI = async () => {
                    let data;
                    const searchKey = item.currentSymbol.toUpperCase();
                    const cryptoKey = Object.keys(mockStockData).find(k => k === searchKey || k.replace('-USD','') === searchKey);
                    const cryptoData = mockStockData[cryptoKey];

                    if (cryptoData && cryptoData.isCrypto) {
                        if (!cryptoDataAvailable && cryptoData.price === 0) {
                             contentArea.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">API ÂøôÁ¢å‰∏≠ (API BUSY)</div>`;
                             return;
                        }
                        
                        // Determine Binance Interval
                        let interval = '5m'; // default 1D
                        if (item.currentRange === '5D') interval = '30m';
                        if (item.currentRange === '1M') interval = '2h';
                        if (['6M','YTD','1Y'].includes(item.currentRange)) interval = '1d';
                        if (['5Y','MAX'].includes(item.currentRange)) interval = '1w';

                        // Fetch REAL History
                        let history = await fetchBinanceHistory(cryptoData.symbol, interval);
                        
                        if (!history) {
                             // Fallback to empty or simple line if fetch fails
                             history = []; 
                        }

                        const basePrice = cryptoData.price;
                        const isUp = cryptoData.change >= 0;
                        const stats = cryptoData.stats || {};

                        data = {
                            symbol: cryptoData.symbol,
                            name: cryptoData.name,
                            exchange: "CRYPTO",
                            flag: "ü™ô",
                            price: basePrice.toFixed(2),
                            change: (isUp ? "+" : "") + (basePrice * cryptoData.change / 100).toFixed(2),
                            changeP: (isUp ? "+" : "") + cryptoData.change.toFixed(2) + "%",
                            isUp: isUp,
                            afterHours: { price: "No Data", change: "No Data" },
                            stats: {
                                prevClose: stats.vwap || "No Data", // Use vwap as proxy for ref
                                open: history.length > 0 ? history[history.length-1].open.toFixed(2) : "No Data",
                                range: history.length > 0 ? `${Math.min(...history.slice(-24).map(h=>h.low)).toFixed(2)} - ${Math.max(...history.slice(-24).map(h=>h.high)).toFixed(2)}` : "No Data",
                                week52: "No Data", 
                                vol: stats.vol || "No Data", 
                                cap: stats.cap || "No Data", 
                                pe: "No Data", eps: "No Data", yield: "No Data", beta: "No Data"
                            },
                            history: history
                        };
                    } else {
                         contentArea.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);text-align:center;">
                            <div style="font-size:3em;margin-bottom:10px;">üîí</div>
                            <div style="font-size:1.2em;font-weight:bold;">SYSTEM LOCKED: CRYPTO ONLY</div>
                            <div style="font-size:0.8em;opacity:0.7;margin-top:5px;">Access restricted to cryptocurrency assets.</div>
                        </div>`;
                        return;
                    }
                    
                    if (!data.history || data.history.length === 0) {
                         contentArea.innerHTML = `<div class="no-data-overlay">ÁÑ°‰∫§ÊòìÈáèÂíåKÁ∑öÂúñ (No Data)</div>`;
                         return;
                    }

                    const cssColorClass = data.isUp ? 'var(--stock-up)' : 'var(--stock-down)';
                    const chartH = 200; const chartW = 800;
                    
                    const prices = data.history.map(d => d.close);
                    const min = Math.min(...data.history.map(d => d.low)) * 0.99; 
                    const max = Math.max(...data.history.map(d => d.high)) * 1.01;
                    const range = max - min;
                    const step = chartW / (data.history.length);

                    // Drawing Logic
                    let chartContent = '';
                    let volSVG = '';
                    
                    const maxVol = Math.max(...data.history.map(d=>d.vol)); 
                    data.history.forEach((h, i) => {
                        const hVol = (h.vol / maxVol) * 50; 
                        const color = h.close >= h.open ? 'var(--stock-up)' : 'var(--stock-down)';
                        volSVG += `<rect x="${i*step}" y="${chartH - hVol}" width="${Math.max(1, step-0.5)}" height="${hVol}" fill="${color}" opacity="0.3" />`;
                    });
                    
                    // Grid & Labels
                    let gridLines = '';
                    let labels = '';
                    const steps = 4;
                    for(let i=0; i<=steps; i++) {
                       const price = min + (range * (i/steps));
                       const y = chartH - (i/steps * chartH);
                       gridLines += `<line x1="0" y1="${y}" x2="${chartW}" y2="${y}" stroke="#333" stroke-width="1" opacity="0.5" />`;
                       labels += `<text x="${chartW - 5}" y="${y - 5}" fill="#888" font-size="10" text-anchor="end">${price.toFixed(2)}</text>`;
                    }
                    
                    // MA
                    const period = 10; 
                    let maPath = '';
                    if (data.history.length >= period) {
                        let maD = '';
                        for(let i=period-1; i<data.history.length; i++) {
                            let sum = 0; for(let j=0; j<period; j++) sum += data.history[i-j].close;
                            const avg = sum / period;
                            const x = i * step + step/2;
                            const y = chartH - ((avg - min) / range * chartH);
                            maD += (i === period-1 ? `M ${x} ${y}` : ` L ${x} ${y}`);
                        }
                        maPath = `<path d="${maD}" fill="none" stroke="#ffa500" stroke-width="1.5" opacity="0.8" />`;
                    }

                    if (['1D', '5D'].includes(item.currentRange)) {
                        let d = `M 0 ${chartH}`;
                        data.history.forEach((h, i) => {
                            const y = chartH - ((h.close - min) / range * chartH);
                            d += ` L ${i * step + step/2} ${y}`;
                        });
                        d += ` V ${chartH} Z`;
                        const lineD = d.replace(/M 0 200/, '').replace(/ V 200 Z/, '');
                        const firstY = chartH - ((data.history[0].close - min) / range * chartH);
                        const finalLineD = `M 0 ${firstY}` + lineD;

                        chartContent = `
                            <defs>
                                <linearGradient id="grad-${item.id}" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:var(--stock-blue);stop-opacity:0.3" />
                                    <stop offset="100%" style="stop-color:var(--stock-blue);stop-opacity:0" />
                                </linearGradient>
                            </defs>
                            ${gridLines}
                            ${volSVG}
                            <path d="${d}" fill="url(#grad-${item.id})" stroke="none" />
                            <path d="${finalLineD}" fill="none" stroke="var(--stock-blue)" stroke-width="2" />
                            ${maPath}
                            ${labels}
                        `;
                    } else {
                        let candlesSVG = '';
                        const candleW = Math.max(1, step * 0.6);
                        data.history.forEach((h, i) => {
                            const x = i * step + (step - candleW)/2;
                            const yOpen = chartH - ((h.open - min) / range * chartH);
                            const yClose = chartH - ((h.close - min) / range * chartH);
                            const yHigh = chartH - ((h.high - min) / range * chartH);
                            const yLow = chartH - ((h.low - min) / range * chartH);
                            const color = h.close >= h.open ? 'var(--stock-up)' : 'var(--stock-down)';
                            candlesSVG += `<line x1="${x+candleW/2}" y1="${yHigh}" x2="${x+candleW/2}" y2="${yLow}" stroke="${color}" stroke-width="1" />`;
                            const bodyH = Math.max(1, Math.abs(yClose - yOpen));
                            const bodyY = Math.min(yOpen, yClose);
                            candlesSVG += `<rect x="${x}" y="${bodyY}" width="${candleW}" height="${bodyH}" fill="${color}" />`;
                        });
                        chartContent = `
                            ${gridLines}
                            ${volSVG}
                            ${candlesSVG}
                            ${maPath}
                            ${labels}
                        `;
                    }

                    const timeRanges = ['1D','5D','1M','6M','YTD','1Y','5Y','MAX'];

                    contentArea.innerHTML = `
                        <div class="finance-main-info">
                            <div class="finance-price-block">
                                <div class="finance-symbol">${data.symbol} <span class="finance-exchange">${data.exchange}</span> ${data.flag}</div>
                                <div class="finance-main-price" style="color:${cssColorClass}">${data.price}</div>
                                <div class="finance-main-change" style="color:${cssColorClass}">${data.change} (${data.changeP})</div>
                            </div>
                            <div class="finance-sub-price-block">
                                <div class="finance-sub-label">After Hours</div>
                                <div class="finance-sub-price">${data.afterHours.price} <span style="font-size:0.8em; color:${data.isUp?'var(--stock-up)':'var(--stock-down)'}">${data.afterHours.change}</span></div>
                                <div class="finance-sub-label" style="margin-top:5px">Prev Close: ${data.stats.prevClose}</div>
                            </div>
                        </div>

                        <div class="finance-chart-controls" id="f-ranges-${item.id}">
                            ${timeRanges.map(r => `<button class="finance-time-btn ${r === item.currentRange ? 'active' : ''}" data-range="${r}">${r}</button>`).join('')}
                        </div>

                        <div class="finance-chart-container">
                            <svg class="finance-chart-svg" viewBox="0 0 ${chartW} ${chartH}" preserveAspectRatio="none">
                                ${chartContent}
                            </svg>
                        </div>

                        <div class="finance-stats-grid">
                            <div class="finance-stat-item"><span class="stat-label">OPEN</span><span class="stat-val">${data.stats.open}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">PREV CLOSE</span><span class="stat-val">${data.stats.prevClose}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">DAY RANGE</span><span class="stat-val">${data.stats.range}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">52WK RANGE</span><span class="stat-val">${data.stats.week52}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">VOLUME</span><span class="stat-val">${data.stats.vol}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">MKT CAP</span><span class="stat-val">${data.stats.cap}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">P/E</span><span class="stat-val">${data.stats.pe}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">EPS</span><span class="stat-val">${data.stats.eps}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">YIELD</span><span class="stat-val">${data.stats.yield}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">BETA</span><span class="stat-val">${data.stats.beta}</span></div>
                        </div>
                    `;

                    const rangeBtns = container.querySelectorAll(`#f-ranges-${item.id} .finance-time-btn`);
                    rangeBtns.forEach(b => {
                        b.onclick = (e) => {
                            e.stopPropagation();
                            item.currentRange = b.dataset.range;
                            updateUI();
                        };
                    });
                };

                btn.onclick = (e) => { e.stopPropagation(); if(input.value) { item.currentSymbol = input.value; updateUI(); } };
                input.addEventListener('keydown', (e) => { if(e.key === 'Enter' && input.value) { item.currentSymbol = input.value; updateUI(); dropdown.style.display='none'; } });
                input.addEventListener('mousedown', e => e.stopPropagation());
                
                input.addEventListener('mouseenter', () => { renderDropdown(); dropdown.style.display = 'block'; });
                container.addEventListener('mouseleave', () => { dropdown.style.display = 'none'; });

                updateUI();
                
                // Only update price every few seconds, don't redraw full history constantly to save API calls
                item.financeInterval = setInterval(() => {
                     if(document.contains(item.el) && item.type === 'finance') {
                         // Just refreshing main price might be better, but full UI update is simpler for now
                         // updateUI(); 
                     }
                     else clearInterval(item.financeInterval);
                }, 60000); // Refresh chart every 1 min
            }
        }
        
        function getWeatherDesc(code) {
             const codes = {0: 'Clear', 1: 'Cloudy', 2: 'Cloudy', 3: 'Overcast', 45: 'Fog', 48: 'Fog', 51: 'Drizzle', 61: 'Rain', 71: 'Snow', 95: 'Storm'};
             return codes[code] || 'Unknown';
        }

        function getDayName(dateStr) {
            const date = new Date(dateStr); return date.toLocaleDateString('en-US', { weekday: 'short' });
        }

        async function renderWeatherContent(item) {
            const container = item.el.querySelector('.content-container');
            if(!container.querySelector('.weather-layout')) {
                container.innerHTML = `
                    <div class="weather-layout">
                        <div class="weather-header widget-header"><span>WEATHER</span></div>
                        <div class="weather-top">
                            <div class="weather-top-left"><div class="weather-main-icon" id="w-icon-${item.id}">‚òÄÔ∏è</div><div class="weather-main-temp" id="w-temp-${item.id}">--</div><div class="weather-unit">¬∞C</div></div>
                            <div class="weather-condition-text" id="w-cond-${item.id}">Clear</div>
                        </div>
                        <div class="weather-middle">
                            <div class="weather-location-text" id="w-city-name-${item.id}">LOADING</div>
                            <div class="weather-hl">H:<span id="w-high-${item.id}">--</span>¬∞ L:<span id="w-low-${item.id}">--</span>¬∞</div>
                        </div>
                        <div class="weather-forecast" id="w-forecast-${item.id}"></div>
                        <div class="weather-search-container"><input type="text" class="weather-search-input" id="w-input-${item.id}" placeholder="Ë´ãÂú®Ê≠§ÊêúÂ∞ãÂüéÂ∏Ç" value=""></div>
                    </div>`;
                const input = container.querySelector(`#w-input-${item.id}`);
                input.addEventListener('keypress', async (e) => {
                    if(e.key === 'Enter') {
                        const val = input.value.trim();
                        if(val) {
                            item.cityLabel = val;
                            container.querySelector(`#w-city-name-${item.id}`).innerText = "SEARCHING";
                            await updateWeatherData(item, val);
                            input.value = '';
                        }
                    }
                });
                 input.addEventListener('mousedown', e => e.stopPropagation());
                 updateWeatherScale(item);
            }
            await updateWeatherData(item, item.cityLabel);
        }

        async function updateWeatherData(item, city) {
            const data = await fetchWeather(city);
            const container = item.el.querySelector('.content-container');
            if(data) {
                container.querySelector(`#w-city-name-${item.id}`).innerText = data.name;
                container.querySelector(`#w-temp-${item.id}`).innerText = Math.round(data.current.temperature_2m);
                container.querySelector(`#w-icon-${item.id}`).innerText = getWeatherIcon(data.current.weather_code);
                container.querySelector(`#w-cond-${item.id}`).innerText = getWeatherDesc(data.current.weather_code);
                if(data.daily) {
                    container.querySelector(`#w-high-${item.id}`).innerText = Math.round(data.daily.temperature_2m_max[0]);
                    container.querySelector(`#w-low-${item.id}`).innerText = Math.round(data.daily.temperature_2m_min[0]);
                }
                const forecastContainer = container.querySelector(`#w-forecast-${item.id}`);
                if(data.daily && forecastContainer) {
                    let forecastHTML = '';
                    for(let i=1; i<=5; i++) {
                        if(data.daily.time[i]) {
                             forecastHTML += `<div class="forecast-item"><div class="forecast-day">${getDayName(data.daily.time[i])}</div><div class="forecast-icon">${getWeatherIcon(data.daily.weather_code[i])}</div><div class="forecast-temp">${Math.round(data.daily.temperature_2m_max[i])}¬∞</div></div>`;
                        }
                    }
                    forecastContainer.innerHTML = forecastHTML;
                }
                item.cityLabel = data.name; 
            } else { const cityEl = container.querySelector(`#w-city-name-${item.id}`); if(cityEl) cityEl.innerText = "NOT FOUND"; }
        }

        function updateWeatherScale(item) {
            const layout = item.el.querySelector('.weather-layout');
            if(layout) layout.style.fontSize = `${item.w / 25}px`;
        }

        // --- Quote Functionality ---
        async function fetchQuote() {
            try {
                const resp = await fetch('https://api.quotable.io/random');
                return await resp.json();
            } catch(e) { return { content: "Knowledge is power.", author: "Francis Bacon" }; }
        }

        async function renderQuoteContent(item) {
            const container = item.el.querySelector('.content-container');
            if(!container.querySelector('.quote-layout')) {
                container.innerHTML = `
                    <div class="quote-layout">
                        <div class="quote-header widget-header"><span>DAILY INSIGHT</span></div>
                        <div class="quote-content" id="q-text-${item.id}">Loading...</div>
                        <div class="quote-author" id="q-auth-${item.id}"></div>
                        <div class="quote-refresh" id="q-btn-${item.id}">‚Üª</div>
                    </div>`;
                const btn = container.querySelector(`#q-btn-${item.id}`);
                if(btn) btn.onclick = (e) => { e.stopPropagation(); updateQuote(item); };
                updateQuoteScale(item);
                await updateQuote(item);
            }
        }

        async function updateQuote(item) {
            const container = item.el.querySelector('.content-container');
            const contentEl = container.querySelector(`#q-text-${item.id}`);
            if(contentEl) contentEl.innerText = "Fetching...";
            const q = await fetchQuote();
            if(contentEl) contentEl.innerText = `"${q.content}"`;
            container.querySelector(`#q-auth-${item.id}`).innerText = `- ${q.author}`;
        }

        function updateQuoteScale(item) {
            const layout = item.el.querySelector('.quote-layout');
            if(layout) layout.style.fontSize = `${item.w / 20}px`;
        }

        // --- Number Fact Functionality ---
        async function fetchNumberFact(num = 'random') {
            try {
                // Try HTTPS mock/proxy first or fallback to static
                const facts = ["42 is the answer to life, the universe, and everything.", "73 is the 21st prime number.", "0 is the additive identity.", "1 is the only number that is neither prime nor composite."];
                try { const resp = await fetch(`https://numbersapi.com/${num}/math?json`); if(resp.ok) return await resp.json(); } catch(e) {}
                return { text: facts[Math.floor(Math.random() * facts.length)], number: num === 'random' ? Math.floor(Math.random()*100) : num };
            } catch(e) { return { text: "Could not fetch fact.", number: "ERR" }; }
        }

        async function renderNumberContent(item) {
            const container = item.el.querySelector('.content-container');
            if(!container.querySelector('.number-layout')) {
                container.innerHTML = `
                    <div class="number-layout">
                        <div class="number-header widget-header"><span>DATA FACT</span></div>
                        <div class="number-val" id="n-val-${item.id}">#</div>
                        <div class="number-fact" id="n-fact-${item.id}">Ready to process...</div>
                        <div class="number-controls">
                            <input type="number" class="number-input" id="n-input-${item.id}" placeholder="Num">
                            <button class="number-btn" id="n-go-${item.id}">GO</button>
                            <button class="number-btn" id="n-rnd-${item.id}">RND</button>
                        </div>
                    </div>`;
                const input = container.querySelector(`#n-input-${item.id}`);
                const goBtn = container.querySelector(`#n-go-${item.id}`);
                const rndBtn = container.querySelector(`#n-rnd-${item.id}`);
                const update = async (val) => {
                    container.querySelector(`#n-fact-${item.id}`).innerText = "Processing...";
                    const data = await fetchNumberFact(val);
                    container.querySelector(`#n-val-${item.id}`).innerText = data.number;
                    container.querySelector(`#n-fact-${item.id}`).innerText = data.text;
                };
                goBtn.onclick = (e) => { e.stopPropagation(); if(input.value) update(input.value); };
                rndBtn.onclick = (e) => { e.stopPropagation(); update('random'); };
                input.addEventListener('mousedown', e => e.stopPropagation());
            }
        }

        // --- Global News Functionality (RSS to JSON) ---
        async function fetchRSSNews() {
            const feeds = [
                'https://www.theverge.com/rss/index.xml', // The Verge
                'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=10000664', // CNBC Tech
                'https://www.engadget.com/rss.xml', // Engadget
                'https://www.wired.com/feed/rss' // Wired
            ];
            
            try {
                const promises = feeds.map(url => 
                    fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`)
                    .then(res => res.json())
                    .then(data => data.status === 'ok' ? data.items : [])
                );
                
                const results = await Promise.all(promises);
                const allNews = results.flat();
                
                // Sort by date descending
                allNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                
                // Filter duplicates by title
                const uniqueNews = allNews.filter((v,i,a)=>a.findIndex(t=>(t.title === v.title))===i);

                return uniqueNews;
            } catch (e) {
                console.warn("RSS Fetch failed", e);
                return [];
            }
        }

        function extractImageFromItem(item) {
            // 1. Enclosure / Thumbnail
            if (item.enclosure && item.enclosure.link) return item.enclosure.link;
            if (item.thumbnail) return item.thumbnail;
            
            // 2. Parse Description/Content HTML using DOMParser to find <img>
            const htmlContent = item.description || item.content || "";
            if (htmlContent) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const img = doc.querySelector('img');
                if (img && img.src) return img.src;
            }

            // 3. Regex Fallback
            const match = htmlContent.match(/src="([^"]*)"/);
            if (match) return match[1];

            // 4. Fallback placeholders
            const placeholders = [
                'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=800&q=80',
                'https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?auto=format&fit=crop&w=800&q=80',
                'https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&w=800&q=80'
            ];
            return placeholders[Math.floor(Math.random() * placeholders.length)];
        }

        async function renderGlobalNewsContent(item) {
            const container = item.el.querySelector('.content-container');
            if(!container.querySelector('.global-news-layout')) {
                container.innerHTML = `
                    <div class="global-news-layout">
                        <div class="global-news-header widget-header">
                            <span style="font-weight:bold; letter-spacing:1px;">GLOBAL NEWS</span>
                            <span style="opacity:0.6; font-size:0.9em;">LIVE FEED</span>
                        </div>
                        <div id="news-content-${item.id}" style="margin-top: 30px;">
                            <div class="news-loading">INITIALIZING CYBER FEED...</div>
                        </div>
                    </div>`;
                
                const contentDiv = container.querySelector(`#news-content-${item.id}`);
                const articles = await fetchRSSNews();
                
                if (articles.length > 0) {
                    const hero = articles[0];
                    const others = articles.slice(1, 12); // Show more items (11 grid items)
                    
                    let html = `
                        <div class="news-hero" onclick="window.open('${hero.link}', '_blank')">
                            <div class="news-hero-content">
                                <div class="news-hero-title">${hero.title}</div>
                                <div class="news-hero-summary">${hero.description.replace(/<[^>]*>?/gm, '').substring(0, 120)}...</div>
                                <div class="news-hero-meta">
                                    <span>‚óè ${new Date(hero.pubDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                </div>
                                <a href="${hero.link}" target="_blank" class="news-source-btn" onclick="event.stopPropagation()">READ SOURCE ‚Üó</a>
                            </div>
                            <img class="news-hero-img" src="${extractImageFromItem(hero)}" onerror="this.style.display='none'">
                        </div>
                        <div class="news-grid">
                    `;
                    
                    others.forEach(art => {
                        html += `
                            <div class="news-grid-card" onclick="window.open('${art.link}', '_blank')">
                                <img class="news-card-img" src="${extractImageFromItem(art)}" onerror="this.style.display='none'">
                                <div class="news-card-content">
                                    <div class="news-card-title">${art.title}</div>
                                    <div class="news-card-meta">
                                        <span>${new Date(art.pubDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                    <a href="${art.link}" target="_blank" class="news-source-btn" onclick="event.stopPropagation()">READ SOURCE ‚Üó</a>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                    contentDiv.innerHTML = html;
                } else {
                    contentDiv.innerHTML = `<div class="news-loading">CONNECTION FAILED // RETRYING...</div>`;
                }
            }
        }

        // --- Finance Pro Functionality (Crypto Only) ---
        function renderFinanceContent(item) {
            const container = item.el.querySelector('.content-container');
            
            // Initial Render Structure
            if(!container.querySelector('.finance-layout')) {
                container.innerHTML = `
                    <div class="finance-layout">
                        <div class="finance-header-bar widget-header">
                            <span>FINANCE PRO // TERMINAL</span>
                        </div>
                        
                        <div class="finance-search-bar">
                            <input type="text" class="finance-search-input" id="f-input-${item.id}" placeholder="Search Crypto (e.g. BTC-USD)">
                            <button class="finance-search-btn" id="f-btn-${item.id}">SEARCH</button>
                            <div class="finance-search-dropdown" id="f-drop-${item.id}"></div>
                        </div>

                        <div class="finance-tabs">
                            <div class="finance-tab active">Overview</div>
                            <div class="finance-tab">History</div>
                            <div class="finance-tab">Financials</div>
                            <div class="finance-tab">Holders</div>
                        </div>

                        <div id="f-content-${item.id}">
                            <!-- Dynamic Content -->
                        </div>
                    </div>`;
                
                const input = container.querySelector(`#f-input-${item.id}`);
                const btn = container.querySelector(`#f-btn-${item.id}`);
                const dropdown = container.querySelector(`#f-drop-${item.id}`);
                const contentArea = container.querySelector(`#f-content-${item.id}`);

                // Internal state
                item.currentSymbol = 'BTC-USD';
                item.currentRange = '1D';

                // Crypto list for dropdown
                const cryptoKeys = ['BTC-USD', 'ETH-USD', 'DOGE-USD', 'SOL-USD', 'ADA-USD', 'XRP-USD', 'DOT-USD'];

                const renderDropdown = () => {
                    let html = '';
                    cryptoKeys.forEach(key => {
                        const data = mockStockData[key];
                        if(data) {
                            const isUp = data.change >= 0;
                            const color = isUp ? 'var(--stock-up)' : 'var(--stock-down)';
                            html += `
                                <div class="finance-dropdown-item" onclick="this.getRootNode().host.selectCrypto('${item.id}', '${key}')">
                                    <span class="finance-dropdown-symbol">${data.symbol}</span>
                                    <span class="finance-dropdown-price">${data.price.toFixed(2)} <span class="finance-dropdown-change" style="color:${color}">${isUp?'+':''}${data.change.toFixed(2)}%</span></span>
                                </div>
                            `;
                        }
                    });
                    dropdown.innerHTML = html;
                    
                    // Bind clicks manually
                    dropdown.querySelectorAll('.finance-dropdown-item').forEach((el, idx) => {
                        el.onclick = (e) => {
                            e.stopPropagation();
                            input.value = cryptoKeys[idx];
                            item.currentSymbol = cryptoKeys[idx];
                            updateUI();
                            dropdown.style.display = 'none';
                        }
                    });
                };

                const updateUI = () => {
                    let data;
                    const searchKey = item.currentSymbol.toUpperCase();
                    const cryptoKey = Object.keys(mockStockData).find(k => k === searchKey || k.replace('-USD','') === searchKey);
                    const cryptoData = mockStockData[cryptoKey];

                    if (cryptoData && cryptoData.isCrypto) {
                        if (!cryptoDataAvailable && cryptoData.price === 0) {
                             contentArea.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">API ÂøôÁ¢å‰∏≠ (API BUSY)</div>`;
                             return;
                        }
                        const basePrice = cryptoData.price;
                        const changeAmount = basePrice * (cryptoData.change / 100);
                        const isUp = cryptoData.change >= 0;
                        
                        // Determine Range Scale
                        let count = 50;
                        let volatility = 0.02;
                        if (item.currentRange === '5D') { count = 100; volatility = 0.03; }
                        if (item.currentRange === '1M') { count = 30; volatility = 0.05; } // Daily bars
                        if (['6M','YTD','1Y'].includes(item.currentRange)) { count = 100; volatility = 0.1; }
                        if (item.currentRange === '5Y' || item.currentRange === 'MAX') { count = 200; volatility = 0.2; }

                        // Generate or use history
                        // For ranges > 1D, we simulate distinct history for demo based on range
                        let history = [];
                        if (item.currentRange === '1D') {
                            // Use the high-res simulated history from mockStockData if available
                            history = cryptoData.history.length > 0 ? cryptoData.history : generateHistory(basePrice, 50);
                        } else {
                            // Simulate broader history
                            history = generateHistory(basePrice, count);
                        }

                        data = {
                            symbol: cryptoData.symbol,
                            name: cryptoData.name,
                            exchange: "CRYPTO",
                            flag: "ü™ô",
                            price: basePrice.toFixed(2),
                            change: (isUp ? "+" : "") + changeAmount.toFixed(2),
                            changeP: (isUp ? "+" : "") + cryptoData.change.toFixed(2) + "%",
                            isUp: isUp,
                            afterHours: { price: "No Data", change: "No Data" },
                            stats: {
                                prevClose: (basePrice / (1 + cryptoData.change/100)).toFixed(2),
                                open: history[0].open.toFixed(2),
                                range: `${Math.min(...history.map(h=>h.low)).toFixed(2)} - ${Math.max(...history.map(h=>h.high)).toFixed(2)}`,
                                week52: "No Data", vol: "No Data", cap: "No Data", pe: "No Data", eps: "No Data", yield: "No Data", beta: "No Data"
                            },
                            history: history
                        };
                    } else {
                        // Rejected
                         contentArea.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);text-align:center;">
                            <div style="font-size:3em;margin-bottom:10px;">üîí</div>
                            <div style="font-size:1.2em;font-weight:bold;">SYSTEM LOCKED: CRYPTO ONLY</div>
                            <div style="font-size:0.8em;opacity:0.7;margin-top:5px;">Access restricted to cryptocurrency assets.</div>
                        </div>`;
                        return;
                    }
                    
                    // No Data Check
                    if (!data.history || data.history.length === 0) {
                         contentArea.innerHTML = `<div class="no-data-overlay">ÁÑ°‰∫§ÊòìÈáèÂíåKÁ∑öÂúñ</div>`;
                         return;
                    }

                    const cssColorClass = data.isUp ? 'var(--stock-up)' : 'var(--stock-down)';
                    const chartH = 200; const chartW = 800;
                    
                    const prices = data.history.map(d => d.close);
                    const min = Math.min(...data.history.map(d => d.low)) * 0.99; 
                    const max = Math.max(...data.history.map(d => d.high)) * 1.01;
                    const range = max - min;
                    const step = chartW / (data.history.length);

                    // --- Drawing Logic ---
                    let chartContent = '';
                    let volSVG = '';
                    
                    // Volume Bars (Always draw)
                    const maxVol = 100; 
                    data.history.forEach((h, i) => {
                        const hVol = Math.random() * 40; 
                        const color = h.close >= h.open ? 'var(--stock-up)' : 'var(--stock-down)';
                        volSVG += `<rect x="${i*step}" y="${chartH - hVol}" width="${Math.max(1, step-1)}" height="${hVol}" fill="${color}" opacity="0.3" />`;
                    });
                    
                    // Grid Lines and Labels
                    let gridLines = '';
                    let labels = '';
                    const steps = 4;
                    for(let i=0; i<=steps; i++) {
                       const price = min + (range * (i/steps));
                       const y = chartH - (i/steps * chartH);
                       gridLines += `<line x1="0" y1="${y}" x2="${chartW}" y2="${y}" stroke="#333" stroke-width="1" opacity="0.5" />`;
                       labels += `<text x="${chartW - 5}" y="${y - 5}" fill="#888" font-size="10" text-anchor="end">${price.toFixed(2)}</text>`;
                    }
                    
                    // Calculate Simple Moving Average (MA)
                    const period = 10; // MA 10
                    let maPath = '';
                    if (data.history.length >= period) {
                        let maD = '';
                        for(let i=period-1; i<data.history.length; i++) {
                            let sum = 0;
                            for(let j=0; j<period; j++) sum += data.history[i-j].close;
                            const avg = sum / period;
                            const x = i * step + step/2;
                            const y = chartH - ((avg - min) / range * chartH);
                            maD += (i === period-1 ? `M ${x} ${y}` : ` L ${x} ${y}`);
                        }
                        maPath = `<path d="${maD}" fill="none" stroke="#ffa500" stroke-width="1.5" opacity="0.8" />`;
                    }

                    if (['1D', '5D'].includes(item.currentRange)) {
                        // --- AREA CHART for Short Term ---
                        let d = `M 0 ${chartH}`;
                        data.history.forEach((h, i) => {
                            const y = chartH - ((h.close - min) / range * chartH);
                            d += ` L ${i * step + step/2} ${y}`;
                        });
                        d += ` V ${chartH} Z`;
                        
                        const lineD = d.replace(/M 0 200/, '').replace(/ V 200 Z/, '');
                        // Fix initial move for line
                        const firstY = chartH - ((data.history[0].close - min) / range * chartH);
                        const finalLineD = `M 0 ${firstY}` + lineD;

                        chartContent = `
                            <defs>
                                <linearGradient id="grad-${item.id}" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:var(--stock-blue);stop-opacity:0.3" />
                                    <stop offset="100%" style="stop-color:var(--stock-blue);stop-opacity:0" />
                                </linearGradient>
                            </defs>
                            ${gridLines}
                            <line x1="0" y1="${chartH - ((data.stats.prevClose - min) / range * chartH)}" x2="${chartW}" y2="${chartH - ((data.stats.prevClose - min) / range * chartH)}" stroke="#787b86" stroke-dasharray="4" opacity="0.5" />
                            ${volSVG}
                            <path d="${d}" fill="url(#grad-${item.id})" stroke="none" />
                            <path d="${finalLineD}" fill="none" stroke="var(--stock-blue)" stroke-width="2" />
                            ${maPath}
                            ${labels}
                        `;
                    } else {
                        // --- CANDLESTICK CHART for Long Term ---
                        let candlesSVG = '';
                        const candleW = Math.max(1, step * 0.6);
                        data.history.forEach((h, i) => {
                            const x = i * step + (step - candleW)/2;
                            const yOpen = chartH - ((h.open - min) / range * chartH);
                            const yClose = chartH - ((h.close - min) / range * chartH);
                            const yHigh = chartH - ((h.high - min) / range * chartH);
                            const yLow = chartH - ((h.low - min) / range * chartH);
                            const color = h.close >= h.open ? 'var(--stock-up)' : 'var(--stock-down)';
                            
                            // Wick
                            candlesSVG += `<line x1="${x+candleW/2}" y1="${yHigh}" x2="${x+candleW/2}" y2="${yLow}" stroke="${color}" stroke-width="1" />`;
                            // Body
                            const bodyH = Math.max(1, Math.abs(yClose - yOpen));
                            const bodyY = Math.min(yOpen, yClose);
                            candlesSVG += `<rect x="${x}" y="${bodyY}" width="${candleW}" height="${bodyH}" fill="${color}" />`;
                        });
                        chartContent = `
                            ${gridLines}
                            <line x1="0" y1="${chartH - ((data.stats.prevClose - min) / range * chartH)}" x2="${chartW}" y2="${chartH - ((data.stats.prevClose - min) / range * chartH)}" stroke="#787b86" stroke-dasharray="4" opacity="0.5" />
                            ${volSVG}
                            ${candlesSVG}
                            ${maPath}
                            ${labels}
                        `;
                    }

                    const timeRanges = ['1D','5D','1M','6M','YTD','1Y','5Y','MAX'];

                    contentArea.innerHTML = `
                        <div class="finance-main-info">
                            <div class="finance-price-block">
                                <div class="finance-symbol">${data.symbol} <span class="finance-exchange">${data.exchange}</span> ${data.flag}</div>
                                <div class="finance-main-price" style="color:${cssColorClass}">${data.price}</div>
                                <div class="finance-main-change" style="color:${cssColorClass}">${data.change} (${data.changeP})</div>
                            </div>
                            <div class="finance-sub-price-block">
                                <div class="finance-sub-label">After Hours</div>
                                <div class="finance-sub-price">${data.afterHours.price} <span style="font-size:0.8em; color:${data.isUp?'var(--stock-up)':'var(--stock-down)'}">${data.afterHours.change}</span></div>
                                <div class="finance-sub-label" style="margin-top:5px">Prev Close: ${data.stats.prevClose}</div>
                            </div>
                        </div>

                        <div class="finance-chart-controls" id="f-ranges-${item.id}">
                            ${timeRanges.map(r => `<button class="finance-time-btn ${r === item.currentRange ? 'active' : ''}" data-range="${r}">${r}</button>`).join('')}
                        </div>

                        <div class="finance-chart-container">
                            <svg class="finance-chart-svg" viewBox="0 0 ${chartW} ${chartH}" preserveAspectRatio="none">
                                ${chartContent}
                            </svg>
                        </div>

                        <div class="finance-stats-grid">
                            <div class="finance-stat-item"><span class="stat-label">OPEN</span><span class="stat-val">${data.stats.open}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">PREV CLOSE</span><span class="stat-val">${data.stats.prevClose}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">DAY RANGE</span><span class="stat-val">${data.stats.range}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">52WK RANGE</span><span class="stat-val">${data.stats.week52}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">VOLUME</span><span class="stat-val">${data.stats.vol}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">MKT CAP</span><span class="stat-val">${data.stats.cap}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">P/E</span><span class="stat-val">${data.stats.pe}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">EPS</span><span class="stat-val">${data.stats.eps}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">YIELD</span><span class="stat-val">${data.stats.yield}</span></div>
                            <div class="finance-stat-item"><span class="stat-label">BETA</span><span class="stat-val">${data.stats.beta}</span></div>
                        </div>
                    `;

                    const rangeBtns = container.querySelectorAll(`#f-ranges-${item.id} .finance-time-btn`);
                    rangeBtns.forEach(b => {
                        b.onclick = (e) => {
                            e.stopPropagation();
                            item.currentRange = b.dataset.range;
                            updateUI();
                        };
                    });
                };

                // Events
                btn.onclick = (e) => { e.stopPropagation(); if(input.value) { item.currentSymbol = input.value; updateUI(); } };
                input.addEventListener('keydown', (e) => { if(e.key === 'Enter' && input.value) { item.currentSymbol = input.value; updateUI(); dropdown.style.display='none'; } });
                input.addEventListener('mousedown', e => e.stopPropagation());
                
                // Dropdown events
                input.addEventListener('mouseenter', () => { renderDropdown(); dropdown.style.display = 'block'; });
                container.addEventListener('mouseleave', () => { dropdown.style.display = 'none'; });

                // Initial Load
                updateUI();
                
                // Live update
                item.financeInterval = setInterval(() => {
                     if(document.contains(item.el) && item.type === 'finance') {
                         updateUI();
                         if(dropdown.style.display === 'block') renderDropdown(); // Update dropdown prices too
                     }
                     else clearInterval(item.financeInterval);
                }, 2000);
            }
        }

        function renderClockContent(item) { 
            const container = item.el.querySelector('.content-container'); const now = new Date(); let timeStr;
            if (!item.timeZone || item.timeZone === 'local') { timeStr = now.toLocaleTimeString('en-US', { hour12: false }); } 
            else { try { timeStr = now.toLocaleTimeString('en-US', { hour12: false, timeZone: item.timeZone }); } catch(e) { timeStr = "Invalid TZ"; } }
            const fontSize = item.w / 6.5; const adjustedFontSize = item.timeZone && item.timeZone !== 'local' ? fontSize * 0.8 : fontSize; const labelSize = adjustedFontSize * 0.3;
            container.innerHTML = `<div class="clock-layout"><div style="font-size:${adjustedFontSize}px; line-height: 1;">${timeStr}</div><div class="clock-city" style="font-size:${labelSize}px;">${item.cityLabel || 'LOCAL'}</div></div>`; 
        }
        function renderChatContent(item) {
            const container = item.el.querySelector('.content-container'); if(container.querySelector('.chat-layout')) return;
            container.innerHTML = `
                <div class="chat-layout">
                    <div class="chat-header widget-header"><span>LLM CHAT</span><span style="font-size:0.8em; opacity:0.7;">ONLINE</span></div>
                    <div class="chat-history" id="history-${item.id}"><div class="chat-msg sys">System initialized. Select model and type command.</div></div>
                    <div class="chat-input-area">
                        <div style="position:relative; display:inline-block;">
                            <button class="chat-upload-btn" title="Upload File" onclick="document.getElementById('file-${item.id}').click()">üìÅ</button>
                            <input type="file" id="file-${item.id}" style="display:none">
                        </div>
                        <input type="text" class="chat-input" placeholder="Type command..." id="input-${item.id}">
                        <select class="chat-model-select" id="model-${item.id}"><option value="llama3">Llama 3</option><option value="deepseek">DeepSeek</option></select>
                        <button class="chat-send-btn" id="btn-${item.id}">SEND</button>
                    </div>
                </div>`;
            const input = container.querySelector(`#input-${item.id}`), btn = container.querySelector(`#btn-${item.id}`), history = container.querySelector(`#history-${item.id}`), modelSelect = container.querySelector(`#model-${item.id}`), fileInput = container.querySelector(`#file-${item.id}`);
            fileInput.addEventListener('change', (e) => { if(e.target.files.length > 0) { const userDiv = document.createElement('div'); userDiv.className = 'chat-msg user'; userDiv.innerText = `Uploading ${e.target.files[0].name}...`; history.appendChild(userDiv); history.scrollTop = history.scrollHeight; } });
            const sendMsg = () => { const text = input.value.trim(); if(!text) return; const userDiv = document.createElement('div'); userDiv.className = 'chat-msg user'; userDiv.innerText = text; history.appendChild(userDiv); input.value = ''; history.scrollTop = history.scrollHeight; setTimeout(() => { const selectedModel = modelSelect.value === 'llama3' ? 'Llama 3' : 'DeepSeek'; const sysDiv = document.createElement('div'); sysDiv.className = 'chat-msg sys'; sysDiv.innerText = `[${selectedModel}] Processing request... Analysis complete. Market volatility is high.`; history.appendChild(sysDiv); history.scrollTop = history.scrollHeight; }, 800); };
            btn.onclick = sendMsg; input.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });
        }
        function renderCalcContent(item) {
            const container = item.el.querySelector('.content-container'); if(container.querySelector('.calc-layout')) return;
            container.innerHTML = `<div class="calc-layout"><div class="calc-header widget-header">CALC-8000</div><div class="calc-display" id="disp-${item.id}">0</div><div class="calc-keys" id="keys-${item.id}"></div></div>`;
            const display = container.querySelector(`#disp-${item.id}`), keysContainer = container.querySelector(`#keys-${item.id}`);
            const keys = ['7','8','9','/','4','5','6','*','1','2','3','-','C','0','=','+']; let currentExp = '';
            keys.forEach(k => {
                const btn = document.createElement('button'); btn.className = 'calc-key'; btn.innerText = k; if(['/','*','-','+'].includes(k)) btn.classList.add('op'); if(k === '=') btn.classList.add('eq');
                btn.onclick = (e) => { e.stopPropagation(); if(k === 'C') { currentExp = ''; display.innerText = '0'; } else if(k === '=') { try { display.innerText = eval(currentExp) || '0'; currentExp = display.innerText; } catch { display.innerText = 'ERR'; currentExp = ''; } } else { currentExp += k; display.innerText = currentExp; } }; keysContainer.appendChild(btn);
            });
        }
        function renderNoteContent(item) {
            const container = item.el.querySelector('.content-container'); if(container.querySelector('.note-layout')) return;
            container.innerHTML = `<div class="note-layout"><div class="note-header widget-header"><span>NOTES</span></div><div class="note-toolbar"><button class="note-btn" data-cmd="bold"><b>B</b></button><button class="note-btn" data-cmd="italic"><i>I</i></button><select class="note-select" data-cmd="fontSize"><option value="1">Tiny</option><option value="3" selected>Normal</option><option value="5">Large</option><option value="7">Huge</option></select></div><div class="note-content" contenteditable="true"></div></div>`;
            const toolbar = container.querySelector('.note-toolbar'), content = container.querySelector('.note-content');
            toolbar.addEventListener('mousedown', e => e.stopPropagation()); content.addEventListener('mousedown', e => e.stopPropagation());
            toolbar.addEventListener('click', (e) => { if(e.target.classList.contains('note-btn') || e.target.parentElement.classList.contains('note-btn')) { const btn = e.target.classList.contains('note-btn') ? e.target : e.target.parentElement; document.execCommand(btn.dataset.cmd, false, null); content.focus(); }});
            toolbar.querySelector('.note-select').addEventListener('change', (e) => { document.execCommand('fontSize', false, e.target.value); content.focus(); });
        }
        function renderBrowserContent(item, initialUrl = '', title = 'WEB') {
            const container = item.el.querySelector('.content-container'); if(container.querySelector('.browser-layout')) return;
            container.innerHTML = `
                <div class="browser-layout">
                    <div class="browser-header widget-header">
                        <span style="font-weight:bold;">${title}</span>
                        <div class="nav-group">
                            <button class="nav-btn" id="back-${item.id}"> &lt; </button>
                            <button class="nav-btn" id="fwd-${item.id}"> &gt; </button>
                            <button class="nav-btn" id="ref-${item.id}"> ‚Üª </button>
                        </div>
                        <input type="text" class="browser-input" placeholder="https://" id="url-${item.id}" value="${initialUrl}">
                        <button class="browser-btn" id="go-${item.id}">GO</button>
                    </div>
                    <iframe class="browser-frame" id="frame-${item.id}" src="${initialUrl}"></iframe>
                </div>
            `;
            const input = container.querySelector(`#url-${item.id}`), 
                  btn = container.querySelector(`#go-${item.id}`), 
                  frame = container.querySelector(`#frame-${item.id}`),
                  backBtn = container.querySelector(`#back-${item.id}`),
                  fwdBtn = container.querySelector(`#fwd-${item.id}`),
                  refBtn = container.querySelector(`#ref-${item.id}`);
            
            item.history = initialUrl ? [initialUrl] : [];
            item.historyIndex = initialUrl ? 0 : -1;

            const loadUrl = (url) => {
                if(!url) return;
                if(!url.startsWith('http')) url = 'https://' + url;
                frame.src = url;
                input.value = url;
                if(item.history[item.historyIndex] !== url) {
                    item.history = item.history.slice(0, item.historyIndex + 1);
                    item.history.push(url);
                    item.historyIndex++;
                }
            };

            btn.onclick = (e) => { e.stopPropagation(); loadUrl(input.value.trim()); }; 
            input.addEventListener('keypress', (e) => { if(e.key === 'Enter') loadUrl(input.value.trim()); });
            input.addEventListener('mousedown', e => e.stopPropagation());
            
            backBtn.onclick = (e) => { e.stopPropagation(); if(item.historyIndex > 0) { item.historyIndex--; const url = item.history[item.historyIndex]; frame.src = url; input.value = url; } };
            fwdBtn.onclick = (e) => { e.stopPropagation(); if(item.historyIndex < item.history.length - 1) { item.historyIndex++; const url = item.history[item.historyIndex]; frame.src = url; input.value = url; } };
            refBtn.onclick = (e) => { e.stopPropagation(); frame.src = frame.src; };
        }

        function renderStockContent(item) {
            if (!item.stockData) return;
            const container = item.el.querySelector('.content-container'), data = item.stockData;
            let layout = container.querySelector('.stock-layout');
            if (!layout) {
                const isUp = data.change >= 0; const trendClass = isUp ? 'up' : 'down';
                const updateTimeHtml = item.showTime ? `<div class="stock-footer-info" id="time-${item.id}">Last: ${new Date().toLocaleTimeString()}</div>` : '';
                container.innerHTML = `<div class="stock-layout ${trendClass}" id="layout-${item.id}"><div class="stock-header"><span>${data.symbol} ${data.name}</span><span id="change-${item.id}" style="font-size:0.8em">${isUp?'‚ñ≤':'‚ñº'} ${Math.abs(data.change).toFixed(2)}</span></div><div class="stock-price-large ${trendClass}" id="price-${item.id}">${data.price.toFixed(2)}</div><svg class="stock-chart" id="chart-${item.id}" preserveAspectRatio="none" viewBox="0 0 ${item.w} ${item.h*0.4 + 20}"></svg>${updateTimeHtml}</div>`;
                layout = container.querySelector('.stock-layout');
            }
            if (data.isCrypto && !cryptoDataAvailable) {
                const priceEl = container.querySelector(`#price-${item.id}`); if(priceEl) { priceEl.innerText = "Êö´ÊôÇÁÑ°Ë≥áË®ä"; priceEl.style.fontSize = "1.2em"; priceEl.style.color = "var(--text-secondary)"; }
                const changeEl = container.querySelector(`#change-${item.id}`); if(changeEl) changeEl.innerText = "";
                const chartEl = container.querySelector(`#chart-${item.id}`); if(chartEl) chartEl.innerHTML = ""; 
                return;
            }
            const isUp = data.change >= 0, trendClass = isUp ? 'up' : 'down';
            layout.className = `stock-layout ${trendClass}`;
            const priceEl = container.querySelector(`#price-${item.id}`); if(priceEl) { priceEl.className = `stock-price-large ${trendClass}`; priceEl.innerText = data.price.toFixed(2); priceEl.style.fontSize = ""; }
            const changeEl = container.querySelector(`#change-${item.id}`); if(changeEl) changeEl.innerText = `${isUp?'‚ñ≤':'‚ñº'} ${Math.abs(data.change).toFixed(2)}${data.isCrypto?'%':''}`;
            const chartEl = container.querySelector(`#chart-${item.id}`);
            if(chartEl) {
                let chartSVG = '', xAxisLabels = '', displayHistory = data.history;
                if (item.viewMode === 'candle') { const count = item.timeRange === '1W' ? 7 : item.timeRange === '1M' ? 20 : 50; displayHistory = data.history.slice(-count); chartSVG = generateCandleChart(displayHistory, item.w, item.h * 0.4); xAxisLabels = generateXAxis(item.w, item.h * 0.4, item.timeRange); } 
                else { const prices = data.history.map(d => d.close), pathD = generateSparkline(prices, item.w, item.h * 0.4); chartSVG = `<path class="chart-path" d="${pathD}" /><path class="chart-area" d="${pathD} V ${item.h*0.4} H 0 Z" />`; }
                chartEl.innerHTML = chartSVG + xAxisLabels; chartEl.setAttribute('viewBox', `0 0 ${item.w} ${item.h*0.4 + 20}`);
            }
            const timeEl = container.querySelector(`#time-${item.id}`);
            if(timeEl) timeEl.innerText = `Last: ${new Date().toLocaleTimeString()}`; else if(item.showTime) { const footer = document.createElement('div'); footer.className = "stock-footer-info"; footer.id = `time-${item.id}`; footer.innerText = `Last: ${new Date().toLocaleTimeString()}`; layout.appendChild(footer); }
        }

        function generateSparkline(data, w, h) {
            if (!data.length) return ""; const max = Math.max(...data), min = Math.min(...data), range = max - min || 1, stepX = w / (data.length - 1); let d = `M 0 ${h - ((data[0] - min) / range * h)}`; for (let i = 1; i < data.length; i++) d += ` L ${i * stepX} ${h - ((data[i] - min) / range * h)}`; return d;
        }
        function generateCandleChart(history, w, h) {
            if(!history.length) return ""; const max = Math.max(...history.map(d => d.high)), min = Math.min(...history.map(d => d.low)), rangeY = max - min || 1, stepX = w / history.length, candleW = Math.max(1, stepX * 0.6); let svg = '';
            history.forEach((d, i) => { const x = i * stepX + (stepX - candleW)/2, yOpen = h - ((d.open - min) / rangeY * h), yClose = h - ((d.close - min) / rangeY * h), yHigh = h - ((d.high - min) / rangeY * h), yLow = h - ((d.low - min) / rangeY * h), colorClass = d.close >= d.open ? 'up' : 'down'; svg += `<line class="wick ${colorClass}" x1="${x+candleW/2}" y1="${yHigh}" x2="${x+candleW/2}" y2="${yLow}" /><rect class="candle ${colorClass}" x="${x}" y="${Math.min(yOpen, yClose)}" width="${candleW}" height="${Math.max(1, Math.abs(yClose - yOpen))}" />`; }); return svg;
        }
        function generateXAxis(w, h, range) {
            const y = h + 15, now = new Date(); let labels = [];
            if (range === '1W') for(let i=6; i>=0; i-=2) { const d = new Date(now); d.setDate(d.getDate() - i); labels.push((d.getMonth()+1) + '/' + d.getDate()); }
            else if (range === '1M') for(let i=3; i>=0; i--) { const d = new Date(now); d.setDate(d.getDate() - (i * 7)); labels.push((d.getMonth()+1) + '/' + d.getDate()); }
            else for(let i=2; i>=0; i--) { const d = new Date(now); d.setMonth(d.getMonth() - i); labels.push(d.toLocaleString('default', { month: 'short' })); }
            let svg = ''; const step = w / labels.length; labels.forEach((txt, i) => svg += `<text class="axis-text" x="${i * step + step/2}" y="${y}">${txt}</text>`); return svg;
        }
        function setupInteractions(item) {
            const { el } = item, resizeHandle = el.querySelector('.item-resize'), menu = el.querySelector('.context-menu'), trigger = el.querySelector('.menu-trigger');
            el.addEventListener('mousedown', (e) => {
                if(e.target === resizeHandle || e.target === trigger || menu.contains(e.target)) return; 
                if (['INPUT', 'BUTTON', 'SELECT', 'OPTION', 'TEXTAREA'].includes(e.target.tagName) || e.target.isContentEditable) return; 
                if (['news', 'chat', 'calc', 'note', 'browser', 'llama', 'tvnews', 'finance'].includes(item.type) && !e.target.closest('.widget-header')) return;
                if (item.type === 'finance' && !e.target.closest('.finance-header-bar')) return;
                e.preventDefault(); const startX = e.clientX, startY = e.clientY, startLeft = item.x, startTop = item.y; el.style.zIndex = 999;
                function onMove(ev) { const dx = ev.clientX - startX, dy = ev.clientY - startY; let rawX = startLeft + dx, rawY = startTop + dy; const maxW = parseInt(gridCanvas.style.width), maxH = parseInt(gridCanvas.style.height); if(rawX < 0) rawX = 0; if(rawY < 0) rawY = 0; if(rawX + item.w > maxW) rawX = maxW - item.w; if(rawY + item.h > maxH) rawY = maxH - item.h; el.style.left = rawX + 'px'; el.style.top = rawY + 'px'; const snapX = snap(rawX), snapY = snap(rawY); if (checkCollision({ ...item, x: snapX, y: snapY }, item.id)) el.classList.add('collision'); else el.classList.remove('collision'); }
                function onUp(ev) { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); el.style.zIndex = ''; const finalX = snap(parseInt(el.style.left)), finalY = snap(parseInt(el.style.top)); if (checkCollision({ ...item, x: finalX, y: finalY }, item.id)) { el.style.left = item.x + 'px'; el.style.top = item.y + 'px'; } else { item.x = finalX; item.y = finalY; el.style.left = finalX + 'px'; el.style.top = finalY + 'px'; } el.classList.remove('collision'); }
                document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
            });
            resizeHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation(); e.preventDefault(); const startX = e.clientX, startY = e.clientY, startW = item.w, startH = item.h;
                function onResize(ev) { const dx = ev.clientX - startX, dy = ev.clientY - startY; let nw = snap(Math.max(MIN_W, startW + dx)), nh = snap(Math.max(MIN_H, startH + dy)); if (checkCollision({ ...item, w: nw, h: nh }, item.id)) el.classList.add('collision'); else { el.classList.remove('collision'); el.style.width = nw + 'px'; el.style.height = nh + 'px'; item.w = nw; item.h = nh; 
                    if(item.type === 'stock') renderStockContent(item); 
                    if(item.type === 'clock') renderClockContent(item); 
                    if(item.type === 'weather') updateWeatherScale(item);
                    if(item.type === 'quote') updateQuoteScale(item);
                } }
                function onUp() { document.removeEventListener('mousemove', onResize); document.removeEventListener('mouseup', onUp); el.classList.remove('collision'); }
                document.addEventListener('mousemove', onResize); document.addEventListener('mouseup', onUp);
            });
        }
        function snap(v) { return Math.round(v / CELL_SIZE) * CELL_SIZE; }
        function checkCollision(target, ignoreId) { return items.some(i => { if (i.id === ignoreId) return false; return (target.x < i.x + i.w && target.x + target.w > i.x && target.y < i.y + i.h && target.y + target.h > i.y); }); }
        function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : { r: 0, g: 0, b: 0 }; }
        gridResizer.addEventListener('mousedown', (e) => { e.stopPropagation(); const startX = e.clientX, startY = e.clientY, startW = parseInt(getComputedStyle(gridCanvas).width), startH = parseInt(getComputedStyle(gridCanvas).height); function resizeGrid(ev) { const nw = Math.max(600, startW + (ev.clientX - startX)), nh = Math.max(600, startH + (ev.clientY - startY)); gridCanvas.style.width = snap(nw) + 'px'; gridCanvas.style.height = snap(nh) + 'px'; } document.addEventListener('mousemove', resizeGrid); document.addEventListener('mouseup', () => document.removeEventListener('mousemove', resizeGrid), {once:true}); });
    </script>
</body>
</html>
