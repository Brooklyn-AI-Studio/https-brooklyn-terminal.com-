<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>brooklyn-terminal</title>
    <style>
        :root {
            /* 淺色模式變數 (預設) */
            --bg-body: #f0f2f5;
            --bg-panel: #ffffff;
            --text-color: #333333;
            --border-color: #cccccc;
            --grid-line: #e0e0e0;
            --accent-color: #007bff;
            --item-bg: rgba(0, 123, 255, 0.2);
            --item-border: #007bff;
            --handle-color: #0056b3;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* 深色模式變數 */
        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-panel: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444444;
            --grid-line: #333333;
            --accent-color: #bb86fc;
            --item-bg: rgba(187, 134, 252, 0.2);
            --item-border: #bb86fc;
            --handle-color: #9965f4;
            --shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        * {
            box-sizing: border-box;
            user-select: none; /* 防止拖曳時選取文字 */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 頂部導航列 */
        header {
            background-color: var(--bg-panel);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .brand {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        .brand span {
            color: var(--accent-color);
        }

        .theme-toggle {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-body);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            border-color: var(--accent-color);
        }

        /* 主要佈局 */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* 左側工具列 */
        .sidebar {
            width: 250px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 5;
        }

        .tool-title {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 10px;
        }

        /* 工具列中的可拖曳範本 */
        .draggable-template {
            width: 100px;
            height: 100px;
            background-color: var(--item-bg);
            border: 2px dashed var(--item-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            border-radius: 4px;
            transition: transform 0.1s;
        }

        .draggable-template:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        /* 操作區容器 (捲動區) */
        .workspace {
            flex: 1;
            overflow: auto;
            position: relative;
            padding: 40px;
            background-color: var(--bg-body);
        }

        /* 實際的網格畫布 */
        #grid-canvas {
            /* 60格 * 20px = 1200px */
            width: 1200px; 
            height: 1200px;
            background-color: var(--bg-panel);
            position: relative;
            box-shadow: var(--shadow);
            
            /* 網格線繪製 */
            background-image: 
                linear-gradient(to right, var(--grid-line) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-line) 1px, transparent 1px);
            background-size: 20px 20px; /* 每一格的大小 */
            border: 1px solid var(--border-color);
        }

        /* 操作區內的物件 */
        .grid-item {
            position: absolute;
            background-color: var(--item-bg);
            border: 2px solid var(--item-border);
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--accent-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .grid-item:hover {
            z-index: 100; /* 懸停時浮起 */
            box-shadow: 0 8px 12px rgba(0,0,0,0.1);
        }

        /* 調整大小的手把 */
        .resize-handle {
            width: 12px;
            height: 12px;
            background-color: var(--handle-color);
            position: absolute;
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
            border-radius: 50%;
            z-index: 101;
        }

        /* 刪除按鈕 */
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background: red;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .grid-item:hover .delete-btn {
            display: block;
        }

        /* 標示尺寸 */
        .size-label {
            pointer-events: none;
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">brooklyn-<span>terminal</span></div>
        <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()">
            切換深色模式
        </button>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <div>
                <div class="tool-title">基本物件</div>
                <div class="tool-desc" style="font-size: 0.8rem; color: var(--text-color); margin-bottom: 10px;">
                    拖曳此方塊至右側網格
                </div>
                <div class="draggable-template" draggable="true" id="square-template">
                    10x10
                </div>
            </div>
            
            <div style="margin-top: auto; font-size: 0.75rem; opacity: 0.5;">
                Grid Size: 60x60<br>
                Cell Size: 20px
            </div>
        </div>

        <div class="workspace">
            <div id="grid-canvas">
                </div>
        </div>
    </div>

    <script>
        // --- 設定與常數 ---
        const CELL_SIZE = 20; // 每一格的像素大小
        const GRID_ROWS = 60;
        const GRID_COLS = 60;
        
        const gridCanvas = document.getElementById('grid-canvas');
        const squareTemplate = document.getElementById('square-template');
        const themeBtn = document.getElementById('themeBtn');

        // --- 狀態變數 ---
        let draggedElement = null; // 正在從側邊欄拖曳的元素類型
        let activeItem = null;     // 正在操作區移動的物件
        let isResizing = false;
        let startX, startY, startLeft, startTop, startWidth, startHeight;

        // --- 主題切換邏輯 ---
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.removeAttribute('data-theme');
                themeBtn.innerText = '切換深色模式';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeBtn.innerText = '切換淺色模式';
            }
        }

        // --- 輔助函式：網格吸附計算 ---
        function snapToGrid(value) {
            return Math.round(value / CELL_SIZE) * CELL_SIZE;
        }

        // --- 1. 從側邊欄拖曳新增 (HTML5 Drag & Drop) ---
        
        squareTemplate.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('type', 'square-10x10');
            e.dataTransfer.effectAllowed = 'copy';
        });

        gridCanvas.addEventListener('dragover', (e) => {
            e.preventDefault(); // 允許 drop
            e.dataTransfer.dropEffect = 'copy';
        });

        gridCanvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            
            if (type === 'square-10x10') {
                // 計算放置位置 (相對於 gridCanvas)
                const rect = gridCanvas.getBoundingClientRect();
                const rawX = e.clientX - rect.left;
                const rawY = e.clientY - rect.top;

                // 預設生成 10x10 格子 (200px x 200px)
                const width = 10 * CELL_SIZE; 
                const height = 10 * CELL_SIZE;

                // 置中游標放置
                const x = snapToGrid(rawX - width / 2);
                const y = snapToGrid(rawY - height / 2);

                createGridItem(x, y, width, height);
            }
        });

        // --- 2. 建立網格物件 ---
        function createGridItem(x, y, w, h) {
            // 邊界檢查
            if (x < 0) x = 0;
            if (y < 0) y = 0;
            if (x + w > GRID_COLS * CELL_SIZE) x = GRID_COLS * CELL_SIZE - w;
            if (y + h > GRID_ROWS * CELL_SIZE) y = GRID_ROWS * CELL_SIZE - h;

            const item = document.createElement('div');
            item.className = 'grid-item';
            item.style.left = x + 'px';
            item.style.top = y + 'px';
            item.style.width = w + 'px';
            item.style.height = h + 'px';

            // 內容標籤
            const label = document.createElement('span');
            label.className = 'size-label';
            updateLabel(label, w, h);
            item.appendChild(label);

            // 調整大小手把
            const handle = document.createElement('div');
            handle.className = 'resize-handle';
            item.appendChild(handle);

            // 刪除按鈕
            const delBtn = document.createElement('div');
            delBtn.className = 'delete-btn';
            delBtn.innerHTML = '×';
            delBtn.onclick = function(e) {
                e.stopPropagation(); // 防止觸發拖曳
                item.remove();
            };
            item.appendChild(delBtn);

            // --- 事件綁定：移動 ---
            item.addEventListener('mousedown', function(e) {
                // 如果點到的是 resize handle 或 delete btn，不觸發移動
                if (e.target === handle || e.target === delBtn) return;

                e.preventDefault(); // 防止瀏覽器預設拖曳行為
                activeItem = item;
                isResizing = false;

                // 記錄初始狀態
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(item.style.left || 0);
                startTop = parseInt(item.style.top || 0);

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            // --- 事件綁定：縮放 ---
            handle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation(); // 阻止冒泡到 item 的移動事件
                activeItem = item;
                isResizing = true;

                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(item.style.width);
                startHeight = parseInt(item.style.height);

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            gridCanvas.appendChild(item);
        }

        // --- 3. 全域滑鼠移動處理 (移動 & 縮放) ---
        function onMouseMove(e) {
            if (!activeItem) return;

            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            if (isResizing) {
                // --- 處理縮放 ---
                let newWidth = startWidth + dx;
                let newHeight = startHeight + dy;

                // 最小尺寸限制 (例如 1格)
                if (newWidth < CELL_SIZE) newWidth = CELL_SIZE;
                if (newHeight < CELL_SIZE) newHeight = CELL_SIZE;

                // 即時更新視覺 (不吸附，為了流暢感)
                activeItem.style.width = newWidth + 'px';
                activeItem.style.height = newHeight + 'px';
                
                // 更新標籤
                const snappedW = Math.round(newWidth / CELL_SIZE);
                const snappedH = Math.round(newHeight / CELL_SIZE);
                updateLabel(activeItem.querySelector('.size-label'), snappedW * CELL_SIZE, snappedH * CELL_SIZE);

            } else {
                // --- 處理移動 ---
                let newLeft = startLeft + dx;
                let newTop = startTop + dy;

                activeItem.style.left = newLeft + 'px';
                activeItem.style.top = newTop + 'px';
            }
        }

        // --- 4. 全域滑鼠放開處理 (吸附 Grid) ---
        function onMouseUp(e) {
            if (!activeItem) return;

            if (isResizing) {
                // 縮放結束：吸附
                let currentW = parseInt(activeItem.style.width);
                let currentH = parseInt(activeItem.style.height);
                
                let snappedW = snapToGrid(currentW);
                let snappedH = snapToGrid(currentH);

                // 防止縮到 0
                if (snappedW < CELL_SIZE) snappedW = CELL_SIZE;
                if (snappedH < CELL_SIZE) snappedH = CELL_SIZE;

                activeItem.style.width = snappedW + 'px';
                activeItem.style.height = snappedH + 'px';
                updateLabel(activeItem.querySelector('.size-label'), snappedW, snappedH);

            } else {
                // 移動結束：吸附
                let currentLeft = parseInt(activeItem.style.left);
                let currentTop = parseInt(activeItem.style.top);

                let snappedLeft = snapToGrid(currentLeft);
                let snappedTop = snapToGrid(currentTop);

                // 邊界限制 (吸附後)
                const maxLeft = (GRID_COLS * CELL_SIZE) - parseInt(activeItem.style.width);
                const maxTop = (GRID_ROWS * CELL_SIZE) - parseInt(activeItem.style.height);

                if (snappedLeft < 0) snappedLeft = 0;
                if (snappedTop < 0) snappedTop = 0;
                if (snappedLeft > maxLeft) snappedLeft = maxLeft;
                if (snappedTop > maxTop) snappedTop = maxTop;

                activeItem.style.left = snappedLeft + 'px';
                activeItem.style.top = snappedTop + 'px';
            }

            // 清理
            activeItem = null;
            isResizing = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        function updateLabel(element, w, h) {
            const gridW = Math.round(w / CELL_SIZE);
            const gridH = Math.round(h / CELL_SIZE);
            element.innerText = `${gridW}x${gridH}`;
        }

    </script>
</body>
</html>
