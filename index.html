<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5bfc21c8d13e485a9f5fbb44151e7360"}'></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BROOKLYN-TERMINAL // V11.04 02 </title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300ffcc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='4 17 10 11 4 5'%3E%3C/polyline%3E%3Cline x1='12' y1='19' x2='20' y2='19'%3E%3C/line%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #050505;
            --bg-panel: #111111; --grid-bg: #0a0a0a;
            --text-primary: #00ffcc; --text-secondary: #888;
            --border-color: #333; --accent-color: #00ffcc;
            --grid-line: rgba(0, 255, 204, 0.1);
            --grid-line-strong: rgba(0, 255, 204, 0.3);
            --handle-color: #ff0055; --shadow-glow: 0 0 10px rgba(0, 255, 204, 0.3);
            --glass-bg: rgba(17, 17, 17, 0.95);
            --error-color: #ff0033;
            --input-bg: rgba(0,0,0,0.5);
            --input-text: #00ffcc;
            --msg-user-bg: rgba(0, 255, 204, 0.1); --msg-sys-bg: rgba(255, 255, 255, 0.05);
            --btn-bg: rgba(0, 255, 204, 0.1);
            --font-main: 'Rajdhani', 'Orbitron', sans-serif;
            --border-radius: 4px;
        }
        [data-theme="light"] {
            --bg-body: #e8eef2;
            --bg-panel: #ffffff; --grid-bg: #f4f7f9;
            --text-primary: #2c3e50; --text-secondary: #555;
            --border-color: #cbd5e0; --accent-color: #0066cc;
            --grid-line: rgba(0, 0, 0, 0.05);
            --grid-line-strong: rgba(0, 0, 0, 0.1);
            --handle-color: #ff9900; --shadow-glow: none; --glass-bg: rgba(255, 255, 255, 0.98);
            --error-color: #e74c3c;
            --input-bg: #f0f2f5; --input-text: #333333;
            --msg-user-bg: rgba(0, 102, 204, 0.1); --msg-sys-bg: rgba(0, 0, 0, 0.03);
            --btn-bg: rgba(0, 0, 0, 0.05);
        }
        [data-pro="true"] {
            --bg-body: #000000;
            --bg-panel: #1a1a1a; --grid-bg: #000000;
            --text-primary: #ff9800; --text-secondary: #ffcc80;
            --border-color: #ff9800; --accent-color: #ff9800;
            --grid-line: rgba(255, 152, 0, 0.15);
            --grid-line-strong: rgba(255, 152, 0, 0.3);
            --handle-color: #ffffff; --shadow-glow: none; --glass-bg: #000000; 
            --error-color: #ff3333;
            --input-bg: #000000; --input-text: #ff9800;
            --msg-user-bg: #331a00; --msg-sys-bg: #1a1a1a; --btn-bg: #331a00;
            --font-main: 'Consolas', 'Monaco', 'Courier New', monospace;
            --border-radius: 0px;
        }
        * { box-sizing: border-box; user-select: none; font-family: var(--font-main); }
        [data-pro="true"] * { text-transform: uppercase !important; letter-spacing: 0.5px; box-shadow: none !important; }
        [data-pro="true"] .grid-item { border: 1px solid var(--border-color) !important; }
        [data-pro="true"] .sidebar { border-right: 2px solid var(--border-color); }
        [data-pro="true"] header { border-bottom: 2px solid var(--border-color); }
        
        body { margin: 0; padding: 0; background-color: var(--bg-body); color: var(--text-primary); height: 100vh;
            display: flex; flex-direction: column; overflow: hidden; transition: background-color 0.3s, color 0.3s;
        }
        header { height: 60px; background-color: var(--bg-panel); border-bottom: 1px solid var(--border-color); display: flex;
            align-items: center; padding: 0 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.5); z-index: 20; justify-content: space-between;
        }
        .brand { font-family: 'Orbitron', sans-serif; font-weight: 900; letter-spacing: 3px; font-size: 1.5rem;
            text-transform: uppercase; text-shadow: var(--shadow-glow); display: flex; align-items: center; gap: 10px;
        }
        [data-pro="true"] .brand { font-family: var(--font-main); text-shadow: none; }
        .brand span { color: var(--handle-color); }
        .beta-badge { font-size: 0.7rem; background: var(--accent-color); color: #000; padding: 2px 6px;
            border-radius: var(--border-radius); margin-left: 5px; font-weight: bold; letter-spacing: 1px; transform: translateY(-2px); box-shadow: 0 0 5px var(--accent-color);
        }
        .logo-icon { width: 32px; height: 32px; fill: none; stroke: var(--accent-color); stroke-width: 2;
            stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 0 5px var(--accent-color)); }
        .header-right { display: flex; align-items: center; gap: 20px; font-size: 12px; opacity: 0.8; }
        .visitor-count { display: flex; align-items: center; gap: 5px; }
        .visitor-num { font-family: 'Orbitron', monospace; color: var(--accent-color); font-weight: bold; letter-spacing: 1px; }

        .sidebar { width: 300px; min-width: 250px; max-width: 500px; background-color: var(--bg-panel); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: relative; z-index: 10; padding: 20px;
            overflow-y: auto; overflow-x: hidden; transition: width 0.3s ease, min-width 0.3s ease, padding 0.3s ease;
        }
        .sidebar.collapsed { width: 70px; min-width: 70px; padding: 20px 10px; }
        
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-section-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 0; font-size: 0.8rem; color: var(--text-secondary); 
            cursor: pointer; border-bottom: 1px dashed var(--border-color); 
            margin-bottom: 10px; text-transform: uppercase; font-weight: 700; 
            user-select: none; transition: color 0.2s;
        }
        .sidebar-section-header:hover { color: var(--text-primary); }
        .sidebar-section-header .arrow { font-size: 0.7em; transition: transform 0.3s; }
        .sidebar-section.closed .sidebar-content-wrapper { display: none; }
        .sidebar-section.closed .arrow { transform: rotate(-90deg); }

        .sidebar.collapsed .sidebar-section-header { display: none; }
        .sidebar.collapsed .sidebar-content-wrapper { display: block !important; }
        .sidebar.collapsed .sidebar-section { margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .sidebar.collapsed .color-picker-container span, .sidebar.collapsed .sidebar-footer-content label, .sidebar.collapsed .control-btn-group span { display: none; }
        .sidebar.collapsed .tool-item { justify-content: center; padding: 15px 0; }
        .sidebar.collapsed .tool-item span { display: none; }
        .sidebar.collapsed .sidebar-footer-content { justify-content: center; }
        .sidebar.collapsed .sidebar-footer-content::after { content: '⚙'; font-size: 12px; opacity: 0.5; cursor: pointer; }
        .sidebar.collapsed .color-picker-container { width: 100%; justify-content: center; padding: 5px; }
        .sidebar.collapsed .control-btn { padding: 8px 0; }

        .sidebar-toggle-btn { position: absolute; top: 10px; right: 10px; width: 24px; height: 24px;
            border: 1px solid var(--border-color); background: var(--bg-panel); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius); font-size: 12px;
            transition: all 0.2s; z-index: 20; }
        .sidebar-toggle-btn:hover { background: var(--accent-color); color: #000; }
        .sidebar.collapsed .sidebar-toggle-btn { right: 50%; transform: translateX(50%); top: 10px; }
        
        .color-picker-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: var(--input-bg); padding: 5px 10px; border-radius: var(--border-radius); border: 1px solid var(--border-color); width: fit-content;
            transition: all 0.3s; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border-color); }

        .control-btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 20px; }
        .control-btn { background: var(--btn-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px;
            font-family: var(--font-main); font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s; border-radius: var(--border-radius);
        }
        .control-btn:hover { border-color: var(--accent-color); background: rgba(0, 255, 204, 0.2); }
        [data-pro="true"] .control-btn:hover { background: var(--accent-color); color: #000; }
        .control-btn:active { transform: translateY(1px); }

        .tool-item { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px;
            cursor: grab; transition: all 0.2s; display: flex; align-items: center; gap: 15px; white-space: nowrap; border-radius: var(--border-radius);
        }
        .tool-item:hover { border-color: var(--accent-color); box-shadow: var(--shadow-glow); background: rgba(255,255,255,0.08); }
        .tool-preview { width: 30px; height: 30px; border: 2px solid var(--text-primary);
            background: rgba(0, 255, 204, 0.1); flex-shrink: 0; border-radius: var(--border-radius); }
        [data-pro="true"] .tool-preview { background: transparent; border: 1px solid var(--accent-color); }
        .tool-preview.clock-icon { border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border-color: var(--handle-color); }
        [data-pro="true"] .tool-preview.clock-icon { border-radius: 0; border-color: var(--accent-color); }
        .tool-preview.icon-only { display: flex; align-items: center; justify-content: center; font-size: 16px; }
        
        .rec-badge {
            font-size: 0.6em; background-color: var(--accent-color); color: #000; padding: 2px 5px;
            border-radius: 2px; margin-left: 6px; font-weight: 900; vertical-align: middle; letter-spacing: 0; box-shadow: 0 0 5px rgba(0, 255, 204, 0.4);
        }
        [data-pro="true"] .rec-badge { background-color: var(--text-primary); color: #000; box-shadow: none; }

        .sidebar-footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
        .sidebar-footer-content { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0;
            bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        [data-pro="true"] .slider { border-radius: 0; border: 1px solid var(--border-color); }
        .slider:before { position: absolute; content: ""; height: 14px;
            width: 14px; left: 3px; bottom: 3px; background-color: #fff; transition: .4s; border-radius: 50%;
        }
        [data-pro="true"] .slider:before { border-radius: 0; background-color: var(--accent-color); }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        [data-pro="true"] input:checked + .slider { background-color: #000; }

        .main-container { display: flex; flex: 1; height: calc(100vh - 60px); }
        .workspace { flex: 1; background-color: #000; background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 20px 20px; overflow: auto; padding: 50px; position: relative; }
        #grid-canvas { width: 1200px; height: 1200px; background-color: var(--grid-bg); position: relative; background-image: linear-gradient(to right, var(--grid-line) 1px, transparent 1px), linear-gradient(to bottom, var(--grid-line) 1px, transparent 1px);
            background-size: 20px 20px; border: 1px solid var(--accent-color); box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        [data-pro="true"] #grid-canvas { border: 2px solid var(--accent-color); box-shadow: none;
            background-image: linear-gradient(to right, rgba(255,152,0,0.1) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,152,0,0.1) 1px, transparent 1px);
        }
        #grid-canvas::after { content: ''; position: absolute; top: 0; left: 0; right: 0;
            bottom: 0; background-image: linear-gradient(to right, var(--grid-line-strong) 1px, transparent 1px), linear-gradient(to bottom, var(--grid-line-strong) 1px, transparent 1px); background-size: 100px 100px; pointer-events: none;
        }
        .grid-resize-handle { width: 20px; height: 20px; background: var(--accent-color); position: absolute; bottom: -10px;
            right: -10px; cursor: nwse-resize; clip-path: polygon(100% 0, 100% 100%, 0 100%); z-index: 5;
        }

        .grid-item { position: absolute; border: 1px solid rgba(255,255,255,0.3); box-sizing: border-box; display: flex;
            flex-direction: column; backdrop-filter: blur(5px); transition: box-shadow 0.2s, border-color 0.2s; border-radius: var(--border-radius);
        }
        .grid-item:hover { box-shadow: 0 0 20px rgba(255,255,255,0.2); z-index: 100; border-color: var(--accent-color); }
        .grid-item.collision { background-color: rgba(255, 0, 51, 0.2) !important; border-color: var(--error-color) !important;
            box-shadow: 0 0 20px var(--error-color); }
        .content-container { width: 100%; height: 100%; overflow: hidden; position: relative; }

        .clock-layout { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;
            height: 100%; font-family: var(--font-main); font-weight: bold; color: var(--text-primary); pointer-events: none;
        }
        .clock-city { margin-top: 5px; font-size: 0.3em; opacity: 0.7; text-transform: uppercase; }
        .chat-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; }
        .chat-header { padding: 8px; border-bottom: 1px solid var(--border-color); font-weight: bold; font-family: var(--font-main);
            font-size: 0.9em; display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); cursor: move;
        }
        .chat-history { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; user-select: text; }
        .chat-msg { padding: 8px; border-radius: var(--border-radius); font-size: 0.85em; max-width: 85%; word-wrap: break-word; }
        .chat-msg.sys { align-self: flex-start; background: var(--msg-sys-bg); border-left: 2px solid var(--accent-color); color: var(--text-primary); }
        .chat-msg.user { align-self: flex-end; background: var(--msg-user-bg); border-right: 2px solid var(--text-primary); color: #fff; }
        .chat-input-area { padding: 8px; border-top: 1px solid var(--border-color); display: flex; gap: 5px; background: rgba(0,0,0,0.2); }
        .chat-input { flex: 1; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 5px; outline: none; font-family: var(--font-main); border-radius: var(--border-radius); }
        .chat-input:focus { border-color: var(--accent-color); }
        .chat-model-select { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 5px;
            outline: none; font-family: var(--font-main); font-size: 0.8em; margin-right: 5px; cursor: pointer; border-radius: var(--border-radius);
        }
        .chat-model-select:focus { border-color: var(--accent-color); }
        .chat-send-btn { background: var(--accent-color); color: #000; border: none; padding: 0 10px;
            cursor: pointer; font-weight: bold; font-family: var(--font-main); font-size: 0.8em; border-radius: var(--border-radius);
        }
        .chat-send-btn:hover { opacity: 0.8; }
        .chat-upload-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); cursor: pointer;
            padding: 5px 10px; border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center;
        }
        .chat-upload-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .calc-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; }
        .calc-header { padding: 5px 10px; font-size: 0.8em; opacity: 0.7; border-bottom: 1px solid var(--border-color); cursor: move; }
        .calc-display { flex: 1; background: rgba(0,0,0,0.3); color: var(--text-primary); font-family: var(--font-main); font-size: 1.5em; text-align: right; padding: 10px; display: flex; align-items: flex-end; justify-content: flex-end; overflow: hidden; }
        .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; padding: 2px; background: var(--border-color); flex: 2; }
        .calc-key { background: var(--bg-panel); border: none; color: var(--text-primary); font-family: var(--font-main); font-size: 1.2em; cursor: pointer; transition: background 0.1s; border-radius: 0; }
        .calc-key:hover { background: rgba(255,255,255,0.1); }
        .calc-key.op { color: var(--accent-color); font-weight: bold; }
        .calc-key.eq { background: var(--accent-color); color: #000; }
        .note-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; }
        .note-header { padding: 5px 10px; font-size: 0.8em; opacity: 0.7; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.2); cursor: move; display: flex; justify-content: space-between; }
        .note-content { flex: 1; background: transparent; border: none; color: var(--text-primary); padding: 10px;
            font-family: var(--font-main); font-size: 1em; overflow-y: auto; outline: none; white-space: pre-wrap;
        }
        .note-toolbar { display: flex; gap: 5px; padding: 5px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-color); }
        .note-btn { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); cursor: pointer; font-family: var(--font-main); padding: 2px 8px; font-size: 0.8em; border-radius: var(--border-radius); }
        .note-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .note-select { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); font-family: var(--font-main);
            font-size: 0.8em; cursor: pointer; border-radius: var(--border-radius); }
        
        .browser-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; background: #fff; }
        .browser-header { padding: 5px 35px 5px 10px; background: var(--bg-panel); display: flex; gap: 5px; align-items: center; cursor: move; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
        .browser-input { flex: 1; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); padding: 2px 8px; font-family: var(--font-main); border-radius: var(--border-radius); outline: none; }
        .browser-btn { background: var(--accent-color); color: #000; border: none; padding: 2px 10px; cursor: pointer; font-weight: bold; border-radius: var(--border-radius); transition: opacity 0.2s; font-size: 0.8em; }
        .browser-btn:hover { opacity: 0.8; }
        .browser-frame { flex: 1; border: none; width: 100%; background: #fff; }
        .nav-group { display: flex; gap: 2px; margin-right: 5px; }
        .nav-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); padding: 2px 6px; cursor: pointer; font-family: var(--font-main); border-radius: var(--border-radius); font-size: 0.8em; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); }

        .weather-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; color: var(--text-primary); position: relative; 
            background: linear-gradient(135deg, rgba(30,30,30,0.9) 0%, rgba(10,10,10,0.95) 100%); padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #fff; font-size: 12px; }
        .weather-header { padding: 5px 10px; position: absolute; top: 0; left: 0; right: 0; height: 25px; 
            background: rgba(255,255,255,0.05); cursor: move; opacity: 0; transition: opacity 0.2s; z-index: 10;
        }
        .weather-layout:hover .weather-header { opacity: 1; }
        .weather-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8em; margin-top: 0.8em;}
        .weather-top-left { display: flex; align-items: center; gap: 0.5em; }
        .weather-main-icon { font-size: 2.5em; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
        .weather-main-temp { font-size: 3em; font-weight: 300; line-height: 1; }
        .weather-unit { font-size: 1em; opacity: 0.6; margin-left: 0.2em; font-weight: 400; }
        .weather-condition-text { font-size: 1em; opacity: 0.9; text-align: right; margin-top: 0.5em;}
        .weather-middle { margin-bottom: 1.5em; }
        .weather-location-text { font-size: 1em; margin-bottom: 0.4em; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .weather-hl { font-size: 0.8em; opacity: 0.7; }
        .weather-forecast { display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1em; margin-top: auto; }
        .forecast-item { display: flex; flex-direction: column; align-items: center; gap: 0.4em; font-size: 0.8em; }
        .forecast-icon { font-size: 1.2em; }
        .forecast-temp { font-weight: 500; }
        .forecast-day { opacity: 0.7; font-size: 0.9em; }
        .weather-search-container { position: absolute; bottom: 10px; right: 10px; width: 140px; z-index: 10; }
        .weather-search-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 4px 8px; font-size: 0.7em; text-align: right; outline: none;
            transition: all 0.3s; opacity: 0.6; }
        .weather-search-input:focus, .weather-search-input:hover { opacity: 1; border-bottom-color: var(--accent-color); width: 160px; background: rgba(0,0,0,0.5); }
        .weather-search-input::placeholder { color: rgba(255,255,255,0.5); font-style: italic; font-size: 0.9em; }

        .quote-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; padding: 20px; position: relative; justify-content: center; text-align: center; background: linear-gradient(45deg, #1a1a1a, #000); font-size: 12px; }
        .quote-header { position: absolute; top: 0; left: 0; right: 0; padding: 5px 10px; background: rgba(255,255,255,0.05); font-size: 0.8em; cursor: move; display: flex; justify-content: space-between; color: var(--text-secondary); }
        .quote-content { font-size: 1.2em; font-style: italic; margin-bottom: 1em; line-height: 1.4; }
        .quote-author { font-weight: bold; color: var(--accent-color); font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        .quote-refresh { position: absolute; bottom: 10px; right: 10px; cursor: pointer; opacity: 0.5; transition: opacity 0.2s; font-size: 1.5em; z-index: 10; }
        .quote-refresh:hover { opacity: 1; }

        .number-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; padding: 20px; position: relative; align-items: center; justify-content: center; text-align: center; background: #000; border: 1px dashed var(--border-color); }
        .number-header { position: absolute; top: 0; left: 0; right: 0; padding: 5px 10px; background: rgba(255,255,255,0.05); font-size: 0.8em; cursor: move; display: flex; justify-content: space-between; color: var(--text-secondary); }
        .number-val { font-size: 4em; font-weight: 900; color: var(--text-primary); line-height: 1; margin-bottom: 10px; font-family: 'Orbitron', sans-serif; }
        .number-fact { font-size: 0.9em; opacity: 0.8; line-height: 1.4; max-height: 100px; overflow-y: auto; padding: 0 10px; }
        .number-controls { position: absolute; bottom: 10px; display: flex; gap: 5px; width: 80%; }
        .number-input { flex: 1; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 2px 5px; font-size: 0.8em; outline: none; text-align: center; }
        .number-btn { background: var(--btn-bg); border: 1px solid var(--border-color); color: var(--text-primary); cursor: pointer; font-size: 0.8em; padding: 2px 8px; }
        .number-btn:hover { border-color: var(--accent-color); }

        .global-news-layout { display: flex; flex-direction: column; width: 100%; height: 100%; background: #080808; color: #fff; position: relative; padding: 10px; overflow-y: auto; }
        .global-news-header { position: absolute; top: 0; left: 0; right: 0; height: 25px; background: rgba(255,255,255,0.05); cursor: move; opacity: 0; transition: opacity 0.2s; z-index: 10; display: flex; justify-content: space-between; padding: 0 10px; align-items: center; font-size: 0.8em; }
        .global-news-layout:hover .global-news-header { opacity: 1; }
        .news-hero { display: flex; gap: 15px; margin-bottom: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); align-items: stretch; position: relative; }
        .news-hero:hover { border-color: var(--accent-color); transform: translateY(-1px); background: rgba(255,255,255,0.05); }
        .news-hero-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .news-hero-title { font-size: 1.3em; font-weight: bold; margin-bottom: 10px; line-height: 1.2; color: #fff; }
        .news-hero-summary { font-size: 0.85em; color: #aaa; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 10px; }
        .news-hero-meta { font-size: 0.75em; color: var(--accent-color); display: flex; align-items: center; gap: 5px; opacity: 0.8; margin-bottom: 10px; }
        .news-hero-img { width: 35%; border-radius: 6px; object-fit: cover; min-height: 140px; background: #111; }
        .news-source-btn { display: inline-block; background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); font-size: 0.7em; padding: 4px 8px; border-radius: 4px; cursor: pointer; text-decoration: none; font-weight: bold; width: fit-content; margin-top: auto; }
        .news-source-btn:hover { background: var(--accent-color); color: #000; }
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
        .news-grid-card { background: rgba(255,255,255,0.03); border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; display: flex; flex-direction: column; cursor: default; position: relative; }
        .news-grid-card:hover { border-color: var(--accent-color); transform: translateY(-2px); background: rgba(255,255,255,0.05); }
        .news-card-img { width: 100%; height: 110px; object-fit: cover; background: #111; }
        .news-card-content { padding: 10px; flex: 1; display: flex; flex-direction: column; }
        .news-card-title { font-size: 0.85em; font-weight: bold; margin-bottom: 8px; line-height: 1.3; flex: 1; color: #eee; }
        .news-card-meta { font-size: 0.7em; color: #777; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .news-loading { text-align: center; padding: 20px; color: var(--text-secondary); width: 100%; }

        .tv-news-layout { display: flex; flex-direction: column; width: 100%; height: 100%; background: #000; position: relative; }
        .tv-news-header { padding: 5px 10px; font-size: 0.8em; background: var(--bg-panel); border-bottom: 1px solid var(--border-color); color: var(--text-primary); cursor: move; display: flex; justify-content: space-between; }
        .tv-news-container { flex: 1; width: 100%; height: 100%; overflow: hidden; }

        /* Workstation Tools Styles */
        /* Kanban */
        .kanban-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; background: var(--bg-panel); padding: 5px; }
        .kanban-header { padding: 5px 10px; background: var(--bg-panel); border-bottom: 1px solid var(--border-color); font-size: 0.8em; color: var(--text-primary); cursor: move; display: flex; justify-content: space-between; }
        .kanban-board { display: flex; flex: 1; gap: 5px; overflow-x: auto; padding: 10px 0; }
        .kanban-col { flex: 1; min-width: 120px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 4px; display: flex; flex-direction: column; }
        .kanban-col-title { padding: 5px; font-size: 0.8em; font-weight: bold; text-align: center; border-bottom: 1px dashed var(--border-color); color: var(--text-secondary); }
        .kanban-items { flex: 1; padding: 5px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .kanban-card { background: var(--input-bg); padding: 8px; border-radius: 2px; font-size: 0.8em; border-left: 2px solid var(--accent-color); cursor: grab; word-wrap: break-word; position: relative; }
        .kanban-card:active { cursor: grabbing; }
        .kanban-add-btn { background: transparent; border: 1px dashed var(--text-secondary); color: var(--text-secondary); margin: 5px; cursor: pointer; font-size: 0.8em; padding: 2px; }
        .kanban-add-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        
        /* Audio Player */
        .audio-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; background: #000; position: relative; overflow: hidden; }
        .audio-header { position: absolute; top: 0; left: 0; right: 0; padding: 5px 10px; background: rgba(0,0,0,0.8); z-index: 10; font-size: 0.8em; color: var(--text-primary); cursor: move; border-bottom: 1px solid var(--border-color); }
        .audio-visualizer { flex: 1; display: flex; align-items: flex-end; justify-content: center; gap: 2px; padding-bottom: 20px; opacity: 0.5; }
        .audio-bar { width: 10px; background: var(--accent-color); animation: bounce 1s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { height: 10%; } 50% { height: 80%; } }
        .audio-controls { height: 60px; background: #111; border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; gap: 15px; z-index: 10; }
        .audio-btn { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-primary); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .audio-btn:hover { border-color: var(--accent-color); background: rgba(0,255,204,0.1); }
        
        /* Pomodoro */
        .pomo-layout { display: flex; flex-direction: column; width: 100%; height: 100%; cursor: default; background: #080808; align-items: center; justify-content: center; position: relative; }
        .pomo-header { position: absolute; top: 0; left: 0; right: 0; padding: 5px 10px; font-size: 0.8em; color: var(--text-secondary); cursor: move; background: rgba(255,255,255,0.05); }
        .pomo-time { font-size: 3em; font-family: 'Orbitron', monospace; color: var(--accent-color); font-weight: bold; }
        .pomo-status { font-size: 0.8em; color: #fff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .pomo-controls { display: flex; gap: 10px; }
        .pomo-btn { background: var(--btn-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 5px 15px; cursor: pointer; font-family: var(--font-main); font-size: 0.9em; }
        .pomo-btn:hover { border-color: var(--accent-color); background: rgba(0,255,204,0.2); }

        .item-resize { width: 15px; height: 15px; background: transparent; border-right: 2px solid var(--text-primary); border-bottom: 2px solid var(--text-primary); position: absolute; bottom: 2px; right: 2px; cursor: nwse-resize; z-index: 101; }
        .menu-trigger { position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; cursor: pointer; z-index: 102; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--text-secondary); border-radius: 50%; background: rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.2s; }
        .grid-item:hover .menu-trigger { opacity: 1; }
        .menu-trigger:hover { background: var(--accent-color); color: #000; }
        .context-menu { position: absolute; top: 30px; right: 5px; background: var(--bg-panel); border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.8); border-radius: var(--border-radius); z-index: 9999; display: none; min-width: 140px; }
        [data-pro="true"] .context-menu { box-shadow: none; border: 1px solid var(--accent-color); }
        .context-menu.show { display: block; }
        .context-menu-item { padding: 8px 12px; cursor: pointer; font-size: 12px; color: var(--text-primary); border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; }
        .context-menu-item:hover { background: rgba(255,255,255,0.1); }
        [data-pro="true"] .context-menu-item:hover { background: var(--accent-color); color: #000; }
        .context-menu-item:last-child { border-bottom: none; }
        .context-menu-item.danger:hover { background: rgba(255,255,255,0.1); color: var(--error-color); }
        .context-menu-item .submenu { display: none; position: absolute; right: 100%; top: 0; background: var(--bg-panel); border: 1px solid var(--border-color); min-width: 120px; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .context-menu-item:hover .submenu { display: block; }
        .widget-header { cursor: move; }
/* --- 2024 Modern Header Design --- */

/* 1. Logo 區域設計 */
.brand {
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: 'Inter', sans-serif; /* 如果沒有 Inter，會回退到系統字體 */
}

/* Logo 方塊盒子 >_ */
.logo-box {
    width: 42px;
    height: 42px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--accent-color);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--accent-color);
    font-family: 'Consolas', 'Monaco', monospace;
    font-weight: 900;
    font-size: 1.2rem;
    box-shadow: 0 0 10px rgba(0, 255, 204, 0.1);
    transition: all 0.3s;
}
.brand:hover .logo-box {
    background: var(--accent-color);
    color: #000;
    box-shadow: 0 0 15px var(--accent-color);
}

/* 文字區域 */
.brand-text {
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1.1;
}
.brand-title {
    font-family: 'Orbitron', sans-serif;
    font-weight: 900;
    font-size: 1.2rem;
    color: #fff;
    letter-spacing: 1px;
}
.brand-subtitle {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.7rem;
    color: var(--accent-color);
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
}

/* 2. 中間導覽列 (膠囊狀容器) */
.nav-pill-container {
    background: #1a1a1a;
    border: 1px solid #333;
    padding: 4px;
    border-radius: 12px;
    display: flex;
    gap: 2px;
    align-items: center;
    height: 44px;
}

.nav-pill-btn {
    background: transparent;
    border: none;
    color: #888;
    padding: 0 16px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    outline: none;
}

.nav-pill-btn:hover {
    color: #fff;
    background: rgba(255,255,255,0.05);
}

/* 激活狀態 */
.nav-pill-btn.active {
    background: #333; /* 深灰色背景 */
    color: #e0e0e0;    /* 亮白色文字 */
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.nav-icon {
    width: 16px;
    height: 16px;
    fill: currentColor;
    opacity: 0.7;
}
.nav-pill-btn.active .nav-icon {
    opacity: 1;
    fill: var(--accent-color); /* 讓圖示變成青色 */
}
        /* --- Nodex AI 戰情室樣式 --- */
.nodex-container {
    width: 100%;
    height: 100%;
    background: var(--bg-body);
    display: flex;
    overflow: hidden;
}

/* 左側：Agent 列表 */
.nodex-sidebar {
    width: 280px;
    background: var(--bg-panel);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    padding: 20px;
}
.nodex-header {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--accent-color);
    margin-bottom: 20px;
    letter-spacing: 2px;
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 10px;
}
.agent-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border: 1px solid transparent;
    border-radius: 6px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
}
.agent-card:hover, .agent-card.active {
    background: rgba(0, 255, 204, 0.1);
    border-color: var(--accent-color);
}
.agent-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: #000;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5em;
    border: 1px solid var(--border-color);
}
.agent-info { display: flex; flex-direction: column; }
.agent-name { font-weight: bold; color: var(--text-primary); font-size: 0.9em; }
.agent-role { font-size: 0.7em; color: var(--text-secondary); text-transform: uppercase; }

/* 右側：對話區域 */
.nodex-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    background: radial-gradient(circle at center, #111 0%, #000 100%);
}
.nodex-chat-window {
    flex: 1;
    padding: 40px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
    justify-content: center; /* 讓敬請期待置中 */
}

/* 敬請期待的鎖定畫面效果 */
.nodex-lock-screen {
    text-align: center;
    border: 1px solid var(--accent-color);
    padding: 40px;
    border-radius: 10px;
    background: rgba(0,0,0,0.8);
    box-shadow: 0 0 50px rgba(0, 255, 204, 0.1);
    max-width: 600px;
    position: relative;
    overflow: hidden;
}
/* 掃描線動畫 */
.nodex-lock-screen::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 5px;
    background: var(--accent-color);
    opacity: 0.5;
    box-shadow: 0 0 20px var(--accent-color);
    animation: scanline 2s linear infinite;
}
@keyframes scanline { 0% { top: -10%; } 100% { top: 110%; } }

.lock-icon { font-size: 4em; margin-bottom: 20px; opacity: 0.8; }
.lock-title { font-size: 2em; font-family: 'Orbitron'; color: var(--accent-color); margin-bottom: 10px; }
.lock-desc { color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }
.lock-tag { 
    display: inline-block; padding: 5px 10px; 
    background: var(--btn-bg); border: 1px solid var(--accent-color); 
    color: var(--accent-color); font-size: 0.8em; letter-spacing: 1px;
}

/* 模擬輸入框 (禁用狀態) */
.nodex-input-area {
    padding: 20px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-panel);
    opacity: 0.5;
    pointer-events: none; /* 禁止點擊 */
}
.nodex-input-mock {
    width: 100%;
    padding: 15px;
    background: #000;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: #555;
    font-family: monospace;
}

        
        /* --- PulseStreet 動態牆樣式 --- */
.pulse-container {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    background: var(--bg-body);
    display: flex;
    justify-content: center;
    padding: 20px;
    /* 隱藏預設捲軸但保持滾動功能 */
    scrollbar-width: none; 
}
.pulse-container::-webkit-scrollbar { display: none; }

.pulse-layout {
    width: 900px;
    max-width: 95%;
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding-bottom: 50px;
}

/* 1. 頂部限時動態區 (Stories) */
.pulse-stories-wrapper {
    background: var(--bg-panel);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    display: flex;
    gap: 15px;
    overflow-x: auto;
    white-space: nowrap;
    scrollbar-width: none;
}
.pulse-story {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    min-width: 70px;
}
.pulse-story-ring {
    width: 65px; height: 65px;
    border-radius: 50%;
    padding: 3px;
    /* IG 風格漸層邊框 */
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    position: relative;
    transition: transform 0.2s;
}
/* 未讀/已讀 區分 (模擬) */
.pulse-story.seen .pulse-story-ring {
    background: var(--border-color);
}
.pulse-story:hover .pulse-story-ring {
    transform: scale(1.05);
}
.pulse-story-img {
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 3px solid var(--bg-panel); /* 內圈黑邊 */
    background: #222;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
}
.pulse-story-name {
    font-size: 0.75em;
    color: var(--text-primary);
    max-width: 70px;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 2. 發文框 (Create Post) */
.pulse-create {
    background: var(--bg-panel);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    display: flex;
    gap: 10px;
    align-items: center;
}
.pulse-input-dummy {
    flex: 1;
    background: var(--input-bg);
    border-radius: 20px;
    padding: 10px 15px;
    color: var(--text-secondary);
    font-size: 0.9em;
    cursor: text;
    border: 1px solid transparent;
}
.pulse-input-dummy:hover {
    background: rgba(255,255,255,0.05);
    border-color: var(--border-color);
}

/* 3. 貼文卡片 (Feed Post) */
.pulse-post {
    background: var(--bg-panel);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    animation: fadeInUp 0.5s ease;
}
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.pulse-post-header {
    padding: 12px 15px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.pulse-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: #333;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2em;
    border: 1px solid var(--border-color);
}
.pulse-meta { flex: 1; display: flex; flex-direction: column; }
.pulse-name { font-weight: bold; color: var(--text-primary); font-size: 0.95em; }
.pulse-time { font-size: 0.75em; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
.pulse-menu-btn { color: var(--text-secondary); cursor: pointer; }

.pulse-content {
    padding: 5px 15px 15px 15px;
    font-size: 0.95em;
    line-height: 1.5;
    color: #eee;
}
.pulse-content-img {
    width: 100%;
    height: auto;
    display: block;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    background: #000;
}

.pulse-stats {
    padding: 10px 15px;
    font-size: 0.8em;
    color: var(--text-secondary);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    display: flex; justify-content: space-between;
}

.pulse-actions {
    display: flex;
}
.pulse-action-btn {
    flex: 1;
    background: transparent;
    border: none;
    padding: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    font-family: var(--font-main);
    font-weight: bold;
    font-size: 0.9em;
    transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 5px;
}
.pulse-action-btn:hover {
    background: rgba(255,255,255,0.05);
    color: var(--accent-color);
}
        /* --- 新增：訪客數據面板樣式 --- */
.visitor-count {
    cursor: pointer;
    position: relative;
    padding: 5px 10px;
    transition: background 0.3s;
    border-radius: 4px;
}
.visitor-count:hover {
    background: rgba(0, 255, 204, 0.1); /* 微發光背景 */
}

/* 數據詳細面板 (預設隱藏) */
#visitor-stats-panel {
    display: none; /* 預設隱藏 */
    position: absolute;
    top: 50px; /* Header 高度下方 */
    right: 10px;
    width: 280px;
    background: var(--bg-panel);
    border: 1px solid var(--accent-color);
    box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
    z-index: 9999;
    padding: 15px;
    clip-path: polygon(0 0, 100% 0, 100% 90%, 90% 100%, 0 100%); /* 科幻切角 */
    backdrop-filter: blur(10px);
}

/* 面板顯示時的狀態 */
#visitor-stats-panel.active {
    display: block;
    animation: panelSlideIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

@keyframes panelSlideIn {
    from { opacity: 0; transform: translateY(-10px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* 數據網格排版 */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 10px;
}

.stat-item {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.75em;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 2px;
}

.stat-value {
    font-family: 'Orbitron', monospace;
    font-size: 1.1em;
    color: var(--text-primary);
    font-weight: bold;
    text-shadow: 0 0 5px rgba(0, 255, 204, 0.3);
}

.stats-footer {
    border-top: 1px dashed var(--border-color);
    margin-top: 10px;
    padding-top: 5px;
    font-size: 0.7em;
    color: var(--accent-color);
    text-align: right;
    opacity: 0.8;
}
        /* --- 新增：空間切換頁籤樣式 --- */
.nav-tabs {
    display: flex;
    gap: 5px;
    margin-left: 30px;
    height: 100%;
    align-items: center;
}

.nav-tab-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 6px 16px;
    cursor: pointer;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.8rem;
    letter-spacing: 1px;
    transition: all 0.3s;
    /* 科幻切角設計 */
    clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%, 0 35%);
    position: relative;
    overflow: hidden;
}

.nav-tab-btn:hover {
    color: var(--accent-color);
    border-color: var(--accent-color);
    background: rgba(0, 255, 204, 0.05);
}

.nav-tab-btn.active {
    background: var(--accent-color);
    color: #000;
    border-color: var(--accent-color);
    font-weight: bold;
    box-shadow: 0 0 15px rgba(0, 255, 204, 0.3);
}

/* 在 Pro 模式下的樣式微調 */
[data-pro="true"] .nav-tab-btn.active {
    background: var(--text-primary);
}
        /* Tutorial Styles - Showcase Mode */
        #tutorial-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            z-index: 99999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #tutorial-overlay.active { opacity: 1; pointer-events: auto; }
        .tutorial-card {
            width: 550px; max-width: 90%;
            background: rgba(5, 5, 5, 0.95);
            border: 1px solid var(--accent-color);
            border-radius: var(--border-radius);
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.15);
            padding: 30px; text-align: center; position: relative; overflow: hidden;
        }
        .tutorial-slides-container { height: 280px; position: relative; }
        .tutorial-slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .tutorial-slide.active { opacity: 1; }
        
        /* Scene 1: Identity */
        .sys-boot-text {
            font-family: 'Courier New', monospace; color: var(--accent-color);
            text-align: left; font-size: 0.9em; line-height: 1.6; width: 100%; padding: 0 20px;
        }
        .typing-line { overflow: hidden; white-space: nowrap; border-right: 2px solid transparent; width: 0; animation: typing 2s steps(40, end) forwards; }
        .typing-line:nth-child(1) { animation-delay: 0s; }
        .typing-line:nth-child(2) { animation-delay: 1s; }
        .typing-line:nth-child(3) { animation-delay: 2s; color: #fff; font-weight: bold; text-shadow: 0 0 5px #fff; }
        .typing-line:nth-child(4) { animation-delay: 3s; }
        
        @keyframes typing { from { width: 0; border-right-color: var(--accent-color); } to { width: 100%; border-right-color: transparent; } }

        /* Scene 2: Pro Ops */
        .scene-box { position: relative; width: 100%; height: 180px; background: #111; border: 1px dashed #333; border-radius: 4px; overflow: hidden; }
        .scene-sidebar { position: absolute; left: 0; top: 0; width: 60px; height: 100%; background: #080808; border-right: 1px solid #333; display: flex; justify-content: center; padding-top: 20px; }
        .scene-tool { width: 30px; height: 30px; border: 1px solid var(--accent-color); background: rgba(0,255,204,0.1); border-radius: 4px; }
        .scene-cursor {
            position: absolute; width: 15px; height: 15px; background: #fff;
            clip-path: polygon(0 0, 0% 100%, 100% 50%); z-index: 20;
            animation: sceneDrag 4s infinite;
        }
        .scene-window {
            position: absolute; width: 30px; height: 30px; background: rgba(0,255,204,0.2); border: 1px solid var(--accent-color);
            opacity: 0; z-index: 10;
            animation: sceneWindowExpand 4s infinite;
        }
        .scene-chart-content {
            width: 100%; height: 100%; display: none;
            background: linear-gradient(180deg, rgba(0,255,204,0.05) 0%, transparent 100%);
            background-image: repeating-linear-gradient(90deg, transparent 0, transparent 10px, rgba(0,255,204,0.1) 10px, rgba(0,255,204,0.1) 11px);
        }
        .scene-floating-data {
            position: absolute; top: 10px; right: -100px; background: #000; border: 1px solid var(--stock-up); color: var(--stock-up);
            padding: 2px 5px; font-size: 0.7em; border-radius: 2px; font-weight: bold;
            animation: sceneDataFloat 4s infinite;
        }

        @keyframes sceneDrag {
            0% { top: 25px; left: 20px; transform: scale(1); }
            20% { top: 25px; left: 20px; transform: scale(0.8); }
            50% { top: 60px; left: 150px; transform: scale(0.8); }
            70% { top: 60px; left: 150px; transform: scale(1); }
            100% { top: 25px; left: 20px; transform: scale(1); }
        }
        @keyframes sceneWindowExpand {
            0%, 20% { opacity: 0; top: 20px; left: 15px; width: 30px; height: 30px; }
            25% { opacity: 1; }
            50% { top: 60px; left: 150px; width: 30px; height: 30px; }
            60% { top: 40px; left: 100px; width: 200px; height: 120px; background: #000; opacity: 1; }
            90% { top: 40px; left: 100px; width: 200px; height: 120px; opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes sceneDataFloat {
            0%, 60% { opacity: 0; right: 80px; }
            65% { opacity: 1; right: 80px; }
            90% { opacity: 1; right: 80px; }
            100% { opacity: 0; right: 80px; }
        }

        /* Scene 3: Customization */
        .scene-ui-mock {
            width: 200px; height: 120px; border: 2px solid; padding: 10px;
            display: flex; flex-direction: column; gap: 5px; position: relative;
            animation: sceneTheme 6s infinite;
        }
        .scene-ui-bar { height: 8px; width: 60%; background: currentColor; opacity: 0.5; }
        .scene-ui-btn { position: absolute; bottom: 10px; right: 10px; width: 30px; height: 15px; border: 1px solid currentColor; }
        .scene-ui-text { font-size: 0.8em; margin-top: 10px; font-weight: bold; }
        
        @keyframes sceneTheme {
            0%, 30% { color: #00ffcc; border-color: #00ffcc; } /* Default */
            33%, 63% { color: #ff9800; border-color: #ff9800; } /* Pro */
            66%, 100% { color: #b026ff; border-color: #b026ff; } /* Neon */
        }

        .tutorial-title { font-family: 'Orbitron', sans-serif; font-size: 1.4rem; color: #fff; margin-bottom: 5px; letter-spacing: 1px; }
        .tutorial-subtitle { font-size: 0.85rem; color: var(--accent-color); margin-bottom: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
        .tutorial-btn {
            background: var(--accent-color); color: #000; border: none; padding: 12px 40px;
            font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.1rem; letter-spacing: 1px;
            cursor: pointer; margin-top: 20px; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: all 0.2s; text-transform: uppercase;
        }
        .tutorial-btn:hover { background: #fff; box-shadow: 0 0 15px #fff; }
        
        .helper-btn {
            width: 30px; height: 30px; border: 1px solid var(--border-color);
            color: var(--text-secondary); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-weight: bold; font-family: monospace;
            transition: all 0.2s;
        }
        .helper-btn:hover { color: var(--accent-color); border-color: var(--accent-color); background: rgba(0,255,204,0.1); }
        
        /* Slide Indicators */
        .slide-dots { display: flex; gap: 8px; justify-content: center; margin-top: 15px; }
        .dot { width: 8px; height: 8px; background: #333; border-radius: 50%; transition: background 0.3s; }
        .dot.active { background: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); }
/* 新增：滑鼠中鍵拖曳時的游標樣式 */
        .workspace.panning { cursor: grabbing; cursor: -webkit-grabbing; }
        /* ==================== 新增樣式開始 ==================== */
        
        /* 1. 滑鼠中鍵拖曳效果 */
        .workspace.panning { cursor: grabbing; cursor: -webkit-grabbing; }

        /* 2. 圓形與文字標籤 */
        .grid-item.circle { border-radius: 50%; }
        /* 讓圓形內的內容垂直水平置中 */
        .grid-item.circle .content-container { 
            display: flex; align-items: center; justify-content: center; 
        }
        /* 文字標籤樣式 */
        .item-label-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; text-align: center; pointer-events: none; z-index: 5;
            color: var(--text-primary); font-weight: bold; font-size: 1.2em;
            text-shadow: 0 0 5px rgba(0,0,0,0.8); word-wrap: break-word;
        }

        /* 3. 連線系統 (SVG 層) */
        #connections-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; /* 位於物件之下 */
        }
        .connection-line {
            stroke: var(--accent-color); stroke-width: 2px; opacity: 0.6;
            transition: stroke 0.3s; pointer-events: auto; cursor: pointer;
        }
        .connection-line:hover { stroke: #fff; opacity: 1; stroke-width: 4px; }
      /* --- 新增：賽博龐克資訊視窗樣式 --- */
.header-btn-terms {
    margin-right: 15px; /* 與右邊的訪客計數器保持距離 */
    color: var(--accent-color); cursor: pointer; font-size: 11px; font-weight: bold;
    border: 1px solid rgba(0, 255, 204, 0.3); padding: 4px 12px;
    background: rgba(0, 0, 0, 0.3); letter-spacing: 1px;
    transition: all 0.2s; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
    display: flex; align-items: center; gap: 5px; text-transform: uppercase;
}
.header-btn-terms:hover {
    background: var(--accent-color); color: #000;
    box-shadow: 0 0 15px var(--accent-color); text-shadow: none;
}
.header-btn-terms::before { content: 'ℹ'; margin-right: 3px; }

#terms-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(8px);
    z-index: 100000; display: flex; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
#terms-overlay.active { opacity: 1; pointer-events: auto; }

.terms-window {
    width: 550px; max-width: 90%;
    background: #0a0a0a; border: 1px solid var(--accent-color);
    box-shadow: 0 0 30px rgba(0, 255, 204, 0.15), inset 0 0 20px rgba(0, 255, 204, 0.05);
    position: relative; padding: 2px;
    /* 科幻切角造型 */
    clip-path: polygon(0 0, 100% 0, 100% 90%, 95% 100%, 0 100%);
    transform: scale(0.9) translateY(20px); transition: all 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
#terms-overlay.active .terms-window { transform: scale(1) translateY(0); }

.terms-inner {
    /* 掃描線背景紋理 */
    background: repeating-linear-gradient(0deg, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 1px, transparent 1px, transparent 4px),
                linear-gradient(135deg, rgba(10,10,10,1) 0%, rgba(20,20,20,1) 100%);
    padding: 30px; height: 100%; width: 100%;
    border: 1px solid rgba(0, 255, 204, 0.1);
    position: relative; overflow: hidden;
}
/* 裝飾線條 */
.terms-inner::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
    background: var(--accent-color); box-shadow: 0 0 10px var(--accent-color);
}

.terms-header {
    font-family: 'Orbitron', sans-serif; color: #fff;
    font-size: 1.4em; padding-bottom: 15px; margin-bottom: 20px;
    border-bottom: 1px dashed rgba(255,255,255,0.2);
    display: flex; justify-content: space-between; align-items: center;
    text-shadow: 0 0 5px rgba(255,255,255,0.5); letter-spacing: 2px;
}

.terms-content {
    font-family: 'Rajdhani', monospace; font-size: 1.1em; line-height: 1.6; color: #ccc;
}
.terms-content p { margin-bottom: 15px; }

.terms-label {
    color: var(--accent-color); font-weight: bold; font-size: 0.8em;
    letter-spacing: 2px; margin-bottom: 8px; opacity: 0.8; display: block;
    border-left: 3px solid var(--accent-color); padding-left: 10px;
}

.terms-link {
    color: #fff; text-decoration: none; position: relative;
    transition: all 0.2s; border-bottom: 1px dotted var(--accent-color);
}
.terms-link:hover {
    color: var(--accent-color); background: rgba(0, 255, 204, 0.1);
}

.terms-close-btn {
    background: transparent; border: 1px solid var(--error-color); color: var(--error-color);
    padding: 4px 12px; cursor: pointer; font-family: 'Orbitron', sans-serif;
    font-size: 0.7em; transition: all 0.2s; letter-spacing: 1px;
}
.terms-close-btn:hover { background: var(--error-color); color: #000; box-shadow: 0 0 10px var(--error-color); }
        
    </style>
</head>
<body>
    <div id="tutorial-overlay">
        <div class="tutorial-card">
            <div class="tutorial-title">BROOKLYN-TERMINAL</div>
            <div class="tutorial-subtitle">自定義生產力工具</div>
            
            <div class="tutorial-slides-container">
                <div class="tutorial-slide active" id="slide-1">
                    <div class="sys-boot-text">
                        <div class="typing-line">> INITIALIZING SYSTEM...</div>
                        <div class="typing-line">> CHECKING LICENSE...@br00klyn_weirdo</div>
                        <div class="typing-line">> ACCESS: Successfuly</div>
                        <div class="typing-line">> WELCOME, TRADER.</div>
                    </div>
                </div>

                <div class="tutorial-slide" id="slide-2">
                    <div class="scene-box">
                        <div class="scene-sidebar"><div class="scene-tool"></div></div>
                        <div class="scene-window"><div class="scene-chart-content" style="display:block;"></div></div>
                        <div class="scene-floating-data">BTC: +12.5%</div>
                        <div class="scene-cursor"></div>
                    </div>
                    <div style="margin-top:15px; font-size:0.9em; color:#aaa;">DRAG & DROP • LIVE CHARTS • REAL-TIME DATA</div>
                </div>

                <div class="tutorial-slide" id="slide-3">
                    <div style="height:180px; display:flex; align-items:center; justify-content:center;">
                        <div class="scene-ui-mock">
                            <div class="scene-ui-bar"></div>
                            <div class="scene-ui-bar" style="width:40%"></div>
                            <div class="scene-ui-btn"></div>
                            <div class="scene-ui-text">THEME ENGINE</div>
                        </div>
                    </div>
                    <div style="margin-top:15px; font-size:0.9em; color:#aaa;">TOTAL VISUAL CONTROL</div>
                </div>
            </div>

            <div class="slide-dots">
                <div class="dot active"></div><div class="dot"></div><div class="dot"></div>
            </div>

            <button class="tutorial-btn" onclick="closeTutorial()">立即體驗</button>
        </div>
    </div>

    <header>
        <div class="brand">
            <div class="logo-box">&gt;_</div>
            <div class="brand-text">
                <span class="brand-title">BROOKLYN</span>
                <span class="brand-subtitle">TERMINAL</span>
            </div>
        </div>

        <div class="nav-pill-container">
            
            <button class="nav-pill-btn active" id="tab-workspace" onclick="switchSpace('workspace')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h3l-1 1v2h12v-2l-1-1h3c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 13H4V5h16v11z"/></svg>
                Workspace
            </button>

            <button class="nav-pill-btn" id="tab-pulse" onclick="switchSpace('pulse')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                PulseStreet
            </button>

            <button class="nav-pill-btn" id="tab-edu" onclick="switchSpace('edu')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>
                Academy
            </button>

            <button class="nav-pill-btn" id="tab-nodex" onclick="switchSpace('nodex')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12c0 5.52 4.48 10 10 10s10-4.48 10-10c0-5.52-4.48-10-10-10zm0 18c-4.41 0-8-3.59-8-8 0-4.41 3.59-8 8-8s8 3.59 8 8c-4.41 0-8 3.59-8 8zm-5-9c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm10 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/></svg>
                Nodex
            </button>

        </div>

        <div class="header-right">
             <div class="header-btn-terms" onclick="openTerms()">INFO</div>
             <div class="visitor-count" onclick="toggleVisitorStats()" title="Click for Detailed Analytics">
                <span>VISITORS:</span> 
                <span id="hosts_count" class="visitor-num">loading...</span>
                <span style="font-size: 0.8em; opacity: 0.7;">▼</span>
                <div id="visitor-stats-panel">
                    <div style="margin-bottom: 10px; font-weight: bold; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">
                        TRAFFIC ANALYTICS 流量分析
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-label">Today Traffic 本日流量</span><span id="busuanzi_today_pv" class="stat-value">...</span></div>
                        <div class="stat-item"><span class="stat-label">Today Users 本日用戶</span><span id="busuanzi_today_uv" class="stat-value">...</span></div>
                        <div class="stat-item"><span class="stat-label">Total Traffic 總流量</span><span id="hosts_count" class="stat-value">...</span></div>
                        <div class="stat-item"><span class="stat-label">Total Users 總用戶</span><span id="busuanzi_site_uv" class="stat-value">...</span></div>
                        <div class="stat-item"><span class="stat-label">Page Hits 頁面總閱讀量</span><span id="busuanzi_page_pv" class="stat-value">...</span></div>
                        <div class="stat-item"><span class="stat-label">Page Users 頁面總訪</span><span id="busuanzi_page_uv" class="stat-value">...</span></div>
                    </div>
                    <div class="stats-footer">SYSTEM STATUS: MONITORING</div>
                </div>
            </div>
            <div style="font-size: 12px; opacity: 0.7;">SYS.STATUS: ONLINE</div>
        </div>
    </header>
    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle-btn" id="sidebarToggle" title="Collapse/Expand">&lt;</button>
            
            <div class="sidebar-section" id="sec-library">
                <div class="sidebar-section-header" onclick="toggleSection('sec-library')">
                    <span>Library</span><span class="arrow">▼</span>
                </div>
                <div class="sidebar-content-wrapper">
                      <div class="tool-item" draggable="true" id="tool-square"><div class="tool-preview" style="background-color: rgba(0,123,255,0.3);"></div><span>Module 10x10</span></div>
                      <div class="tool-item" draggable="true" id="tool-circle"><div class="tool-preview" style="background-color: rgba(255, 0, 85, 0.3); border-radius: 50%;"></div><span>Circle Node</span></div>
                      <div class="tool-item" draggable="true" id="tool-line">
                      <div class="tool-preview icon-only">✏️</div>
                      <span>Connect Line</span>
                </div>
            </div></div>

            <div class="sidebar-section" id="sec-tools">
                <div class="sidebar-section-header" onclick="toggleSection('sec-tools')">
                    <span>Tools</span><span class="arrow">▼</span>
                </div>
                <div class="sidebar-content-wrapper">
                    <div class="tool-item" draggable="true" id="tool-tvchart"><div class="tool-preview icon-only">📈</div><span>Advanced Chart <span class="rec-badge">推薦</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-ticker-tape"><div class="tool-preview icon-only">🎞️</div><span>Ticker Tape <span class="rec-badge">推薦</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-heatmap-stock"><div class="tool-preview icon-only">🇺🇸</div><span>Stock Heatmap  <span class="rec-badge">推薦</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-heatmap-crypto"><div class="tool-preview icon-only">🪙</div><span>Crypto Map <span class="rec-badge">推薦</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-heatmap-etf"><div class="tool-preview icon-only">🇹🇼</div><span>ETF Heatmap<span class="rec-badge">推薦</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-tv-news"><div class="tool-preview icon-only">📰</div><span>Top Stories <span class="rec-badge">推薦</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-tv-eco"><div class="tool-preview icon-only">📅</div><span>Eco Calendar <span class="rec-badge">推薦</span></span></div>
                    
                    <div class="tool-item" draggable="true" id="tool-kanban"><div class="tool-preview icon-only">📋</div><span>Ops Board <span class="rec-badge">新</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-audio"><div class="tool-preview icon-only">🎧</div><span>Neural Audio <span class="rec-badge">新</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-pomodoro"><div class="tool-preview icon-only">⏱️</div><span>Chrono Sync <span class="rec-badge">新</span></span></div>

                    <div class="tool-item" draggable="true" id="tool-llama"><div class="tool-preview icon-only">🦙</div><span>Llama Online <span class="rec-badge">推薦</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-browser"><div class="tool-preview icon-only">🌐</div><span>Web Portal <span class="rec-badge">推薦</span></span></div>
                    <div class="tool-item" draggable="true" id="tool-youtube"> <div class="tool-preview icon-only">📺</div> <span>YouTube Player</span></div>

                    <div class="tool-item" draggable="true" id="tool-tvnews"><div class="tool-preview icon-only">🌐</div><span>Global News </span></div>
                    <div class="tool-item" draggable="true" id="tool-clock"><div class="tool-preview clock-icon">🕓</div><span>Digital Clock </span></div>
                    <div class="tool-item" draggable="true" id="tool-weather"><div class="tool-preview icon-only">☁️</div><span>Weather Station </span></div>
                    <div class="tool-item" draggable="true" id="tool-quote"><div class="tool-preview icon-only">❝</div><span>Daily Insight </span></div>
                    <div class="tool-item" draggable="true" id="tool-number"><div class="tool-preview icon-only">#</div><span>Data Fact </span></div>
                    <div class="tool-item" draggable="true" id="tool-chat"><div class="tool-preview icon-only">🤖</div><span>LLM Chat </span></div>
                    <div class="tool-item" draggable="true" id="tool-calc"><div class="tool-preview icon-only">🧮</div><span>Calculator </span></div>
                    <div class="tool-item" draggable="true" id="tool-note"><div class="tool-preview icon-only">📝</div><span>Notes </span></div>
                </div>
            </div> <div style="margin-top: auto;"></div>

            <div class="sidebar-section" id="sec-controls">
                 <div class="sidebar-section-header" onclick="toggleSection('sec-controls')">
                    <span>Controls</span><span class="arrow">▼</span>
                </div>
                 <div class="sidebar-content-wrapper">
                    <div class="control-btn-group">
                        <button class="control-btn" onclick="saveLayout()">💾 SAVE</button>
                        <button class="control-btn" onclick="loadLayout()">📂 LOAD</button>
                        <button class="control-btn" onclick="clearGrid()">🗑️ CLEAR</button>
                    </div>
                    <div class="color-picker-container"><input type="color" id="colorPicker" value="#007bff"><span id="colorValue" style="font-size: 12px; opacity: 0.8;">#007bff</span></div>
                 </div> 
            </div> <div class="sidebar-footer">
                <div class="sidebar-footer-content">
                    <span id="mode-label">MODE: DARK</span>
                    <label class="switch"><input type="checkbox" id="themeSwitch"><span class="slider"></span></label>
                </div>
                <div class="sidebar-footer-content">
                    <span>PRO MODE</span>
                    <label class="switch"><input type="checkbox" id="proSwitch"><span class="slider"></span></label>
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top:5px;">
                    <div class="helper-btn" onclick="showTutorial()" title="System Briefing">?</div>
                </div>
            </div>
        </div>
       <div class="workspace">
            <div id="grid-canvas">
                <svg id="connections-layer"></svg>
                <div class="grid-resize-handle" id="gridResizer"></div>
            </div>
        </div>
    <script>
        const CELL_SIZE = 20, MIN_W = CELL_SIZE * 4, MIN_H = CELL_SIZE * 4;
        const gridCanvas = document.getElementById('grid-canvas'), colorPicker = document.getElementById('colorPicker'), colorValue = document.getElementById('colorValue');
        const themeSwitch = document.getElementById('themeSwitch'), proSwitch = document.getElementById('proSwitch'), modeLabel = document.getElementById('mode-label');
        const gridResizer = document.getElementById('gridResizer');
        const sidebar = document.getElementById('sidebar'), sidebarToggle = document.getElementById('sidebarToggle');
        // 1. 新增全域變數
        const svgLayer = document.getElementById('connections-layer');
        const workspace = document.querySelector('.workspace');
        let connections = []; // 儲存連線資料
        let connectMode = false; // 是否正在連線模式
        let connectSource = null; // 連線起點 ID
        let currentSpace = 'workspace';

        // 2. 加入新工具的 Drag 監聽 (請加在原有的 tool-square 監聽器下方)
        document.getElementById('tool-circle').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'circle'));
        document.getElementById('tool-line').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'line_tool'));
        // --- Middle Mouse Pan Logic (新增功能：滑鼠中鍵拖曳畫布) ---
        
        let isPanning = false;
        let startX, startY, scrollLeft, scrollTop;

        workspace.addEventListener('mousedown', (e) => {
            // e.button === 1 代表滑鼠中鍵 (滾輪點擊)
            if (e.button === 1) {
                e.preventDefault(); // 防止瀏覽器預設的自動捲動圖示出現
                isPanning = true;
                workspace.classList.add('panning');
                
                // 記錄初始位置與目前的捲軸位置
                startX = e.pageX - workspace.offsetLeft;
                startY = e.pageY - workspace.offsetTop;
                scrollLeft = workspace.scrollLeft;
                scrollTop = workspace.scrollTop;
            }
        });

        workspace.addEventListener('mouseleave', () => {
            isPanning = false;
            workspace.classList.remove('panning');
        });

        workspace.addEventListener('mouseup', () => {
            isPanning = false;
            workspace.classList.remove('panning');
        });

        workspace.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            e.preventDefault();
            
            // 計算滑鼠移動的距離
            const x = e.pageX - workspace.offsetLeft;
            const y = e.pageY - workspace.offsetTop;
            const walkX = (x - startX); // 這裡可以乘上倍率來加速捲動，例如 (x - startX) * 2
            const walkY = (y - startY);
            
            // 更新捲軸位置 (反向移動實現拖曳效果)
            workspace.scrollLeft = scrollLeft - walkX;
            workspace.scrollTop = scrollTop - walkY;
        });
        // -------------------------------------------------------
        let items = [], activeColor = '#007bff';
        let isSidebarCollapsed = false;
        
        // Tutorial Logic V10.5
        let currentSlide = 0;
        let slideInterval;
        const slides = document.querySelectorAll('.tutorial-slide');
        const dots = document.querySelectorAll('.dot');

        function showTutorial() {
            document.getElementById('tutorial-overlay').classList.add('active');
            resetSlides();
            startSlideShow();
        }
        function closeTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('active');
            stopSlideShow();
        }
        function resetSlides() {
            currentSlide = 0;
            updateSlideClasses();
        }
        function updateSlideClasses() {
            slides.forEach((s, i) => {
                s.classList.toggle('active', i === currentSlide);
            });
            dots.forEach((d, i) => {
                d.classList.toggle('active', i === currentSlide);
            });
        }
        function nextSlide() {
            currentSlide = (currentSlide + 1) % slides.length;
            updateSlideClasses();
        }
        function startSlideShow() {
            stopSlideShow(); 
            slideInterval = setInterval(nextSlide, 4000);
        }
        function stopSlideShow() {
            if(slideInterval) clearInterval(slideInterval);
        }

        // Auto-show tutorial on first load
        window.onload = function() {
            setTimeout(showTutorial, 500);
        };
        // --- 新增：切換空間功能 ---
       // --- 更新後的切換空間邏輯 (含 Nodex) ---
        window.switchSpace = function(spaceMode) {
            if (currentSpace === spaceMode) return;
            currentSpace = spaceMode;

            // 1. 更新按鈕 UI
            //document.querySelectorAll('.nav-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-pill-btn').forEach(btn => btn.classList.remove('active'));
            const targetBtn = document.getElementById(`tab-${spaceMode}`);
            if(targetBtn) targetBtn.classList.add('active');

            // 2. 清理畫面
            clearGrid(); 
            // 移除所有特殊模式的容器 (Pulse & Nodex)
            document.querySelectorAll('.pulse-container, .nodex-container').forEach(el => el.remove());
            
            const gridCanvas = document.getElementById('grid-canvas');

            // 3. 路由判斷
            if (spaceMode === 'pulse') {
                if(gridCanvas) gridCanvas.style.display = 'none';
                renderPulseStreet();
            } else if (spaceMode === 'nodex') {
                // Nodex 模式：隱藏網格，渲染 AI 戰情室
                if(gridCanvas) gridCanvas.style.display = 'none';
                renderNodex();
            } else {
                // Workspace/Edu 模式
                if(gridCanvas) gridCanvas.style.display = 'block';
                loadLayout(true);
            }
        }
// --- Nodex 渲染核心 ---
        function renderNodex() {
            const workspace = document.querySelector('.workspace');
            
            const container = document.createElement('div');
            container.className = 'nodex-container';
            
            container.innerHTML = `
                <div class="nodex-sidebar">
                    <div class="nodex-header">探索 Nodex </div>
                    
                    <div class="agent-card active">
                        <div class="agent-avatar">📈</div>
                        <div class="agent-info">
                            <div class="agent-name">Stock Analyst 股市分析師</div>
                            <div class="agent-role">提供專業的股市情報。</div>
                        </div>
                    </div>
                    
                    <div class="agent-card">
                        <div class="agent-avatar">🔍</div>
                        <div class="agent-info">
                            <div class="agent-name">Data Scientist 資料科學家</div>
                            <div class="agent-role">為您提供的資料找出Insight.</div>
                        </div>
                    </div>

                    <div class="agent-card" style="opacity:0.5;">
                        <div class="agent-avatar">💻</div>
                        <div class="agent-info">
                            <div class="agent-name">DeepSeek Coder</div>
                            <div class="agent-role">Let the Code Write Itself.</div>
                        </div>
                    </div>
                </div>

                <div class="nodex-main">
                    <div class="nodex-chat-window">
                        
                        <div class="nodex-lock-screen">
                            <div class="lock-icon">🚧</div>
                            <div class="lock-title">開發中，敬請期待。</div>
                            <div class="lock-desc">
                                <strong>Nodex</strong> 是brooklyn-terminal的大語言模型(LLM)互動環境，透過專業訓練集微調，為使用者提供強大的AI工具。<br><br>
                                您可以在Workspace -> 工作列表 -> Tools 中 找到LLama online獲得暫時性語言模型服務 (每日限制50對話次數)。
                            </div>
                            <div class="lock-tag">敬請期待</div>
                        </div>

                    </div>

                    <div class="nodex-input-area">
                        <div class="nodex-input-mock">System Offline. Waiting for module update...</div>
                    </div>
                </div>
            `;
            
            workspace.appendChild(container);
        }
        // --- 新增：PulseStreet 渲染核心函式 ---
        function renderPulseStreet() {
            const workspace = document.querySelector('.workspace');
            
            // 建立主容器
            const container = document.createElement('div');
            container.className = 'pulse-container';
            
            // 模擬資料：限時動態 (Stories)
            const stories = [
                { name: "Your Story", icon: "＋", seen: false },
                { name: "伊龍馬", icon: "🚀", seen: false },
                { name: "全都是泡沫", icon: "🔶", seen: false },
                { name: "uni-tech", icon: "🦄", seen: false },
                { name: "泡泡博士", icon: "₿", seen: true },
                { name: "韭菜新手", icon: "🏦", seen: true },
                { name: "當沖機器", icon: "🤖", seen: false },
            ];

            // 生成 Stories 的 HTML
            let storiesHTML = stories.map(s => `
                <div class="pulse-story ${s.seen ? 'seen' : ''}">
                    <div class="pulse-story-ring">
                        <div class="pulse-story-img">${s.icon}</div>
                    </div>
                    <div class="pulse-story-name">${s.name}</div>
                </div>
            `).join('');

            // 模擬資料：貼文 (Feed)
            const posts = [
                {
                    name: "Brooklyn", time: "2h ago • 公開",
                    avatar: "Ⓜ️",
                    content: "PulseStreet是brooklyn-terminal系統的動態社群，您可以在這裡找到股市同好、工作夥伴，以及大語言模型愛好者! 你工作無聊的閒暇時間，或許能在這裡獲得精神娛樂連結。 功能開發中，敬啟期待。 #LLM #BTC #Crypto",
                    image: null, // 純文字貼文
                    likes: "1.2k", comments: "342"
                },
                {
                    name: "Tech-Weirdo", time: "4h ago • 公開",
                    avatar: "🚇",
                    content: "Breaking: New quantum chip prototype demonstrates 1000x efficiency gain. The AI race is just getting started.",
                    image: "https://images.unsplash.com/photo-1635070041078-e363dbe005cb?auto=format&fit=crop&w=800&q=80", 
                    likes: "8.5k", comments: "1.2k"
                },
                {
                    name: "System Bot", time: "Just now • 系統公告",
                    avatar: "⚙️",
                    content: "System maintenance scheduled for 03:00 UTC. Please save your workspace configurations.",
                    image: null,
                    likes: "1984", comments: "0"
                }
            ];

            // 生成 Posts 的 HTML
            let postsHTML = posts.map(p => `
                <div class="pulse-post">
                    <div class="pulse-post-header">
                        <div class="pulse-avatar">${p.avatar}</div>
                        <div class="pulse-meta">
                            <div class="pulse-name">${p.name}</div>
                            <div class="pulse-time">${p.time}</div>
                        </div>
                        <div class="pulse-menu-btn">•••</div>
                    </div>
                    <div class="pulse-content">
                        ${p.content}
                    </div>
                    ${p.image ? `<img src="${p.image}" class="pulse-content-img" loading="lazy">` : ''}
                    <div class="pulse-stats">
                        <span>👍 ${p.likes} Likes</span>
                        <span>${p.comments} Comments</span>
                    </div>
                    <div class="pulse-actions">
                        <button class="pulse-action-btn"><span>👍</span> Like</button>
                        <button class="pulse-action-btn"><span>💬</span> Comment</button>
                        <button class="pulse-action-btn"><span>↗</span> Share</button>
                    </div>
                </div>
            `).join('');

            // 組合最終 HTML 結構
            container.innerHTML = `
                <div class="pulse-layout">
                    <div class="pulse-stories-wrapper">
                        ${storiesHTML}
                    </div>
                    
                    <div class="pulse-create">
                        <div class="pulse-avatar">Ⓜ️</div>
                        <div class="pulse-input-dummy">聊聊你對AMD暴漲有什麼看法?</div>
                    </div>

                    <div class="pulse-feed">
                        ${postsHTML}
                        <div style="text-align:center; padding:20px; opacity:0.5; font-size:0.8em;">
                            — 已經到底了 —
                        </div>
                    </div>
                </div>
            `;

            // 將動態牆插入到 workspace 區域
            workspace.appendChild(container);
        }

        // 輔助：清空連線 (原本的 clearGrid 只有清空 items，沒有清空 SVG 連線)
        function clearAllConnections() {
            const layer = document.getElementById('connections-layer');
            while (layer.firstChild) {
                layer.removeChild(layer.firstChild);
            }
            connections = [];
        }

        // Toggle Section Logic
        window.toggleSection = function(id) {
            const sec = document.getElementById(id);
            if(sec) sec.classList.toggle('closed');
        }

        sidebarToggle.addEventListener('click', () => { isSidebarCollapsed = !isSidebarCollapsed; if (isSidebarCollapsed) { sidebar.classList.add('collapsed'); sidebarToggle.innerHTML = '&gt;'; } else { sidebar.classList.remove('collapsed'); sidebarToggle.innerHTML = '&lt;'; }});
        themeSwitch.addEventListener('change', (e) => { if (e.target.checked) { document.documentElement.setAttribute('data-theme', 'light'); modeLabel.innerText = "MODE: LIGHT"; } else { document.documentElement.removeAttribute('data-theme'); modeLabel.innerText = "MODE: DARK"; }});
        proSwitch.addEventListener('change', (e) => { if (e.target.checked) document.documentElement.setAttribute('data-pro', 'true'); else document.documentElement.removeAttribute('data-pro'); });
        colorPicker.addEventListener('input', (e) => { activeColor = e.target.value; colorValue.innerText = activeColor; document.querySelector('.tool-preview').style.backgroundColor = activeColor + '4D'; document.querySelector('.tool-preview').style.borderColor = activeColor; });
        // 修改後的 saveLayout
        function saveLayout() {
            const layoutData = items.map(i => {
                const el = document.getElementById(i.id);
                let noteContent = ''; if(i.type === 'note') { const contentDiv = el.querySelector('.note-content'); if(contentDiv) noteContent = contentDiv.innerHTML; }
                let webUrl = ''; if (i.type === 'browser' || i.type === 'llama') { const iframe = el.querySelector('.browser-frame'); if (iframe) webUrl = iframe.src; }
                let weatherCity = ''; if(i.type === 'weather') weatherCity = i.cityLabel;
                // 加入 label 儲存
                return { 
                    type: i.type, x: i.x, y: i.y, w: i.w, h: i.h, 
                    timeZone: i.timeZone, cityLabel: i.cityLabel, 
                    noteContent: noteContent, webUrl: webUrl, weatherCity: weatherCity,
                    label: i.label, // 確保名稱也被儲存
                    color: i.el.style.borderColor // 確保顏色被儲存
                };
            });
            
            // ★ 重點：儲存連線資訊
            const linesData = connections.map(c => ({ s: c.s, t: c.t }));

            // ★ 重點：根據 currentSpace 決定存到哪個 Key
            const storageKey = currentSpace === 'edu' ? 'brooklyn_layout_v11_edu' : 'brooklyn_layout_v11_workspace';
            
            const savePackage = {
                items: layoutData,
                lines: linesData
            };

            localStorage.setItem(storageKey, JSON.stringify(savePackage)); 
            alert(`Layout Saved to [ ${currentSpace.toUpperCase()} ] !`);
        }

        // 修改後的 loadLayout
        function loadLayout(isSilent = false) {
            // ★ 重點：根據 currentSpace 決定讀取哪個 Key
            const storageKey = currentSpace === 'edu' ? 'brooklyn_layout_v11_edu' : 'brooklyn_layout_v11_workspace';
            
            const saved = localStorage.getItem(storageKey);
            
            if(!saved) { 
                if(!isSilent) alert(`No saved layout found for ${currentSpace.toUpperCase()}.`); 
                return; 
            }
            
            clearGrid(); // 先清空
            
            // 相容舊版資料 (舊版直接存陣列，新版存 {items, lines})
            let data = JSON.parse(saved);
            let layoutData = [];
            let linesData = [];

            if (Array.isArray(data)) {
                layoutData = data; // 舊版格式
            } else {
                layoutData = data.items || [];
                linesData = data.lines || [];
            }

            layoutData.forEach(data => {
                // 讀取顏色，若無則預設
                let color = data.color || '#007bff'; 
                if(['clock','news','chat','calc','note','browser','llama','weather','quote','number','tvnews','tvchart','tv-news','tv-eco','heatmap-stock','heatmap-crypto','heatmap-etf','ticker-tape','kanban','audio','pomodoro'].includes(data.type)) color = '#ffffff';
                
                const newItem = createItem(data.x, data.y, data.w, data.h, color, data.type);
                
                // 還原 Label
                if(data.label) {
                    newItem.obj.label = data.label;
                    const lbl = document.getElementById(`lbl-${newItem.obj.id}`);
                    if(lbl) lbl.innerText = data.label;
                }

                // ... (原有的 switch case 邏輯保持不變，照抄原本的即可) ...
                if (data.type === 'clock') { newItem.obj.timeZone = data.timeZone; newItem.obj.cityLabel = data.cityLabel; renderClockContent(newItem.obj); } 
                else if (data.type === 'note') { const el = document.getElementById(newItem.obj.id); const contentDiv = el.querySelector('.note-content'); if(contentDiv && data.noteContent) contentDiv.innerHTML = data.noteContent; } 
                else if ((data.type === 'browser' || data.type === 'llama') && data.webUrl) { const el = document.getElementById(newItem.obj.id); const iframe = el.querySelector('.browser-frame'); const input = el.querySelector('.browser-input'); if (iframe && input) { iframe.src = data.webUrl; input.value = data.webUrl; } }
                else if (data.type === 'weather') { newItem.obj.cityLabel = data.weatherCity || 'Taipei'; renderWeatherContent(newItem.obj); }
                else if (data.type === 'quote') renderQuoteContent(newItem.obj);
                else if (data.type === 'number') renderNumberContent(newItem.obj);
                else if (data.type === 'tvnews') renderGlobalNewsContent(newItem.obj);
                else if (data.type === 'tvchart') renderTradingViewContent(newItem.obj);
                else if (data.type === 'tv-news') renderTVNewsContent(newItem.obj);
                else if (data.type === 'tv-eco') renderTVEcoContent(newItem.obj);
                else if (data.type === 'heatmap-stock') renderStockHeatmap(newItem.obj);
                else if (data.type === 'heatmap-crypto') renderCryptoHeatmap(newItem.obj);
                else if (data.type === 'heatmap-etf') renderETFHeatmap(newItem.obj);
                else if (data.type === 'ticker-tape') renderTickerTapeContent(newItem.obj);
                else if (data.type === 'kanban') renderKanbanContent(newItem.obj);
                else if (data.type === 'audio') renderAudioContent(newItem.obj);
                else if (data.type === 'youtube') renderYouTubeContent(newItem.obj);
                else if (data.type === 'pomodoro') renderPomodoroContent(newItem.obj);
            });

            // ★ 還原連線
            if (linesData && linesData.length > 0) {
                 // 稍微延遲一下確保 DOM 建立完成
                 setTimeout(() => {
                     linesData.forEach(l => {
                         // 確保兩端物件都存在
                         if (items.find(i => i.id === l.s) && items.find(i => i.id === l.t)) {
                             createConnection(l.s, l.t);
                         }
                     });
                 }, 50);
            }
        }

        // 修改後的 clearGrid (確保連線也被清除)
        function clearGrid() { 
            items.forEach(i => { const el = document.getElementById(i.id); if(el) el.remove(); });
            items = []; 
            clearAllConnections(); // 呼叫上方定義的清空連線函式
        }
        /* --- 新增：使用條款視窗控制 --- */
function openTerms() {
    document.getElementById('terms-overlay').classList.add('active');
}

// --- 新增：訪客面板控制與腳本引入 ---

// 1. 面板開關功能
function toggleVisitorStats() {
    const panel = document.getElementById('visitor-stats-panel');
    panel.classList.toggle('active');
}

// 2. 點擊其他地方時關閉面板
document.addEventListener('click', function(e) {
    const container = document.querySelector('.visitor-count');
    const panel = document.getElementById('visitor-stats-panel');
    // 如果點擊的不是 visitor-count 本身或其子元素，就關閉面板
    if (!container.contains(e.target)) {
        panel.classList.remove('active');
    }
});

// 3. 解決 ID 重複問題 (同步 Header 與 面板內的總瀏覽量)
// 不蒜子腳本載入後，會自動填入 busuanzi_value_site_pv
// 我們設一個定時器，把 Header 的值同步到面板內的 ..._detail
setInterval(() => {
    const mainVal = document.getElementById('busuanzi_value_site_pv').innerText;
    const detailEl = document.getElementById('busuanzi_value_site_pv_detail');
    if(mainVal && mainVal !== 'loading...' && detailEl) {
        detailEl.innerText = mainVal;
    }
}, 1000);
















        
function closeTerms(e) {
    // 點擊背景遮罩或關閉按鈕時關閉視窗
    if (!e || e.target.id === 'terms-overlay' || e.target.classList.contains('terms-close-btn')) {
        document.getElementById('terms-overlay').classList.remove('active');
    }
}

       /* function loadLayout() {
            const saved = localStorage.getItem('brooklyn_layout_v11');
            if(!saved) { alert('No saved layout found.'); return; }
            clearGrid();
            const layoutData = JSON.parse(saved);
            layoutData.forEach(data => {
                let color = '#007bff'; if(['clock','news','chat','calc','note','browser','llama','weather','quote','number','tvnews','tvchart','tv-news','tv-eco','heatmap-stock','heatmap-crypto','heatmap-etf','ticker-tape','kanban','audio','pomodoro'].includes(data.type)) color = '#ffffff';
                const newItem = createItem(data.x, data.y, data.w, data.h, color, data.type);
                if (data.type === 'clock') { newItem.obj.timeZone = data.timeZone; newItem.obj.cityLabel = data.cityLabel; renderClockContent(newItem.obj); } 
                else if (data.type === 'note') { const el = document.getElementById(newItem.obj.id); const contentDiv = el.querySelector('.note-content'); if(contentDiv && data.noteContent) contentDiv.innerHTML = data.noteContent; } 
                else if ((data.type === 'browser' || data.type === 'llama') && data.webUrl) { const el = document.getElementById(newItem.obj.id); const iframe = el.querySelector('.browser-frame'); const input = el.querySelector('.browser-input'); if (iframe && input) { iframe.src = data.webUrl; input.value = data.webUrl; } }
                else if (data.type === 'weather') { newItem.obj.cityLabel = data.weatherCity || 'Taipei'; renderWeatherContent(newItem.obj); }
                else if (data.type === 'quote') renderQuoteContent(newItem.obj);
                else if (data.type === 'number') renderNumberContent(newItem.obj);
                else if (data.type === 'tvnews') renderGlobalNewsContent(newItem.obj);
                else if (data.type === 'tvchart') renderTradingViewContent(newItem.obj);
                else if (data.type === 'tv-news') renderTVNewsContent(newItem.obj);
                else if (data.type === 'tv-eco') renderTVEcoContent(newItem.obj);
                else if (data.type === 'heatmap-stock') renderStockHeatmap(newItem.obj);
                else if (data.type === 'heatmap-crypto') renderCryptoHeatmap(newItem.obj);
                else if (data.type === 'heatmap-etf') renderETFHeatmap(newItem.obj);
                else if (data.type === 'ticker-tape') renderTickerTapeContent(newItem.obj);
                else if (data.type === 'kanban') renderKanbanContent(newItem.obj);
                else if (data.type === 'audio') renderAudioContent(newItem.obj);
                else if (data.type === 'youtube') renderYouTubeContent(newItem.obj);
                else if (data.type === 'pomodoro') renderPomodoroContent(newItem.obj);
            });
        }*/

        function clearGrid() { items.forEach(i => { const el = document.getElementById(i.id); if(el) el.remove(); }); items = []; }

        document.getElementById('tool-square').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'shape'));
        document.getElementById('tool-clock').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'clock'));
        document.getElementById('tool-weather').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'weather'));
        document.getElementById('tool-tvnews').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'tvnews'));
        document.getElementById('tool-tvchart').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'tvchart'));
        document.getElementById('tool-tv-news').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'tv-news'));
        document.getElementById('tool-tv-eco').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'tv-eco'));
        document.getElementById('tool-heatmap-stock').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'heatmap-stock'));
        document.getElementById('tool-heatmap-crypto').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'heatmap-crypto'));
        document.getElementById('tool-heatmap-etf').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'heatmap-etf'));
        document.getElementById('tool-ticker-tape').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'ticker-tape'));
        document.getElementById('tool-kanban').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'kanban'));
        document.getElementById('tool-audio').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'audio'));
        document.getElementById('tool-pomodoro').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'pomodoro'));
        document.getElementById('tool-quote').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'quote'));
        document.getElementById('tool-number').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'number'));
        document.getElementById('tool-chat').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'chat'));
        document.getElementById('tool-calc').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'calc'));
        document.getElementById('tool-note').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'note'));
        document.getElementById('tool-browser').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'browser'));
        document.getElementById('tool-youtube').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'youtube'));
        document.getElementById('tool-llama').addEventListener('dragstart', (e) => e.dataTransfer.setData('type', 'llama'));
        
        gridCanvas.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
        gridCanvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            const rect = gridCanvas.getBoundingClientRect();
            const x = snap(e.clientX - rect.left);
            const y = snap(e.clientY - rect.top);

            // 1. 處理線條工具：拖曳放開後啟動連線模式
            if (type === 'line_tool') {
                alert("【連線模式啟動】\n請依序點擊兩個物件來建立連線。");
                connectMode = true;
                connectSource = null;
                gridCanvas.style.cursor = 'crosshair'; // 改變游標提示
                return;
            }
            // 2. 處理圓形
            if (type === 'circle') { 
                if(!checkCollision({x, y, w: 160, h: 160})) createItem(x, y, 160, 160, activeColor, 'circle');
            }      
            // 3. 處理方形 (原有邏輯)
            else if (type === 'shape') { 
                if(!checkCollision({x, y, w: 200, h: 200})) createItem(x, y, 200, 200, activeColor, 'shape'); 
            }


           
            else if (type === 'clock') { if(!checkCollision({x, y, w: 200, h: 100})) createItem(x, y, 200, 100, '#ffffff', 'clock'); }
            else if (type === 'weather') { if(!checkCollision({x, y, w: 280, h: 180})) createItem(x, y, 280, 180, '#ffffff', 'weather'); }
            else if (type === 'tvnews') { if(!checkCollision({x, y, w: 500, h: 400})) createItem(x, y, 500, 400, '#ffffff', 'tvnews'); }
            else if (type === 'tvchart') { if(!checkCollision({x, y, w: 600, h: 450})) createItem(x, y, 600, 450, '#ffffff', 'tvchart'); }
            else if (type === 'tv-news') { if(!checkCollision({x, y, w: 420, h: 600})) createItem(x, y, 420, 600, '#ffffff', 'tv-news'); }
            else if (type === 'tv-eco') { if(!checkCollision({x, y, w: 420, h: 600})) createItem(x, y, 420, 600, '#ffffff', 'tv-eco'); }
            else if (type === 'heatmap-stock') { if(!checkCollision({x, y, w: 600, h: 500})) createItem(x, y, 600, 500, '#ffffff', 'heatmap-stock'); }
            else if (type === 'heatmap-crypto') { if(!checkCollision({x, y, w: 600, h: 500})) createItem(x, y, 600, 500, '#ffffff', 'heatmap-crypto'); }
            else if (type === 'heatmap-etf') { if(!checkCollision({x, y, w: 600, h: 500})) createItem(x, y, 600, 500, '#ffffff', 'heatmap-etf'); }
            else if (type === 'ticker-tape') { if(!checkCollision({x, y, w: 1000, h: 110})) createItem(x, y, 1000, 110, '#ffffff', 'ticker-tape'); }
            else if (type === 'kanban') { if(!checkCollision({x, y, w: 400, h: 300})) createItem(x, y, 400, 300, '#ffffff', 'kanban'); }
            else if (type === 'audio') { if(!checkCollision({x, y, w: 300, h: 150})) createItem(x, y, 300, 150, '#ffffff', 'audio'); }
            else if (type === 'pomodoro') { if(!checkCollision({x, y, w: 250, h: 150})) createItem(x, y, 250, 150, '#ffffff', 'pomodoro'); }
            else if (type === 'quote') { if(!checkCollision({x, y, w: 300, h: 160})) createItem(x, y, 300, 160, '#ffffff', 'quote'); }
            else if (type === 'number') { if(!checkCollision({x, y, w: 240, h: 200})) createItem(x, y, 240, 200, '#ffffff', 'number'); }
            else if (type === 'chat') { if(!checkCollision({x, y, w: 300, h: 400})) createItem(x, y, 300, 400, '#ffffff', 'chat'); }
            else if (type === 'calc') { if(!checkCollision({x, y, w: 200, h: 300})) createItem(x, y, 200, 300, '#ffffff', 'calc'); }
            else if (type === 'note') { if(!checkCollision({x, y, w: 200, h: 200})) createItem(x, y, 200, 200, '#ffffff', 'note'); }
            else if (type === 'browser') { if(!checkCollision({x, y, w: 400, h: 300})) createItem(x, y, 400, 300, '#ffffff', 'browser'); }
            else if (type === 'llama') { if(!checkCollision({x, y, w: 400, h: 500})) createItem(x, y, 400, 500, '#ffffff', 'llama'); }
            else if (type === 'youtube') {if(!checkCollision({x, y, w: 400, h: 300})) createItem(x, y, 400, 300, '#ff0000', 'youtube'); 
}
        });
        function createItem(x, y, w, h, color, type) {
            const id = 'item_' + Date.now() + Math.random().toString(36).substr(2, 5);
            const el = document.createElement('div'); 
            el.className = 'grid-item'; 
            
            // 處理圓形樣式
            if (type === 'circle') el.classList.add('circle');
            
            el.id = id; el.style.left = x + 'px'; el.style.top = y + 'px';
            el.style.width = w + 'px'; el.style.height = h + 'px';
            
            const rgb = hexToRgb(color); 
            el.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`;
            el.style.borderColor = color;

            // ★ 修改重點：加入 item-label-container 與 編輯/移除名稱 的選單
            el.innerHTML = `
                <div class="content-container" style="width:100%; height:100%;"></div>
                <div class="item-label-container" id="lbl-${id}"></div>
                <div class="menu-trigger">⋮</div>
                <div class="context-menu">
                    <div class="context-menu-item" onclick="editLabel('${id}')">編輯名稱 (Name)</div>
                    <div class="context-menu-item" onclick="removeLabel('${id}')">移除名稱 (Clear)</div>
                    <div class="context-menu-item danger" onclick="deleteItem('${id}')">移除 (Remove)</div>
                </div>
                <div class="item-resize"></div>`;
            
            const menu = el.querySelector('.context-menu');
            // ★ 新增：為 Module 10x10 和 Circle Node 加入顏色切換功能
            if (type === 'shape' || type === 'circle') {
                // 1. 建立一個隱藏的顏色輸入框
                const colInput = document.createElement('input');
                colInput.type = 'color';
                colInput.style.display = 'none';
                // 當顏色改變時，觸發變色函式
                colInput.oninput = (e) => setItemColor(id, e.target.value);
                el.appendChild(colInput);

                // 2. 在選單最上方加入選項
                const colBtn = document.createElement('div');
                colBtn.className = 'context-menu-item';
                colBtn.innerText = '變更顏色 (Color)';
                colBtn.onclick = (e) => {
                    e.stopPropagation();
                    menu.classList.remove('show'); // 關閉選單
                    colInput.click(); // 觸發選色器
                };
                // 插入到選單的第一個位置
                menu.insertBefore(colBtn, menu.firstChild);
            }


          // ★ 修正：針對「天氣 (Weather)」加入變更城市選項
            if (type === 'weather') {
                const cityBtn = document.createElement('div');
                cityBtn.className = 'context-menu-item';
                cityBtn.innerText = '📍 設定城市 (Change City)';
                cityBtn.onclick = (e) => {
                    e.stopPropagation();
                    menu.classList.remove('show');
                    const newCity = prompt("請輸入城市名稱 (例如: Tokyo, New York):", itemObj.cityLabel || "Taipei");
                    if (newCity) {
                        itemObj.cityLabel = newCity;
                        // 呼叫天氣更新函式 (需確保此時 updateWeatherData 已定義，或稍後執行)
                        if (typeof updateWeatherData === 'function') {
                            updateWeatherData(itemObj, newCity);
                        }
                    }
                };
                // 插入到選單最上方
                menu.insertBefore(cityBtn, menu.firstChild);
            }

            // ★ 修正：針對「時鐘 (Clock)」加入變更時區選項
            if (type === 'clock') {
                const tzBtn = document.createElement('div');
                tzBtn.className = 'context-menu-item';
                tzBtn.innerText = '🕒 設定時區 (Timezone)';
                tzBtn.style.borderBottom = '1px solid var(--accent-color)'; // 加個底線區隔
                tzBtn.onclick = (e) => {
                    e.stopPropagation();
                    menu.classList.remove('show');
                    const newTz = prompt("請輸入時區 (例如: Asia/Tokyo, Europe/London, local):", itemObj.timeZone || "local");
                    if (newTz) {
                        itemObj.timeZone = newTz;
                        renderClockContent(itemObj);
                    }
                };
                menu.insertBefore(tzBtn, menu.firstChild);
            }            
            const trigger = el.querySelector('.menu-trigger');

            // 選單開關
            trigger.onclick = (e) => { 
                e.stopPropagation(); 
                document.querySelectorAll('.context-menu').forEach(m => { if(m!==menu) m.classList.remove('show'); }); 
                menu.classList.toggle('show'); 
            };

            // ★ 新增：物件點擊事件 (用於連線模式)
            el.onclick = (e) => {
                if (connectMode) {
                    e.stopPropagation();
                    handleConnectClick(id);
                }
            };

            gridCanvas.appendChild(el);
            
            // 加入 items 陣列 (新增 label 屬性)
            const itemObj = { id, x, y, w, h, el, type, label: '' };
            items.push(itemObj);

            // 渲染既有 Widget 內容
            if (type === 'clock') renderClockContent(itemObj);
            if (type === 'chat') renderChatContent(itemObj);
            if (type === 'calc') renderCalcContent(itemObj);
            if (type === 'note') renderNoteContent(itemObj);
            if (type === 'browser') renderBrowserContent(itemObj, 'https://www.wikipedia.org', 'WEB PORTAL');
            if (type === 'weather') { itemObj.cityLabel = 'Taipei'; renderWeatherContent(itemObj); }
            if (type === 'quote') renderQuoteContent(itemObj);
            if (type === 'number') renderNumberContent(itemObj);
            if (type === 'tvnews') renderGlobalNewsContent(itemObj);
            if (type === 'tvchart') renderTradingViewContent(itemObj);
            if (type === 'tv-news') renderTVNewsContent(itemObj);
            if (type === 'tv-eco') renderTVEcoContent(itemObj);
            if (type === 'heatmap-stock') renderStockHeatmap(itemObj);
            if (type === 'heatmap-crypto') renderCryptoHeatmap(itemObj);
            if (type === 'heatmap-etf') renderETFHeatmap(itemObj);
            if (type === 'ticker-tape') renderTickerTapeContent(itemObj);
            if (type === 'kanban') renderKanbanContent(itemObj);
            if (type === 'audio') renderAudioContent(itemObj);
            if (type === 'pomodoro') renderPomodoroContent(itemObj);
            if (type === 'llama') renderBrowserContent(itemObj, 'https://llama.online/chat', 'LLAMA ONLINE');
            if (type === 'youtube') renderYouTubeContent(itemObj);

            setupInteractions(itemObj); 
            document.addEventListener('click', () => menu.classList.remove('show')); 
            
            return { el, obj: itemObj };
        }
        
        // --- New Workstation Tools ---
        function renderKanbanContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.kanban-layout')) return;
            
            container.innerHTML = `
                <div class="kanban-layout">
                    <div class="kanban-header widget-header"><span>OPS BOARD</span><span style="opacity:0.5">PROJECTS</span></div>
                    <div class="kanban-board">
                        <div class="kanban-col" id="col-todo-${item.id}">
                            <div class="kanban-col-title">TO DO</div>
                            <div class="kanban-items"></div>
                            <button class="kanban-add-btn" onclick="addKanbanCard('${item.id}', 'col-todo-${item.id}')">+ ADD</button>
                        </div>
                        <div class="kanban-col" id="col-prog-${item.id}">
                            <div class="kanban-col-title">IN PROGRESS</div>
                            <div class="kanban-items"></div>
                            <button class="kanban-add-btn" onclick="addKanbanCard('${item.id}', 'col-prog-${item.id}')">+ ADD</button>
                        </div>
                        <div class="kanban-col" id="col-done-${item.id}">
                            <div class="kanban-col-title">DONE</div>
                            <div class="kanban-items"></div>
                            <button class="kanban-add-btn" onclick="addKanbanCard('${item.id}', 'col-done-${item.id}')">+ ADD</button>
                        </div>
                    </div>
                </div>
            `;
            // Pre-fill some sample tasks
            addKanbanCard(item.id, `col-todo-${item.id}`, 'Research NVDA Earnings');
            addKanbanCard(item.id, `col-prog-${item.id}`, 'Update Stop-Loss');
        }

        function addKanbanCard(itemId, colId, text = null) {
            const col = document.getElementById(colId).querySelector('.kanban-items');
            const cardText = text || prompt("Enter task:");
            if(!cardText) return;
            
            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.innerText = cardText;
            card.draggable = true;
            
            card.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', card.id);
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => card.style.opacity = '0.5', 0);
            });
            card.addEventListener('dragend', () => card.style.opacity = '1');
            card.addEventListener('dblclick', () => card.remove()); // Delete on double click
            
            // Simple drag logic for cards within columns
            // Note: Full D&D logic for columns usually requires more complex event handling on columns
            // For simplicity in this massive file, we use basic append.
            
            col.appendChild(card);
        }

        function renderAudioContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.audio-layout')) return;
            
            container.innerHTML = `
                <div class="audio-layout">
                    <div class="audio-header widget-header"><span>NEURAL AUDIO</span><span>LOFI.RADIO</span></div>
                    
                    <div class="audio-visualizer">
                        <div class="audio-bar" style="height:40%; animation-delay:0s"></div>
                        <div class="audio-bar" style="height:70%; animation-delay:0.2s"></div>
                        <div class="audio-bar" style="height:30%; animation-delay:0.4s"></div>
                        <div class="audio-bar" style="height:80%; animation-delay:0.1s"></div>
                        <div class="audio-bar" style="height:50%; animation-delay:0.3s"></div>
                        <div class="audio-bar" style="height:90%; animation-delay:0.5s"></div>
                        <div class="audio-bar" style="height:20%; animation-delay:0s"></div>
                    </div>

                    <div class="audio-controls">
                        <button class="audio-btn" onclick="toggleAudio('${item.id}')">⏯</button>
                    </div>
                    
                    <iframe id="yt-${item.id}" width="0" height="0" src="https://www.youtube.com/embed/jfKfPfyJRdk?enablejsapi=1" frameborder="0" allow="autoplay"></iframe>
                </div>
            `;
            item.isPlaying = false;
        }
        
        window.toggleAudio = function(itemId) {
            const item = items.find(i => i.id === itemId);
            const iframe = document.getElementById(`yt-${itemId}`);
            if(!item.isPlaying) {
                // Trick to play: reload src with autoplay (since we can't easily access YT API without script loading)
                // Or use postMessage if API was loaded. Simple reload method for standalone HTML:
                iframe.src = iframe.src + "&autoplay=1";
                item.isPlaying = true;
                item.el.querySelector('.audio-visualizer').style.opacity = '1';
            } else {
                iframe.src = iframe.src.replace("&autoplay=1", "");
                item.isPlaying = false;
                item.el.querySelector('.audio-visualizer').style.opacity = '0.5';
            }
        }

        function renderPomodoroContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.pomo-layout')) return;
            
            container.innerHTML = `
                <div class="pomo-layout">
                    <div class="pomo-header widget-header"><span>CHRONO SYNC</span></div>
                    <div class="pomo-status" id="pomo-status-${item.id}">FOCUS</div>
                    <div class="pomo-time" id="pomo-time-${item.id}">25:00</div>
                    <div class="pomo-controls">
                        <button class="pomo-btn" onclick="startPomo('${item.id}')">START</button>
                        <button class="pomo-btn" onclick="resetPomo('${item.id}')">RESET</button>
                    </div>
                </div>
            `;
            item.pomoTime = 25 * 60;
            item.pomoInterval = null;
        }

        window.startPomo = function(itemId) {
            const item = items.find(i => i.id === itemId);
            if(item.pomoInterval) return;
            
            item.pomoInterval = setInterval(() => {
                item.pomoTime--;
                if(item.pomoTime < 0) {
                    clearInterval(item.pomoInterval);
                    item.pomoInterval = null;
                    alert("Session Complete");
                    return;
                }
                const m = Math.floor(item.pomoTime / 60).toString().padStart(2, '0');
                const s = (item.pomoTime % 60).toString().padStart(2, '0');
                document.getElementById(`pomo-time-${itemId}`).innerText = `${m}:${s}`;
            }, 1000);
        }

        window.resetPomo = function(itemId) {
            const item = items.find(i => i.id === itemId);
            if(item.pomoInterval) clearInterval(item.pomoInterval);
            item.pomoInterval = null;
            item.pomoTime = 25 * 60;
            document.getElementById(`pomo-time-${itemId}`).innerText = "25:00";
        }

        // --- TradingView Functionalities ---
        function renderTradingViewContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.tradingview-widget-container')) return;
            
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                    <div class="widget-header" style="padding:5px 10px; background:var(--bg-panel); border-bottom:1px solid var(--border-color); cursor:move; font-size:0.8em; color:var(--text-primary); display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">ADVANCED CHART</span>
                        <span style="opacity:0.5; font-size:0.8em;">TRADINGVIEW</span>
                    </div>
                    <div class="tv-embed-wrapper" style="flex:1; position:relative; overflow:hidden;"></div>
                </div>
            `;
            
            const wrapper = container.querySelector('.tv-embed-wrapper');
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';
            widgetContainer.style.height = '100%';
            widgetContainer.style.width = '100%';
            
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            widgetDiv.style.height = '100%';
            widgetDiv.style.width = '100%';
            
            widgetContainer.appendChild(widgetDiv);
            wrapper.appendChild(widgetContainer);

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "allow_symbol_change": true,
                "calendar": false,
                "details": false,
                "hide_side_toolbar": true,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "hide_volume": false,
                "hotlist": false,
                "interval": "D",
                "locale": "zh_TW",
                "save_image": true,
                "style": "1",
                "symbol": "NASDAQ:NVDA",
                "theme": "dark",
                "timezone": "Etc/UTC",
                "backgroundColor": "#0F0F0F",
                "gridColor": "rgba(242, 242, 242, 0.06)",
                "watchlist": [],
                "withdateranges": false,
                "compareSymbols": [],
                "studies": [],
                "autosize": true
            });
            widgetContainer.appendChild(script);
        }

        function renderTVNewsContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.tradingview-widget-container')) return;
            
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                    <div class="widget-header" style="padding:5px 10px; background:var(--bg-panel); border-bottom:1px solid var(--border-color); cursor:move; font-size:0.8em; color:var(--text-primary); display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">TOP STORIES</span>
                        <span style="opacity:0.5; font-size:0.8em;">TRADINGVIEW</span>
                    </div>
                    <div class="tv-embed-wrapper" style="flex:1; position:relative; overflow:hidden;"></div>
                </div>
            `;
            
            const wrapper = container.querySelector('.tv-embed-wrapper');
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';
            widgetContainer.style.height = '100%';
            widgetContainer.style.width = '100%';
            
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            
            widgetContainer.appendChild(widgetDiv);
            wrapper.appendChild(widgetContainer);

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-timeline.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "displayMode": "compact",
                "feedMode": "all_symbols",
                "colorTheme": "dark",
                "isTransparent": false,
                "locale": "zh_TW",
                "width": "100%",
                "height": "100%"
            });
            widgetContainer.appendChild(script);
        }

        function renderTVEcoContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.tradingview-widget-container')) return;
            
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                    <div class="widget-header" style="padding:5px 10px; background:var(--bg-panel); border-bottom:1px solid var(--border-color); cursor:move; font-size:0.8em; color:var(--text-primary); display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">ECO CALENDAR</span>
                        <span style="opacity:0.5; font-size:0.8em;">TRADINGVIEW</span>
                    </div>
                    <div class="tv-embed-wrapper" style="flex:1; position:relative; overflow:hidden;"></div>
                </div>
            `;
            
            const wrapper = container.querySelector('.tv-embed-wrapper');
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';
            widgetContainer.style.height = '100%';
            widgetContainer.style.width = '100%';
            
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            
            widgetContainer.appendChild(widgetDiv);
            wrapper.appendChild(widgetContainer);

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-events.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "colorTheme": "dark",
                "isTransparent": false,
                "locale": "zh_TW",
                "countryFilter": "us,tw,jp,cn,hk",
                "importanceFilter": "-1,0,1",
                "width": "100%",
                "height": "100%"
            });
            widgetContainer.appendChild(script);
        }

        function renderStockHeatmap(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.tradingview-widget-container')) return;
            
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                    <div class="widget-header" style="padding:5px 10px; background:var(--bg-panel); border-bottom:1px solid var(--border-color); cursor:move; font-size:0.8em; color:var(--text-primary); display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">STOCK HEATMAP</span>
                        <span style="opacity:0.5; font-size:0.8em;">S&P 500</span>
                    </div>
                    <div class="tv-embed-wrapper" style="flex:1; position:relative; overflow:hidden;"></div>
                </div>
            `;
            
            const wrapper = container.querySelector('.tv-embed-wrapper');
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';
            widgetContainer.style.height = '100%';
            widgetContainer.style.width = '100%';
            
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            
            widgetContainer.appendChild(widgetDiv);
            wrapper.appendChild(widgetContainer);

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "dataSource": "SPX500",
                "blockSize": "market_cap_basic",
                "blockColor": "change",
                "grouping": "sector",
                "locale": "zh_TW",
                "symbolUrl": "",
                "colorTheme": "dark",
                "exchanges": [],
                "hasTopBar": true,
                "isDataSetEnabled": true,
                "isZoomEnabled": true,
                "hasSymbolTooltip": true,
                "isMonoSize": false,
                "width": "100%",
                "height": "100%"
            });
            widgetContainer.appendChild(script);
        }

        function renderCryptoHeatmap(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.tradingview-widget-container')) return;
            
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                    <div class="widget-header" style="padding:5px 10px; background:var(--bg-panel); border-bottom:1px solid var(--border-color); cursor:move; font-size:0.8em; color:var(--text-primary); display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">CRYPTO HEATMAP</span>
                        <span style="opacity:0.5; font-size:0.8em;">COINS</span>
                    </div>
                    <div class="tv-embed-wrapper" style="flex:1; position:relative; overflow:hidden;"></div>
                </div>
            `;
            
            const wrapper = container.querySelector('.tv-embed-wrapper');
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';
            widgetContainer.style.height = '100%';
            widgetContainer.style.width = '100%';
            
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            
            widgetContainer.appendChild(widgetDiv);
            wrapper.appendChild(widgetContainer);

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-crypto-coins-heatmap.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "dataSource": "Crypto",
                "blockSize": "market_cap_calc",
                "blockColor": "change",
                "locale": "zh_TW",
                "symbolUrl": "",
                "colorTheme": "dark",
                "hasTopBar": true,
                "isDataSetEnabled": true,
                "isZoomEnabled": true,
                "hasSymbolTooltip": true,
                "isMonoSize": false,
                "width": "100%",
                "height": "100%"
            });
            widgetContainer.appendChild(script);
        }

        function renderETFHeatmap(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.tradingview-widget-container')) return;
            
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                    <div class="widget-header" style="padding:5px 10px; background:var(--bg-panel); border-bottom:1px solid var(--border-color); cursor:move; font-size:0.8em; color:var(--text-primary); display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">TW ETF HEATMAP</span>
                        <span style="opacity:0.5; font-size:0.8em;">TAIWAN</span>
                    </div>
                    <div class="tv-embed-wrapper" style="flex:1; position:relative; overflow:hidden;"></div>
                </div>
            `;
            
            const wrapper = container.querySelector('.tv-embed-wrapper');
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';
            widgetContainer.style.height = '100%';
            widgetContainer.style.width = '100%';
            
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            
            widgetContainer.appendChild(widgetDiv);
            wrapper.appendChild(widgetContainer);

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-etf-heatmap.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "dataSource": "AllTWEtf",
                "blockSize": "monoSize",
                "blockColor": "change",
                "grouping": "asset_class",
                "locale": "zh_TW",
                "symbolUrl": "",
                "colorTheme": "dark",
                "hasTopBar": false,
                "isDataSetEnabled": false,
                "isZoomEnabled": true,
                "hasSymbolTooltip": true,
                "isMonoSize": false,
                "width": "100%",
                "height": "100%"
            });
            widgetContainer.appendChild(script);
        }

        function renderTickerTapeContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.tradingview-widget-container')) return;
            
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                    <div class="widget-header" style="padding:5px 10px; background:var(--bg-panel); border-bottom:1px solid var(--border-color); cursor:move; font-size:0.8em; color:var(--text-primary); display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">TICKER TAPE</span>
                        <span style="opacity:0.5; font-size:0.8em;">TRADINGVIEW</span>
                    </div>
                    <div class="tv-embed-wrapper" style="flex:1; position:relative; overflow:hidden;"></div>
                </div>
            `;
            
            const wrapper = container.querySelector('.tv-embed-wrapper');
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';
            widgetContainer.style.height = '100%';
            widgetContainer.style.width = '100%';
            
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            widgetDiv.style.height = '100%';
            widgetDiv.style.width = '100%';
            
            widgetContainer.appendChild(widgetDiv);
            wrapper.appendChild(widgetContainer);

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "symbols": [
                    { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500 Index" },
                    { "proName": "FOREXCOM:NSXUSD", "title": "US 100 Cash CFD" },
                    { "proName": "FX_IDC:EURUSD", "title": "EUR to USD" },
                    { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" },
                    { "proName": "BITSTAMP:ETHUSD", "title": "Ethereum" },
                    { "proName": "NASDAQ:TSLA", "title": "Tesla" },
                    { "proName": "NASDAQ:META", "title": "META" },
                    { "proName": "NASDAQ:AMZN", "title": "AMAZON" },
                    { "proName": "NASDAQ:GOOGL", "title": "Google" },
                    { "proName": "NASDAQ:PLTR", "title": "PLTR" },
                    { "proName": "NASDAQ:AAPL", "title": "APPL" },
                    { "proName": "NASDAQ:NVDA", "title": "NVDA" }
                ],
                "colorTheme": "dark",
                "isTransparent": false,
                "displayMode": "adaptive",
                "locale": "zh_TW"
            });
            widgetContainer.appendChild(script);
        }

        // --- Weather Functionality ---
        async function fetchWeather(city) {
            try {
                const geoResp = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=en&format=json`);
                const geoData = await geoResp.json();
                if(!geoData.results || geoData.results.length === 0) return null;
                const { latitude, longitude, name } = geoData.results[0];
                const weatherResp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`);
                const weatherData = await weatherResp.json();
                return { name, current: weatherData.current, daily: weatherData.daily };
            } catch(e) { console.error(e); return null; }
        }

        function getWeatherIcon(code) {
            if (code === 0) return '☀️';
            if (code >= 1 && code <= 3) return '☁️'; if (code >= 45 && code <= 48) return '🌫️';
            if (code >= 51 && code <= 67) return '🌧️'; if (code >= 71 && code <= 77) return '❄️';
            if (code >= 80 && code <= 82) return '🌧️';
            if (code >= 95 && code <= 99) return '⛈️';
            return '❓';
        }
        
        function getWeatherDesc(code) {
             const codes = {0: 'Clear', 1: 'Cloudy', 2: 'Cloudy', 3: 'Overcast', 45: 'Fog', 48: 'Fog', 51: 'Drizzle', 61: 'Rain', 71: 'Snow', 95: 'Storm'};
             return codes[code] || 'Unknown';
        }

        function getDayName(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { weekday: 'short' });
        }

        async function renderWeatherContent(item) {
            const container = item.el.querySelector('.content-container');
            if(!container.querySelector('.weather-layout')) {
                container.innerHTML = `
                    <div class="weather-layout">
                        <div class="weather-header widget-header"><span>WEATHER</span></div>
                        <div class="weather-top">
                            <div class="weather-top-left"><div class="weather-main-icon" id="w-icon-${item.id}">☀️</div><div class="weather-main-temp" id="w-temp-${item.id}">--</div><div class="weather-unit">°C</div></div>
                            <div class="weather-condition-text" id="w-cond-${item.id}">Clear</div>
                        </div>
                        <div class="weather-middle">
                            <div class="weather-location-text" id="w-city-name-${item.id}">LOADING</div>
                            <div class="weather-hl">H:<span id="w-high-${item.id}">--</span>° L:<span id="w-low-${item.id}">--</span>°</div>
                        </div>
                        <div class="weather-forecast" id="w-forecast-${item.id}"></div>
                        <div class="weather-search-container"><input type="text" class="weather-search-input" id="w-input-${item.id}" placeholder="請在此搜尋城市" value=""></div>
                    </div>`;
                const input = container.querySelector(`#w-input-${item.id}`);
                input.addEventListener('keypress', async (e) => {
                    if(e.key === 'Enter') {
                        const val = input.value.trim();
                        if(val) {
                            item.cityLabel = val;
                            container.querySelector(`#w-city-name-${item.id}`).innerText = "SEARCHING";
                            await updateWeatherData(item, val);
                            input.value = '';
                        }
                    }
                });
                input.addEventListener('mousedown', e => e.stopPropagation());
                 updateWeatherScale(item);
            }
            await updateWeatherData(item, item.cityLabel);
        }

        async function updateWeatherData(item, city) {
            const data = await fetchWeather(city);
            const container = item.el.querySelector('.content-container');
            if(data) {
                container.querySelector(`#w-city-name-${item.id}`).innerText = data.name;
                container.querySelector(`#w-temp-${item.id}`).innerText = Math.round(data.current.temperature_2m);
                container.querySelector(`#w-icon-${item.id}`).innerText = getWeatherIcon(data.current.weather_code);
                container.querySelector(`#w-cond-${item.id}`).innerText = getWeatherDesc(data.current.weather_code);
                if(data.daily) {
                    container.querySelector(`#w-high-${item.id}`).innerText = Math.round(data.daily.temperature_2m_max[0]);
                    container.querySelector(`#w-low-${item.id}`).innerText = Math.round(data.daily.temperature_2m_min[0]);
                }
                const forecastContainer = container.querySelector(`#w-forecast-${item.id}`);
                if(data.daily && forecastContainer) {
                    let forecastHTML = '';
                    for(let i=1; i<=5; i++) {
                        if(data.daily.time[i]) {
                             forecastHTML += `<div class="forecast-item"><div class="forecast-day">${getDayName(data.daily.time[i])}</div><div class="forecast-icon">${getWeatherIcon(data.daily.weather_code[i])}</div><div class="forecast-temp">${Math.round(data.daily.temperature_2m_max[i])}°</div></div>`;
                        }
                    }
                    forecastContainer.innerHTML = forecastHTML;
                }
                item.cityLabel = data.name;
            } else { const cityEl = container.querySelector(`#w-city-name-${item.id}`); if(cityEl) cityEl.innerText = "NOT FOUND"; }
        }

        function updateWeatherScale(item) {
            const layout = item.el.querySelector('.weather-layout');
            if(layout) layout.style.fontSize = `${item.w / 25}px`;
        }

        // --- Quote Functionality ---
        async function fetchQuote() {
            try {
                const resp = await fetch('https://api.quotable.io/random');
                return await resp.json();
            } catch(e) { return { content: "Knowledge is power.", author: "Francis Bacon" }; }
        }

        async function renderQuoteContent(item) {
            const container = item.el.querySelector('.content-container');
            if(!container.querySelector('.quote-layout')) {
                container.innerHTML = `
                    <div class="quote-layout">
                        <div class="quote-header widget-header"><span>DAILY INSIGHT</span></div>
                        <div class="quote-content" id="q-text-${item.id}">Loading...</div>
                        <div class="quote-author" id="q-auth-${item.id}"></div>
                        <div class="quote-refresh" id="q-btn-${item.id}">↻</div>
                    </div>`;
                const btn = container.querySelector(`#q-btn-${item.id}`);
                if(btn) btn.onclick = (e) => { e.stopPropagation(); updateQuote(item); };
                updateQuoteScale(item);
                await updateQuote(item);
            }
        }

        async function updateQuote(item) {
            const container = item.el.querySelector('.content-container');
            const contentEl = container.querySelector(`#q-text-${item.id}`);
            if(contentEl) contentEl.innerText = "Fetching...";
            const q = await fetchQuote();
            if(contentEl) contentEl.innerText = `"${q.content}"`;
            container.querySelector(`#q-auth-${item.id}`).innerText = `- ${q.author}`;
        }

        function updateQuoteScale(item) {
            const layout = item.el.querySelector('.quote-layout');
            if(layout) layout.style.fontSize = `${item.w / 20}px`;
        }

        // --- Number Fact Functionality ---
        async function fetchNumberFact(num = 'random') {
            try {
                const facts = ["42 is the answer to life, the universe, and everything.", "73 is the 21st prime number.", "0 is the additive identity.", "1 is the only number that is neither prime nor composite."];
                try { const resp = await fetch(`https://numbersapi.com/${num}/math?json`); if(resp.ok) return await resp.json(); } catch(e) {}
                return { text: facts[Math.floor(Math.random() * facts.length)], number: num === 'random' ? Math.floor(Math.random()*100) : num };
            } catch(e) { return { text: "Could not fetch fact.", number: "ERR" }; }
        }

        async function renderNumberContent(item) {
            const container = item.el.querySelector('.content-container');
            if(!container.querySelector('.number-layout')) {
                container.innerHTML = `
                    <div class="number-layout">
                        <div class="number-header widget-header"><span>DATA FACT</span></div>
                        <div class="number-val" id="n-val-${item.id}">#</div>
                        <div class="number-fact" id="n-fact-${item.id}">Ready to process...</div>
                        <div class="number-controls">
                            <input type="number" class="number-input" id="n-input-${item.id}" placeholder="Num">
                            <button class="number-btn" id="n-go-${item.id}">GO</button>
                            <button class="number-btn" id="n-rnd-${item.id}">RND</button>
                        </div>
                    </div>`;
                const input = container.querySelector(`#n-input-${item.id}`);
                const goBtn = container.querySelector(`#n-go-${item.id}`);
                const rndBtn = container.querySelector(`#n-rnd-${item.id}`);
                const update = async (val) => {
                    container.querySelector(`#n-fact-${item.id}`).innerText = "Processing...";
                    const data = await fetchNumberFact(val);
                    container.querySelector(`#n-val-${item.id}`).innerText = data.number;
                    container.querySelector(`#n-fact-${item.id}`).innerText = data.text;
                };
                goBtn.onclick = (e) => { e.stopPropagation(); if(input.value) update(input.value); };
                rndBtn.onclick = (e) => { e.stopPropagation(); update('random'); };
                input.addEventListener('mousedown', e => e.stopPropagation());
            }
        }

        // --- Global News Functionality (RSS to JSON) ---
        async function fetchRSSNews() {
            const feeds = [
                'https://www.theverge.com/rss/index.xml', // The Verge
                'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=10000664', // CNBC Tech
                'https://www.engadget.com/rss.xml', // Engadget
                'https://www.wired.com/feed/rss' // Wired
            ];
            try {
                const promises = feeds.map(url => 
                    fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`)
                    .then(res => res.json())
                    .then(data => data.status === 'ok' ? data.items : [])
                );
                const results = await Promise.all(promises);
                const allNews = results.flat();
                allNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                const uniqueNews = allNews.filter((v,i,a)=>a.findIndex(t=>(t.title === v.title))===i);
                return uniqueNews;
            } catch (e) {
                console.warn("RSS Fetch failed", e);
                return [];
            }
        }

        function extractImageFromItem(item) {
            if (item.enclosure && item.enclosure.link) return item.enclosure.link;
            if (item.thumbnail) return item.thumbnail;
            const htmlContent = item.description || item.content || "";
            if (htmlContent) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const img = doc.querySelector('img');
                if (img && img.src) return img.src;
            }
            const match = htmlContent.match(/src="([^"]*)"/);
            if (match) return match[1];
            const placeholders = [
                'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=800&q=80',
                'https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?auto=format&fit=crop&w=800&q=80',
                'https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&w=800&q=80'
            ];
            return placeholders[Math.floor(Math.random() * placeholders.length)];
        }

        async function renderGlobalNewsContent(item) {
            const container = item.el.querySelector('.content-container');
            if(!container.querySelector('.global-news-layout')) {
                container.innerHTML = `
                    <div class="global-news-layout">
                        <div class="global-news-header widget-header">
                            <span style="font-weight:bold; letter-spacing:1px;">GLOBAL NEWS</span>
                            <span style="opacity:0.6; font-size:0.9em;">LIVE FEED</span>
                        </div>
                        <div id="news-content-${item.id}" style="margin-top: 30px;">
                            <div class="news-loading">INITIALIZING CYBER FEED...</div>
                        </div>
                    </div>`;
                
                const contentDiv = container.querySelector(`#news-content-${item.id}`);
                const articles = await fetchRSSNews();
                
                if (articles.length > 0) {
                    const hero = articles[0];
                    const others = articles.slice(1, 12);
                    let html = `
                        <div class="news-hero" onclick="window.open('${hero.link}', '_blank')">
                            <div class="news-hero-content">
                                <div class="news-hero-title">${hero.title}</div>
                                <div class="news-hero-summary">${hero.description.replace(/<[^>]*>?/gm, '').substring(0, 120)}...</div>
                                <div class="news-hero-meta">
                                    <span>● ${new Date(hero.pubDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                </div>
                                <a href="${hero.link}" target="_blank" class="news-source-btn" onclick="event.stopPropagation()">READ SOURCE ↗</a>
                            </div>
                            <img class="news-hero-img" src="${extractImageFromItem(hero)}" onerror="this.style.display='none'">
                        </div>
                        <div class="news-grid">
                    `;
                    others.forEach(art => {
                        html += `
                            <div class="news-grid-card" onclick="window.open('${art.link}', '_blank')">
                                <img class="news-card-img" src="${extractImageFromItem(art)}" onerror="this.style.display='none'">
                                <div class="news-card-content">
                                    <div class="news-card-title">${art.title}</div>
                                    <div class="news-card-meta">
                                        <span>${new Date(art.pubDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                    <a href="${art.link}" target="_blank" class="news-source-btn" onclick="event.stopPropagation()">READ SOURCE ↗</a>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                    contentDiv.innerHTML = html;
                } else {
                    contentDiv.innerHTML = `<div class="news-loading">CONNECTION FAILED // RETRYING...</div>`;
                }
            }
        }

        function renderClockContent(item) { 
            const container = item.el.querySelector('.content-container');
            const now = new Date(); let timeStr;
            if (!item.timeZone || item.timeZone === 'local') { timeStr = now.toLocaleTimeString('en-US', { hour12: false }); } 
            else { try { timeStr = now.toLocaleTimeString('en-US', { hour12: false, timeZone: item.timeZone }); } catch(e) { timeStr = "Invalid TZ"; } }
            const fontSize = item.w / 6.5;
            const adjustedFontSize = item.timeZone && item.timeZone !== 'local' ? fontSize * 0.8 : fontSize; const labelSize = adjustedFontSize * 0.3;
            container.innerHTML = `<div class="clock-layout"><div style="font-size:${adjustedFontSize}px; line-height: 1;">${timeStr}</div><div class="clock-city" style="font-size:${labelSize}px;">${item.cityLabel || 'LOCAL'}</div></div>`;
        }
        function renderChatContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.chat-layout')) return;
            container.innerHTML = `
                <div class="chat-layout">
                    <div class="chat-header widget-header"><span>LLM CHAT</span><span style="font-size:0.8em; opacity:0.7;">ONLINE</span></div>
                    <div class="chat-history" id="history-${item.id}"><div class="chat-msg sys">System initialized. Select model and type command.</div></div>
                    <div class="chat-input-area">
                        <div style="position:relative; display:inline-block;">
                            <button class="chat-upload-btn" title="Upload File" onclick="document.getElementById('file-${item.id}').click()">📁</button>
                            <input type="file" id="file-${item.id}" style="display:none">
                        </div>
                        <input type="text" class="chat-input" placeholder="Type command..." id="input-${item.id}">
                        <select class="chat-model-select" id="model-${item.id}"><option value="llama3">Llama 3</option><option value="deepseek">DeepSeek</option></select>
                        <button class="chat-send-btn" id="btn-${item.id}">SEND</button>
                    </div>
                </div>`;
            const input = container.querySelector(`#input-${item.id}`), btn = container.querySelector(`#btn-${item.id}`), history = container.querySelector(`#history-${item.id}`), modelSelect = container.querySelector(`#model-${item.id}`), fileInput = container.querySelector(`#file-${item.id}`);
            fileInput.addEventListener('change', (e) => { if(e.target.files.length > 0) { const userDiv = document.createElement('div'); userDiv.className = 'chat-msg user'; userDiv.innerText = `Uploading ${e.target.files[0].name}...`; history.appendChild(userDiv); history.scrollTop = history.scrollHeight; } });
            const sendMsg = () => { const text = input.value.trim(); if(!text) return; const userDiv = document.createElement('div'); userDiv.className = 'chat-msg user';
            userDiv.innerText = text; history.appendChild(userDiv); input.value = ''; history.scrollTop = history.scrollHeight;
            setTimeout(() => { const selectedModel = modelSelect.value === 'llama3' ? 'Llama 3' : 'DeepSeek'; const sysDiv = document.createElement('div'); sysDiv.className = 'chat-msg sys'; sysDiv.innerText = `[${selectedModel}] Processing request... Analysis complete. Market volatility is high.`; history.appendChild(sysDiv); history.scrollTop = history.scrollHeight; }, 800);
            };
            btn.onclick = sendMsg; input.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });
        }
        function renderCalcContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.calc-layout')) return;
            container.innerHTML = `<div class="calc-layout"><div class="calc-header widget-header">CALC-8000</div><div class="calc-display" id="disp-${item.id}">0</div><div class="calc-keys" id="keys-${item.id}"></div></div>`;
            const display = container.querySelector(`#disp-${item.id}`), keysContainer = container.querySelector(`#keys-${item.id}`);
            const keys = ['7','8','9','/','4','5','6','*','1','2','3','-','C','0','=','+']; let currentExp = '';
            keys.forEach(k => {
                const btn = document.createElement('button'); btn.className = 'calc-key'; btn.innerText = k; if(['/','*','-','+'].includes(k)) btn.classList.add('op'); if(k === '=') btn.classList.add('eq');
                btn.onclick = (e) => { e.stopPropagation(); if(k === 'C') { currentExp = ''; display.innerText = '0'; } else if(k === '=') { try { display.innerText = eval(currentExp) || '0'; currentExp = display.innerText; } catch { display.innerText = 'ERR'; currentExp = ''; } } 
                else { currentExp += k; display.innerText = currentExp; } }; keysContainer.appendChild(btn);
            });
        }
        function renderNoteContent(item) {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.note-layout')) return;
            container.innerHTML = `<div class="note-layout"><div class="note-header widget-header"><span>NOTES</span></div><div class="note-toolbar"><button class="note-btn" data-cmd="bold"><b>B</b></button><button class="note-btn" data-cmd="italic"><i>I</i></button><select class="note-select" data-cmd="fontSize"><option value="1">Tiny</option><option value="3" selected>Normal</option><option value="5">Large</option><option value="7">Huge</option></select></div><div class="note-content" contenteditable="true"></div></div>`;
            const toolbar = container.querySelector('.note-toolbar'), content = container.querySelector('.note-content');
            toolbar.addEventListener('mousedown', e => e.stopPropagation()); content.addEventListener('mousedown', e => e.stopPropagation());
            toolbar.addEventListener('click', (e) => { if(e.target.classList.contains('note-btn') || e.target.parentElement.classList.contains('note-btn')) { const btn = e.target.classList.contains('note-btn') ? e.target : e.target.parentElement; document.execCommand(btn.dataset.cmd, false, null); content.focus(); }});
            toolbar.querySelector('.note-select').addEventListener('change', (e) => { document.execCommand('fontSize', false, e.target.value); content.focus(); });
        }
        function renderBrowserContent(item, initialUrl = '', title = 'WEB') {
            const container = item.el.querySelector('.content-container');
            if(container.querySelector('.browser-layout')) return;
            container.innerHTML = `
                <div class="browser-layout">
                    <div class="browser-header widget-header">
                        <span style="font-weight:bold;">${title}</span>
                        <div class="nav-group">
                             <button class="nav-btn" id="back-${item.id}"> &lt; </button>
                            <button class="nav-btn" id="fwd-${item.id}"> &gt; </button>
                            <button class="nav-btn" id="ref-${item.id}"> ↻ </button>
                        </div>
                        <input type="text" class="browser-input" placeholder="https://" id="url-${item.id}" value="${initialUrl}">
                        <button class="browser-btn" id="go-${item.id}">GO</button>
                    </div>
                    <iframe class="browser-frame" id="frame-${item.id}" src="${initialUrl}"></iframe>
                </div>
            `;
            const input = container.querySelector(`#url-${item.id}`), 
                  btn = container.querySelector(`#go-${item.id}`), 
                  frame = container.querySelector(`#frame-${item.id}`),
                  backBtn = container.querySelector(`#back-${item.id}`),
                  fwdBtn = container.querySelector(`#fwd-${item.id}`),
                  refBtn = container.querySelector(`#ref-${item.id}`);
            
            item.history = initialUrl ? [initialUrl] : [];
            item.historyIndex = initialUrl ? 0 : -1;
            const loadUrl = (url) => {
                if(!url) return;
                if(!url.startsWith('http')) url = 'https://' + url;
                frame.src = url;
                input.value = url;
                if(item.history[item.historyIndex] !== url) {
                    item.history = item.history.slice(0, item.historyIndex + 1);
                    item.history.push(url);
                    item.historyIndex++;
                }
            };
            btn.onclick = (e) => { e.stopPropagation(); loadUrl(input.value.trim()); }; 
            input.addEventListener('keypress', (e) => { if(e.key === 'Enter') loadUrl(input.value.trim()); });
            input.addEventListener('mousedown', e => e.stopPropagation());
            
            backBtn.onclick = (e) => { e.stopPropagation(); if(item.historyIndex > 0) { item.historyIndex--; const url = item.history[item.historyIndex];
            frame.src = url; input.value = url; } };
            fwdBtn.onclick = (e) => { e.stopPropagation();
            if(item.historyIndex < item.history.length - 1) { item.historyIndex++; const url = item.history[item.historyIndex]; frame.src = url; input.value = url; } };
            refBtn.onclick = (e) => { e.stopPropagation(); frame.src = frame.src; };
        }
        // --- YouTube Player Functionality ---
function renderYouTubeContent(item) {
    const container = item.el.querySelector('.content-container');
    if(container.querySelector('.youtube-layout')) return;

    // 預設影片 (例如 Lofi Girl，也可以留空)
    const defaultId = "jfKfPfyJRdk"; 

    container.innerHTML = `
        <div class="youtube-layout" style="display:flex; flex-direction:column; width:100%; height:100%;">
            <div class="widget-header" style="padding:5px 10px; background:var(--bg-panel); border-bottom:1px solid var(--border-color); cursor:move; font-size:0.8em; color:var(--text-primary); display:flex; gap:5px; align-items:center;">
                <span style="font-weight:bold;">YOUTUBE</span>
                <input type="text" class="browser-input" id="yt-input-${item.id}" placeholder="Paste YouTube Link or ID" style="flex:1; font-size:0.8em;">
                <button class="browser-btn" id="yt-go-${item.id}">PLAY</button>
            </div>
            <div style="flex:1; background:#000; position:relative;">
                <iframe id="yt-frame-${item.id}" width="100%" height="100%" src="https://www.youtube.com/embed/${defaultId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>
    `;

    const input = container.querySelector(`#yt-input-${item.id}`);
    const btn = container.querySelector(`#yt-go-${item.id}`);
    const frame = container.querySelector(`#yt-frame-${item.id}`);

    // 防止輸入時觸發拖曳
    input.addEventListener('mousedown', e => e.stopPropagation());

    // 解析 YouTube 網址的函式
    const loadVideo = () => {
        let val = input.value.trim();
        if(!val) return;
        
        let videoId = val;
        // 簡單的正則表達式來抓取 ID
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = val.match(regExp);
        if (match && match[2].length === 11) {
            videoId = match[2];
        }

        frame.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
    };

    btn.onclick = (e) => { 
        e.stopPropagation(); 
        loadVideo(); 
    };

    input.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') loadVideo();
    });
}
        
        function setupInteractions(item) {
            const { el } = item, resizeHandle = el.querySelector('.item-resize'), menu = el.querySelector('.context-menu'), trigger = el.querySelector('.menu-trigger');
            el.addEventListener('mousedown', handleStart);
            el.addEventListener('touchstart', handleStart, {passive: false});

            function handleStart(e) {
                if(e.target === resizeHandle || e.target === trigger || menu.contains(e.target)) return; 
                if (['INPUT', 'BUTTON', 'SELECT', 'OPTION', 'TEXTAREA'].includes(e.target.tagName) || e.target.isContentEditable) return; 
                if (['news', 'chat', 'calc', 'note', 'browser', 'llama', 'tvnews', 'tvchart', 'tv-news', 'tv-eco', 'heatmap-stock', 'heatmap-crypto', 'heatmap-etf', 'ticker-tape', 'kanban', 'audio', 'pomodoro'].includes(item.type) && !e.target.closest('.widget-header')) return;
                if(e.type === 'touchstart') e.preventDefault();

                const startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
                const startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
                const startLeft = item.x;
                const startTop = item.y; 
                el.style.zIndex = 999;

                function onMove(ev) { 
                    const clientX = ev.type === 'mousemove' ? ev.clientX : ev.touches[0].clientX;
                    const clientY = ev.type === 'mousemove' ? ev.clientY : ev.touches[0].clientY;
                    const dx = clientX - startX;
                    const dy = clientY - startY; 
                    let rawX = startLeft + dx;
                    let rawY = startTop + dy; 
                    const maxW = parseInt(gridCanvas.style.width);
                    const maxH = parseInt(gridCanvas.style.height); 
                    if(rawX < 0) rawX = 0; 
                    if(rawY < 0) rawY = 0; 
                    if(rawX + item.w > maxW) rawX = maxW - item.w; 
                    if(rawY + item.h > maxH) rawY = maxH - item.h; 
                    el.style.left = rawX + 'px'; 
                    el.style.top = rawY + 'px'; 
                    // ★ 新增：即時更新數據以驅動線條
                    item.x = rawX;
                    item.y = rawY;
                    updateLines();
                    const snapX = snap(rawX);
                    const snapY = snap(rawY);
                    if (checkCollision({ ...item, x: snapX, y: snapY }, item.id)) el.classList.add('collision'); 
                    else el.classList.remove('collision');
                }

                function onUp(ev) { 
                    document.removeEventListener('mousemove', onMove); 
                    document.removeEventListener('mouseup', onUp);
                    document.removeEventListener('touchmove', onMove); 
                    document.removeEventListener('touchend', onUp); 
                    el.style.zIndex = ''; 
                    const finalX = snap(parseInt(el.style.left)); 
                    const finalY = snap(parseInt(el.style.top));
                    if (checkCollision({ ...item, x: finalX, y: finalY }, item.id)) { 
                        el.style.left = item.x + 'px'; 
                        el.style.top = item.y + 'px';
                    } else { 
                        item.x = finalX; 
                        item.y = finalY; 
                        el.style.left = finalX + 'px'; 
                        el.style.top = finalY + 'px';
                    } 
                    el.classList.remove('collision'); 
                }

                if (e.type === 'mousedown') {
                    document.addEventListener('mousemove', onMove); 
                    document.addEventListener('mouseup', onUp);
                } else {
                    document.addEventListener('touchmove', onMove, {passive: false}); 
                    document.addEventListener('touchend', onUp);
                }
            }

            resizeHandle.addEventListener('mousedown', handleResizeStart);
            resizeHandle.addEventListener('touchstart', handleResizeStart, {passive: false});

            function handleResizeStart(e) {
                e.stopPropagation(); 
                if(e.type === 'touchstart') e.preventDefault();

                const startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
                const startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
                const startW = item.w; 
                const startH = item.h;

                function onResize(ev) { 
                    const clientX = ev.type === 'mousemove' ? ev.clientX : ev.touches[0].clientX;
                    const clientY = ev.type === 'mousemove' ? ev.clientY : ev.touches[0].clientY;
                    const dx = clientX - startX; 
                    const dy = clientY - startY; 
                    let nw = snap(Math.max(MIN_W, startW + dx)); 
                    let nh = snap(Math.max(MIN_H, startH + dy)); 
                    if (checkCollision({ ...item, w: nw, h: nh }, item.id)) el.classList.add('collision'); 
                    else { 
                        el.classList.remove('collision'); 
                        el.style.width = nw + 'px'; 
                        el.style.height = nh + 'px'; 
                        item.w = nw;
                        item.h = nh;
                        updateLines();
                        if(item.type === 'clock') renderClockContent(item); 
                        if(item.type === 'weather') updateWeatherScale(item);
                        if(item.type === 'quote') updateQuoteScale(item);
                    } 
                }

                function onResizeUp() { 
                    document.removeEventListener('mousemove', onResize); 
                    document.removeEventListener('mouseup', onResizeUp);
                    document.removeEventListener('touchmove', onResize); 
                    document.removeEventListener('touchend', onResizeUp); 
                    el.classList.remove('collision'); 
                }

                if(e.type === 'mousedown') {
                    document.addEventListener('mousemove', onResize); 
                    document.addEventListener('mouseup', onResizeUp);
                } else {
                    document.addEventListener('touchmove', onResize, {passive: false}); 
                    document.addEventListener('touchend', onResizeUp);
                }
            }
        }
        function snap(v) { return Math.round(v / CELL_SIZE) * CELL_SIZE; }
        function checkCollision(target, ignoreId) { return items.some(i => { if (i.id === ignoreId) return false; return (target.x < i.x + i.w && target.x + target.w > i.x && target.y < i.y + i.h && target.y + target.h > i.y); }); }
        function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : { r: 0, g: 0, b: 0 }; }
        
        const handleGridResize = (e) => {
            e.stopPropagation(); 
            if(e.type === 'touchstart') e.preventDefault();
            const startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
            const startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
            const startW = parseInt(getComputedStyle(gridCanvas).width);
            const startH = parseInt(getComputedStyle(gridCanvas).height);
            
            function resizeGrid(ev) {
                const clientX = ev.type === 'mousemove' ? ev.clientX : ev.touches[0].clientX;
                const clientY = ev.type === 'mousemove' ? ev.clientY : ev.touches[0].clientY;
                const nw = Math.max(600, startW + (clientX - startX));
                const nh = Math.max(600, startH + (clientY - startY));
                gridCanvas.style.width = snap(nw) + 'px';
                gridCanvas.style.height = snap(nh) + 'px';
            }
            
            function stopResize() {
                document.removeEventListener('mousemove', resizeGrid);
                document.removeEventListener('touchmove', resizeGrid);
            }

            if(e.type === 'mousedown') {
                document.addEventListener('mousemove', resizeGrid);
                document.addEventListener('mouseup', stopResize, {once:true});
            } else {
                document.addEventListener('touchmove', resizeGrid, {passive: false});
                document.addEventListener('touchend', stopResize, {once:true});
            }
        };
        gridResizer.addEventListener('mousedown', handleGridResize);
        gridResizer.addEventListener('touchstart', handleGridResize, {passive: false});
        // ==================== 新功能函式庫 ====================

        // --- 1. 文字標籤功能 ---
        window.editLabel = function(id) {
            const item = items.find(i => i.id === id);
            if(!item) return;
            // 隱藏選單
            item.el.querySelector('.context-menu').classList.remove('show');
            
            const text = prompt("請輸入名稱 (Enter Name):", item.label || "");
            if (text !== null) {
                item.label = text;
                document.getElementById(`lbl-${id}`).innerText = text;
            }
        }

        window.removeLabel = function(id) {
            const item = items.find(i => i.id === id);
            if(item) {
                item.label = "";
                document.getElementById(`lbl-${id}`).innerText = "";
                item.el.querySelector('.context-menu').classList.remove('show');
            }
        }
        // --- 新增功能：個別物件變更顏色 ---
        window.setItemColor = function(id, color) {
            const item = items.find(i => i.id === id);
            if(item) {
                const rgb = hexToRgb(color);
                // 更新邊框顏色
                item.el.style.borderColor = color;
                // 更新背景顏色 (保持 10% 透明度)
                item.el.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`;
            }
        }

        // --- 2. 連線系統邏輯 ---
        function handleConnectClick(id) {
            if (!connectSource) {
                // 第一個點
                connectSource = id;
                alert(`已選取起點。請點擊第二個物件作為終點。`);
            } else {
                // 第二個點
                if (connectSource === id) {
                    alert("不能連接自己！");
                    return;
                }
                createConnection(connectSource, id);
                // 重置模式
                connectMode = false;
                connectSource = null;
                gridCanvas.style.cursor = 'default';
            }
        }

        function createConnection(sourceId, targetId) {
            // 檢查是否重複連線
            const exists = connections.find(c => (c.s === sourceId && c.t === targetId) || (c.s === targetId && c.t === sourceId));
            if (exists) return;

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('class', 'connection-line');

            line.style.stroke = activeColor;
            // 雙擊線條刪除
            line.addEventListener('dblclick', function() {
                if(confirm('刪除這條連線？')) {
                    svgLayer.removeChild(line);
                    connections = connections.filter(c => c.line !== line);
                }
            });

            svgLayer.appendChild(line);
            connections.push({ s: sourceId, t: targetId, line: line });
            updateLines(); // 立即繪製
        }

        function updateLines() {
            connections.forEach(conn => {
                const sItem = items.find(i => i.id === conn.s);
                const tItem = items.find(i => i.id === conn.t);
                
                if (sItem && tItem) {
                    // 計算中心點 (包含當前拖曳位置)
                    // 注意：這裡使用 sItem.x 而非 el.style.left，因為我們會在 onMove 更新 sItem.x
                    const x1 = sItem.x + sItem.w / 2;
                    const y1 = sItem.y + sItem.h / 2;
                    const x2 = tItem.x + tItem.w / 2;
                    const y2 = tItem.y + tItem.h / 2;

                    conn.line.setAttribute('x1', x1);
                    conn.line.setAttribute('y1', y1);
                    conn.line.setAttribute('x2', x2);
                    conn.line.setAttribute('y2', y2);
                }
            });
        }

        // 修改刪除函式：刪除物件時一併刪除線條
        
        deleteItem = function(id) { 
            const idx = items.findIndex(i => i.id === id);
            if (idx > -1) { 
                items[idx].el.remove(); 
                items.splice(idx, 1); 
                
                // 刪除相關連線
                const toRemove = connections.filter(c => c.s === id || c.t === id);
                toRemove.forEach(c => {
                    if(c.line) c.line.remove();
                });
                connections = connections.filter(c => c.s !== id && c.t !== id);
            } 
        }

        // --- 3. 關鍵修正：讓線條跟隨移動 ---
        // 我們需要攔截 setupInteractions 裡的移動事件，
        // 最簡單的方法是重新定義 setupInteractions 裡面的 onMove 邏輯。
        // 請務必確認 setupInteractions 內的 onMove 包含以下邏輯：
        /*
           item.x = rawX; 
           item.y = rawY;
           updateLines();
        */
  
    </script>
 <div id="terms-overlay" onclick="closeTerms(event)">
    <div class="terms-window">
        <div class="terms-inner">
            <div class="terms-header">
                <span>SYSTEM_INFO</span>
                <button class="terms-close-btn" onclick="closeTerms()">CLOSE [X]</button>
            </div>
            <div class="terms-content">
                <div style="margin-bottom: 25px;">
                     <span class="terms-label">WELCOME TRADER</span>
                     <p>歡迎使用 <strong style="color:var(--accent-color)">Brooklyn-Terminal</strong>，開源自定義生產力平台。</p>
                     <p>您可以從左側工具列表（Library / Tools）中，將所需的元件<span style="color:#fff; border-bottom:1px solid #555">拖曳</span>至中央的操作區，依照您的個人工作流喜好自由佈置版面。</p>
                </div>

                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                     <span class="terms-label">CONTACT</span>
                     <p> Email : <a href="mailto:coreinformation30@gmail.com" class="terms-link">coreinformation30@gmail.com</a></p>
                     <p> Instagram : <a href="https://www.instagram.com/br00klyn_weirdo/" target="_blank" class="terms-link">@br00klyn_weirdo</a></p>
                </div>
            </div>
            <div style="margin-top:20px; text-align:right; font-size:0.7em; color:var(--text-secondary); font-family:'Orbitron';">
                TERMINAL_ID: BROOKLYN_V11.04 01 // CONNECTED
            </div>
        </div>
    </div>
</div>
        <script src="https://cdn.busuanzi.cc/busuanzi/3.6.9/busuanzi.min.js" defer></script>
</body>
</html>
