
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2300ff9d%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5%22/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg-primary)',
                        surface: 'var(--bg-secondary)',
                        sidebar: 'var(--bg-sidebar)',
                        text: 'var(--text-primary)',
                        muted: 'var(--text-secondary)',
                        accent: 'var(--accent-color)',
                        border: 'var(--border-color)',
                        grid: 'var(--grid-color)',
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                        sans: ['"Inter"', '"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
      /* åŠ å…¥ style æ¨™ç±¤å…§ */
      /* éš±è—æ²è»¸ */
#canvas-scroll-container {
    background-color: #000000 !important; /* å¼·åˆ¶å…¨é»‘èƒŒæ™¯ */
    /* è®“æ“ä½œå€åœ¨ç•«é¢ä¸­ç•™ä¸€é»é‚Šè·ï¼Œçœ‹èµ·ä¾†åƒä¸€å¼µæ¡Œå­ä¸Šçš„åœ–ç´™ */
    padding: 50px; 
    
    /* éš±è—æ²è»¸ */
    scrollbar-width: none; 
    -ms-overflow-style: none;
}
#canvas-scroll-container::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
}
/* 2. æ“ä½œå€ (ç¶ è‰²å€åŸŸ)ï¼šè¨­å®šé‚Šæ¡†èˆ‡ç¶²æ ¼ */
#canvas-sizer {
    background-color: #0a100d;
    border: 2px solid var(--accent-color);
    box-shadow: 0 0 30px rgba(0, 255, 157, 0.15);
    
    margin: 0; /* æ”¹æˆ 0ï¼Œå–æ¶ˆæ°´å¹³ç½®ä¸­ */
    container-type: size;
    background-image: 
        linear-gradient(to right, rgba(0, 255, 157, 0.1) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0, 255, 157, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
}
/* 3. ä¿®æ­£åŸæœ¬çš„ grid-canvas èƒŒæ™¯ï¼Œç§»é™¤é‡è¤‡çš„ç¶²æ ¼è¨­å®š */
#grid-canvas {
    background: transparent !important; /* è®“å®ƒé€æ˜ï¼Œé¡¯ç¤º canvas-sizer çš„èƒŒæ™¯ */
}

        /* å®šç¾©ä¸»é¡Œè®Šæ•¸ */
        :root {
            /* é è¨­: è³½åšé¾å…‹ (Cyberpunk) - æ–°å¢éœ“è™¹è®Šæ•¸ */
            --bg-primary: #050505;
            --bg-secondary: #0a0a0a;
            --bg-sidebar: #080808;
            --text-primary: #e0e0e0;
            --text-secondary: #6b7280;
            --accent-color: #00ff9d; /* Neon Green */
            --accent-secondary: #ff0055; /* Neon Pink */
            --border-color: #1f1f1f;
            --grid-color: rgba(0, 255, 157, 0.15);
            --font-main: 'JetBrains Mono', monospace;
            
            /* éœ“è™¹å…‰æšˆè®Šæ•¸ (åƒ…åœ¨ Cyberpunk æ¨¡å¼ä¸‹ç”Ÿæ•ˆ) */
            --neon-text-shadow: 0 0 5px var(--accent-color), 0 0 10px var(--accent-color);
            --neon-box-shadow: 0 0 5px var(--accent-color), inset 0 0 5px rgba(0, 255, 157, 0.1);
        }

        /* ä¸»é¡Œ: é«˜ç´šå•†å‹™ (Premium Business) */
        [data-theme="business"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f1f5f9;
            --bg-sidebar: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --accent-color: #0284c7;
            --accent-secondary: #f59e0b; 
            --border-color: #cbd5e1;
            --grid-color: rgba(15, 23, 42, 0.08);
            --font-main: 'Inter', 'Noto Sans TC', sans-serif;
            --neon-text-shadow: none;
            --neon-box-shadow: none;
        }

        /* ä¸»é¡Œ: é–‹ç™¼è€… (Developer) */
        [data-theme="developer"] {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-sidebar: #252526;
            --text-primary: #d4d4d4;
            --text-secondary: #a1a1a1;
            --accent-color: #007acc;
            --accent-secondary: #ce9178;
            --border-color: #3e3e42;
            --grid-color: rgba(255, 255, 255, 0.05);
            --font-main: 'JetBrains Mono', monospace;
            --neon-text-shadow: none;
            --neon-box-shadow: none;
        }

        /* ä¸»é¡Œ: çµ‚ç«¯æ©Ÿ (Terminal) - æ”¹ç‚ºé§­å®¢ç¶  (Green Phosphor) */
        [data-theme="terminal"] {
            --bg-primary: #051105;      /* æ¥µæ·±ç¶ é»‘ */
            --bg-secondary: #0a1a0a;
            --bg-sidebar: #000000;
            --text-primary: #00ff33;    /* ç¶“å…¸è¢å…‰ç¶  */
            --text-secondary: #00cc29;  /* ç¨æš—çš„ç¶ è‰² */
            --accent-color: #00ff33;
            --accent-secondary: #00ff33;
            --border-color: #003300;
            --grid-color: rgba(0, 255, 51, 0.2);
            --font-main: 'Courier New', 'JetBrains Mono', monospace;
            --neon-text-shadow: none; /* çµ‚ç«¯æ©Ÿé¢¨æ ¼ä¿æŒéŠ³åˆ©ï¼Œä¸åŠ æšˆå…‰ */
            --neon-box-shadow: none;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-main);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }

        svg { color: var(--text-primary); }
        .text-muted svg { color: currentColor; }
        .text-accent svg { color: currentColor; }
        .text-red-500 svg { color: currentColor; }

        /* ç¶²æ ¼èƒŒæ™¯ç‰¹æ•ˆ */
        .grid-bg {
            background-size: 40px 40px;
            background-image:
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            mask-image: radial-gradient(circle at center, black 60%, transparent 100%);
        }

        .dots-bg {
            background-image: radial-gradient(var(--text-secondary) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.2;
        }

        .sidebar-transition {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        .popover-enter { opacity: 0; transform: translateY(10px) scale(0.95); }
        .popover-enter-active { opacity: 1; transform: translateY(0) scale(1); transition: opacity 0.2s, transform 0.2s; }
        
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s ease-out, transform 0.2s ease-out; }

        .nav-item:hover { background-color: rgba(255,255,255, 0.05); color: var(--accent-color); }
        
        [data-theme="business"] .nav-item:hover { background-color: rgba(0,0,0, 0.08); }
        [data-theme="business"] .nav-item:hover svg, [data-theme="business"] .nav-item:hover span { color: var(--accent-color); }
        
        .rotate-90 { transform: rotate(90deg); }
        
        .nav-active { color: var(--accent-color); background-color: rgba(255,255,255, 0.05); border-right: 2px solid var(--accent-color); }
        [data-theme="business"] .nav-active { background-color: rgba(0,0,0, 0.05); }
        [data-theme="terminal"] .nav-active { background-color: var(--text-primary); color: var(--bg-primary); border-right: none; }
        [data-theme="terminal"] .nav-active svg { color: var(--bg-primary); }

        /* --- è³½åšé¾å…‹å°ˆå±¬éœ“è™¹ç‰¹æ•ˆ --- */
        /* ç•¶æ²’æœ‰ data-theme (é è¨­) æˆ– data-theme="cyberpunk" æ™‚ç”Ÿæ•ˆ */
        :not([data-theme="business"]):not([data-theme="developer"]):not([data-theme="terminal"]) .text-accent,
        [data-theme="cyberpunk"] .text-accent {
            text-shadow: var(--neon-text-shadow);
        }

              :not([data-theme="business"]):not([data-theme="developer"]):not([data-theme="terminal"]) .border-accent,
              [data-theme="cyberpunk"] .border-accent {
              border: 1px solid var(--accent-color);
              box-shadow: var(--neon-box-shadow);
            }
        
        /* å°ˆæ¡ˆå…§å®¹çš„ç¯€é»å‹•ç•« */
        .node-appear { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0.5); }
        @keyframes popIn { to { opacity: 1; transform: scale(1); } }

        /* --- ç¶²æ ¼æ‹–æ›³é …ç›®æ¨£å¼ (ä»¿ APP.txt) --- */
        .grid-item { position: absolute; border: 1px solid rgba(255,255,255,0.3); box-sizing: border-box; display: flex; flex-direction: column; backdrop-filter: blur(5px); transition: box-shadow 0.2s, border-color 0.2s; border-radius: 4px; }
        .grid-item:hover { box-shadow: 0 0 20px rgba(255,255,255,0.2); z-index: 100; border-color: var(--accent-color); }
        .grid-item.collision { background-color: rgba(255, 0, 51, 0.2) !important; border-color: #ff0033 !important; box-shadow: 0 0 20px #ff0033; }
        .grid-item.circle { border-radius: 50%; }
        .grid-item.circle .content-container { display: flex; align-items: center; justify-content: center; }
        
        .item-label-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; text-align: center; pointer-events: none; z-index: 5; color: var(--text-primary); font-weight: bold; font-size: 1.2em; text-shadow: 0 0 5px rgba(0,0,0,0.8); word-wrap: break-word; }
        
        .item-resize { width: 15px; height: 15px; background: transparent; border-right: 2px solid var(--text-primary); border-bottom: 2px solid var(--text-primary); position: absolute; bottom: 2px; right: 2px; cursor: nwse-resize; z-index: 101; }
        
        .menu-trigger { position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; cursor: pointer; z-index: 102; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--text-secondary); border-radius: 50%; background: rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.2s; }
        .grid-item:hover .menu-trigger { opacity: 1; }
        .menu-trigger:hover { background: var(--accent-color); color: #000; }
        
        .context-menu { position: absolute; top: 30px; right: 5px; background: var(--bg-secondary); border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.8); border-radius: 4px; z-index: 9999; display: none; min-width: 140px; }
        .context-menu.show { display: block; }
        .context-menu-item { padding: 8px 12px; cursor: pointer; font-size: 12px; color: var(--text-primary); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .context-menu-item:hover { background: rgba(255,255,255,0.1); }
        .context-menu-item.danger:hover { background: rgba(255,255,255,0.1); color: #ff0033; }

        /* é€£ç·š SVG */
        #connections-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .connection-line { stroke: var(--accent-color); stroke-width: 2px; opacity: 0.6; transition: stroke 0.3s; pointer-events: auto; cursor: pointer; }
        .connection-line:hover { stroke: #fff; opacity: 1; stroke-width: 4px; }

        /* è¦–çª—åŒ– Widget æ¨£å¼ */
        .widget-header { cursor: move; }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden selection:bg-accent selection:text-bg">

    <div id="global-context-menu" class="fixed hidden bg-surface border border-border rounded shadow-xl z-50 p-1 w-32 backdrop-blur-md">
        <button id="global-edit-btn" class="w-full text-left px-3 py-2 text-xs text-text hover:bg-accent hover:text-bg rounded transition-colors flex items-center gap-2">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
            <span data-i18n="edit">Edit</span>
        </button>
    </div>

    <div id="add-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-surface border border-border p-6 rounded-lg w-96 shadow-2xl transform transition-all modal-enter border-accent" id="modal-content">
            <h3 class="text-lg font-bold text-accent mb-4 tracking-wider" data-i18n="modal_title">NEW WORKSPACE NODE</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-muted mb-1 uppercase font-bold" data-i18n="modal_name">Section Name</label>
                    <input type="text" id="new-section-name" class="w-full bg-bg border border-border rounded px-3 py-2 text-sm text-text focus:border-accent focus:outline-none transition-colors" placeholder="e.g. Project Omega">
                </div>
                <div>
                    <label class="block text-xs text-muted mb-1 uppercase font-bold" data-i18n="modal_desc">Description</label>
                    <textarea id="new-section-desc" rows="3" class="w-full bg-bg border border-border rounded px-3 py-2 text-sm text-text focus:border-accent focus:outline-none transition-colors" placeholder="Brief description..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal()" class="px-4 py-2 text-xs font-bold text-muted hover:text-text transition-colors" data-i18n="modal_cancel">CANCEL</button>
                <button onclick="confirmAddSection()" class="px-4 py-2 text-xs font-bold bg-accent text-bg rounded hover:bg-opacity-90 transition-colors" data-i18n="modal_confirm">CONFIRM</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-surface border border-border p-6 rounded-lg w-[450px] shadow-2xl transform transition-all modal-enter border-accent" id="edit-modal-content">
            <h3 class="text-lg font-bold text-accent mb-4 tracking-wider" data-i18n="edit_modal_title">EDIT WORKSPACE</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-muted mb-1 uppercase font-bold" data-i18n="modal_name">Section Name</label>
                    <input type="text" id="edit-section-name" class="w-full bg-bg border border-border rounded px-3 py-2 text-sm text-text focus:border-accent focus:outline-none transition-colors">
                </div>
                <div>
                    <label class="block text-xs text-muted mb-1 uppercase font-bold" data-i18n="modal_desc">Description</label>
                    <textarea id="edit-section-desc" rows="2" class="w-full bg-bg border border-border rounded px-3 py-2 text-sm text-text focus:border-accent focus:outline-none transition-colors"></textarea>
                </div>

                <div>
                    <label class="block text-xs text-muted mb-2 uppercase font-bold" data-i18n="edit_members">Invite Members (Email)</label>
                    <div class="flex gap-2 mb-2">
                        <input type="email" id="new-member-input" class="flex-1 bg-bg border border-border rounded px-3 py-1.5 text-xs text-text focus:border-accent focus:outline-none" placeholder="friend@example.com" onkeypress="handleMemberInputKey(event)">
                        <button onclick="addMember()" class="px-3 py-1.5 bg-white/5 border border-border rounded text-xs hover:text-accent hover:border-accent transition-colors">+</button>
                    </div>
                    <div id="members-list" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-1">
                        </div>
                </div>
            </div>

            <div class="border-t border-border mt-6 pt-4 flex justify-between items-center">
                <button onclick="deleteWorkspace()" class="px-3 py-2 text-xs font-bold text-red-500 border border-red-500/50 bg-red-500/10 rounded hover:bg-red-500 hover:text-white transition-all flex items-center gap-2 group">
                    <svg class="w-3 h-3 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <span data-i18n="delete_workspace">DELETE</span>
                </button>

                <div class="flex gap-3">
                    <button onclick="closeEditModal()" class="px-4 py-2 text-xs font-bold text-muted hover:text-text transition-colors" data-i18n="modal_cancel">CANCEL</button>
                    <button onclick="saveEditWorkspace()" class="px-4 py-2 text-xs font-bold bg-accent text-bg rounded hover:bg-opacity-90 transition-colors" data-i18n="modal_save">SAVE</button>
                </div>
            </div>
        </div>
    </div>

    <aside id="sidebar" class="sidebar-transition h-full flex flex-col justify-between border-r border-border bg-sidebar z-20 w-64 relative group">
        
        <div class="flex flex-col">
            <div class="h-16 flex items-center justify-between px-4 border-b border-border">
                <div id="logo-container" class="flex items-center gap-3 overflow-hidden whitespace-nowrap">
                    <svg class="w-8 h-8 text-accent min-w-[32px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"></path>
                    </svg>
                    <span class="font-bold tracking-wider text-lg transition-opacity duration-300 sidebar-text text-text">WORKSPACE</span>
                </div>
                <button id="toggle-sidebar" class="p-1 rounded hover:bg-white/10 text-muted hover:text-accent transition-colors">
                    <svg id="toggle-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                    </svg>
                </button>
            </div>

            <nav class="flex-1 py-6 px-3 space-y-4 overflow-y-auto" id="sidebar-nav">
                
                <button onclick="openModal()" class="w-full flex items-center gap-3 px-3 py-3 rounded-md text-sm border border-dashed border-border text-muted hover:text-accent hover:border-accent transition-all group">
                    <svg class="w-5 h-5 min-w-[20px] text-muted group-hover:text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span class="sidebar-text whitespace-nowrap" data-i18n="add_tool_section">Add Tool Section</span>
                </button>

                <div>
                    <button onclick="toggleWorkspace()" class="w-full flex items-center gap-2 px-2 py-2 rounded-md text-sm text-text hover:bg-white/5 transition-all group">
                        <svg id="workspace-arrow" class="w-4 h-4 min-w-[16px] text-muted transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="sidebar-text whitespace-nowrap font-semibold tracking-wide" data-i18n="my_workspace">My Workspace</span>
                    </button>
                    <div id="workspace-list" class="hidden pl-4 mt-1 border-l border-border ml-4 space-y-1">
                        <div class="px-3 py-2 text-xs text-muted italic" id="loading-text">Loading...</div>
                    </div>
                </div>
                
                <!-- å·¥å…·é–“ (Tool Room) -->
                <div>
                    <button onclick="toggleTools()" class="w-full flex items-center gap-2 px-2 py-2 rounded-md text-sm text-text hover:bg-white/5 transition-all group">
                        <svg id="tools-arrow" class="w-4 h-4 min-w-[16px] text-muted transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="sidebar-text whitespace-nowrap font-semibold tracking-wide" data-i18n="tools_section">Tool Room</span>
                    </button>
                    <div id="tools-list" class="hidden pl-4 mt-1 border-l border-border ml-4 space-y-1">
                        <!-- æ–°å¢çš„å·¥å…·ï¼šç©ºè¦–çª— -->
                        <div class="tool-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-text hover:bg-white/5 transition-all cursor-grab group border border-transparent hover:border-accent" draggable="true" id="tool-empty">
                            <div class="w-5 h-5 flex items-center justify-center bg-white/10 rounded text-xs border border-muted group-hover:border-accent">â–¡</div>
                            <span class="sidebar-text whitespace-nowrap">Empty Window</span>
                        </div>
                    </div>
                </div>

            </nav>
        </div>

        <div class="p-3 border-t border-border bg-surface/50 relative">
            
            <div id="tool-row" class="flex gap-2 mb-3">
                <div class="relative flex-1">
                    <button id="lang-btn" class="w-full flex items-center justify-center gap-2 px-2 py-2 rounded-md hover:bg-white/5 text-muted hover:text-accent transition-colors" title="Language">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                    <div id="lang-menu" class="hidden absolute bottom-full left-0 w-32 mb-2 bg-sidebar border border-border rounded-lg shadow-xl overflow-hidden z-50 p-1">
                        <button onclick="setLanguage('en')" class="w-full text-left px-3 py-2 text-xs hover:bg-accent hover:text-bg rounded">English</button>
                        <button onclick="setLanguage('zh')" class="w-full text-left px-3 py-2 text-xs hover:bg-accent hover:text-bg rounded">ç¹é«”ä¸­æ–‡</button>
                    </div>
                </div>

                <div class="relative flex-1">
                    <button id="theme-btn" class="w-full flex items-center justify-center gap-2 px-2 py-2 rounded-md hover:bg-white/5 text-muted hover:text-accent transition-colors" title="Appearance">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </button>
                    <div id="theme-menu" class="hidden absolute bottom-full left-0 w-48 mb-2 bg-sidebar border border-border rounded-lg shadow-xl overflow-hidden z-50 p-1">
                        <button onclick="setTheme('business')" id="opt-business" class="w-full text-left px-3 py-2 text-xs text-text hover:bg-accent hover:text-bg rounded flex items-center gap-2">Business</button>
                        <button onclick="setTheme('developer')" id="opt-developer" class="w-full text-left px-3 py-2 text-xs text-text hover:bg-accent hover:text-bg rounded flex items-center gap-2">Developer</button>
                        <button onclick="setTheme('terminal')" id="opt-terminal" class="w-full text-left px-3 py-2 text-xs text-text hover:bg-accent hover:text-bg rounded flex items-center gap-2">Terminal</button>
                        <button onclick="setTheme('cyberpunk')" id="opt-cyberpunk" class="w-full text-left px-3 py-2 text-xs text-text hover:bg-accent hover:text-bg rounded flex items-center gap-2">Cyberpunk</button>
                    </div>
                </div>

<div class="relative flex-1">
                    <button id="style-btn" class="w-full flex items-center justify-center gap-2 px-2 py-2 rounded-md hover:bg-white/5 text-muted hover:text-accent transition-colors" title="Canvas Style">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>
                    </button>
                    
                    <div id="style-menu" class="hidden absolute bottom-full left-0 w-48 mb-2 bg-sidebar border border-border rounded-lg shadow-xl overflow-hidden z-50 p-3 space-y-3">
                        <div class="text-xs font-bold text-accent tracking-wider mb-1">CANVAS STYLE</div>
                        
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-muted">Background</label>
                            <input type="color" id="input-bg-color" class="w-6 h-6 bg-transparent border-0 cursor-pointer" value="#0a100d">
                        </div>

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-muted">Border</label>
                            <input type="color" id="input-border-color" class="w-6 h-6 bg-transparent border-0 cursor-pointer" value="#00ff9d">
                        </div>

                        <hr class="border-white/10">

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-muted">Grid Color</label>
                            <input type="color" id="input-grid-color" class="w-6 h-6 bg-transparent border-0 cursor-pointer" value="#00ff9d">
                        </div>

                        <div class="space-y-1">
                            <div class="flex justify-between text-xs text-muted">
                                <span>Grid Opacity</span>
                                <span id="grid-opacity-val">10%</span>
                            </div>
                            <input type="range" id="input-grid-opacity" min="0" max="100" value="10" class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-accent">
                        </div>
                    </div>
                </div>
<!-- Canvas Size æŒ‰éˆ•ï¼šåªé¡¯ç¤º SVG åœ–ç¤ºï¼Œé»æ“Šå‘¼å« resizeCanvasPrompt() -->
<div class="relative flex-1">
    <button id="canvas-size-btn"
            onclick="resizeCanvasPrompt()"
            class="w-full flex items-center justify-center px-2 py-2 rounded-md hover:bg-white/5 text-muted hover:text-accent transition-colors"
            title="Canvas Size">
        <!-- ä½ åŸæœ¬çš„ç¸®æ”¾åœ–ç¤º SVGï¼Œä¿ç•™å³å¯ -->
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
            </path>
        </svg>
    </button>
</div>
    
            </div>

            <div id="auth-container" class="pt-3 border-t border-border">
                
                <button id="btn-login" class="w-full flex items-center justify-center gap-2 bg-white text-black px-3 py-2 rounded-md hover:bg-gray-200 transition-colors font-bold text-sm shadow-lg shadow-white/10">
                    <svg width="16" height="16" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"></path>
                        <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"></path>
                        <path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"></path>
                        <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.159 6.656 3.58 9 3.58z" fill="#EA4335"></path>
                    </svg>
                    <span class="whitespace-nowrap">Sign in</span>
                </button>

                <div id="user-profile" class="hidden flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors group relative border border-transparent hover:border-border">
                    <img id="user-avatar" src="" alt="User" class="w-8 h-8 rounded-full border border-border group-hover:border-accent transition-colors object-cover bg-surface">
                    
                    <div class="flex flex-col overflow-hidden sidebar-text flex-1">
                        <span id="user-name" class="text-xs font-bold text-text truncate">User Name</span>
                        <span id="user-email" class="text-[10px] text-muted truncate">email@example.com</span>
                    </div>

                    <div id="logout-menu" class="absolute bottom-full left-0 w-full mb-2 hidden pb-1 z-50">
                        <button id="btn-logout" class="w-full bg-surface border border-border text-red-500 px-3 py-2 rounded shadow-xl text-xs font-bold hover:bg-red-500/10 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Log Out
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </aside>

   <main class="relative flex-1 h-full bg-bg">
    <!-- èƒŒæ™¯é»é» -->
    <div class="absolute inset-0 dots-bg pointer-events-none z-0"></div>

    <!-- ğŸ”¹ ä¸Šæ–¹å·¥å…·åˆ—ï¼šå›ºå®šåœ¨ main é ‚éƒ¨ï¼Œä¸æ²å‹• -->
    <div class="absolute inset-x-0 top-0 h-12 border-b border-border flex items-center justify-between px-6 bg-surface/50 backdrop-blur z-20 border-accent">
        <div class="text-sm font-mono text-muted flex items-center">
            <span class="text-accent mr-2">&gt;</span>
            <span class="hover:text-text cursor-pointer transition-colors" onclick="resetBreadcrumb()">Workspace</span>
            <span id="breadcrumb-separator" class="mx-2 hidden">/</span>
            <span id="breadcrumb-current" class="text-text font-bold hidden ml-2 text-accent"></span>
        </div>

        <div class="text-sm font-mono text-muted flex items-center"></div>

        <div id="online-users-container" class="flex-1 flex justify-end items-center px-4 gap-2 hidden">
            <span class="text-[10px] text-muted uppercase tracking-widest">Active:</span>
            <div id="online-avatars" class="flex -space-x-2 overflow-hidden"></div>
        </div>
    </div>

    <!-- ğŸ”¹ ä¸‹æ–¹æ“ä½œå€ï¼šç¨ç«‹çš„å¯æ²å‹•å€å¡Šï¼ˆæ°´å¹³ï¼‹å‚ç›´ï¼‰ -->
    <div id="canvas-scroll-container"
         class="absolute inset-x-0 bottom-0 top-12 overflow-auto bg-bg cursor-default z-10">
        <div id="canvas-sizer"
             class="relative border border-grid flex flex-col overflow-hidden resize"
             style="width: 600px; height: 600px;">

            <div id="grid-canvas" class="relative w-full h-full">
                <svg id="connections-layer" class="w-full h-full"></svg>
            </div>

            <div id="empty-state-container"
                 class="absolute top-0 left-0 w-full h-[calc(100vh-100px)] z-10 flex items-center justify-center pointer-events-none">
                <div class="text-center space-y-4 pointer-events-auto">
                    <!-- ä½ çš„ + æŒ‰éˆ•èˆ‡æ–‡å­— -->
                    ...
                </div>
            </div>

            <div id="project-content-container"
                 class="hidden relative z-10 w-full h-full p-6 overflow-hidden">
            </div>
        </div>
    </div>
</main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, orderBy, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAIwisA_UnOiNRVwYE6tJV47Sp3_1i19IM",
            authDomain: "brooklyn-terminal.firebaseapp.com",
            projectId: "brooklyn-terminal",
            storageBucket: "brooklyn-terminal.firebasestorage.app",
            messagingSenderId: "438411734316",
            appId: "1:438411734316:web:649051890cf381eb0fd089",
            measurementId: "G-G0GMW0XHG1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        const appId = 'brooklyn-terminal-v1';

        const loginBtn = document.getElementById('btn-login');
        const userProfile = document.getElementById('user-profile');
        const logoutMenu = document.getElementById('logout-menu');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const logoutBtn = document.getElementById('btn-logout');
        const emptyDescText = document.getElementById('empty-desc-text');

        let currentUser = null;
        let unsubscribeProjects = null;

        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => alert("Login Error: " + error.message));
        });

        logoutBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            window.currentUser = user;
            if (user) {
                loginBtn.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userProfile.classList.add('flex');
                userAvatar.src = user.photoURL || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + user.uid;
                userName.textContent = user.displayName || 'User';
                userEmail.textContent = user.email;
                
                emptyDescText.textContent = "";
                
                initWorkspaceListener(user);
            } else {
                loginBtn.classList.remove('hidden');
                userProfile.classList.add('hidden');
                userProfile.classList.remove('flex');
                
                emptyDescText.textContent = "Please sign in to access or create workspaces.";
                
              if (unsubscribeProjects) unsubscribeProjects();
              if (window.updateProjectsList) window.updateProjectsList([]);
              if (window.resetBreadcrumb) window.resetBreadcrumb();;
            }
        });

        function initWorkspaceListener(user) {
    const q = query(
        collection(db, 'artifacts', appId, 'public', 'data', 'workspaces'),
        where('members', 'array-contains', user.email)
    );

    unsubscribeProjects = onSnapshot(q, (snapshot) => {
        const projects = [];
        snapshot.forEach((doc) => {
            projects.push({ id: doc.id, ...doc.data() });
        });
        if (window.updateProjectsList) {
            window.updateProjectsList(projects);
        }
    }, (error) => {
        console.error("Data fetch error:", error);

        // â˜… æŠŠ Loading æ”¹æˆéŒ¯èª¤æç¤º
        const loadingText = document.getElementById('loading-text');
        if (loadingText) {
            loadingText.textContent = 'è®€å–å¤±æ•—: ' + (error.code || error.message);
            loadingText.classList.remove('italic');
        }
    });
}
        
        window.dbCreateProject = async (name, desc, nodes) => {
            if (!currentUser) return alert("Please login first!");
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'workspaces'), {
                    name: name,
                    desc: desc,
                    ownerId: currentUser.uid,
                    ownerEmail: currentUser.email,
                    members: [currentUser.email], 
                    nodes: nodes,
                    createdAt: new Date().toISOString()
                });
            } catch (e) {
                console.error("Error adding doc: ", e);
                alert("Error creating workspace: " + e.message);
            }
        };
        

        window.dbUpdateProject = async (projectId, data) => {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'workspaces', projectId);
            try {
                await updateDoc(docRef, data);
            } catch (e) {
                console.error("Error updating doc: ", e);
            }
        };
        // å°‡ç•«é¢ä¸Šçš„ç‰©ä»¶åŒæ­¥å›è³‡æ–™åº«
      
        window.dbDeleteProject = async (projectId) => {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'workspaces', projectId);
            try {
                await deleteDoc(docRef);
            } catch (e) {
                console.error("Error deleting doc: ", e);
            }
        };
        
        window.isUserLoggedIn = () => {
            return !!currentUser;
        }
        // çµ¦å‰ç«¯ç”¨ï¼šè¨‚é–±å–®ä¸€ workspace æ–‡ä»¶
// å›å‚³å€¼æ˜¯ unsubscribe function
window.subscribeWorkspace = (workspaceId, onChange) => {
    const docRef = doc(
        db,
        'artifacts',
        appId,
        'public',
        'data',
        'workspaces',
        workspaceId
    );

    return onSnapshot(docRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        // æŠŠ id ä¸€èµ·å›å‚³ï¼Œå‰ç«¯æ¯”è¼ƒå¥½ç”¨
        window.isRemoteUpdate = true;
        onChange({ id: snap.id, ...data });
        window.isRemoteUpdate = false;
    }, (err) => {
        console.error('workspace snapshot error:', err);
    });
};
       
    </script>
    <script>
        // State
        const state = {
            sidebarOpen: true,
            theme: 'cyberpunk',
            lang: 'en',
            currentProjectId: null,
            editingProjectId: null,
            tempMembers: [],
            projects: [] 
        };

        const translations = {
            en: {
                add_tool_section: 'Add Tool Section',
                my_workspace: 'My Workspace',
                tools_section: 'Tool Room', 
                language: 'Language',
                appearance: 'Appearance',
                select_theme: 'SELECT THEME',
                theme_business: 'Premium Business',
                theme_dev: 'Developer',
                theme_terminal: 'Terminal',
                theme_cyber: 'Cyberpunk',
                empty_state: '',
                empty_desc: '',
                modal_title: 'NEW WORKSPACE NODE',
                modal_name: 'SECTION NAME',
                modal_desc: 'DESCRIPTION',
                modal_cancel: 'CANCEL',
                modal_confirm: 'CONFIRM',
                edit_modal_title: 'EDIT WORKSPACE',
                edit_members: 'MEMBERS (EMAIL)',
                delete_workspace: 'DELETE WORKSPACE',
                modal_save: 'SAVE',
                edit: 'Edit'
            },
            zh: {
                add_tool_section: 'æ–°å¢å·¥å…·å€é–“',
                my_workspace: 'æˆ‘çš„å·¥ä½œå€é–“',
                tools_section: 'å·¥å…·é–“',    
                language: 'èªè¨€è¨­å®š',
                appearance: 'å¤–è§€é¢¨æ ¼',
                select_theme: 'é¸æ“‡ä¸»é¡Œ',
                theme_business: 'å•†å‹™äººå£«',
                theme_dev: 'é–‹ç™¼è€…',
                theme_terminal: 'çµ‚ç«¯æ©Ÿ',
                theme_cyber: 'è³½åšé¾å…‹',
                empty_state: '',
                empty_desc: '',
                modal_title: 'å»ºç«‹æ–°å·¥ä½œå€é–“',
                modal_name: 'å€é–“åç¨±',
                modal_desc: 'æè¿°',
                modal_cancel: 'å–æ¶ˆ',
                modal_confirm: 'ç¢ºèªæ–°å¢',
                edit_modal_title: 'ç·¨è¼¯å·¥ä½œå€é–“',
                edit_members: 'æˆå“¡åå–® (Email)',
                delete_workspace: 'åˆªé™¤å·¥ä½œå€',
                modal_save: 'å„²å­˜',
                edit: 'ç·¨è¼¯'
            }
        };

        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggle-sidebar');
        const toggleIcon = document.getElementById('toggle-icon');
        const textElements = document.querySelectorAll('.sidebar-text');
        const langBtn = document.getElementById('lang-btn');
        const langMenu = document.getElementById('lang-menu');
        const themeBtn = document.getElementById('theme-btn');
        const themeMenu = document.getElementById('theme-menu');
        const styleBtn = document.getElementById('style-btn');
        const styleMenu = document.getElementById('style-menu');
        const inputBgColor = document.getElementById('input-bg-color');
        const inputBorderColor = document.getElementById('input-border-color');
        const inputGridColor = document.getElementById('input-grid-color');
        const inputGridOpacity = document.getElementById('input-grid-opacity');
        const gridOpacityVal = document.getElementById('grid-opacity-val');
        const canvasSizer = document.getElementById('canvas-sizer');
        const modal = document.getElementById('add-modal');
        const modalContent = document.getElementById('modal-content');
        const nameInput = document.getElementById('new-section-name');
        const descInput = document.getElementById('new-section-desc');
        const editModal = document.getElementById('edit-modal');
        const editModalContent = document.getElementById('edit-modal-content');
        const editNameInput = document.getElementById('edit-section-name');
        const editDescInput = document.getElementById('edit-section-desc');
        const membersList = document.getElementById('members-list');
        const newMemberInput = document.getElementById('new-member-input');
        const breadcrumbSep = document.getElementById('breadcrumb-separator');
        const breadcrumbCurrent = document.getElementById('breadcrumb-current');
        const emptyState = document.getElementById('empty-state-container');
        const projectContent = document.getElementById('project-content-container');
        const workspaceList = document.getElementById('workspace-list');
        const workspaceArrow = document.getElementById('workspace-arrow');
        const globalContextMenu = document.getElementById('global-context-menu');
        const globalEditBtn = document.getElementById('global-edit-btn');
        
        const userProfile = document.getElementById('user-profile');
        const logoutMenu = document.getElementById('logout-menu');
        
        // æ‹–æ›³ç›¸é—œå…¨åŸŸè®Šæ•¸
        const gridCanvas = document.getElementById('grid-canvas');
        const CELL_SIZE = 20, MIN_W = CELL_SIZE * 4, MIN_H = CELL_SIZE * 4;
        let items = []; // å­˜å„²ç•«é¢ä¸Šçš„ç‰©ä»¶
        let activeColor = '#00ff9d'; // é è¨­å¼·èª¿è‰²

        let activeContextProjectId = null;
        let unsubscribeCurrentProject = null; // æ–°å¢ï¼šç”¨ä¾†å–æ¶ˆèˆŠå°ˆæ¡ˆçš„å³æ™‚ç›£è½
        window.isRemoteUpdate = false;  
        let isRemoteUpdate = false; // æ–°å¢ï¼šé˜²æ­¢åŒæ­¥è¿´åœˆ (æ¥æ”¶è³‡æ–™æ™‚ä¸è§¸ç™¼å„²å­˜)
        // --- æ–°å¢ï¼šPresence ç›¸é—œè®Šæ•¸ ---
        let unsubscribePresence = null;
        let presenceInterval = null;

        // --- Data Sync ---
        window.updateProjectsList = (projects) => {
            state.projects = projects;
            renderWorkspaceList();
            
            if (state.currentProjectId && !projects.find(p => p.id === state.currentProjectId)) {
                resetBreadcrumb();
            } else if (state.currentProjectId) {
                const current = projects.find(p => p.id === state.currentProjectId);
                renderProjectGrid(current);
            }
        };

        // --- UI Logic ---

        window.handlePlusClick = () => {
            if (window.isUserLoggedIn && window.isUserLoggedIn()) {
                openModal();
            } else {
                alert("Please Sign In first using the button in the sidebar.");
            }
        };

        window.openModal = () => { modal.classList.remove('hidden'); setTimeout(() => modalContent.classList.add('modal-enter-active'), 10); nameInput.focus(); };
        window.closeModal = () => { modalContent.classList.remove('modal-enter-active'); setTimeout(() => { modal.classList.add('hidden'); nameInput.value = ''; descInput.value = ''; }, 200); };
        
        window.confirmAddSection = () => {
            const name = nameInput.value.trim();
            const desc = descInput.value.trim();
            if (name) {
                if(window.dbCreateProject) {
                   window.dbCreateProject(name, desc, []);
                }
                closeModal();
            } else {
                nameInput.classList.add('border-red-500'); setTimeout(() => nameInput.classList.remove('border-red-500'), 1000);
            }
        };

        userProfile.addEventListener('click', (e) => {
            e.stopPropagation(); 
            if (logoutMenu.classList.contains('hidden')) {
                langMenu.classList.add('hidden');
                themeMenu.classList.add('hidden');
                globalContextMenu.classList.add('hidden');
                
                logoutMenu.classList.remove('hidden');
                logoutMenu.classList.add('popover-enter-active'); 
            } else {
                logoutMenu.classList.add('hidden');
                logoutMenu.classList.remove('popover-enter-active');
            }
        });
        
        function renderWorkspaceList() {
            workspaceList.innerHTML = '';
            if (state.projects.length === 0) {
                workspaceList.innerHTML = '<div class="px-3 py-2 text-xs text-muted italic opacity-50">No workspaces found.</div>';
                return;
            }

            state.projects.forEach(proj => {
                const container = document.createElement('div');
                container.className = "group relative flex items-center w-full rounded hover:bg-white/5 transition-colors pr-1 mb-1 border-accent";
                if(proj.id === state.currentProjectId) {
                     container.classList.add('bg-white/5', 'border-r-2');
                     if(state.theme === 'terminal') { container.classList.remove('border-r-2', 'border-accent'); container.classList.add('bg-text', 'text-bg'); }
                }

                const btn = document.createElement('button');
                btn.className = "flex-1 text-left block px-3 py-2 text-xs text-muted hover:text-accent transition-colors sidebar-text truncate";
                btn.textContent = proj.name;
                if(state.theme === 'terminal' && proj.id === state.currentProjectId) { btn.classList.remove('text-muted', 'hover:text-accent'); btn.classList.add('text-bg'); }
                btn.onclick = function() { selectWorkspaceItem(proj.id); };

                const menuBtn = document.createElement('button');
                menuBtn.className = "p-1 opacity-0 group-hover:opacity-100 transition-opacity text-muted hover:text-accent shrink-0 focus:outline-none";
                menuBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>`;
                menuBtn.onclick = function(e) { e.stopPropagation(); showGlobalContextMenu(e, proj.id); };

                container.appendChild(btn);
                container.appendChild(menuBtn);
                workspaceList.appendChild(container);
            });
            
            if (workspaceList.classList.contains('hidden') && state.projects.length > 0) {
                workspaceList.classList.remove('hidden');
                workspaceArrow.classList.add('rotate-90');
            }
        }
        // åˆ‡æ›ç›®å‰é¸ä¸­çš„ workspaceï¼Œä¸¦è¨‚é–±è©² workspace çš„å³æ™‚è®ŠåŒ–ï¼ˆUI ç‰ˆæœ¬ï¼‰
window.selectWorkspaceItem = (projectId) => {
    // å¦‚æœæœ¬ä¾†å°±é¸é€™å€‹ï¼Œå°±ä¸ç”¨å†åš
    if (state.currentProjectId === projectId) return;

    // å…ˆå–æ¶ˆä¸Šä¸€å€‹ workspace çš„è¨‚é–±
    if (unsubscribeCurrentProject) {
        unsubscribeCurrentProject();
        unsubscribeCurrentProject = null;
    }

    state.currentProjectId = projectId;

    // æ›´æ–° breadcrumb
    const proj = state.projects.find(p => p.id === projectId);
    breadcrumbSep.classList.remove('hidden');
    breadcrumbCurrent.classList.remove('hidden');
    breadcrumbCurrent.textContent = proj ? proj.name : '';

    // é¡¯ç¤ºå·¥ä½œå€å…§å®¹ã€éš±è—ç©ºç‹€æ…‹
    emptyState.classList.add('hidden');
    projectContent.classList.remove('hidden');

    // æ¸…æ‰ç›®å‰ç•«é¢ä¸Šçš„ nodes
    items.forEach(i => i.el.remove());
    items = [];

    // é‡æ–°ç•« headerï¼ˆOWNER / MEMBERS / DESC é‚£è¡Œï¼‰
    if (proj) {
        renderProjectGrid(proj);
    }

    // é–‹å§‹è¨‚é–±é€™å€‹ workspace æ–‡ä»¶ï¼ˆé‡é»ï¼šé€™è£¡å•Ÿç”¨å¤šä½¿ç”¨è€…åŒæ­¥ï¼‰
    if (window.subscribeWorkspace) {
        unsubscribeCurrentProject = window.subscribeWorkspace(projectId, (projectData) => {
            // é€™è£¡æœƒåœ¨ä»»ä½•äººæ›´æ–° nodes æ™‚è¢«å‘¼å«ï¼ˆåŒ…å«è‡ªå·±ï¼‰
            isRemoteUpdate = true;

            // æ›´æ–° header
            renderProjectGrid(projectData);

            // å…ˆæ¸…æ‰èˆŠçš„ nodes
            items.forEach(i => i.el.remove());
            items = [];

            const nodes = projectData.nodes || [];
            nodes.forEach(n => {
                // æ³¨æ„ï¼šæŠŠ savedItem å‚³é€²å»ï¼ŒcreateItem è£¡å°±ä¸æœƒå†å‘¼å« saveProjectState()
                createItem(
                    n.x,
                    n.y,
                    n.w,
                    n.h,
                    n.color || activeColor,
                    n.type || 'empty-window',
                    n            // savedItem
                );
            });

            isRemoteUpdate = false;
        });
    }
    startPresenceSystem(projectId);
};

        function showGlobalContextMenu(e, projectId) {
            activeContextProjectId = projectId;
            const rect = e.currentTarget.getBoundingClientRect();
            globalEditBtn.onclick = () => { openEditProjectModal(activeContextProjectId); globalContextMenu.classList.add('hidden'); };
            globalContextMenu.style.top = `${rect.bottom}px`;
            globalContextMenu.style.left = `${rect.right - 10}px`;
            globalContextMenu.classList.remove('hidden');
        }

        window.openEditProjectModal = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if(!project) return;
            state.editingProjectId = projectId;
            state.tempMembers = project.members ? [...project.members] : [];
            editNameInput.value = project.name;
            editDescInput.value = project.desc || '';
            renderEditMembers();
            editModal.classList.remove('hidden');
            setTimeout(() => editModalContent.classList.add('modal-enter-active'), 10);
        };

        window.closeEditModal = () => {
            editModalContent.classList.remove('modal-enter-active');
            setTimeout(() => { editModal.classList.add('hidden'); state.editingProjectId = null; state.tempMembers = []; }, 200);
        };

        function renderEditMembers() {
            membersList.innerHTML = '';
            state.tempMembers.forEach((member, index) => {
                const chip = document.createElement('div');
                chip.className = "flex items-center gap-1 px-2 py-1 bg-white/5 border border-border rounded text-xs text-text border-accent";
                chip.innerHTML = `<span class="text-accent">${member}</span><button onclick="removeMember(${index})" class="text-muted hover:text-red-500 ml-1">Ã—</button>`;
                membersList.appendChild(chip);
            });
        }

        window.addMember = () => { 
            const email = newMemberInput.value.trim(); 
            if(email && email.includes('@')) { 
                if(!state.tempMembers.includes(email)) {
                    state.tempMembers.push(email); 
                }
                newMemberInput.value = ''; 
                renderEditMembers(); 
            } else {
                alert("Please enter a valid email.");
            }
        };
        window.removeMember = (index) => { state.tempMembers.splice(index, 1); renderEditMembers(); };
        window.handleMemberInputKey = (e) => {if (e.key === 'Enter') window.addMember();};

        window.saveEditWorkspace = () => {
    if(!state.editingProjectId) return;
    if(window.dbUpdateProject) {
        const members = [...state.tempMembers];
        // ç¢ºä¿ owner ä¸€å®šåœ¨ members è£¡ï¼ˆcurrentUser å¯å¾ module ä¸Ÿåˆ° windowï¼Œä¾‹å¦‚ window.currentUserï¼‰
        if (window.currentUser && !members.includes(window.currentUser.email)) {
            members.push(window.currentUser.email);
        }

        window.dbUpdateProject(state.editingProjectId, {
            name: editNameInput.value.trim(),
            desc: editDescInput.value.trim(),
            members
        });
    }
    closeEditModal();
};

        window.deleteWorkspace = () => {
            if(!state.editingProjectId) return;
            if(confirm('Are you sure you want to delete this workspace? All members will lose access.')) {
                if(window.dbDeleteProject) {
                    window.dbDeleteProject(state.editingProjectId);
                }
                closeEditModal();
            }
        };

        function updateThemeMenuHighlight() {
            ['business', 'developer', 'terminal', 'cyberpunk'].forEach(t => {
                const btn = document.getElementById(`opt-${t}`);
                if(btn) { btn.classList.remove('text-accent', 'font-bold'); btn.classList.add('text-text'); }
            });
            const activeBtn = document.getElementById(`opt-${state.theme}`);
            if(activeBtn) { activeBtn.classList.remove('text-text'); activeBtn.classList.add('text-accent', 'font-bold'); }
        }

        function generateRandomNodes() {
            const count = Math.floor(Math.random() * 5) + 3; 
            const nodes = [];
            for (let i = 0; i < count; i++) { nodes.push({ top: Math.floor(Math.random() * 80) + '%', left: Math.floor(Math.random() * 80) + '%', type: Math.random() > 0.5 ? 'data' : 'process' }); }
            return nodes;
        }

    
        function renderProjectGrid(project) {
            projectContent.innerHTML = '';
        }

        window.resetBreadcrumb = () => {
            stopPresenceSystem();
            state.currentProjectId = null;
            // å–æ¶ˆç›®å‰ workspace çš„è¨‚é–±
            if (unsubscribeCurrentProject) {
            unsubscribeCurrentProject();
            unsubscribeCurrentProject = null;
           } 

    // æ¸…ç©ºç•«é¢ä¸Šçš„ nodes
    items.forEach(i => i.el.remove());
    items = [];

    breadcrumbSep.classList.add('hidden');
    breadcrumbCurrent.classList.add('hidden');
    renderWorkspaceList();
    emptyState.classList.remove('hidden');
    projectContent.classList.add('hidden');
};
window.toggleWorkspace = () => {
    if (!state.sidebarOpen) toggleBtn.click(); 

    const list = document.getElementById('workspace-list');
    const arrow = document.getElementById('workspace-arrow');

    list.classList.toggle('hidden');
    arrow.classList.toggle('rotate-90');
};
   
        window.toggleTools = () => {
            if (!state.sidebarOpen) toggleBtn.click();
            const list = document.getElementById('tools-list');
            const arrow = document.getElementById('tools-arrow');
            list.classList.toggle('hidden');
            arrow.classList.toggle('rotate-90');
        };

        const toolRow = document.getElementById('tool-row');

        toggleBtn.addEventListener('click', () => {
            state.sidebarOpen = !state.sidebarOpen;
            
            if (!state.sidebarOpen) {
                sidebar.classList.remove('w-64'); 
                sidebar.classList.add('w-16');
                textElements.forEach(el => el.classList.add('opacity-0', 'pointer-events-none', 'hidden'));
                toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>';
                workspaceList.classList.add('hidden'); 
                workspaceArrow.classList.remove('rotate-90');
                const toolsList = document.getElementById('tools-list');
                const toolsArrow = document.getElementById('tools-arrow');
                if(toolsList) toolsList.classList.add('hidden');
                if(toolsArrow) toolsArrow.classList.remove('rotate-90');
                if(toolRow) {
                    toolRow.classList.remove('flex-row');
                    toolRow.classList.add('flex-col');
                }
            } else {
                sidebar.classList.remove('w-16'); 
                sidebar.classList.add('w-64');
                setTimeout(() => textElements.forEach(el => el.classList.remove('opacity-0', 'pointer-events-none', 'hidden')), 100);
                toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>';
                if(toolRow) {
                    toolRow.classList.remove('flex-col');
                    toolRow.classList.add('flex-row');
                }
            }
        });

        function toggleMenu(menu) {
    const menus = [langMenu, themeMenu, styleMenu, globalContextMenu];

    // å…ˆæŠŠæ‰€æœ‰ menu é—œæ‰
    menus.forEach(m => {
        if (!m) return;
        if (m !== menu) {
            m.classList.add('hidden');
            m.classList.remove('popover-enter-active');
        }
    });

    // å†æ±ºå®šè¦ä¸è¦åˆ‡æ›ç›®å‰é€™ä¸€å€‹
    const isHidden = menu.classList.contains('hidden');
    if (isHidden) {
        menu.classList.remove('hidden');
        menu.classList.add('popover-enter-active');
    } else {
        menu.classList.add('hidden');
        menu.classList.remove('popover-enter-active');
    }
}

        langBtn.addEventListener('click', (e) => { e.stopPropagation(); if(!state.sidebarOpen) toggleBtn.click(); toggleMenu(langMenu); });
        
        themeBtn.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            if(!state.sidebarOpen) toggleBtn.click(); 
            toggleMenu(themeMenu); 
            updateThemeMenuHighlight(); 
        });
        styleBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (!state.sidebarOpen) toggleBtn.click(); // è‹¥å´é‚Šæ¬„ç¸®èµ·ä¾†ï¼Œé †ä¾¿æ‰“é–‹
    toggleMenu(styleMenu);
});
        // --- æ–°å¢ï¼šæ¨£å¼èª¿æ•´é‚è¼¯ ---

        // 1. èƒŒæ™¯é¡è‰²
        inputBgColor.addEventListener('input', (e) => {
            canvasSizer.style.backgroundColor = e.target.value;
        });

        // 2. å¤–æ¡†é¡è‰²
        inputBorderColor.addEventListener('input', (e) => {
            canvasSizer.style.borderColor = e.target.value;
        });

        // 3. ç¶²æ ¼æ›´æ–°å‡½æ•¸ (åˆä½µé¡è‰²èˆ‡é€æ˜åº¦)
        function updateGridStyle() {
            const colorHex = inputGridColor.value;
            const opacity = inputGridOpacity.value / 100;
            gridOpacityVal.textContent = inputGridOpacity.value + '%';

            // å°‡ Hex è½‰ç‚º RGB
            const r = parseInt(colorHex.substr(1,2), 16);
            const g = parseInt(colorHex.substr(3,2), 16);
            const b = parseInt(colorHex.substr(5,2), 16);
            
            const rgba = `rgba(${r}, ${g}, ${b}, ${opacity})`;

            // æ›´æ–° canvas-sizer çš„èƒŒæ™¯åœ– (ç¶²æ ¼)
            canvasSizer.style.backgroundImage = `
                linear-gradient(to right, ${rgba} 1px, transparent 1px),
                linear-gradient(to bottom, ${rgba} 1px, transparent 1px)
            `;
        }

        // ç›£è½ç¶²æ ¼é¡è‰²èˆ‡é€æ˜åº¦
        inputGridColor.addEventListener('input', updateGridStyle);
        inputGridOpacity.addEventListener('input', updateGridStyle);
        document.addEventListener('click', (e) => {
    // é»åœ¨ Style menu è£¡å°±ä¸è¦é—œæ‰
    if (styleMenu.contains(e.target)) return;

    // é»ç•«é¢å…¶ä»–åœ°æ–¹ â†’ å…¨éƒ¨ menu é—œé–‰
    [langMenu, themeMenu, styleMenu, globalContextMenu].forEach(m => {
        if (!m) return;
        m.classList.add('hidden');
        m.classList.remove('popover-enter-active');
    });

    if (userProfile && !userProfile.contains(e.target)) {
        if (logoutMenu) logoutMenu.classList.add('hidden');
    }

    if (e.target === modal) closeModal();
    if (e.target === editModal) closeEditModal();
});

        window.setLanguage = (lang) => {
            state.lang = lang; const t = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (t[key]) el.textContent = t[key]; });
            if(lang === 'zh') { document.getElementById('new-section-name').placeholder = 'ä¾‹å¦‚: å°ˆæ¡ˆ Omega'; document.getElementById('new-section-desc').placeholder = 'ç°¡çŸ­æè¿°...'; } else { document.getElementById('new-section-name').placeholder = 'e.g. Project Omega'; document.getElementById('new-section-desc').placeholder = 'Brief description...'; }
        };

        window.setTheme = (themeName) => {
            state.theme = themeName;
            if (themeName === 'cyberpunk') document.documentElement.removeAttribute('data-theme'); else document.documentElement.setAttribute('data-theme', themeName);
            updateThemeMenuHighlight();
        };
        // å°‡ç•«é¢ä¸Šçš„ç‰©ä»¶åŒæ­¥å›è³‡æ–™åº«ï¼ˆUI ç‰ˆæœ¬ï¼‰
// ç›´æ¥å‘¼å« module é‚£é‚Šæä¾›çš„ dbUpdateProject
window.saveProjectState = async () => {
    // æ²’æœ‰é¸ workspaceï¼Œæˆ–ç›®å‰æ˜¯é ç«¯åŒæ­¥ä¸­ï¼Œå°±ä¸ç”¨å¯«å› DB
    if (!state.currentProjectId || window.isRemoteUpdate) return;
    const nodesData = items.map(i => ({
        id: i.id,
        x: i.x,
        y: i.y,
        w: i.w,
        h: i.h,
        type: i.type,
        color: i.el.style.borderColor,
        label: i.label || ''
    }));

    if (!window.dbUpdateProject) return;

    try {
        await window.dbUpdateProject(state.currentProjectId, { nodes: nodesData });
        console.log('State synced to DB');
    } catch (e) {
        console.error('Sync error:', e);
    }
};




        

        // --- Drag and Drop Logic (æ–°å¢éƒ¨åˆ†) ---
        
        // Helper Functions
        function snap(v) { return Math.round(v / CELL_SIZE) * CELL_SIZE; }
        function checkCollision(target, ignoreId) { 
            return items.some(i => { 
                if (i.id === ignoreId) return false; 
                return (target.x < i.x + i.w && target.x + target.w > i.x && target.y < i.y + i.h && target.y + target.h > i.y); 
            }); 
        }
        function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : { r: 0, g: 0, b: 0 }; }

        // Setup Drag Listeners
        const toolEmpty = document.getElementById('tool-empty');
        if (toolEmpty) {
            toolEmpty.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', 'empty-window');
            });
        }

        // Drop Listener
        gridCanvas.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
        gridCanvas.addEventListener('drop', (e) => {
            e.preventDefault();
            
            // åªæœ‰åœ¨ grid-canvas é¡¯ç¤ºæ™‚æ‰å…è¨±æ”¾ä¸‹ (é›–ç„¶ main éš±è—æ™‚ä¹Ÿæ‹–ä¸é€²ä¾†)
            if (gridCanvas.offsetParent === null) return;

            const type = e.dataTransfer.getData('type');
            const rect = gridCanvas.getBoundingClientRect();
            // è¨ˆç®—ç›¸å°ä½ç½®ï¼Œä¸¦è€ƒæ…®æ²è»¸
            const scrollTop = gridCanvas.scrollTop || 0; // å¦‚æœ gridCanvas æœ¬èº«æœ‰æ²å‹•
            const scrollLeft = gridCanvas.scrollLeft || 0;
            
            // ç”±æ–¼ gridCanvas æ˜¯ relative ä¸” full sizeï¼Œé€™è£¡ä½¿ç”¨ client åº§æ¨™è½‰æ›
            // ä¸¦ä¸”å¸é™„ç¶²æ ¼
            const x = snap(e.clientX - rect.left);
            const y = snap(e.clientY - rect.top);

            if (type === 'empty-window') {
                if(!checkCollision({x, y, w: 300, h: 200})) {
                    createItem(x, y, 300, 200, '#ffffff', 'empty-window');
                }
            }
        });

        function createItem(x, y, w, h, color, type, savedItem = null) {
            // const id = 'item_' + Date.now() + Math.random().toString(36).substr(2, 5);
            const id = savedItem ? savedItem.id : ('item_' + Date.now() + Math.random().toString(36).substr(2, 5));
            const labelContent = savedItem ? (savedItem.label || '') : '';
            const el = document.createElement('div'); 
            el.className = 'grid-item'; 
            
            el.id = id; 
            el.style.left = x + 'px'; 
            el.style.top = y + 'px';
            el.style.width = w + 'px'; 
            el.style.height = h + 'px';
            
            const rgb = hexToRgb(color); 
            el.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`;
            el.style.borderColor = color;

            el.innerHTML = `
                <div class="content-container" style="width:100%; height:100%;"></div>
                <div class="item-label-container" id="lbl-${id}"></div>
                <div class="menu-trigger">â‹®</div>
                <div class="context-menu">
                    <div class="context-menu-item" onclick="editLabel('${id}')">ç·¨è¼¯åç¨± (Name)</div>
                    <div class="context-menu-item danger" onclick="deleteItem('${id}')">ç§»é™¤ (Remove)</div>
                </div>
                <div class="item-resize"></div>`;
            
            const menu = el.querySelector('.context-menu');
            const trigger = el.querySelector('.menu-trigger');

            trigger.onclick = (e) => { 
                e.stopPropagation(); 
                document.querySelectorAll('.context-menu').forEach(m => { if(m!==menu) m.classList.remove('show'); }); 
                menu.classList.toggle('show'); 
            };

            gridCanvas.appendChild(el);
            const itemObj = { id, x, y, w, h, el, type, label: labelContent }; // ç¢ºä¿é€™è£¡æœ‰ label
           // const itemObj = { id, x, y, w, h, el, type, label: '' };
            items.push(itemObj);
            // å¦‚æœæœ‰ saved labelï¼Œé¡¯ç¤ºåœ¨ç•«é¢ä¸Š
            if(labelContent) {
                setTimeout(() => { document.getElementById(`lbl-${id}`).innerText = labelContent; }, 0);
            }
            // --- æ–°å¢é€™æ®µï¼šç•¶æœ‰ç‰©ä»¶å»ºç«‹æ™‚ï¼Œéš±è—åˆå§‹åŒ–æŒ‰éˆ• ---
            const emptyState = document.getElementById('empty-state-container');
            if (emptyState && !emptyState.classList.contains('hidden')) {
                emptyState.classList.add('hidden');
                emptyState.style.display = 'none'; // é›™é‡ç¢ºä¿éš±è—
              }

            // Render Content
            if (type === 'empty-window') renderEmptyWindowContent(itemObj);
            // é‡è¦ï¼šå¦‚æœæ˜¯ã€Œä½¿ç”¨è€…æ‰‹å‹•æ–°å¢ã€çš„(æ²’æœ‰ savedItem)ï¼Œæ‰è§¸ç™¼å„²å­˜
            // å¦‚æœæ˜¯ã€ŒåŒæ­¥éä¾†ã€çš„ï¼Œå°±ä¸è§¸ç™¼å„²å­˜ï¼Œé¿å…ç„¡çª®è¿´åœˆ
            if (!savedItem && !isRemoteUpdate) {
                saveProjectState();
            }
            setupInteractions(itemObj); 
            document.addEventListener('click', () => menu.classList.remove('show')); 
            
            return { el, obj: itemObj };
        }

        // Render Functions
        function renderEmptyWindowContent(item) {
            const container = item.el.querySelector('.content-container');
            if (container.querySelector('.empty-window-layout')) return;

            container.innerHTML = `
                <div class="empty-window-layout flex flex-col w-full h-full bg-surface/50 backdrop-blur-sm overflow-hidden rounded">
                    <div class="widget-header p-2 bg-bg border-b border-border flex justify-between items-center cursor-move select-none">
                        <span class="font-bold text-xs tracking-wider text-text">WINDOW</span>
                        <span class="text-[10px] text-muted opacity-50 uppercase tracking-widest">EMPTY</span>
                    </div>
                    <div class="flex-1 p-4 overflow-auto text-muted text-sm relative">
                        <div class="absolute inset-2 border-2 border-dashed border-border rounded flex items-center justify-center opacity-30 pointer-events-none">
                            <span class="text-xs uppercase tracking-widest">Content Area</span>
                        </div>
                    </div>
                </div>
            `;
        }



        
        // Interaction Setup (Drag & Resize)
        function setupInteractions(item) {
            const { el } = item, resizeHandle = el.querySelector('.item-resize'), menu = el.querySelector('.context-menu'), trigger = el.querySelector('.menu-trigger');
            el.addEventListener('mousedown', handleStart);
            el.addEventListener('touchstart', handleStart, {passive: false});

            function handleStart(e) {
                if(e.target === resizeHandle || e.target === trigger || menu.contains(e.target)) return; 
                if (['INPUT', 'BUTTON', 'SELECT', 'OPTION', 'TEXTAREA'].includes(e.target.tagName) || e.target.isContentEditable) return; 
                
                // â˜… é™åˆ¶åªèƒ½æ‹–æ›³ Header çš„å·¥å…·é¡å‹ â˜…
                // é€™è£¡åŠ å…¥äº† 'empty-window'ï¼Œç¢ºä¿ä½¿ç”¨è€…å¿…é ˆæŒ‰ä½æ¨™é¡Œåˆ—æ‰èƒ½æ‹–å‹•è¦–çª—
                if (['empty-window'].includes(item.type) && !e.target.closest('.widget-header')) return;
                
                if(e.type === 'touchstart') e.preventDefault();

                const startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
                const startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
                const startLeft = item.x;
                const startTop = item.y; 
                el.style.zIndex = 999;

                function onMove(ev) { 
                    const clientX = ev.type === 'mousemove' ? ev.clientX : ev.touches[0].clientX;
                    const clientY = ev.type === 'mousemove' ? ev.clientY : ev.touches[0].clientY;
                    const dx = clientX - startX;
                    const dy = clientY - startY; 
                    let rawX = startLeft + dx;
                    let rawY = startTop + dy; 

                    const containerW = canvasSizer.offsetWidth
                    const containerH = canvasSizer.offsetHeight;
                    
                    // å·¦å´é™åˆ¶
                    if(rawX < 0) rawX = 0; 
                    // ä¸Šæ–¹é™åˆ¶
                    if(rawY < 0) rawY = 0;
                    const maxX = containerW - item.w;
                    const maxY = containerH - item.h;

                    if (rawX > maxX) rawX = maxX;
                    if (rawY > maxY) rawY = maxY;

                    // --- ä¿®æ”¹çµæŸ ---

                    el.style.left = rawX + 'px'; 
                    el.style.top = rawY + 'px';
                    
                    // æ›´æ–°æ•¸æ“šèˆ‡é€£ç·š
                    item.x = rawX;
                    item.y = rawY;
                    if (typeof updateLines === 'function') updateLines(); // ç¢ºä¿é€£ç·šè·Ÿéš¨

                    const snapX = snap(rawX);
                    const snapY = snap(rawY);
                    if (checkCollision({ ...item, x: snapX, y: snapY }, item.id)) el.classList.add('collision'); 
                    else el.classList.remove('collision');
                }

                function onUp(ev) { 
                    document.removeEventListener('mousemove', onMove); 
                    document.removeEventListener('mouseup', onUp);
                    document.removeEventListener('touchmove', onMove); 
                    document.removeEventListener('touchend', onUp); 
                    el.style.zIndex = ''; 
                    const finalX = snap(parseInt(el.style.left)); 
                    const finalY = snap(parseInt(el.style.top));
                    if (checkCollision({ ...item, x: finalX, y: finalY }, item.id)) { 
                        // å¦‚æœç¢°æ’ï¼Œå½ˆå›åŸä½ (æˆ–è€…ä½ è¦å…è¨±é‡ç–Šä¹Ÿå¯ä»¥ç§»é™¤é€™æ®µ)
                        el.style.left = item.x + 'px'; 
                        el.style.top = item.y + 'px';
                    } else { 
                        item.x = finalX; 
                        item.y = finalY; 
                        el.style.left = finalX + 'px'; 
                        el.style.top = finalY + 'px';
                    } 
                    el.classList.remove('collision'); 
                    saveProjectState();
                }

                if (e.type === 'mousedown') {
                    document.addEventListener('mousemove', onMove); 
                    document.addEventListener('mouseup', onUp);
                } else {
                    document.addEventListener('touchmove', onMove, {passive: false}); 
                    document.addEventListener('touchend', onUp);
                }
            }

            // Resize Logic
            resizeHandle.addEventListener('mousedown', handleResizeStart);
            resizeHandle.addEventListener('touchstart', handleResizeStart, {passive: false});

            function handleResizeStart(e) {
                e.stopPropagation(); 
                if(e.type === 'touchstart') e.preventDefault();

                const startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
                const startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
                const startW = item.w; 
                const startH = item.h;

                function onResize(ev) { 
                    const clientX = ev.type === 'mousemove' ? ev.clientX : ev.touches[0].clientX;
                    const clientY = ev.type === 'mousemove' ? ev.clientY : ev.touches[0].clientY;
                    const dx = clientX - startX; 
                    const dy = clientY - startY; 
                    let nw = snap(Math.max(MIN_W, startW + dx)); 
                    let nh = snap(Math.max(MIN_H, startH + dy)); 
                    
                    if (checkCollision({ ...item, w: nw, h: nh }, item.id)) el.classList.add('collision'); 
                    else { 
                        el.classList.remove('collision'); 
                        el.style.width = nw + 'px'; 
                        el.style.height = nh + 'px'; 
                        item.w = nw;
                        item.h = nh;
                    } 
                }

                function onResizeUp() { 
                    document.removeEventListener('mousemove', onResize); 
                    document.removeEventListener('mouseup', onResizeUp);
                    document.removeEventListener('touchmove', onResize); 
                    document.removeEventListener('touchend', onResizeUp); 
                    el.classList.remove('collision'); 
                    saveProjectState();
                }

                if(e.type === 'mousedown') {
                    document.addEventListener('mousemove', onResize); 
                    document.addEventListener('mouseup', onResizeUp);
                } else {
                    document.addEventListener('touchmove', onResize, {passive: false}); 
                    document.addEventListener('touchend', onResizeUp);
                }
            }
        }

        // Global functions for context menu
        window.editLabel = function(id) {
            const item = items.find(i => i.id === id);
            if(!item) return;
            item.el.querySelector('.context-menu').classList.remove('show');
            const text = prompt("è«‹è¼¸å…¥åç¨± (Enter Name):", item.label || "");
            if (text !== null) {
                item.label = text;
                saveProjectState();
                document.getElementById(`lbl-${id}`).innerText = text;
            }
        }

        window.deleteItem = function(id) {
            const idx = items.findIndex(i => i.id === id);
            if (idx > -1) { 
                items[idx].el.remove(); 
                items.splice(idx, 1); 
                saveProjectState();
            // --- æ–°å¢ï¼šå¦‚æœç•«é¢æ¸…ç©ºäº†ï¼Œé¡¯ç¤ºåˆå§‹åŒ–æŒ‰éˆ• ---
            if (items.length === 0) {
                const emptyState = document.getElementById('empty-state-container');
                if (emptyState) {
                    emptyState.classList.remove('hidden');
                    emptyState.style.display = 'flex';
               }
            }
            // ------------------------------------------
            }
        }
// --- æ–°å¢ï¼šæ»‘é¼ ä¸­éµæ‹–æ›³ç•«å¸ƒ (Panning) ---
// --- Middle Mouse Pan Logic (å¾ APP.txt å¾©åˆ») ---
const scrollContainer = document.getElementById('canvas-scroll-container'); // å°æ‡‰ APP.txt çš„ .workspace
let isPanning = false;
let startX, startY, scrollLeft, scrollTop;

scrollContainer.addEventListener('mousedown', (e) => {
    // e.button === 1 ä»£è¡¨æ»‘é¼ ä¸­éµ (æ»¾è¼ªé»æ“Š)
    if (e.button === 1) {
        e.preventDefault(); // é˜²æ­¢ç€è¦½å™¨é è¨­çš„è‡ªå‹•æ²å‹•åœ–ç¤ºå‡ºç¾
        isPanning = true;
        
        // æ”¹è®Šæ¸¸æ¨™æ¨£å¼ (å°æ‡‰ CSS .cursor-grabbing)
        scrollContainer.style.cursor = 'grabbing'; 
        
        // è¨˜éŒ„åˆå§‹ä½ç½® (ç›¸å°æ–¼å®¹å™¨)
        // APP.txt ä½¿ç”¨: e.pageX - workspace.offsetLeft
        startX = e.pageX - scrollContainer.offsetLeft;
        startY = e.pageY - scrollContainer.offsetTop;
        
        // è¨˜éŒ„ç›®å‰çš„æ²å‹•ä½ç½®
        scrollLeft = scrollContainer.scrollLeft;
        scrollTop = scrollContainer.scrollTop;
    }
});

scrollContainer.addEventListener('mouseleave', () => {
    isPanning = false;
    scrollContainer.style.cursor = 'default';
});

scrollContainer.addEventListener('mouseup', () => {
    isPanning = false;
    scrollContainer.style.cursor = 'default';
});

scrollContainer.addEventListener('mousemove', (e) => {
    if (!isPanning) return;
    e.preventDefault();
    
    // è¨ˆç®—æ»‘é¼ ç§»å‹•çš„æ–°ä½ç½®
    const x = e.pageX - scrollContainer.offsetLeft;
    const y = e.pageY - scrollContainer.offsetTop;
    
    // è¨ˆç®—ä½ç§»é‡ (APP.txt é‚è¼¯: åŸå§‹ä½ç½® - æ–°ä½ç½®)
    const walkX = (x - startX); 
    const walkY = (y - startY);
    
    // æ›´æ–°æ²è»¸ä½ç½® (åå‘ç§»å‹•å¯¦ç¾æ‹–æ›³æ•ˆæœ)
    scrollContainer.scrollLeft = scrollLeft - walkX;
    scrollContainer.scrollTop = scrollTop - walkY;
});
        // --- æ–°å¢ï¼šå‹•æ…‹èª¿æ•´ç•«å¸ƒå¤§å° ---
window.resizeCanvasPrompt = function() {
    const sizer = document.getElementById('canvas-sizer');
    const currentW = parseInt(sizer.style.width);
    const currentH = parseInt(sizer.style.height);

    // ç°¡å–®ä½¿ç”¨ prompt è®“ä½¿ç”¨è€…è¼¸å…¥ (æ‚¨ä¹Ÿå¯ä»¥æ”¹æˆæ¼‚äº®çš„ modal)
    const newW = prompt("è«‹è¼¸å…¥ç•«å¸ƒå¯¬åº¦ (Width px):", currentW);
    if (newW === null) return; // å–æ¶ˆ
    
    const newH = prompt("è«‹è¼¸å…¥ç•«å¸ƒé«˜åº¦ (Height px):", currentH);
    if (newH === null) return; // å–æ¶ˆ

    if (newW && newH && !isNaN(newW) && !isNaN(newH)) {
        sizer.style.width = newW + 'px';
        sizer.style.height = newH + 'px';
        ensureCanvasOverflow();
        // é‡æ–°ç½®ä¸­ã€Œåˆå§‹åŒ–æŒ‰éˆ•ã€çš„ä½ç½®
        const emptyState = document.getElementById('empty-state-container');
        if (emptyState) {
            // é›–ç„¶ CSS å·²ç¶“æ˜¯ç”¨è¦–çª—è¨ˆç®—ï¼Œä½†è‹¥ç•«å¸ƒå°æ–¼è¦–çª—ï¼Œå¯èƒ½éœ€è¦å¾®èª¿ï¼Œé€™è£¡ä¿æŒåŸæ¨£å³å¯
        }
    } else {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—ï¼");
    }
}
        // ğŸ”¸ ä¿è­‰ç•«å¸ƒç¸½æ˜¯æ¯”å¯è¦–å€åŸŸå†å¤§ä¸€æˆªï¼ˆä¸€å®šæœƒæœ‰æ°´å¹³æ²å‹•ï¼‰
function ensureCanvasOverflow() {
    const container = document.getElementById('canvas-scroll-container');
    const sizer = document.getElementById('canvas-sizer');
    if (!container || !sizer) return;

    // ç›®å‰å¯è¦–å¯¬ã€é«˜
    const visibleW = container.clientWidth;
    const visibleH = container.clientHeight;

    // å¤šç•™ä¸€é»ç©ºé–“ï¼Œç¢ºä¿å¯ä»¥å·¦å³æ‹–ï¼ˆä½ å¯ä»¥æ”¹æˆ 300ã€500 çœ‹æ‰‹æ„Ÿï¼‰
    const extraX = 300;
    const extraY = 0; // å‚ç›´ä½ å·²ç¶“æœƒ overflowï¼Œé€™è£¡å¯ä»¥ä¸ç”¨åŠ 

    const minW = visibleW + extraX;
    const minH = visibleH + extraY;

    // è®€ç›®å‰çš„å¯¬é«˜ï¼ˆå¦‚æœ style ä¸Šæ˜¯ç©ºçš„ï¼Œå°±ç”¨ getComputedStyleï¼‰
    const style = window.getComputedStyle(sizer);
    let curW = parseInt(style.width, 10) || 0;
    let curH = parseInt(style.height, 10) || 0;

    if (curW < minW) {
        sizer.style.width = minW + 'px';
    }
    if (curH < minH) {
        sizer.style.height = minH + 'px';
    }
}

// è¼‰å…¥æ™‚ï¼†è¦–çª—å°ºå¯¸æ”¹è®Šæ™‚ï¼Œéƒ½æª¢æŸ¥ä¸€æ¬¡
window.addEventListener('load', ensureCanvasOverflow);
window.addEventListener('resize', ensureCanvasOverflow);
        
// 1. å•Ÿå‹• Presence ç³»çµ± (é€²å…¥å°ˆæ¡ˆæ™‚å‘¼å«)
        async function startPresenceSystem(workspaceId) {
            if (!currentUser) return;

            // å®šç¾©ï¼šå›å ±è‡ªå·±ã€Œåœ¨ç·šã€çš„å‡½æ•¸
            const reportAlive = async () => {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'workspaces', workspaceId, 'presence', currentUser.uid);
                try {
                    await setDoc(userRef, {
                        email: currentUser.email,
                        photoURL: currentUser.photoURL,
                        displayName: currentUser.displayName,
                        lastSeen: serverTimestamp() // ä¼ºæœå™¨æ™‚é–“
                    }, { merge: true });
                } catch (e) { console.error("Presence error", e); }
            };

            // ç«‹å³å›å ±ä¸€æ¬¡
            reportAlive();

            // æ¯ 60 ç§’å›å ±ä¸€æ¬¡ (å¿ƒè·³æ©Ÿåˆ¶)
            presenceInterval = setInterval(reportAlive, 60000);

            // ç›£è½è©²å°ˆæ¡ˆçš„ presence å­é›†åˆ
            const presenceCol = collection(db, 'artifacts', appId, 'public', 'data', 'workspaces', workspaceId, 'presence');
            unsubscribePresence = onSnapshot(presenceCol, (snapshot) => {
                const onlineUsers = [];
                const now = Date.now();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // éæ¿¾ï¼šå¦‚æœ lastSeen è¶…é 2 åˆ†é˜ï¼Œè¦–ç‚ºé›¢ç·š (è™•ç†ä¸æ­£å¸¸é—œé–‰)
                    // æ³¨æ„ï¼šserverTimestamp åœ¨æœ¬åœ°å‰›å¯«å…¥æ™‚å¯èƒ½æ˜¯ null (pending)ï¼Œè¦è¦–ç‚ºæœ‰æ•ˆ
                    if (data.lastSeen) {
                        const lastSeenTime = data.lastSeen.toMillis ? data.lastSeen.toMillis() : now;
                        if (now - lastSeenTime < 120000) { // 2åˆ†é˜å…§æ´»èº
                            onlineUsers.push(data);
                        }
                    } else {
                        onlineUsers.push(data); // æœ¬åœ°å‰›å¯«å…¥ï¼Œç®—åœ¨ç·š
                    }
                });
                renderOnlineAvatars(onlineUsers);
            });
        }

        // 2. åœæ­¢ Presence ç³»çµ± (é›¢é–‹å°ˆæ¡ˆæ™‚å‘¼å«)
        async function stopPresenceSystem() {
            if (presenceInterval) clearInterval(presenceInterval);
            if (unsubscribePresence) unsubscribePresence();
            
            // å˜—è©¦åˆªé™¤è‡ªå·±çš„åœ¨ç·šç´€éŒ„ (æ­£å¸¸é›¢é–‹)
            if (state.currentProjectId && currentUser) {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'workspaces', state.currentProjectId, 'presence', currentUser.uid);
                await deleteDoc(userRef).catch(()=>{});
            }
            
            document.getElementById('online-users-container').classList.add('hidden');
        }

        // 3. æ¸²æŸ“é ­è²¼
        function renderOnlineAvatars(users) {
            const container = document.getElementById('online-avatars');
            container.innerHTML = '';
            
            users.forEach(u => {
                const img = document.createElement('img');
                img.src = u.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${u.email}`;
                img.className = "inline-block h-6 w-6 rounded-full ring-2 ring-bg bg-surface object-cover";
                img.title = u.displayName || u.email;
                container.appendChild(img);
            });
            
            // é¡¯ç¤ºå®¹å™¨
            document.getElementById('online-users-container').classList.remove('hidden');
        }
        
        // ç¢ºä¿é—œé–‰è¦–çª—æ™‚ä¹Ÿèƒ½ç§»é™¤ç‹€æ…‹
        window.addEventListener('beforeunload', () => {
            stopPresenceSystem();
        });


        
        window.onload = () => { setTheme('cyberpunk'); setLanguage('zh'); };
    </script>
</body>
</html>




















