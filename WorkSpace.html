<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --grid-color: #2a2a2a;
            --sidebar-bg: #252526;
            --sidebar-border: #333;
            --panel-bg: #2d2d2d;
            --text-color: #cccccc;
            --accent-color: #007acc;
            --danger-color: #f14c4c;
            
            /* Note Colors */
            --note-yellow: #fff9c4;
            --note-green: #dcedc8;
            --note-blue: #b3e5fc;
            --note-pink: #f8bbd0;
            --note-dark: #333333;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--grid-color) 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Segoe UI', sans-serif;
            color: var(--text-color);
        }

        /* --- 左側工具欄 (Icon Bar) --- */
        #sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 60px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 15px;
            padding-bottom: 15px; /* 底部留白 */
            z-index: 2000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            user-select: none;
        }

        .tool-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #858585;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
            position: relative; /* For badges or overflow */
        }

        .tool-btn:hover, .tool-btn.active {
            background-color: #383838;
            color: #fff;
        }

        .tool-btn.active {
            color: var(--accent-color);
            border-left: 3px solid var(--accent-color);
        }

        .tool-btn svg { width: 24px; height: 24px; fill: currentColor; }

        .divider { width: 30px; height: 1px; background-color: #444; margin: 10px 0; }

        /* 顏色選單 */
        .color-submenu {
            position: absolute; left: 60px; top: 0;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--sidebar-border);
            border-radius: 0 8px 8px 0;
            padding: 10px; display: flex; flex-direction: column; gap: 8px;
            box-shadow: 4px 4px 15px rgba(0,0,0,0.4);
            opacity: 0; visibility: hidden; transform: translateX(-10px);
            transition: all 0.2s ease; z-index: 2100;
        }

        .tool-wrapper:hover .color-submenu, .color-submenu:hover {
            opacity: 1; visibility: visible; transform: translateX(0);
        }

        .menu-color-option {
            width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; border: 2px solid transparent; transition: transform 0.2s;
            position: relative;
        }
        .menu-color-option:hover { transform: scale(1.1); border-color: rgba(255,255,255,0.3); }
        .menu-color-option.selected::after {
            content: '✓'; color: #555; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 16px; font-weight: bold;
        }
        .menu-color-option[data-color="dark"].selected::after { color: #fff; }
        #colorBtnIndicator {
            width: 12px; height: 12px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2); position: absolute; bottom: 12px; right: 12px; pointer-events: none;
        }

        /* --- Auth Section (New Design) --- */
        #auth-section {
            margin-top: auto; /* 推到底部 */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 使用者頭貼按鈕樣式 */
        .auth-avatar-btn {
            padding: 0;
            overflow: hidden;
            border: 2px solid transparent;
        }
        .auth-avatar-btn:hover {
            border-color: var(--accent-color);
        }
        .auth-avatar-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px; /* 稍微圓角，符合整體方正風格 */
        }

        /* 使用者選單 (懸浮面板) */
        #user-menu {
            position: absolute;
            left: 60px; /* 側邊欄寬度 */
            bottom: 0;  /* 對齊底部 */
            background-color: var(--sidebar-bg);
            border: 1px solid var(--sidebar-border);
            border-radius: 0 8px 8px 0;
            padding: 15px;
            width: 240px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 4px 4px 15px rgba(0,0,0,0.5);
            z-index: 2200;
            
            /* 動畫 */
            opacity: 0;
            visibility: hidden;
            transform: translateX(-10px);
            transition: all 0.2s ease;
        }

        #user-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #444;
            margin-bottom: 5px;
        }
        
        .user-profile-header img {
            width: 40px; height: 40px; border-radius: 8px; background: #333;
        }
        
        .user-info-text {
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        .user-name { font-size: 14px; font-weight: bold; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-email { font-size: 11px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .menu-action-btn {
            display: flex; align-items: center; gap: 10px;
            width: 100%; text-align: left; padding: 10px;
            background: transparent; border: none; border-radius: 6px;
            color: #ccc; font-size: 13px; cursor: pointer; transition: 0.2s;
        }
        .menu-action-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .menu-action-btn.logout { color: #ff6b6b; }
        .menu-action-btn.logout:hover { background: rgba(255, 82, 82, 0.1); }

        /* --- 專案列表面板 (Project Panel) --- */
        #doc-panel {
            position: fixed;
            left: 60px;
            top: 0;
            bottom: 0;
            width: 240px;
            background-color: var(--panel-bg);
            border-right: 1px solid #444;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1900;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }

        #doc-panel.open { transform: translateX(0); }

        .panel-header {
            padding: 15px;
            font-size: 14px;
            font-weight: bold;
            color: #ddd;
            border-bottom: 1px solid #444;
            background: rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-board-btn {
            background: var(--accent-color); border: none; color: white;
            border-radius: 4px; width: 24px; height: 24px; font-size: 18px;
            line-height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .add-board-btn:hover { filter: brightness(1.1); }

        #panel-content { flex-grow: 1; overflow-y: auto; padding: 10px 0; }

        /* 畫布列表項目 */
        .board-item {
            padding: 8px 15px; cursor: pointer; color: #aaa; display: flex; flex-direction: column;
            border-left: 3px solid transparent; transition: background 0.2s;
        }
        .board-item:hover { background-color: rgba(255,255,255,0.05); }
        .board-item.active {
            background-color: rgba(0, 0, 0, 0.2); border-left-color: var(--accent-color); color: #fff;
        }
        .board-header { display: flex; justify-content: space-between; align-items: center; font-size: 15px; font-weight: 500; }
        
        .board-delete-btn { opacity: 0; color: var(--danger-color); font-size: 16px; padding: 0 5px; transition: opacity 0.2s; }
        .board-item:hover .board-delete-btn { opacity: 1; }

        .note-sublist { margin-top: 5px; margin-left: 10px; border-left: 1px solid #444; display: none; }
        .board-item.active .note-sublist { display: block; }

        .note-item { padding: 5px 10px; font-size: 13px; color: #888; display: flex; align-items: center; transition: color 0.2s; }
        .note-item:hover { color: var(--accent-color); }
        .note-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }

        /* --- 畫布標題區塊 --- */
        #top-bar {
            position: absolute; top: 15px; left: 80px; right: 20px;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 50; pointer-events: none;
        }

        #board-title {
            font-size: 24px; font-weight: 600; color: #666; margin: 0;
            padding: 5px 10px; border-radius: 6px; cursor: text; pointer-events: auto;
            border: 1px solid transparent;
        }
        #board-title:focus { outline: none; background-color: #2d2d2d; color: #eee; border-color: #444; }

        /* 線上使用者 (Presence) */
        #online-users {
            display: flex; gap: -5px; pointer-events: auto;
        }
        .user-avatar-sm {
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--bg-color);
            margin-left: -8px; background: #333; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: transform 0.2s;
        }
        .user-avatar-sm:first-child { margin-left: 0; }
        .user-avatar-sm:hover { transform: translateY(-3px); z-index: 10; }
        .user-avatar-sm img { width: 100%; height: 100%; object-fit: cover; }
        
        .mode-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; 
            margin-left: 10px; vertical-align: middle; font-weight: normal;
            opacity: 0.7;
        }
        .badge-local { background: #444; color: #aaa; }
        .badge-cloud { background: var(--accent-color); color: #000; font-weight: bold; }

        /* --- 畫布與便條 --- */
        .note {
            position: absolute; width: 240px; min-height: 160px;
            border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            display: flex; flex-direction: column; transition: box-shadow 0.2s, transform 0.2s;
            resize: both; overflow: hidden; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;} }
        @keyframes flashBorder { 0%,100%{box-shadow:0 0 0 2px var(--accent-color);} 50%{box-shadow:0 0 0 6px var(--accent-color);} }
        .note.highlight { animation: flashBorder 0.6s ease-in-out; z-index: 9999 !important; }
        .note:active { box-shadow: 0 12px 30px rgba(0,0,0,0.6); z-index: 1000 !important; }

        .note-header { height: 32px; background: rgba(0,0,0,0.1); cursor: grab; display: flex; align-items: center; padding: 0 5px; gap: 5px; }
        .note-header:active { cursor: grabbing; }
        .note-title-input { flex-grow: 1; background: transparent; border: none; font-family: inherit; font-size: 13px; font-weight: bold; color: inherit; opacity: 0.8; padding: 2px 4px; }
        .note-title-input:focus { outline: none; background: rgba(255,255,255,0.1); opacity: 1; }
        .close-btn { opacity: 0.4; cursor: pointer; font-size: 18px; padding: 0 8px; }
        .close-btn:hover { opacity: 1; color: var(--danger-color); }

        .note-toolbar { display: flex; align-items: center; padding: 2px 5px; background: rgba(0,0,0,0.05); border-bottom: 1px solid rgba(0,0,0,0.05); gap: 2px; user-select: none; }
        .note[data-dark="true"] .note-toolbar { background: rgba(255,255,255,0.1); }
        .note-toolbar button { background: transparent; border: none; cursor: pointer; border-radius: 3px; padding: 2px 5px; font-size: 13px; color: inherit; opacity: 0.6; font-family: monospace; min-width: 24px; text-align: center; }
        .note-toolbar button:hover { background: rgba(0,0,0,0.1); opacity: 1; }
        .toolbar-sep { color: inherit; opacity: 0.3; margin: 0 2px; font-size: 12px; cursor: default; }

        .note-content { flex-grow: 1; padding: 15px; outline: none; font-size: 15px; line-height: 1.6; color: #222; overflow-y: auto; }
        .note-content[data-dark="true"] { color: #ddd; }

    </style>
</head>
<body>

    <!-- 左側工具欄 -->
    <div id="sidebar">
        <!-- 新增便條 -->
        <div class="tool-wrapper">
            <button class="tool-btn" onclick="createNote()" title="新增便條 (N)">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>
        </div>

        <!-- 畫布/文件列表 -->
        <div class="tool-wrapper">
            <button class="tool-btn" id="listToggleBtn" onclick="toggleDocPanel()" title="畫布列表 (L)">
                <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/></svg>
            </button>
        </div>

        <div class="divider"></div>

        <!-- 顏色選單 -->
        <div class="tool-wrapper">
            <button class="tool-btn" id="colorBtn">
                <svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 0 0 0 18c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                <div id="colorBtnIndicator" style="background-color: var(--note-yellow);"></div>
            </button>
            <div class="color-submenu">
                <div class="menu-color-option selected" data-color="yellow" style="background:var(--note-yellow)" onclick="selectColor('yellow', this)"></div>
                <div class="menu-color-option" data-color="green" style="background:var(--note-green)" onclick="selectColor('green', this)"></div>
                <div class="menu-color-option" data-color="blue" style="background:var(--note-blue)" onclick="selectColor('blue', this)"></div>
                <div class="menu-color-option" data-color="pink" style="background:var(--note-pink)" onclick="selectColor('pink', this)"></div>
                <div class="menu-color-option" data-color="dark" style="background:var(--note-dark)" onclick="selectColor('dark', this)"></div>
            </div>
        </div>

        <div class="divider"></div>

        <!-- 清除畫布 -->
        <div class="tool-wrapper">
            <button class="tool-btn" onclick="clearCurrentBoard()" title="清空當前畫布">
                <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
        </div>

        <!-- Auth Section (Stylish Integration) -->
        <div id="auth-section">
            <div class="divider"></div>
            
            <!-- Login Button (Not Logged In) -->
            <div class="tool-wrapper" id="login-wrapper">
                <button class="tool-btn" id="login-btn" title="Google 登入 (Sign In)">
                    <!-- 使用通用使用者圖示，更符合介面風格 -->
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                </button>
            </div>

            <!-- User Avatar (Logged In) -->
            <div class="tool-wrapper" id="user-wrapper" style="display:none;">
                <button class="tool-btn auth-avatar-btn" id="user-avatar-btn" title="使用者選單">
                    <img id="user-avatar-img" src="" alt="User">
                </button>
                
                <!-- Stylized User Menu -->
                <div id="user-menu">
                    <div class="user-profile-header">
                        <img id="menu-user-img" src="" alt="">
                        <div class="user-info-text">
                            <span id="user-name-disp" class="user-name">User</span>
                            <span id="user-email-disp" class="user-email">email</span>
                        </div>
                    </div>
                    <button class="menu-action-btn logout" id="logout-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                        登出 (Sign Out)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 專案/畫布管理面板 -->
    <div id="doc-panel">
        <div class="panel-header">
            <span>文件清單</span>
            <button class="add-board-btn" onclick="addNewBoard()" title="新增畫布">+</button>
        </div>
        <div id="panel-content">
            <!-- JS 動態生成 -->
        </div>
    </div>

    <!-- 頂部資訊列 (標題 + 線上人員) -->
    <div id="top-bar">
        <h1 id="board-title" contenteditable="true" spellcheck="false">載入中...</h1>
        <div id="online-users">
            <!-- 線上使用者頭貼 -->
        </div>
    </div>

    <!-- 畫布區域 -->
    <div id="board"></div>

    <script type="module">
        // --- Firebase Integration ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, setDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAIwisA_UnOiNRVwYE6tJV47Sp3_1i19IM",
            authDomain: "brooklyn-terminal.firebaseapp.com",
            projectId: "brooklyn-terminal",
            storageBucket: "brooklyn-terminal.firebasestorage.app",
            messagingSenderId: "438411734316",
            appId: "1:438411734316:web:649051890cf381eb0fd089",
            measurementId: "G-G0GMW0XHG1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const APP_COLLECTION = 'pi_canvas_boards';
        const APP_ID = 'pi-canvas-v1';

        // UI Elements
        const loginBtn = document.getElementById('login-btn');
        const loginWrapper = document.getElementById('login-wrapper');
        const userWrapper = document.getElementById('user-wrapper');
        const userAvatarBtn = document.getElementById('user-avatar-btn');
        const userMenu = document.getElementById('user-menu');
        const userNameDisp = document.getElementById('user-name-disp');
        const userEmailDisp = document.getElementById('user-email-disp');
        const userAvatarImg = document.getElementById('user-avatar-img');
        const menuUserImg = document.getElementById('menu-user-img');
        const logoutBtn = document.getElementById('logout-btn');
        const boardTitle = document.getElementById('board-title');

        // State
        window.currentUser = null;
        let unsubscribeBoards = null;
        let unsubscribeCurrentBoard = null;
        let unsubscribePresence = null;
        let presenceInterval = null;
        let isRemoteUpdate = false;

        // --- Auth Functions ---
        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => alert("Login Error: " + error.message));
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
            userMenu.classList.remove('show');
        });

        userAvatarBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenu.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!userMenu.contains(e.target) && e.target !== userAvatarBtn) {
                userMenu.classList.remove('show');
            }
        });

        // --- Auth State Observer ---
        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            if (user) {
                // UI Switch
                loginWrapper.style.display = 'none';
                userWrapper.style.display = 'flex';
                
                // Set User Info
                const photo = user.photoURL || 'https://www.gstatic.com/images/branding/product/1x/avatar_square_grey_512dp.png';
                userAvatarImg.src = photo;
                menuUserImg.src = photo;
                userNameDisp.textContent = user.displayName;
                userEmailDisp.textContent = user.email;
                
                updateModeBadge(true);
                initCloudApp();
            } else {
                // UI Switch
                loginWrapper.style.display = 'flex';
                userWrapper.style.display = 'none';
                
                updateModeBadge(false);
                stopCloudSync();
                window.initLocalApp();
            }
        });

        function updateModeBadge(isCloud) {
            const badges = document.querySelectorAll('.mode-badge');
            badges.forEach(b => b.remove());

            const badge = document.createElement('span');
            badge.className = `mode-badge ${isCloud ? 'badge-cloud' : 'badge-local'}`;
            badge.textContent = isCloud ? 'CLOUD' : 'LOCAL';
            boardTitle.parentNode.insertBefore(badge, boardTitle.nextSibling);
        }

        // --- Cloud Logic ---

        async function initCloudApp() {
            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', APP_COLLECTION),
                where('members', 'array-contains', window.currentUser.email)
            );

            unsubscribeBoards = onSnapshot(q, (snapshot) => {
                const cloudBoards = [];
                snapshot.forEach(doc => {
                    cloudBoards.push({ id: doc.id, ...doc.data() });
                });

                if (cloudBoards.length === 0 && !window.creatingDefault) {
                    window.creatingDefault = true;
                    createCloudBoard('My First Board').then(() => window.creatingDefault = false);
                } else {
                    window.updateAppData(cloudBoards);
                }
            });
        }

        function stopCloudSync() {
            if (unsubscribeBoards) unsubscribeBoards();
            if (unsubscribeCurrentBoard) unsubscribeCurrentBoard();
            stopPresenceSystem();
            window.appData.boards = [];
            window.appData.currentBoardId = null;
        }

        async function createCloudBoard(title) {
            if (!window.currentUser) return;
            try {
                const docRef = await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', APP_COLLECTION), {
                    title: title,
                    ownerId: window.currentUser.uid,
                    members: [window.currentUser.email],
                    nodes: [],
                    createdAt: serverTimestamp()
                });
                return docRef.id;
            } catch (e) {
                console.error("Error creating board:", e);
            }
        }

        window.cloudAddNewBoard = () => {
            const title = '新畫布 ' + (new Date().toLocaleTimeString());
            createCloudBoard(title);
        };

        window.cloudDeleteBoard = async (boardId) => {
            if (confirm("確定刪除此雲端畫布？(無法復原)")) {
                await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', APP_COLLECTION, boardId));
            }
        };

        window.cloudSwitchBoard = (boardId) => {
            if (unsubscribeCurrentBoard) unsubscribeCurrentBoard();
            stopPresenceSystem();

            document.getElementById('board').innerHTML = '';

            const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', APP_COLLECTION, boardId);
            
            unsubscribeCurrentBoard = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('board-title').innerText = data.title;
                    document.title = data.title;

                    isRemoteUpdate = true;
                    window.renderNodesFromCloud(data.nodes || []);
                    isRemoteUpdate = false;
                } else {
                    window.appData.currentBoardId = null;
                    document.getElementById('board').innerHTML = '';
                    document.getElementById('board-title').innerText = "畫布已刪除";
                }
            });

            startPresenceSystem(boardId);
        };

        window.cloudSaveNodes = async (boardId, nodes) => {
            if (isRemoteUpdate) return;
            const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', APP_COLLECTION, boardId);
            await updateDoc(docRef, { nodes: nodes });
        };

        window.cloudUpdateTitle = async (boardId, newTitle) => {
            const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', APP_COLLECTION, boardId);
            await updateDoc(docRef, { title: newTitle });
        };

        // --- Presence System ---
        async function startPresenceSystem(boardId) {
            if (!window.currentUser) return;
            
            const report = async () => {
                const presenceRef = doc(db, 'artifacts', APP_ID, 'public', 'data', APP_COLLECTION, boardId, 'presence', window.currentUser.uid);
                await setDoc(presenceRef, {
                    uid: window.currentUser.uid,
                    displayName: window.currentUser.displayName,
                    photoURL: window.currentUser.photoURL,
                    lastSeen: serverTimestamp()
                }, { merge: true });
            };
            report();
            presenceInterval = setInterval(report, 60000);

            const presenceCol = collection(db, 'artifacts', APP_ID, 'public', 'data', APP_COLLECTION, boardId, 'presence');
            unsubscribePresence = onSnapshot(presenceCol, (snapshot) => {
                const onlineDiv = document.getElementById('online-users');
                onlineDiv.innerHTML = '';
                const now = Date.now();

                snapshot.forEach(d => {
                    const u = d.data();
                    const lastSeen = u.lastSeen ? (u.lastSeen.toMillis ? u.lastSeen.toMillis() : now) : now;
                    if (now - lastSeen < 120000) {
                        const img = document.createElement('div');
                        img.className = 'user-avatar-sm';
                        img.title = u.displayName;
                        img.innerHTML = `<img src="${u.photoURL}" alt="${u.displayName}">`;
                        onlineDiv.appendChild(img);
                    }
                });
            });
        }

        async function stopPresenceSystem() {
            if (presenceInterval) clearInterval(presenceInterval);
            if (unsubscribePresence) unsubscribePresence();
            document.getElementById('online-users').innerHTML = '';
        }

    </script>

    <script>
        // --- Vanilla JS Logic ---
        
        const board = document.getElementById('board');
        const boardTitle = document.getElementById('board-title');
        const docPanel = document.getElementById('doc-panel');
        const panelContent = document.getElementById('panel-content');
        
        let zIndexCounter = 100;
        
        window.appData = {
            boards: [],
            currentBoardId: null
        };

        let currentColor = { bg: 'var(--note-yellow)', text: '#222', isDark: false };
        const colors = {
            yellow: { bg: 'var(--note-yellow)', text: '#222', isDark: false },
            green: { bg: 'var(--note-green)', text: '#222', isDark: false },
            blue: { bg: 'var(--note-blue)', text: '#222', isDark: false },
            pink: { bg: 'var(--note-pink)', text: '#222', isDark: false },
            dark: { bg: 'var(--note-dark)', text: '#ddd', isDark: true }
        };

        // --- Init Logic ---
        window.initLocalApp = function() {
            const meta = localStorage.getItem('piCanvas_v3_meta');
            if (meta) {
                window.appData = JSON.parse(meta);
            } else {
                const defaultBoardId = 'local_' + Date.now();
                window.appData.boards = [{ id: defaultBoardId, title: '本地草稿' }];
                window.appData.currentBoardId = defaultBoardId;
                saveLocalMeta();
            }

            if (window.appData.boards.length > 0) {
                if (!window.appData.boards.find(b => b.id === window.appData.currentBoardId)) {
                    window.appData.currentBoardId = window.appData.boards[0].id;
                }
                switchBoard(window.appData.currentBoardId);
            } else {
                addNewBoard();
            }
            updatePanelList();
        }

        // --- Unified Data Handling ---
        window.updateAppData = function(cloudBoards) {
            window.appData.boards = cloudBoards;
            if (cloudBoards.length > 0) {
                if (!window.appData.currentBoardId || !cloudBoards.find(b => b.id === window.appData.currentBoardId)) {
                    switchBoard(cloudBoards[0].id);
                } else {
                    updatePanelList();
                }
            } else {
                board.innerHTML = '';
                boardTitle.innerText = "無專案";
                updatePanelList();
            }
        }

        // --- Board Management ---
        window.addNewBoard = function() {
            if (window.currentUser) {
                window.cloudAddNewBoard();
            } else {
                const newId = 'local_' + Date.now();
                const newTitle = '新畫布 ' + (window.appData.boards.length + 1);
                window.appData.boards.push({ id: newId, title: newTitle });
                saveLocalMeta();
                switchBoard(newId);
            }
        }

        window.switchBoard = function(boardId) {
            const target = window.appData.boards.find(b => b.id === boardId);
            if (!target) return;
            
            window.appData.currentBoardId = boardId;
            updatePanelList();

            if (window.currentUser) {
                window.cloudSwitchBoard(boardId);
            } else {
                saveLocalMeta();
                loadLocalBoard(boardId);
            }
        }

        window.deleteBoard = function(e, boardId) {
            e.stopPropagation();
            if (confirm("確定刪除此畫布？")) {
                if (window.currentUser) {
                    window.cloudDeleteBoard(boardId);
                } else {
                    if (window.appData.boards.length <= 1) return alert("至少保留一個！");
                    window.appData.boards = window.appData.boards.filter(b => b.id !== boardId);
                    localStorage.removeItem('piCanvas_v3_content_' + boardId);
                    
                    if (window.appData.currentBoardId === boardId) {
                        switchBoard(window.appData.boards[0].id);
                    } else {
                        saveLocalMeta();
                        updatePanelList();
                    }
                }
            }
        }

        // --- Local Storage Helpers ---
        function saveLocalMeta() {
            localStorage.setItem('piCanvas_v3_meta', JSON.stringify(window.appData));
        }
        
        function loadLocalBoard(boardId) {
            board.innerHTML = '';
            const target = window.appData.boards.find(b => b.id === boardId);
            boardTitle.innerText = target ? target.title : '';
            document.title = target ? target.title : 'Pi-Canvas';

            const contentJson = localStorage.getItem('piCanvas_v3_content_' + boardId);
            if (contentJson) {
                const nodes = JSON.parse(contentJson);
                nodes.forEach(n => createNoteDOM(n));
            }
            updatePanelList();
        }

        function saveLocalNodes() {
            if (!window.appData.currentBoardId) return;
            const nodes = getNodesFromDOM();
            localStorage.setItem('piCanvas_v3_content_' + window.appData.currentBoardId, JSON.stringify(nodes));
        }

        // --- DOM & Logic ---
        function getNodesFromDOM() {
            const nodes = [];
            document.querySelectorAll('.note').forEach(note => {
                nodes.push({
                    id: note.id,
                    x: parseFloat(note.style.left),
                    y: parseFloat(note.style.top),
                    w: note.style.width,
                    h: note.style.height,
                    content: note.querySelector('.note-content').innerHTML,
                    title: note.querySelector('.note-title-input').value,
                    color: {
                        bg: note.dataset.bg,
                        text: note.dataset.text,
                        isDark: note.dataset.isDark === 'true'
                    }
                });
            });
            return nodes;
        }

        window.renderNodesFromCloud = function(cloudNodes) {
            board.innerHTML = ''; 
            cloudNodes.forEach(n => createNoteDOM(n));
            updatePanelList();
        }

        boardTitle.addEventListener('input', () => {
            const newTitle = boardTitle.innerText;
            if (window.currentUser && window.appData.currentBoardId) {
                window.cloudUpdateTitle(window.appData.currentBoardId, newTitle);
            } else {
                const b = window.appData.boards.find(b => b.id === window.appData.currentBoardId);
                if (b) {
                    b.title = newTitle;
                    saveLocalMeta();
                    updatePanelList();
                }
            }
        });

        // --- Note Logic ---
        function createNoteDOM(data) {
            const note = document.createElement('div');
            note.classList.add('note');
            note.id = data.id || ('note_' + Date.now() + Math.random().toString(36).substr(2,9));
            
            const useColor = data.color || currentColor;

            note.style.left = (data.x || (100 + Math.random()*100)) + 'px';
            note.style.top = (data.y || (100 + Math.random()*100)) + 'px';
            note.style.width = data.w || '240px';
            note.style.height = data.h || '180px';
            note.style.backgroundColor = useColor.bg;
            note.style.color = useColor.text;
            note.style.zIndex = zIndexCounter++;
            note.dataset.dark = useColor.isDark;

            note.dataset.bg = useColor.bg;
            note.dataset.text = useColor.text;
            note.dataset.isDark = useColor.isDark;

            note.innerHTML = `
                <div class="note-header">
                    <span class="drag-handle">⣿</span>
                    <input type="text" class="note-title-input" value="${data.title || ''}" placeholder="未命名">
                    <span class="close-btn" onclick="deleteNote(this)">×</span>
                </div>
                <div class="note-toolbar">
                    <button onmousedown="event.preventDefault(); formatDoc('bold')" title="粗體"><b>B</b></button>
                    <button onmousedown="event.preventDefault(); formatDoc('italic')" title="斜體"><i>I</i></button>
                    <button onmousedown="event.preventDefault(); formatDoc('underline')" title="底線"><u>U</u></button>
                    <span class="toolbar-sep">|</span>
                    <button onmousedown="event.preventDefault(); formatDoc('fontSize', '5')" title="字體加大">A+</button>
                    <button onmousedown="event.preventDefault(); formatDoc('fontSize', '3')" title="恢復">A</button>
                    <span class="toolbar-sep">|</span>
                    <button onmousedown="event.preventDefault(); formatDoc('insertUnorderedList')" title="清單">≣</button>
                </div>
                <div class="note-content" contenteditable="true" spellcheck="false">${data.content || ''}</div>
            `;

            makeDraggable(note);
            note.onmousedown = () => { note.style.zIndex = zIndexCounter++; };
            
            const contentDiv = note.querySelector('.note-content');
            const titleInput = note.querySelector('.note-title-input');

            const triggerSave = () => {
                if (window.currentUser) {
                     const nodes = getNodesFromDOM();
                     window.cloudSaveNodes(window.appData.currentBoardId, nodes);
                } else {
                    saveLocalNodes();
                }
            };

            contentDiv.oninput = triggerSave;
            titleInput.oninput = () => { triggerSave(); updatePanelList(); };
            titleInput.onmousedown = (e) => e.stopPropagation();

            new ResizeObserver(() => {
                triggerSave(); 
            }).observe(note);

            board.appendChild(note);
        }

        window.createNote = function() {
            createNoteDOM({ content: '', title: '' });
            if(window.currentUser) window.cloudSaveNodes(window.appData.currentBoardId, getNodesFromDOM());
            else saveLocalNodes();
            updatePanelList();
        }

        window.deleteNote = function(btn) {
            btn.closest('.note').remove();
            if(window.currentUser) window.cloudSaveNodes(window.appData.currentBoardId, getNodesFromDOM());
            else saveLocalNodes();
            updatePanelList();
        }

        window.clearCurrentBoard = function() {
            if(confirm('清空畫布？')) {
                board.innerHTML = '';
                if(window.currentUser) window.cloudSaveNodes(window.appData.currentBoardId, []);
                else saveLocalNodes();
                updatePanelList();
            }
        }

        function highlightNote(note) {
            note.style.zIndex = ++zIndexCounter;
            note.scrollIntoView({ behavior: 'smooth', block: 'center' });
            note.classList.remove('highlight');
            void note.offsetWidth;
            note.classList.add('highlight');
        }

        function formatDoc(cmd, value) {
            document.execCommand(cmd, false, value);
        }

        function updatePanelList() {
            panelContent.innerHTML = '';
            window.appData.boards.forEach(b => {
                const isActive = b.id === window.appData.currentBoardId;
                const item = document.createElement('div');
                item.className = 'board-item' + (isActive ? ' active' : '');
                item.onclick = () => { if (!isActive) switchBoard(b.id); };

                const header = document.createElement('div');
                header.className = 'board-header';
                header.innerHTML = `<span>${b.title}</span><span class="board-delete-btn" onclick="deleteBoard(event, '${b.id}')">×</span>`;
                item.appendChild(header);

                if (isActive) {
                    const sublist = document.createElement('div');
                    sublist.className = 'note-sublist';
                    const notes = document.querySelectorAll('.note');
                    
                    if (notes.length === 0) {
                        sublist.innerHTML = '<div style="padding:5px 10px; font-size:12px; color:#555;">(無便條)</div>';
                    } else {
                        notes.forEach((note, idx) => {
                            const titleInput = note.querySelector('.note-title-input');
                            const noteTitle = titleInput ? titleInput.value : '';
                            const displayTitle = noteTitle || `便條 ${idx+1}`;
                            const bg = note.style.backgroundColor;
                            
                            const noteEl = document.createElement('div');
                            noteEl.className = 'note-item';
                            noteEl.innerHTML = `<div class="note-dot" style="background:${bg}"></div><span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${displayTitle}</span>`;
                            noteEl.onclick = (e) => {
                                e.stopPropagation();
                                highlightNote(note);
                            };
                            sublist.appendChild(noteEl);
                        });
                    }
                    item.appendChild(sublist);
                }

                panelContent.appendChild(item);
            });
        }

        function selectColor(colorName, el) {
            currentColor = colors[colorName];
            document.querySelectorAll('.menu-color-option').forEach(dot => dot.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('colorBtnIndicator').style.backgroundColor = currentColor.bg;
        }

        function toggleDocPanel() {
            docPanel.classList.toggle('open');
            document.getElementById('listToggleBtn').classList.toggle('active');
        }
        
        function makeDraggable(el) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = el.querySelector('.note-header');
            
            header.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                if(e.target.tagName === 'INPUT' || e.target.classList.contains('close-btn')) return;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                el.style.opacity = "0.9";
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                let newTop = el.offsetTop - pos2;
                let newLeft = el.offsetLeft - pos1;
                
                const sidebarWidth = 60;
                if (newLeft < sidebarWidth) newLeft = sidebarWidth;
                if (newTop < 0) newTop = 0;

                el.style.top = newTop + "px";
                el.style.left = newLeft + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                el.style.opacity = "1";
                if(window.currentUser) window.cloudSaveNodes(window.appData.currentBoardId, getNodesFromDOM());
                else saveLocalNodes();
            }
        }
        
        window.selectColor = selectColor;
        window.toggleDocPanel = toggleDocPanel;
        window.formatDoc = formatDoc;

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Delete') clearCurrentBoard();
            if (e.key.toLowerCase() === 'l' && !e.target.isContentEditable && e.target.tagName !== 'INPUT') toggleDocPanel();
        });

    </script>
</body>
</html>
