<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brooklyn Terminal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Outfit', sans-serif; }
        
        /* 隱藏 Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 簡單的淡入動畫 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* 模擬 React 的 Zoom In 動畫 */
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-zoom-in {
            animation: zoomIn 0.2s ease-out forwards;
        }
        .markdown-body { font-size: 0.95rem; line-height: 1.6; color: inherit; word-wrap: break-word; }
        .markdown-body pre { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; overflow-x: auto; margin: 10px 0; border: 1px solid rgba(255,255,255,0.1); }
        .markdown-body code { font-family: 'Courier New', monospace; background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 4px; font-size: 0.9em; }
        .markdown-body p { margin-bottom: 10px; }
    
        /* Thinking 動畫 */
        .typing-indicator { display: inline-flex; gap: 4px; padding: 5px 10px; background: rgba(255,255,255,0.05); border-radius: 12px; align-items: center; }
        .typing-dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; opacity: 0.6; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

    </style>

</head>
<body>
    <!-- 應用程式掛載點 -->
    <div id="app"></div>

    <!-- 應用程式邏輯 -->
    <script type="module">
        // --- 1. Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, setDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 2. 設定與變數 ---
        const WORKER_URL = "https://nodex-proxy.coreinformation30.workers.dev"; // API 代理
        
        const firebaseConfig = {
            apiKey: "AIzaSyAIwisA_UnOiNRVwYE6tJV47Sp3_1i19IM",
            authDomain: "brooklyn-terminal.firebaseapp.com",
            projectId: "brooklyn-terminal",
            storageBucket: "brooklyn-terminal.firebasestorage.app",
            messagingSenderId: "438411734316",
            appId: "1:438411734316:web:649051890cf381eb0fd089",
            measurementId: "G-G0GMW0XHG1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // 應用程式狀態
        const state = {
            isSidebarOpen: false,
            isSettingsOpen: false,
            isLangMenuOpen: false,
            isThemeMenuOpen: false,
            language: 'zh-TW',
            theme: 'business', // 預設改為商務白，方便測試
            activePage: 'nodex',
            user: null,
            // LLM 相關狀態
            currentModel: 'gemini-2.5-flash',
            currentChatId: null,
            isSearchEnabled: false,
            inputMessage: ''
        };

        // --- 3. 資料與設定 (Translations & Styles) ---
        // (保留你原本的 translations 和 themeStyles，為了版面整潔這裡省略內容，請務必貼上你原本的物件)
        const translations = {
            'zh-TW': { newChat: '開啟新對話', tempChat: '臨時對話', settings: '設定', activity: '活動紀錄', scheduled: '排定的動作', theme: '主題', themeDefault: '深夜', themeBusiness: '商務', themeCyberpunk: '霓虹', language: '語言', manageSub: '管理訂閱項目', upgradeMaster: '升級至 Master', feedback: '提供意見', help: '說明', login: '登入帳號', logout: '登出', pulse: 'Pulse', space: 'Space', nodex: 'NodeX' },
            'en-US': { newChat: 'New Chat', tempChat: 'Temporary Chat', settings: 'Settings', activity: 'Activity', scheduled: 'Scheduled Actions', theme: 'Theme', themeDefault: 'Dark', themeBusiness: 'Business', themeCyberpunk: 'Neon', language: 'Language', manageSub: 'Manage Subscription', upgradeMaster: 'Upgrade to Master', feedback: 'Send Feedback', help: 'Help', login: 'Sign In', logout: 'Log Out', pulse: 'Pulse', space: 'Space', nodex: 'NodeX' }
        };

        const themeStyles = {
             default: { appBg: 'bg-[#131314]', sidebarBg: 'bg-[#1E1F20]', textPrimary: 'text-gray-200', textSecondary: 'text-gray-400', textHover: 'hover:text-white', iconColor: 'text-gray-400', buttonHover: 'hover:bg-[#333537]', primaryBtnBg: 'bg-[#1A1A1C]', primaryBtnHover: 'hover:bg-[#28292C]', gridBtnBgOpen: 'bg-[#28292C]/40', popupBg: 'bg-[#2B2C2E]', popupBorder: 'border-[#444]', separator: 'bg-[#444]', userBlockBg: 'bg-[#28292C]/50', userBlockBorder: 'border-[#333]', activeItemBg: 'bg-[#28292C]', loginBorder: 'border-gray-700 hover:border-gray-500', logoText: 'text-[#C4C7C5] font-bold tracking-tight', spaceColor: 'text-blue-400', spaceHoverBorder: 'group-hover:border-blue-500/30', spaceHoverShadow: 'group-hover:shadow-blue-900/20', spaceBg: 'bg-gradient-to-br from-blue-900/10 to-transparent', pulseColor: 'text-rose-400', pulseHoverBorder: 'group-hover:border-rose-500/30', pulseHoverShadow: 'group-hover:shadow-rose-900/20', pulseBg: 'bg-gradient-to-br from-rose-900/10 to-transparent', nodexColor: 'text-emerald-400', nodexHoverBorder: 'group-hover:border-emerald-500/30', nodexHoverShadow: 'group-hover:shadow-emerald-900/20', nodexBg: 'bg-gradient-to-br from-emerald-900/10 to-transparent', chatBubbleUser: 'bg-[#2B2C2E]', chatBubbleAi: 'bg-transparent' },
             business: { appBg: 'bg-[#f0f2f5]', sidebarBg: 'bg-white', textPrimary: 'text-gray-800', textSecondary: 'text-gray-500', textHover: 'hover:text-black', iconColor: 'text-gray-600', buttonHover: 'hover:bg-gray-100', primaryBtnBg: 'bg-gray-100', primaryBtnHover: 'hover:bg-gray-200', gridBtnBgOpen: 'bg-gray-50', popupBg: 'bg-white', popupBorder: 'border-gray-200', separator: 'bg-gray-200', userBlockBg: 'bg-gray-50', userBlockBorder: 'border-gray-200', activeItemBg: 'bg-gray-100', loginBorder: 'border-gray-300 hover:border-gray-400', logoText: 'text-gray-800 font-bold tracking-tight', spaceColor: 'text-blue-600', spaceHoverBorder: 'group-hover:border-blue-200', spaceHoverShadow: 'group-hover:shadow-blue-200', spaceBg: 'bg-blue-50', pulseColor: 'text-rose-600', pulseHoverBorder: 'group-hover:border-rose-200', pulseHoverShadow: 'group-hover:shadow-rose-200', pulseBg: 'bg-rose-50', nodexColor: 'text-emerald-600', nodexHoverBorder: 'group-hover:border-emerald-200', nodexHoverShadow: 'group-hover:shadow-emerald-200', nodexBg: 'bg-emerald-50', chatBubbleUser: 'bg-white border border-gray-200 shadow-sm', chatBubbleAi: 'bg-transparent' },
             cyberpunk: { appBg: 'bg-black', sidebarBg: 'bg-[#050505] border-r border-[#ff00ff]/30 shadow-[4px_0_20px_-5px_rgba(255,0,255,0.2)]', textPrimary: 'text-[#ff00ff] drop-shadow-[0_0_2px_rgba(255,0,255,0.8)]', textSecondary: 'text-[#00ffff] drop-shadow-[0_0_1px_rgba(0,255,255,0.5)]', textHover: 'hover:text-[#ffffff] hover:drop-shadow-[0_0_5px_rgba(255,255,255,1)]', iconColor: 'text-[#ff00ff] drop-shadow-[0_0_3px_#ff00ff]', buttonHover: 'hover:bg-[#111] hover:shadow-[inset_0_0_10px_#ff00ff] hover:border hover:border-[#ff00ff]', primaryBtnBg: 'bg-[#000] border border-[#00ffff] shadow-[0_0_5px_#00ffff]', primaryBtnHover: 'hover:bg-[#111] hover:shadow-[0_0_15px_#00ffff]', gridBtnBgOpen: 'bg-[#000] border border-[#ff00ff] shadow-[0_0_5px_#ff00ff]', popupBg: 'bg-black', popupBorder: 'border-[#00ffff] shadow-[0_0_15px_#00ffff]', separator: 'bg-[#00ffff] shadow-[0_0_5px_#00ffff]', userBlockBg: 'bg-[#000]', userBlockBorder: 'border-[#ff00ff] shadow-[0_0_8px_#ff00ff]', activeItemBg: 'bg-[#1a1a1a] border-l-2 border-[#00ff00] shadow-[0_0_10px_rgba(0,255,0,0.3)]', loginBorder: 'border-[#00ffff] shadow-[0_0_5px_#00ffff] hover:border-[#ffffff] hover:shadow-[0_0_10px_#ffffff]', logoText: 'text-[#00ffff] font-bold tracking-widest drop-shadow-[0_0_5px_#00ffff] font-mono', spaceColor: 'text-[#00ffff] drop-shadow-[0_0_3px_#00ffff]', spaceHoverBorder: 'group-hover:border-[#00ffff]', spaceHoverShadow: 'group-hover:shadow-[0_0_20px_#00ffff]', spaceBg: 'bg-black', pulseColor: 'text-[#ff00ff] drop-shadow-[0_0_3px_#ff00ff]', pulseHoverBorder: 'group-hover:border-[#ff00ff]', pulseHoverShadow: 'group-hover:shadow-[0_0_20px_#ff00ff]', pulseBg: 'bg-black', nodexColor: 'text-[#00ff00] drop-shadow-[0_0_3px_#00ff00]', nodexHoverBorder: 'group-hover:border-[#00ff00]', nodexHoverShadow: 'group-hover:shadow-[0_0_20px_#00ff00]', nodexBg: 'bg-black', chatBubbleUser: 'bg-[#111] border border-[#00ff00]', chatBubbleAi: 'bg-black' }
        };

        const Icons = {
            Workspace: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect x="3" y="3" width="7" height="7" rx="2" /><rect x="14" y="3" width="7" height="7" rx="2" /><rect x="14" y="14" width="7" height="7" rx="2" /><rect x="3" y="14" width="7" height="7" rx="2" /></svg>`,
            PulseStreet: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M22 12h-4l-3 9L9 3l-3 9H2" /></svg>`,
            NodeX: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M18 6L6 18M6 6l12 12" /></svg>`,
            MasterStar: `<svg viewBox="0 0 24 24" fill="none" class="w-5 h-5 text-yellow-400"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>`
        };

        // --- 4. Window API (HTML onclick 進入點) ---
        window.app = {
            // UI 控制
            toggleSidebar: () => { state.isSidebarOpen = !state.isSidebarOpen; render(); },
            toggleSettings: (e) => { if(e) e.stopPropagation(); state.isSettingsOpen = !state.isSettingsOpen; state.isLangMenuOpen = false; state.isThemeMenuOpen = false; render(); },
            setPage: (id) => { state.activePage = id; render(); },
            setLanguage: (lang) => { state.language = lang; render(); },
            setTheme: (theme) => { state.theme = theme; render(); },
            toggleLangMenu: (e) => { e.stopPropagation(); state.isLangMenuOpen = !state.isLangMenuOpen; state.isThemeMenuOpen = false; render(); },
            toggleThemeMenu: (e) => { e.stopPropagation(); state.isThemeMenuOpen = !state.isThemeMenuOpen; state.isLangMenuOpen = false; render(); },
            
            // Auth 控制
            login: async () => { try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); alert(e.message); } },
            logout: async () => { try { await signOut(auth); state.user = null; render(); } catch (e) { console.error(e); } },

            // NodeX Chat 控制
            toggleSearch: () => { 
                state.isSearchEnabled = !state.isSearchEnabled; 
                // 更新按鈕樣式 (Direct DOM manipulation for speed)
                const btn = document.getElementById('btn-web-search');
                if(btn) btn.style.color = state.isSearchEnabled ? '#60a5fa' : 'inherit'; // Blue or inherit
            },
            setModel: (model) => { 
                state.currentModel = model; 
                document.getElementById('model-display').innerText = model;
            },
            
            // 發送訊息 (API 核心)
            sendMessage: async () => {
                const inputEl = document.getElementById('nodex-input');
                const text = inputEl.value.trim();
                if(!text) return;
                
                if (!state.user) { alert("請先登入 (Sign In First)"); return; }

                // 1. 清空輸入框 & UI 調整
                inputEl.value = '';
                state.inputMessage = ''; // clear state buffer
                
                const historyEl = document.getElementById('nodex-chat-history');
                const welcomeEl = document.getElementById('nodex-welcome');
                if(welcomeEl) welcomeEl.style.display = 'none'; // 隱藏歡迎詞
                
                // 2. 顯示使用者訊息
                appendMessage('user', text);

                // 3. 準備 Loading
                const loadingId = appendLoading();

                try {
                    // 4. API 呼叫
                    const response = await fetch(WORKER_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            model: state.currentModel,
                            useSearch: state.isSearchEnabled,
                            contents: [{ parts: [{ text: text }] }] 
                        })
                    });

                    if (!response.ok) throw new Error("API Error");

                    // 5. 處理串流 (Stream)
                    removeElement(loadingId);
                    const aiContentEl = appendMessage('ai', ''); // 建立空的 AI 訊息框
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullText = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        // 簡單解析 JSON Stream 格式 (假設 Worker 回傳的是 JSON line 或是特定格式)
                        // 這裡沿用你 Nodex 的正則邏輯
                        const matches = chunk.match(/"text":\s*"((?:[^"\\]|\\.)*)"/g);
                        if (matches) {
                            matches.forEach(match => {
                                let textPart = match.replace(/"text":\s*"/, "").replace(/"$/, "");
                                try {
                                    textPart = JSON.parse(`"${textPart}"`); // 解碼 unicode
                                    fullText += textPart;
                                    // 即時渲染 Markdown
                                    aiContentEl.innerHTML = marked.parse(fullText);
                                    // 捲動到底部
                                    historyEl.scrollTop = historyEl.scrollHeight;
                                } catch(e) {}
                            });
                        }
                    }
                    
                    // 6. 渲染數學公式 (Katex)
                    renderMathInElement(aiContentEl, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });

                    // 7. (可選) 存入 Firestore 歷史紀錄
                    // await addDoc(...) 
                    
                } catch (error) {
                    removeElement(loadingId);
                    appendMessage('system', `Error: ${error.message}`);
                }
            }
        };

        // --- 5. 輔助函式 (DOM Manipulation) ---
        function appendMessage(role, text) {
            const container = document.getElementById('nodex-chat-history');
            if(!container) return null;

            const div = document.createElement('div');
            const s = themeStyles[state.theme];
            
            div.className = `flex w-full mb-6 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            if (role === 'user') {
                div.innerHTML = `
                    <div class="max-w-[80%] ${s.chatBubbleUser} px-4 py-3 rounded-2xl rounded-tr-sm text-sm whitespace-pre-wrap leading-relaxed shadow-sm">
                        ${text}
                    </div>
                `;
            } else if (role === 'ai') {
                div.innerHTML = `
                    <div class="flex gap-3 max-w-[90%]">
                        <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center shrink-0 border border-emerald-500/20">
                            ${Icons.NodeX}
                        </div>
                        <div class="markdown-body text-sm pt-1 ${s.textPrimary}"></div>
                    </div>
                `;
            } else { // system
                div.innerHTML = `<div class="w-full text-center text-xs opacity-50 my-2">${text}</div>`;
                container.appendChild(div);
                return;
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            if(role === 'ai') return div.querySelector('.markdown-body');
        }

        function appendLoading() {
            const container = document.getElementById('nodex-chat-history');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex w-full justify-start mb-6 gap-3";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center shrink-0 border border-emerald-500/20">
                    ${Icons.NodeX}
                </div>
                <div class="typing-indicator text-emerald-500">
                    <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeElement(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // --- 6. 渲染邏輯 (Render) ---
        function render() {
            const t = translations[state.language];
            const s = themeStyles[state.theme];

            const projectButtons = [
                { id: 'pulsestreet', label: t.pulse, iconHtml: Icons.PulseStreet, color: s.pulseColor, hoverBorder: s.pulseHoverBorder, hoverShadow: s.pulseHoverShadow, bg: s.pulseBg },
                { id: 'workspace', label: t.space, iconHtml: Icons.Workspace, color: s.spaceColor, hoverBorder: s.spaceHoverBorder, hoverShadow: s.spaceHoverShadow, bg: s.spaceBg },
                { id: 'nodex', label: t.nodex, iconHtml: Icons.NodeX, color: s.nodexColor, hoverBorder: s.nodexHoverBorder, hoverShadow: s.nodexHoverShadow, bg: s.nodexBg },
            ];

            // --- Main Content 邏輯 ---
            let mainContentHtml = '';
            
            if (state.activePage === 'nodex') {
                // NodeX: 聊天介面 (核心修改處)
                mainContentHtml = `
                    <div class="flex-1 flex flex-col h-full animate-fade-in relative">
                        <header class="flex items-center justify-between px-6 pt-6 pb-4 border-b border-white/5 shrink-0 z-10">
                            <div>
                                <h1 class="text-xl font-semibold tracking-tight ${s.textPrimary}">${t.nodex}</h1>
                                <p class="text-xs opacity-70 mt-1 ${s.textSecondary}">LLM Gateway</p>
                            </div>
                            <div class="flex items-center gap-2 text-xs opacity-70">
                                <span class="px-2 py-1 rounded-full border border-white/10 text-[11px] uppercase tracking-wide">AI Connected</span>
                            </div>
                        </header>
                        
                        <div id="nodex-chat-history" class="flex-1 overflow-y-auto p-4 md:p-6 w-full max-w-4xl mx-auto scrollbar-hide">
                            <div id="nodex-welcome" class="flex flex-col items-center justify-center h-full opacity-60">
                                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-transparent flex items-center justify-center mb-4 border border-emerald-500/20">
                                    ${Icons.NodeX}
                                </div>
                                <h2 class="text-lg font-medium ${s.textPrimary}">Thinking in Nodes</h2>
                            </div>
                        </div>

                        <div class="p-4 w-full flex justify-center shrink-0 pb-8">
                            <div class="w-full max-w-3xl flex flex-col gap-3">
                                <div class="w-full ${s.sidebarBg} rounded-[1.5rem] border ${s.popupBorder} shadow-lg relative flex flex-col transition-colors duration-300 ring-1 ring-white/5 focus-within:ring-emerald-500/50">
                                    <textarea id="nodex-input" 
                                        class="w-full bg-transparent ${s.textPrimary} placeholder-gray-500 px-5 py-4 resize-none outline-none overflow-hidden min-h-[56px] text-[15px]" 
                                        placeholder="Ask anything..." 
                                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); app.sendMessage(); }"></textarea>
                                    
                                    <div class="flex items-center justify-between px-3 pb-3 pt-1">
                                        <div class="flex items-center gap-1">
                                            <button id="btn-web-search" onclick="app.toggleSearch()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full ${s.buttonHover} transition-colors border border-transparent hover:border-white/10 group">
                                                <i data-lucide="globe" width="14" class="transition-colors"></i>
                                                <span class="text-xs font-medium ${s.textSecondary}">Search</span>
                                            </button>
                                            
                                            <button class="flex items-center gap-1.5 px-3 py-1.5 rounded-full ${s.buttonHover} transition-colors border border-transparent hover:border-white/10 group">
                                                <i data-lucide="cpu" width="14" class="${s.textSecondary}"></i>
                                                <span id="model-display" class="text-xs font-medium ${s.textSecondary} group-hover:text-emerald-400 transition-colors">${state.currentModel}</span>
                                            </button>
                                        </div>
                                        
                                        <div class="flex items-center gap-1">
                                            <button onclick="app.sendMessage()" class="p-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl transition-all shadow-md hover:shadow-lg flex items-center justify-center active:scale-95">
                                                <i data-lucide="arrow-up" width="18"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center"><p class="text-[10px] ${s.textSecondary} opacity-60">AI can make mistakes. Check important info.</p></div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.activePage === 'pulsestreet') {
                mainContentHtml = `<div class="flex-1 flex flex-col animate-fade-in"><header class="flex items-center justify-between px-6 pt-6 pb-4 border-b border-white/5"><div><h1 class="text-xl font-semibold tracking-tight ${s.textPrimary}">${t.pulse}</h1></div></header><div class="p-6 text-sm opacity-60 ${s.textSecondary}">Work in progress...</div></div>`;
            } else if (state.activePage === 'workspace') {
                mainContentHtml = `<div class="flex-1 flex flex-col animate-fade-in"><header class="flex items-center justify-between px-6 pt-6 pb-4 border-b border-white/5"><div><h1 class="text-xl font-semibold tracking-tight ${s.textPrimary}">${t.space}</h1></div></header><div class="p-6 text-sm opacity-60 ${s.textSecondary}">Work in progress...</div></div>`;
            }

            // --- Settings Popup 邏輯 (簡略) ---
            let settingsPopupHtml = '';
            if (state.isSettingsOpen) {
                const items = [
                    { id: 'theme', icon: 'sun', label: t.theme, isThemeTrigger: true },
                    { id: 'language', icon: 'globe', label: t.language, isLangTrigger: true },
                    { id: 'logout', icon: 'log-out', label: state.user ? t.logout : t.login, onClick: state.user ? 'app.logout()' : 'app.login()', special: !state.user }
                ];
                
                const menuItems = items.map(item => {
                    let subHtml = '';
                    if (item.isThemeTrigger && state.isThemeMenuOpen) {
                        subHtml = `<div class="${s.activeItemBg} mt-1 rounded-lg overflow-hidden"><button onclick="app.setTheme('business')" class="w-full text-left px-4 py-2 text-xs ${s.textSecondary} hover:text-blue-400">Business</button><button onclick="app.setTheme('cyberpunk')" class="w-full text-left px-4 py-2 text-xs ${s.textSecondary} hover:text-pink-400">Cyberpunk</button></div>`;
                    }
                    if (item.isLangTrigger && state.isLangMenuOpen) {
                        subHtml = `<div class="${s.activeItemBg} mt-1 rounded-lg overflow-hidden"><button onclick="app.setLanguage('zh-TW')" class="w-full text-left px-4 py-2 text-xs ${s.textSecondary}">中文</button><button onclick="app.setLanguage('en-US')" class="w-full text-left px-4 py-2 text-xs ${s.textSecondary}">English</button></div>`;
                    }
                    
                    return `
                        <div>
                            <button onclick="${item.onClick || (item.isThemeTrigger ? 'app.toggleThemeMenu(event)' : 'app.toggleLangMenu(event)')}" class="w-full flex items-center gap-3 px-4 py-2.5 ${s.buttonHover} transition-colors text-left rounded-lg">
                                <i data-lucide="${item.icon}" width="16" class="${item.special ? 'text-emerald-400' : s.textSecondary}"></i>
                                <span class="text-[13px] ${s.textPrimary}">${item.label}</span>
                            </button>
                            ${subHtml}
                        </div>`;
                }).join('');
                
                settingsPopupHtml = `<div id="settings-popup" class="absolute bottom-full left-12 mb-2 w-[240px] ${s.popupBg} rounded-xl shadow-2xl border ${s.popupBorder} p-2 z-50 animate-zoom-in flex flex-col gap-1">${menuItems}</div>`;
            }

            // --- Grid Buttons (Side) ---
            const gridButtonsHtml = projectButtons.map(btn => {
                const isActive = state.activePage === btn.id;
                const btnClass = `relative group flex flex-col rounded-xl border border-transparent transition-all duration-300 ${state.isSidebarOpen ? `w-full p-3 ${isActive ? s.activeItemBg : 'hover:bg-white/5'}` : `w-10 h-10 items-center justify-center p-0 ${isActive ? s.activeItemBg : 'hover:bg-white/5'}`}`;
                
                return `
                    <button onclick="app.setPage('${btn.id}')" class="${btnClass}" title="${btn.label}">
                         <div class="${isActive ? btn.color : s.textSecondary} transition-colors">${btn.iconHtml}</div>
                         ${state.isSidebarOpen ? `<span class="ml-3 text-sm font-medium ${isActive ? s.textPrimary : s.textSecondary}">${btn.label}</span>` : ''}
                    </button>
                `;
            }).join('');

            // --- User Block ---
            let userHtml = '';
            if (state.user) {
                userHtml = `
                    <div class="flex items-center gap-3 ${state.isSidebarOpen ? 'px-2' : 'justify-center'}">
                        ${state.user.photoURL ? `<img src="${state.user.photoURL}" class="w-8 h-8 rounded-full border border-white/10">` : `<div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-xs font-bold text-white">U</div>`}
                        ${state.isSidebarOpen ? `<div class="flex flex-col overflow-hidden"><span class="text-sm font-medium ${s.textPrimary} truncate">${state.user.displayName}</span><span class="text-[10px] ${s.textSecondary} truncate">Pro Plan</span></div>` : ''}
                    </div>`;
            } else {
                userHtml = `
                    <button onclick="app.login()" class="flex items-center gap-3 w-full p-2 rounded-lg border border-dashed ${s.loginBorder} ${state.isSidebarOpen ? 'justify-start px-3' : 'justify-center'}">
                        <i data-lucide="log-in" width="16" class="${s.textSecondary}"></i>
                        ${state.isSidebarOpen ? `<span class="text-xs ${s.textSecondary}">Sign In</span>` : ''}
                    </button>`;
            }

            // --- DOM Diffing / Update ---
            const appEl = document.getElementById('app');
            let wrapper = document.getElementById('app-wrapper');
            let sidebar = document.getElementById('app-sidebar');
            let main = document.getElementById('app-main');
            let sidebarInner = document.getElementById('sidebar-inner');

            if (!wrapper) {
                appEl.innerHTML = `
                    <div id="app-wrapper" class="flex h-screen w-full overflow-hidden transition-colors duration-300">
                        <aside id="app-sidebar" class="flex flex-col relative z-50 transition-all duration-300 ease-[cubic-bezier(0.25,0.1,0.25,1)] border-r border-transparent">
                            <div id="sidebar-inner" class="flex flex-col h-full w-full"></div>
                        </aside>
                        <main id="app-main" class="flex-1 flex flex-col relative overflow-hidden"></main>
                    </div>`;
                wrapper = document.getElementById('app-wrapper');
                sidebar = document.getElementById('app-sidebar');
                main = document.getElementById('app-main');
                sidebarInner = document.getElementById('sidebar-inner');
            }

            wrapper.className = `flex h-screen w-full overflow-hidden transition-colors duration-300 ${s.appBg}`;
            sidebar.className = `flex flex-col relative z-50 transition-all duration-300 ease-[cubic-bezier(0.25,0.1,0.25,1)] ${s.sidebarBg} border-r ${s.popupBorder} ${state.isSidebarOpen ? 'w-[260px]' : 'w-[72px]'}`;

            sidebarInner.innerHTML = `
                <div class="p-4 flex flex-col gap-6 h-full">
                    <div class="flex items-center gap-3 ${state.isSidebarOpen ? '' : 'justify-center'}">
                        <button onclick="app.toggleSidebar()" class="p-2 rounded-lg hover:bg-white/5 ${s.textSecondary} transition-colors">
                            <i data-lucide="${state.isSidebarOpen ? 'panel-left-close' : 'panel-left'}" width="20"></i>
                        </button>
                        ${state.isSidebarOpen ? `<span class="text-lg ${s.logoText}">NodeX</span>` : ''}
                    </div>

                    <div class="flex flex-col gap-1 w-full">
                        ${gridButtonsHtml}
                    </div>

                    <div class="mt-auto flex flex-col gap-2 relative">
                        ${settingsPopupHtml}
                        <div class="py-3 border-t ${s.separator}">
                            ${userHtml}
                        </div>
                        <button id="settings-btn" onclick="app.toggleSettings(event)" class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 ${state.isSidebarOpen ? '' : 'justify-center'}">
                            <i data-lucide="settings-2" width="20" class="${s.textSecondary}"></i>
                            ${state.isSidebarOpen ? `<span class="text-sm ${s.textSecondary}">${t.settings}</span>` : ''}
                        </button>
                    </div>
                </div>
            `;
            
            // 只有當 main 內容結構改變時才更新，避免輸入框失去焦點
            // 這裡簡單做個檢查：如果 ID 不一樣就重繪
            // 實務上 Chat 需要更精細的控制，但目前切換頁面重繪是 OK 的
            if (main.innerHTML === '' || !document.getElementById('nodex-input')) {
                 main.innerHTML = mainContentHtml;
            } else if (state.activePage !== 'nodex') {
                 main.innerHTML = mainContentHtml;
            }
            
            lucide.createIcons();
        }

        // --- 7. Auth Listener & Init ---
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            render();
        });

        // Initial Render
        render();

        // Close Popups on Click Outside
        document.addEventListener('click', (e) => {
            if (state.isSettingsOpen && !e.target.closest('#settings-popup') && !e.target.closest('#settings-btn')) {
                state.isSettingsOpen = false;
                render();
            }
        });

    </script>
</body>

</html>

