<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5bfc21c8d13e485a9f5fbb44151e7360"}'></script>
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>PulseStreet</title> 
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6600' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='22 12 18 12 15 21 9 3 6 12 2 12'%3E%3C/polyline%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet"> 
    <style> 
        /* --- åŸºç¤è®Šæ•¸ (é è¨­: PulseOrange) --- */
        :root { 
            --bg-body: #050505;
            --bg-panel: #111111; 
            --text-primary: #e0e0e0; 
            --text-secondary: #888;
            --border-color: #333; 
            --accent-main: #ff6600; /* PulseStreet å°ˆå±¬æ©™è‰² */
            --accent-hover: #ff9933;
            --font-main: 'Rajdhani', sans-serif;
            --font-display: 'Orbitron', sans-serif;
            --border-radius: 4px;
        }

        /* --- 1. TechBusiness (ç§‘æŠ€å•†å‹™) --- */
        [data-theme-mode="techbusiness"] {
            --bg-body: #1c1c24;
            --bg-panel: #262633;
            --text-primary: #e5e5f0;
            --text-secondary: #99a0b3;
            --border-color: #3f4458;
            --accent-main: #00bcd4; /* å†·é’è—è‰² */
            --accent-hover: #4dd0e1;
        }

        /* --- 2. Cyberpunk (è³½åšé¾å…‹) --- */
        [data-theme-mode="cyberpunk"] {
            --bg-body: #0a001a;
            --bg-panel: #18002d;
            --text-primary: #ff4d94; /* éœ“è™¹ç²‰ */
            --text-secondary: #9933ff;
            --border-color: #330066;
            --accent-main: #cc33ff; /* éœ“è™¹ç´« */
            --accent-hover: #e066ff;
        }
        [data-theme-mode="cyberpunk"] .user-avatar-circle { border-color: var(--accent-main) !important; box-shadow: 0 0 10px var(--accent-main); }
        [data-theme-mode="cyberpunk"] .pulse-logo-svg path { stroke: var(--accent-main); }
        [data-theme-mode="cyberpunk"] .pulse-logo-svg text { fill: #fff; }


        /* --- 3. Terminal (çµ‚ç«¯æ©Ÿ) --- */
        [data-theme-mode="terminal"] {
            --bg-body: #000000;
            --bg-panel: #0a0a0a;
            --text-primary: #00ff00; /* äº®ç¶ è‰² */
            --text-secondary: #008800;
            --border-color: #004400;
            --accent-main: #00ff00;
            --accent-hover: #33ff33;
        }
        [data-theme-mode="terminal"] .pulse-nav-btn:hover { background: rgba(0, 255, 0, 0.1); color: var(--accent-main); }
        [data-theme-mode="terminal"] .pulse-nav-btn.active { color: var(--accent-main); background: rgba(0, 255, 0, 0.05); }
        [data-theme-mode="terminal"] .pulse-post { box-shadow: none; border-radius: 0; }
        [data-theme-mode="terminal"] .pulse-create-box { border-radius: 0; }
        [data-theme-mode="terminal"] .user-avatar-circle { border-radius: 0; }


        
        /* é€šç”¨æ¨£å¼ï¼Œä½¿ç”¨ accent-main */
        * { box-sizing: border-box; user-select: none; font-family: var(--font-main); }
        
        body { 
            margin: 0; padding: 0; 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            height: 100vh;
            overflow: hidden; 
        }
        
        .main-container { height: 100vh; position: relative; overflow: hidden; }
        .pulse-container {
                  width: 100%;
                  height: 100%; 
                  background: var(--bg-body); 
                  overflow: hidden; /* â˜… ä¿®æ”¹ï¼šç¦æ­¢å¤–å±¤æ²å‹•ï¼Œæ”¹ç‚ºå…§éƒ¨ç¨ç«‹æ²å‹• */
                  display: flex; 
                  justify-content: center;
         }
        .pulse-layout {
            width: 1400px; max-width: 98%; height: 100%;
            display: grid; grid-template-columns: 260px 1fr 320px; 
            gap: 20px; padding: 20px 0;
        }

        /* Pulse Sidebar Left */
        .pulse-sidebar-left { 
            /* position: sticky;  <-- é€™è¡Œå¯ä»¥åˆªé™¤ï¼Œå› ç‚ºå¤–å±¤ä¸å‹•äº†ï¼Œå®ƒè‡ªç„¶æœƒå›ºå®š */
            /* top: 0;            <-- é€™è¡Œå¯ä»¥åˆªé™¤ */
            height: 100%;         /* æ”¹ç‚ºå¡«æ»¿é«˜åº¦ */
           overflow-y: auto;     /* å¦‚æœè¢å¹•å¤ªçŸ®ï¼Œå…è¨±å·¦å´å–®ç¨æ²å‹• */
           display: flex; 
           flex-direction: column; 
           gap: 10px; 
           padding-top: 15px;
         }

        .pulse-sidebar-right {
         height: 100%;
         padding-top: 15px;
    
          /* â˜… é—œéµä¿®æ­£ï¼šåŠ å…¥é€™å…©è¡Œä¾†å•Ÿç”¨å½ˆæ€§æ’ç‰ˆ */
         display: flex;          
         flex-direction: column; 
    
         overflow-y: auto;     /* å…§å®¹éå¤šæ™‚ä¿ç•™æ²å‹•åŠŸèƒ½ */
         padding-bottom: 20px; /* åº•éƒ¨ç•™ä¸€é»ç©ºé–“æ¯”è¼ƒå¥½çœ‹ */
        }

        
        .pulse-logo-area { padding: 10px 0 20px 10px; }
        .pulse-logo-svg { height: 40px; width: auto; }
        .pulse-logo-svg path { stroke: var(--accent-main); }

        .pulse-nav-btn {
            display: flex; align-items: center; gap: 15px; padding: 12px 20px;
            border-radius: 30px; color: var(--text-primary); text-decoration: none;
            font-size: 1.1em; font-weight: 500; transition: all 0.2s;
            cursor: pointer; border: 1px solid transparent;
        }
        .pulse-nav-btn:hover { background: rgba(255, 102, 0, 0.1); color: var(--accent-hover); }
        .pulse-nav-btn.active { color: var(--accent-main); font-weight: bold; }
        .pulse-nav-icon { width: 24px; height: 24px; stroke-width: 2px; }

        .pulse-lang-toggle, .pulse-theme-toggle {
            margin-top: 10px; display: flex; align-items: center; gap: 10px; padding: 10px 20px;
            cursor: pointer; color: var(--text-secondary); transition: color 0.3s;
        }
        .pulse-lang-toggle:hover, .pulse-theme-toggle:hover { color: var(--text-primary); }
        
        /* Pulse Center Feed */
       .pulse-feed-container { 
                display: flex;
                flex-direction: column; 
                gap: 20px; 
                min-width: 0; 
                padding-bottom: 50px; 
    
               /* â˜… æ–°å¢ä»¥ä¸‹ä¸‰è¡Œ */
                height: 100%;         /* å¼·åˆ¶å¡«æ»¿é«˜åº¦ */
                overflow-y: auto;     /* åªæœ‰é€™å€‹å€å¡Šæœƒç”¢ç”Ÿç›´å‘æ²è»¸ */
                padding-right: 5px;   /* é¿å…æ²è»¸è“‹ä½å…§å®¹ (é¸ç”¨) */
             }
        .pulse-feed-container::-webkit-scrollbar {display: none;}
       /* --- å€‹äººè³‡æ–™é é¢æ¨£å¼ --- */
.profile-header-card {
    background: var(--bg-panel);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    position: relative;
}
.profile-cover {
    height: 150px;
    background: linear-gradient(45deg, var(--bg-body), var(--accent-main));
    opacity: 0.3;
}
.profile-info-section {
    padding: 20px;
    margin-top: -60px; /* è®“é ­åƒå¾€ä¸Šè“‹ä½å°é¢ */
    position: relative;
    display: flex;
    flex-direction: column;
}
.profile-avatar-big {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 4px solid var(--bg-panel);
    background: #000;
    overflow: hidden;
    margin-bottom: 15px;
}
.profile-avatar-big img { width: 100%; height: 100%; object-fit: cover; }
.profile-name-large {
    font-size: 1.8em;
    font-weight: 900;
    color: #fff;
    font-family: var(--font-display);
}
.profile-email { color: var(--text-secondary); margin-bottom: 15px; }
.profile-stats-row {
    display: flex;
    gap: 20px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
}
.p-stat-box { font-size: 0.9em; color: var(--text-secondary); }
.p-stat-num { color: #fff; font-weight: bold; margin-right: 5px; font-size: 1.1em; }
        
        
        .pulse-create-box {
            background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px;
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            position: relative; 
        }
        .user-avatar-circle {
            width: 48px; height: 48px; border-radius: 50%; background: #222; 
            border: 2px solid var(--accent-main); overflow: hidden; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .user-avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .quick-input {
               flex: 1;
               background: transparent; 
               border: none; 
               font-size: 1.1em; 
               color: var(--text-primary);
               outline: none; 
               resize: none; 
               padding: 10px 0; 
               font-family: var(--font-main);
                 /* â˜… åŠ å…¥æˆ–ç¢ºèªé€™å…©è¡Œ */
               white-space: pre-wrap;     /* è¼¸å…¥æ™‚ä¿ç•™æ ¼å¼ */
               overflow-wrap: break-word; /* è¼¸å…¥é•·å­—ä¸²æ™‚è‡ªå‹•æŠ˜è¡Œ */
           }
        .create-top {
              display: flex;           /* å•Ÿç”¨å½ˆæ€§æ’ç‰ˆ */
              gap: 15px;               /* è¨­å®šé ­åƒèˆ‡è¼¸å…¥æ¡†çš„é–“è· */
              align-items: flex-start; /* è®“å…§å®¹é ä¸Šå°é½Š */
              width: 100%;             /* ç¢ºä¿å®¹å™¨å¯¬åº¦å¡«æ»¿ */
          }

        .create-actions { 
              border-top: 1px solid rgba(255,255,255,0.1); 
              padding-top: 15px;
              display: flex;               /* å•Ÿç”¨å½ˆæ€§æ’ç‰ˆ */
              justify-content: space-between; /* é‡é»ï¼šå·¦å³åˆ†æ•£å°é½Š (åœ–ç¤ºå·¦ï¼ŒæŒ‰éˆ•å³) */
              align-items: center;         /* å‚ç›´ç½®ä¸­å°é½Š */
         }
        .action-icons { color: var(--accent-main); }
        .post-btn {
            background: var(--accent-main); color: #000; border: none; padding: 8px 24px;
            border-radius: 20px; font-weight: bold; cursor: pointer; font-family: var(--font-display);
        }
        .post-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 102, 0, 0.4); }

        /* Disabled Post Box Overlay */
        .post-disabled-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            font-size: 1.2em; color: #ddd; cursor: not-allowed; z-index: 10;
            padding-bottom: 20px; 
        }
        .post-disabled-overlay .login-cta-btn {
            margin-top: 15px; 
            background: var(--accent-main);
            color: #000; border: none; padding: 10px 30px;
            border-radius: 20px; font-weight: bold; cursor: pointer;
            font-family: var(--font-display); font-size: 0.9em;
            pointer-events: auto; 
        }
        .post-disabled-overlay .login-cta-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.4);
        }

        /* --- è²¼æ–‡è¨­è¨ˆèª¿æ•´ (Post Design Adjustments) --- */
        .pulse-post {
            background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px;
            padding: 20px; margin-bottom: 20px; animation: fadeIn 0.5s ease;
        }

        /* --- è²¼æ–‡å³ä¸Šè§’åˆªé™¤æŒ‰éˆ• (SVG) --- */
.delete-post-btn {
    background: none;
    border: none;
    color: var(--text-secondary); /* é è¨­ä½¿ç”¨æ¬¡è¦æ–‡å­—é¡è‰² (ç°è‰²) */
    cursor: pointer;
    margin-left: auto;            /* æ ¸å¿ƒé—œéµï¼šå°‡æŒ‰éˆ•æ¨åˆ°æœ€å³å´ */
    padding: 8px;
    border-radius: 50%;           /* åœ“å½¢èƒŒæ™¯ */
    transition: all 0.2s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
}

.delete-post-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;         /* åœ–ç¤ºé¡è‰²è·Ÿéš¨æ–‡å­—é¡è‰² */
}

/* æ‡¸åœç‰¹æ•ˆï¼šè®Šç´…è‰² */
.delete-post-btn:hover {
    background: rgba(255, 0, 0, 0.1); /* æ·¡æ·¡çš„ç´…è‰²èƒŒæ™¯ */
    color: #ff4d4d;                   /* åœ–ç¤ºè®Šæˆç´…è‰² */
    transform: scale(1.1);            /* è¼•å¾®æ”¾å¤§ */
}


         /* --- è²¼æ–‡åº•éƒ¨äº’å‹•å€ (æ™‚å°šç‰ˆ) --- */
        .post-stats {
            display: flex;
            align-items: center;
            gap: 25px;                    /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.08); /* æ¥µç´°çš„åˆ†éš”ç·š */
            color: var(--text-secondary); /* é è¨­ç‚ºæ¬¡è¦æ–‡å­—é¡è‰² (ç°è‰²) */
         }

        .stat-item {
           display: flex;
           align-items: center;
           gap: 8px;                     /* åœ–ç¤ºèˆ‡æ•¸å­—çš„è·é›¢ */
           cursor: pointer;
           font-size: 0.9em;
           transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å½ˆæ€§éæ¸¡æ•ˆæœ */
           padding: 5px 10px;
           border-radius: 20px;          /* åœ“è§’èƒŒæ™¯ */
         }

       .stat-item svg {
          width: 20px;
          height: 20px;
          fill: none;
          stroke: currentColor;         /* è·Ÿéš¨æ–‡å­—é¡è‰² */
          stroke-width: 2;
          stroke-linecap: round;
          stroke-linejoin: round;
          transition: fill 0.3s;
        }

/* --- æ‡¸åœäº’å‹•ç‰¹æ•ˆ --- */

/* 1. æ„›å¿ƒ (Like) - æ‡¸åœè®Šç´… */
       .stat-item.like:hover {
         color: #f91880;               /* é®®è±”çš„æ´‹ç´…è‰²/ç´…è‰² */
         background: rgba(249, 24, 128, 0.1);
     }
       .stat-item.like:hover svg {
         fill: #f91880;                /* åœ–ç¤ºå¡«æ»¿é¡è‰² */
     }

/* 2. ç•™è¨€ (Comment) - æ‡¸åœè®Šä¸»é¡Œè‰² */
       .stat-item.comment:hover {
          color: var(--accent-main);
          background: rgba(255, 255, 255, 0.05);
    }
  
    /* 3. è½‰æ¨/åˆ†äº« (Retweet) - æ‡¸åœè®Šç¶ è‰² */
      .stat-item.repost:hover {
        color: #00ba7c;               /* é¡ä¼¼ X (Twitter) çš„è½‰æ¨ç¶  */
        background: rgba(0, 186, 124, 0.1);
    }

        .post-content {
            white-space: pre-wrap;       /* â˜… æ ¸å¿ƒè¨­å®šï¼šä¿ç•™ç©ºç™½èˆ‡æ›è¡Œç¬¦è™Ÿ */
            word-break: break-word;      /* â˜… è‡ªå‹•æŠ˜è¡Œï¼šç¢ºä¿é•·å–®å­—æˆ–ç¶²å€ä¸æœƒæ’é–‹ç‰ˆé¢ */
            line-height: 1.6;            /* å¢åŠ è¡Œé«˜ï¼Œè®“å¤šè¡Œæ–‡å­—é–±è®€æ›´èˆ’é© */
            margin-top: 10px;            /* èˆ‡ä¸Šæ–¹ä½œè€…è³‡è¨Šä¿æŒè·é›¢ */
           font-size: 1em;              /* è¨­å®šå­—é«”å¤§å° */
           color: var(--text-primary);  /* ç¢ºä¿æ–‡å­—é¡è‰²æ­£ç¢º */
        }
        .post-header { 
            display: flex; 
            align-items: center; /* å‚ç›´ç½®ä¸­ */
            gap: 12px; 
            margin-bottom: 10px; 
        }
        
        .post-meta-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.2;
        }
        
        .post-author-name {
            font-weight: bold;
            color: #fff;
            font-size: 1.1em; /* æ”¾å¤§åç¨± */
            margin-bottom: 2px;
        }
        /* --- ç®¡ç†å“¡æ¨™ç±¤æ¨£å¼ --- */
    .admin-badge {
    background: var(--accent-main); /* ä½¿ç”¨ä¸»é¡Œè‰² (ä¾‹å¦‚æ©˜è‰²) */
    color: #000;                    /* é»‘å­—å°æ¯”æ¯”è¼ƒé«˜ */
    font-size: 0.7em;               /* å­—é«”å°ä¸€é» */
    padding: 2px 8px;
    border-radius: 4px;             /* åœ“è§’ */
    margin-left: 8px;               /* èˆ‡åå­—ä¿æŒè·é›¢ */
    vertical-align: middle;         /* å‚ç›´ç½®ä¸­ */
    font-weight: 800;               /* ç‰¹ç²—é«” */
    letter-spacing: 0.5px;
    display: inline-block;
    box-shadow: 0 0 10px rgba(255, 102, 0, 0.4); /* æ·¡æ·¡çš„ç™¼å…‰æ•ˆæœ */
    }
        .post-time {
            font-size: 0.8em; /* ç¶­æŒå¤§å° */
            color: #a0a0a0; /* æ”¹ç‚ºæ·ºç°è‰² (æ¬¡è¦) */
        }
        /* --- End Post Design Adjustments --- */
        
        
        .widget-box {
            background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px;
            overflow: hidden; display: flex; flex-direction: column;
        }
        .widget-title {
            padding: 10px 15px; background: rgba(255, 102, 0, 0.1); color: var(--accent-main);
            font-weight: bold; border-bottom: 1px solid var(--border-color); font-size: 0.9em; letter-spacing: 1px;
        }
        .news-item:hover { background: rgba(255,255,255,0.05); }

        /* --- Auth Button & Dropdown Menu --- */
        #auth-container { position: fixed; top: 10px; right: 20px; z-index: 100; }
        
        /* New App Switcher Button Style */
        #app-switcher-btn {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: var(--font-display);
        }
        #app-switcher-btn:hover {
            border-color: var(--accent-main);
            background: rgba(255, 102, 0, 0.1);
            color: var(--accent-main);
        }

        #profile-menu {
            position: absolute; top: 50px; right: 0; background: var(--bg-panel);
            border: 1px solid var(--accent-main); border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); min-width: 240px; z-index: 99;
            padding: 10px 0; display: none; animation: slideIn 0.3s ease-out;
        }
        .menu-item { display: flex; align-items: center; padding: 12px 15px; font-size: 1em; color: var(--text-primary); cursor: pointer; transition: background 0.2s; }
        .menu-item:hover { background: rgba(255, 102, 0, 0.15); color: var(--accent-main); }
        .menu-item-icon { width: 20px; height: 20px; margin-right: 15px; stroke: currentColor; fill: none; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-main); }
    </style>
</head>
<body onload="initApp()" data-theme-mode="pulseorange">

    <!-- Right-aligned Auth/Profile Button and Dropdown Menu -->
    <div id="auth-container">
        <!-- Button/Avatar injected here by JS -->
    </div>
    
    <div id="profile-menu">
        <!-- Menu items injected here by JS -->
    </div>

    <!-- Main Content Area (Full Height) -->
    <div class="main-container" id="main-app">
        <!-- PulseStreet Container -->
        <div class="pulse-container" id="pulse-app">
            <!-- Content injected by JS -->
        </div>
    </div>

    <!-- External Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration (Please replace with your actual configuration)
        const firebaseConfig = {
            apiKey: "AIzaSyAIwisA_UnOiNRVwYE6tJV47Sp3_1i19IM",
            authDomain: "brooklyn-terminal.firebaseapp.com",
            projectId: "brooklyn-terminal",
            storageBucket: "brooklyn-terminal.firebasestorage.app",
            messagingSenderId: "438411734316",
            appId: "1:438411734316:web:649051890cf381eb0fd089"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        window.db = db;
        window.fs = { collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, updateProfile };
        window.appAuth = auth;
        window.currentUser = null;

        // --- Theme Management ---
        const THEMES = ['pulseorange', 'techbusiness', 'cyberpunk', 'terminal'];
        let currentThemeIndex = 0;

        window.toggleNextTheme = function() {
            currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
            const newTheme = THEMES[currentThemeIndex];
            document.body.setAttribute('data-theme-mode', newTheme);
            localStorage.setItem('pulsestreet_theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const themeToggle = document.getElementById('theme-toggle-label');
            if (themeToggle) {
                const currentTheme = document.body.getAttribute('data-theme-mode');
                const t = i18n[pulseLang];
                themeToggle.querySelector('span').innerText = t[currentTheme] || currentTheme.toUpperCase();
            }
        }

        // --- App Switcher / Auth Menu Logic ---

        const performLogin = () => {
            signInWithPopup(auth, provider).catch(e => alert("ç™»å…¥å¤±æ•—: " + e.message));
        };
        
        window.toggleProfileMenu = function() {
        const menu = document.getElementById('profile-menu');
        if (!menu) return;
 
        const cur = menu.style.display;
        if (!cur || cur === 'none') {
         menu.style.display = 'block';
        } else {
         menu.style.display = 'none';
         }
        };
        
        document.addEventListener('click', (event) => {
            const menu = document.getElementById('profile-menu');
            const authContainer = document.getElementById('auth-container');
            
            if (menu && authContainer && menu.style.display === 'block') {
                if (!menu.contains(event.target) && !authContainer.contains(event.target)) {
                    menu.style.display = 'none';
                }
            }
        });

        window.viewProfile = function(name) {
            alert(`æ­£åœ¨è¼‰å…¥ ${name} çš„å€‹äººè³‡æ–™é é¢...`);
            window.toggleProfileMenu(); 
        }
        
        window.switchApp = function(appId) {
            window.toggleProfileMenu(); // é—œé–‰é¸å–®
            let msg = '';
            
            if (appId === 'workspace') {
                window.location.href = 'app.html';
            } else if (appId === 'nodex') {
                window.location.href = 'nodex.html';
            } else if (appId === 'pulse') {
                 msg = 'å·²è¿”å› PulseStreetã€‚';
            }
            alert(msg);
        }

        const updateAuthUI = (user) => {
            const authContainer = document.getElementById('auth-container');
            const profileMenu = document.getElementById('profile-menu');

            if (!authContainer) return;
            authContainer.innerHTML = ''; 
            profileMenu.innerHTML = '';
            
            // 1. Render App Switcher Button
            const avatarHtml = user 
                ? `<img src="${user.photoURL}" alt="Avatar" style="width:24px; height:24px; border-radius:50%; margin-left:8px;">`
                : '';

            authContainer.innerHTML = `
                <button id="app-switcher-btn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    åˆ‡æ›
                    ${avatarHtml}
                </button>`;
            document.getElementById('app-switcher-btn').onclick = window.toggleProfileMenu;

            // 2. Render Menu Content
            
            // App Switcher Section
            profileMenu.innerHTML += `
                <div class="menu-item" onclick="window.switchApp('pulse')">
                    <svg class="menu-item-icon" viewBox="0 0 24 24" stroke="var(--accent-main)"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    PulseStreet 
                </div>
                <div class="menu-item" onclick="window.switchApp('workspace')">
                    <svg class="menu-item-icon" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L12 19.25L14.25 17M12 19.25V4M5.75 12H18.25"/></svg>
                    WorkSpace 
                </div>
                <div class="menu-item" onclick="window.switchApp('nodex')">
                    <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12c0 5.52 4.48 10 10 10s10-4.48 10-10c0-5.52-4.48-10-10-10zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 6c-3.31 0-6 2.69-6 6h2c0-2.21 1.79-4 4-4s4 1.79 4 4h2c0-3.31-2.69-6-6-6z"/></svg>
                    NodeX 
                </div>
                <div style="border-top: 1px solid var(--border-color); margin: 10px 0;"></div>
            `;


            // Auth Section
            if (user) {
                profileMenu.innerHTML += `
                    <div class="menu-item" style="border-bottom: 1px solid var(--border-color); cursor: default;">
                         <img src="${user.photoURL}" alt="Avatar" style="width:20px; height:20px; border-radius:50%; margin-right:15px;">
                        <div style="font-weight: bold;">${user.displayName}</div>
                    </div>
                    <div class="menu-item" onclick="window.viewProfile('${user.displayName}')">
                        <svg class="menu-item-icon" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        å€‹äººè³‡æ–™
                    </div>
                    <div class="menu-item" onclick="signOut(auth).then(()=>location.reload())">
                        <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M10 22H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h5"></path><polyline points="17 16 21 12 17 8"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        ç™»å‡º (Logout)
                    </div>`;

            } else {
                profileMenu.innerHTML += `
                    <div class="menu-item" onclick="performLogin()" style="color: var(--accent-main); font-weight: bold;">
                        <svg class="menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                        Google ç™»å…¥
                    </div>`;
            }
        }

        // --- Initialization & State Change Listener ---
        onAuthStateChanged(auth, user => {
            window.currentUser = user;
            updateAuthUI(user);
            if(window.initApp) window.initApp(); 
        });

        // --- Core Application Logic (Outside Auth) ---

        const i18n = {
            zh: {
                home: "é¦–é ", profile: "å€‹äººè³‡æ–™", notify: "é€šçŸ¥", create: "å»ºç«‹è²¼æ–‡", mail: "ä¿¡ç®±",
                admin: "ç®¡ç†å“¡",  
                quickPh: "åˆ†äº«æ‚¨çš„å¸‚å ´è§€é»ã€‚", post: "ç™¼ä½ˆ",
                techNews: "è‚¡å¸‚æ’è¡Œæ¦œ", market: "é ­æ¢æ–°è",
                loginReq: "è«‹å…ˆç™»å…¥ä»¥ç™¼æ–‡",
                pulseorange: "è„ˆè¡—ç¶“å…¸", techbusiness: "ç§‘æŠ€å•†å‹™", cyberpunk: "è³½åšé¾å…‹", terminal: "çµ‚ç«¯æ©Ÿ"
            },
            en: {
                home: "Home", profile: "Profile", notify: "Notifications", create: "Create Post", mail: "Mailbox",
                admin: "Admin", 
                quickPh: "Share your market insights...", post: "Post",
                techNews: "Stock Market", market: "News",
                loginReq: "Please login to post",
                pulseorange: "Orange Signature", techbusiness: "Tech Business", cyberpunk: "Cyberpunk", terminal: "Terminal"
            }
        };
        
        // â˜… ä¿®æ­£ï¼šå°‡ icons ç§»è‡³å…¨åŸŸä½œç”¨åŸŸ
        const icons = {
            home: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>`,
            profile: `<svg class="menu-item-icon" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>`, // Used in dropdown
            notify: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>`,
            create: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>`,
            mail: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>`,
            earth: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>`,
            admin: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>`,
            /* æ‰¾åˆ° icons ç‰©ä»¶ä¸­çš„ logo å±¬æ€§ä¸¦æ›¿æ›æ•´è¡Œ */
           logo: `<svg class="pulse-logo-svg" viewBox="0 0 240 60" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
           <path d="M10 30 L30 30 L40 10 L50 50 L60 20 L70 30 L90 30" stroke="var(--accent-main)" />
           <text x="100" y="38" font-family="Orbitron" font-size="25" fill="#fff" stroke="none" font-weight="900">PulseStreet</text>
           </svg>`
        };

        let pulseLang = 'zh';

        window.togglePulseLanguage = function() {
            pulseLang = pulseLang === 'zh' ? 'en' : 'zh';
            renderPulseStreet();
        }

        window.renderPulseStreet = function() {
            const container = document.getElementById('pulse-app');
            const t = i18n[pulseLang];
            const user = window.currentUser;
            const photo = user ? user.photoURL : ''; 
            const isLoggedIn = !!user;
            
            // â˜… å®‰å…¨è¨­å®šï¼šä½¿ç”¨ UID ä¾†åˆ¤æ–·ç®¡ç†å“¡
            const ADMIN_UID = "1EALL0fq7nUzEi8B96qwXZuyG7h1"; 
            const isAdmin = user && user.uid === ADMIN_UID;

            // 1. å…ˆå°‡ HTML å­—ä¸²çµ„å¥½ (åŒ…å«æ‚¨æ–°çš„ TradingView Widget)
            const htmlContent = `
                <div class="pulse-layout">
                    <div class="pulse-sidebar-left">
    <div class="pulse-logo-area">
        ${icons.logo}
    </div>
    
    <a class="pulse-nav-btn active" id="nav-home" onclick="window.renderPulseStreet()">
        ${icons.home} <span>${t.home}</span>
    </a>
    
    <a class="pulse-nav-btn" id="nav-profile" onclick="window.navigateToProfile()">
        ${icons.profile} <span>${t.profile}</span>
    </a>
    
    <a class="pulse-nav-btn">${icons.notify} <span>${t.notify}</span></a>
    <a class="pulse-nav-btn">${icons.create} <span>${t.create}</span></a>
    <a class="pulse-nav-btn">${icons.mail} <span>${t.mail}</span></a>

    ${isAdmin ? `
        <a class="pulse-nav-btn" onclick="alert('ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨')" style="color: var(--accent-main); border: 1px solid rgba(255, 102, 0, 0.3); margin-top: 5px;">
            ${icons.admin || 'ğŸ›¡ï¸'} <span>${t.admin}</span>
        </a>
    ` : ''}

    <div style="border-top: 1px solid var(--border-color); margin-top: 20px; padding-top: 10px;"></div>

    <a class="pulse-lang-toggle" onclick="window.togglePulseLanguage()">
        ${icons.earth} <span>${pulseLang === 'zh' ? 'English' : 'ç¹é«”ä¸­æ–‡'}</span>
    </a>

    <a class="pulse-theme-toggle" id="theme-toggle-label" onclick="window.toggleNextTheme()">
        <svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 2.5px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a2 2 0 01-2-2v-4a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2H7z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 14h.01M17 10h.01M17 6h.01M17 2h.01M13 2h.01M9 2h.01M5 2h.01"></path>
            <path d="M17 18a2 2 0 002-2v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4a2 2 0 002 2h4z"></path>
        </svg>
        <span>${t[document.body.getAttribute('data-theme-mode')] || document.body.getAttribute('data-theme-mode').toUpperCase()}</span>
    </a>
</div>

                    <div class="pulse-feed-container">
                        <div style="height:76px; overflow:hidden; border-radius:12px; border:1px solid var(--border-color);">
                            <div class="tradingview-widget-container">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                                {
                                "symbols": [
                                    {"proName": "FOREXCOM:SPXUSD", "title": "S&P 500"},
                                    {"proName": "FOREXCOM:NSXUSD", "title": "US 100"},
                                    {"proName": "BITSTAMP:BTCUSD", "title": "Bitcoin"},
                                    {"proName": "NASDAQ:NVDA", "title": "NVIDIA"},
                                    {"proName": "NASDAQ:TSLA", "title": "Tesla"}
                                ],
                                "showSymbolLogo": true,
                                "colorTheme": "dark",
                                "isTransparent": true,
                                "displayMode": "adaptive",
                                "locale": "${pulseLang === 'zh' ? 'zh_TW' : 'en'}"
                                }
                                <\/script>
                            </div>
                        </div>

                        <div class="pulse-create-box">
                            ${!isLoggedIn ? `
                                <div class="post-disabled-overlay">
                                    <span style="margin-bottom: 15px;">${t.loginReq}</span>
                                    <button class="login-cta-btn" onclick="performLogin()">LOGIN</button>
                                </div>
                            ` : ''}

                            <div class="create-top">
                                <div class="user-avatar-circle">
                                    ${photo ? `<img src="${photo}" alt="Avatar">` : 'ğŸ‘¤'}
                                </div>
                                <textarea id="pulse-input" class="quick-input" rows="2" placeholder="${t.quickPh}" ${!isLoggedIn ? 'disabled' : ''}></textarea>
                            </div>
                            <div class="create-actions">
                                <div class="action-icons" style="${!isLoggedIn ? 'opacity:0.5; cursor:not-allowed;' : ''}">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                </div>
                                <button class="post-btn" onclick="window.submitPost()" ${!isLoggedIn ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>${t.post}</button>
                            </div>
                        </div>

                        <div id="feed-stream">
                            <div style="text-align:center; padding:40px; color:#666;">
                                Connecting to Pulse Network...
                            </div>
                        </div>
                    </div>

                    <div class="pulse-sidebar-right">
                        
                        <div class="widget-box" style="height: 550px;">
                            <div class="widget-title">${t.techNews}</div>
                            <div class="tradingview-widget-container" style="width: 100%; height: 100%;">
                                <div class="tradingview-widget-container__widget" style="width: 100%; height: 100%;"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-hotlists.js" async>
                                {
                                    "exchange": "US",
                                    "colorTheme": "dark",
                                    "dateRange": "12M",
                                    "showChart": true,
                                    "locale": "${pulseLang === 'zh' ? 'zh_TW' : 'en'}",
                                    "largeChartUrl": "",
                                    "isTransparent": true,
                                    "showSymbolLogo": false,
                                    "showFloatingTooltip": false,
                                    "plotLineColorGrowing": "rgba(41, 98, 255, 1)",
                                    "plotLineColorFalling": "rgba(41, 98, 255, 1)",
                                    "gridLineColor": "rgba(240, 243, 250, 0)",
                                    "scaleFontColor": "#DBDBDB",
                                    "belowLineFillColorGrowing": "rgba(41, 98, 255, 0.12)",
                                    "belowLineFillColorFalling": "rgba(41, 98, 255, 0.12)",
                                    "belowLineFillColorGrowingBottom": "rgba(41, 98, 255, 0)",
                                    "belowLineFillColorFallingBottom": "rgba(41, 98, 255, 0)",
                                    "symbolActiveColor": "rgba(41, 98, 255, 0.12)",
                                    "width": "100%",
                                    "height": "100%"
                                }
                                <\/script>
                            </div>
                            </div>

                        <div class="widget-box" style="flex:1; min-height:400px; margin-top:16px;">
                            <div class="widget-title">${t.market}</div>
                            <div class="tradingview-widget-container" style="height:100%; width:100%">
                                <div class="tradingview-widget-container__widget" style="height:100%; width:100%"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                                {
                                "feedMode": "market",
                                "market": "crypto",
                                "colorTheme": "dark",
                                "isTransparent": true,
                                "displayMode": "regular",
                                "width": "100%",
                                "height": "100%",
                                "locale": "${pulseLang === 'zh' ? 'zh_TW' : 'en'}"
                                }
                                <\/script>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 2. æ³¨å…¥ HTML åˆ°é é¢
            container.innerHTML = htmlContent;

            // 3. â˜… é—œéµä¿®å¾©ï¼šæ‰‹å‹•å–šé†’ script æ¨™ç±¤ (è§£æ±ºä¸€ç‰‡ç©ºç™½çš„å•é¡Œ)
            // åŸç†ï¼šç€è¦½å™¨ä¸åŸ·è¡Œ innerHTML ä¸­çš„ scriptï¼Œæ‰€ä»¥æˆ‘å€‘å¿…é ˆæŠŠå®ƒå€‘ã€Œè¤‡è£½ã€å‡ºä¾†ä¸¦é‡æ–°åŠ å…¥ DOM
            const scripts = container.querySelectorAll("script");
            scripts.forEach(oldScript => {
                const newScript = document.createElement("script");
                // è¤‡è£½å±¬æ€§ (src, async, type...)
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                // è¤‡è£½å…§å®¹ (JSON è¨­å®šæª”)
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                // æ›¿æ›èˆŠæ¨™ç±¤ï¼Œé€™æœƒå¼·åˆ¶ç€è¦½å™¨åŸ·è¡Œå®ƒ
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });

            document.body.style.setProperty('--accent-main', getComputedStyle(document.body).getPropertyValue('--accent-main'));
            loadFeed();
            updateThemeIcon(); 
            updateAuthUI(user); 
        };


        const ADMIN_UID = "1EALL0fq7nUzEi8B96qwXZuyG7h1";
       function loadFeed() {
            if(!window.fs || !window.db) return;
            const { collection, query, orderBy, onSnapshot } = window.fs;
            const q = query(collection(window.db, "posts"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const feedEl = document.getElementById('feed-stream');
                if(!feedEl) return;
                
                let html = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const date = p.timestamp ? p.timestamp.toDate() : new Date();
                    const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const user = window.currentUser;

                    // æ¬Šé™åˆ¤æ–·
                    const isAdmin = user && user.uid === ADMIN_UID; // æˆ‘æ˜¯å¦ç‚ºç®¡ç†å“¡(æ±ºå®šèƒ½ä¸èƒ½åˆªæ–‡)
                    const isOwner = user && user.uid === p.uid; 
                    const canDelete = isOwner || isAdmin; 
                    
                    // â˜… æ–°å¢ï¼šåˆ¤æ–·ã€Œé€™ç¯‡è²¼æ–‡çš„ä½œè€…ã€æ˜¯å¦ç‚ºç®¡ç†å“¡
                    const isPostAuthorAdmin = p.uid === ADMIN_UID;
                    // â˜… æ–°å¢ï¼šå¦‚æœæ˜¯ç®¡ç†å“¡ç™¼çš„æ–‡ï¼Œå°±ç”¢ç”Ÿæ¨™ç±¤ HTML
                    const adminBadge = isPostAuthorAdmin ? `<span class="admin-badge">ç®¡ç†å“¡</span>` : '';

                    const postUserAvatar = p.avatar ? `<img src="${p.avatar}" alt="Avatar">` : 'ğŸ‘¤';

                    html += `
                        <div class="pulse-post">
                            <div class="post-header">
                                <div class="user-avatar-circle" style="width:40px; height:40px; border-width:1px;">
                                    ${postUserAvatar}
                                </div>
                                <div class="post-meta-container">
                                    <div class="post-author-name">
                                        ${p.name || 'Anonymous'}
                                        ${adminBadge} </div>
                                    <div class="post-time">${timeStr}</div>
                                </div>
                                
                                ${canDelete ? `
                                    <button class="delete-post-btn" onclick="window.deletePost('${doc.id}')" title="åˆªé™¤è²¼æ–‡">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                            <div class="post-content">${p.content}</div>
                            
                            <div class="post-stats"> 
                                <div class="stat-item like" onclick="alert('Like!')">
                                    <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                    <span>${p.likes || 0}</span>
                                </div>
                                <div class="stat-item comment">
                                    <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                    <span>${p.comments || 0}</span>
                                </div>
                                <div class="stat-item repost">
                                    <svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                                    <span>è½‰æ¨</span>
                                </div>
                            </div>
                        </div>
                    `; 
                });
                feedEl.innerHTML = html;
            });
        }

        // â˜… ä¿®æ­£ 2: æ–°å¢ deletePost å‡½å¼ï¼Œè®“åˆªé™¤æŒ‰éˆ•çœŸçš„æœ‰ä½œç”¨
        window.deletePost = async function(postId) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™å‰‡è²¼æ–‡å—ï¼Ÿ(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)")) return;
            
            try {
                // å¾ window.fs ä¸­å–å‡º deleteDoc å’Œ doc
                const { deleteDoc, doc } = window.fs;
                // åŸ·è¡Œåˆªé™¤
                await deleteDoc(doc(window.db, "posts", postId));
                // æˆåŠŸå¾Œä¸éœ€è¦æ‰‹å‹•æ›´æ–°ç•«é¢ï¼Œå› ç‚º onSnapshot æœƒè‡ªå‹•ç›£è½ä¸¦é‡ç¹ª
            } catch(e) {
                console.error(e);
                alert("åˆªé™¤å¤±æ•—: " + e.message + "\n(è«‹ç¢ºèªæ‚¨æ˜¯å¦æœ‰æ¬Šé™æˆ–å·²ç™»å…¥)");
            }
        }

        window.submitPost = async function() {
            if(!window.currentUser) {
                alert(i18n[pulseLang].loginReq);
                return;
            }
            const input = document.getElementById('pulse-input');
            const val = input.value.trim();
            if(!val) return;

            try {
                const { addDoc, collection, serverTimestamp } = window.fs;
                await addDoc(collection(window.db, "posts"), {
                    content: val,
                    name: window.currentUser.displayName,
                    avatar: window.currentUser.photoURL,
                    uid: window.currentUser.uid,
                    timestamp: serverTimestamp(),
                    likes: 0
                });
                input.value = '';
            } catch(e) { alert("Error: " + e.message); }
        }
  // --- å€‹äººè³‡æ–™é é¢é‚è¼¯ ---

        window.navigateToProfile = function() {
            const user = window.currentUser;
            if (!user) {
                alert(i18n[pulseLang].loginReq);
                performLogin();
                return;
            }

            // 1. åˆ‡æ›é¸å–®çš„ Active ç‹€æ…‹
            document.querySelectorAll('.pulse-nav-btn').forEach(btn => btn.classList.remove('active'));
            const profileBtn = document.getElementById('nav-profile');
            if(profileBtn) profileBtn.classList.add('active');

            // 2. å–å¾—ä¸­é–“æ¬„ä½å®¹å™¨
            const centerCol = document.querySelector('.pulse-feed-container');
            if (!centerCol) return;

            // 3. æ¸²æŸ“å€‹äººè³‡æ–™ Header
            const photo = user.photoURL || '';
            
            centerCol.innerHTML = `
                <div class="profile-header-card">
                    <div class="profile-cover"></div>
                    <div class="profile-info-section">
                        <div class="profile-avatar-big">
                            ${photo ? `<img src="${photo}" alt="Avatar">` : ''}
                        </div>
                        <div class="profile-name-large">${user.displayName}</div>
                        <div class="profile-email">@${user.uid.slice(0,8)}...</div>
                        
                        <div class="profile-stats-row">
                            <span class="p-stat-box"><span class="p-stat-num" id="p-post-count">0</span> Posts</span>
                            <span class="p-stat-box"><span class="p-stat-num">0</span> Following</span>
                            <span class="p-stat-box"><span class="p-stat-num">0</span> Followers</span>
                        </div>
                    </div>
                </div>

                <h3 style="margin: 10px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">æˆ‘çš„è²¼æ–‡</h3>
                
                <div id="profile-feed-stream">
                    <div style="text-align:center; padding:20px; color:#666;">Loading your posts...</div>
                </div>
            `;

            // 4. è¼‰å…¥è©²ä½¿ç”¨è€…çš„è²¼æ–‡
            loadProfileFeed(user.uid);
        }

        function loadProfileFeed(targetUid) {
            if(!window.fs || !window.db) return;
            const { collection, query, orderBy, onSnapshot, where } = window.fs;
            
            // â˜… é‡é»ï¼šåªç¯©é¸ uid ç­‰æ–¼ç›®å‰ä½¿ç”¨è€…çš„è²¼æ–‡
            const q = query(
                collection(window.db, "posts"), 
                where("uid", "==", targetUid),
                orderBy("timestamp", "desc")
            );
            
            onSnapshot(q, (snapshot) => {
                const feedEl = document.getElementById('profile-feed-stream');
                const countEl = document.getElementById('p-post-count');
                if(!feedEl) return;
                
                // æ›´æ–°è²¼æ–‡æ•¸
                if(countEl) countEl.innerText = snapshot.size;

                if (snapshot.empty) {
                    feedEl.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">å°šæœªç™¼å¸ƒä»»ä½•è²¼æ–‡ã€‚</div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const date = p.timestamp ? p.timestamp.toDate() : new Date();
                    const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const user = window.currentUser;
                    
                    const isAdmin = user && user.uid === "1EALL0fq7nUzEi8B96qwXZuyG7h1"; 
                    const isOwner = user && user.uid === p.uid; 
                    const canDelete = isOwner || isAdmin;
                    const isPostAuthorAdmin = p.uid === "1EALL0fq7nUzEi8B96qwXZuyG7h1";
                    const adminBadge = isPostAuthorAdmin ? `<span class="admin-badge">ç®¡ç†å“¡</span>` : '';
                    const postUserAvatar = p.avatar ? `<img src="${p.avatar}" alt="Avatar">` : 'ğŸ‘¤';

                    // é€™è£¡é‡è¤‡ä½¿ç”¨ pulse-post çš„æ¨£å¼ï¼Œä¿æŒé¢¨æ ¼ä¸€è‡´
                    html += `
                        <div class="pulse-post">
                            <div class="post-header">
                                <div class="user-avatar-circle" style="width:40px; height:40px; border-width:1px;">
                                    ${postUserAvatar}
                                </div>
                                <div class="post-meta-container">
                                    <div class="post-author-name">
                                        ${p.name || 'Anonymous'}
                                        ${adminBadge}
                                    </div>
                                    <div class="post-time">${timeStr}</div>
                                </div>
                                ${canDelete ? `
                                    <button class="delete-post-btn" onclick="window.deletePost('${doc.id}')" title="åˆªé™¤è²¼æ–‡">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                            <div class="post-content">${p.content}</div>
                            <div class="post-stats"> 
                                <div class="stat-item like"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${p.likes || 0}</span></div>
                                <div class="stat-item comment"><svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg><span>${p.comments || 0}</span></div>
                                <div class="stat-item repost"><svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg><span>è½‰æ¨</span></div>
                            </div>
                        </div>
                    `; 
                });
                feedEl.innerHTML = html;
            });
        }
  
        window.initApp = window.renderPulseStreet;
    </script>
</body>
</html>
