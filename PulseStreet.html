<!DOCTYPE html>
<html lang="zh-TW">
<head> 
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5bfc21c8d13e485a9f5fbb44151e7360"}'></script>
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>PulseStreet</title> 
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6600' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='22 12 18 12 15 21 9 3 6 12 2 12'%3E%3C/polyline%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet"> 
    <style> 
        /* --- åŸºç¤è®Šæ•¸ (é è¨­: PulseOrange) --- */
        :root { 
            --bg-body: #050505;
            --bg-panel: #111111; 
            --text-primary: #e0e0e0; 
            --text-secondary: #888;
            --border-color: #333; 
            --accent-main: #ff6600; /* PulseStreet å°ˆå±¬æ©™è‰² */
            --accent-hover: #ff9933;
            --font-main: 'Rajdhani', sans-serif;
            --font-display: 'Orbitron', sans-serif;
            --border-radius: 4px;
        }

        /* --- 1. TechBusiness (ç§‘æŠ€å•†å‹™) --- */
        [data-theme-mode="techbusiness"] {
            --bg-body: #1c1c24;
            --bg-panel: #262633;
            --text-primary: #e5e5f0;
            --text-secondary: #99a0b3;
            --border-color: #3f4458;
            --accent-main: #00bcd4; /* å†·é’è—è‰² */
            --accent-hover: #4dd0e1;
        }

        /* --- 2. Cyberpunk (è³½åšé¾å…‹) --- */
        [data-theme-mode="cyberpunk"] {
            --bg-body: #0a001a;
            --bg-panel: #18002d;
            --text-primary: #ff4d94; /* éœ“è™¹ç²‰ */
            --text-secondary: #9933ff;
            --border-color: #330066;
            --accent-main: #cc33ff; /* éœ“è™¹ç´« */
            --accent-hover: #e066ff;
        }
        [data-theme-mode="cyberpunk"] .user-avatar-circle { border-color: var(--accent-main) !important; box-shadow: 0 0 10px var(--accent-main); }
        [data-theme-mode="cyberpunk"] .pulse-logo-svg path { stroke: var(--accent-main); }
        [data-theme-mode="cyberpunk"] .pulse-logo-svg text { fill: #fff; }


        /* --- 3. Terminal (çµ‚ç«¯æ©Ÿ) --- */
        [data-theme-mode="terminal"] {
            --bg-body: #000000;
            --bg-panel: #0a0a0a;
            --text-primary: #00ff00; /* äº®ç¶ è‰² */
            --text-secondary: #008800;
            --border-color: #004400;
            --accent-main: #00ff00;
            --accent-hover: #33ff33;
        }
        [data-theme-mode="terminal"] .pulse-nav-btn:hover { background: rgba(0, 255, 0, 0.1); color: var(--accent-main); }
        [data-theme-mode="terminal"] .pulse-nav-btn.active { color: var(--accent-main); background: rgba(0, 255, 0, 0.05); }
        [data-theme-mode="terminal"] .pulse-post { box-shadow: none; border-radius: 0; }
        [data-theme-mode="terminal"] .pulse-create-box { border-radius: 0; }
        [data-theme-mode="terminal"] .user-avatar-circle { border-radius: 0; }


        
        /* é€šç”¨æ¨£å¼ï¼Œä½¿ç”¨ accent-main */
        * { box-sizing: border-box; user-select: none; font-family: var(--font-main); }
        
        body { 
            margin: 0; padding: 0; 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            height: 100vh;
            overflow: hidden; 
        }
        /* --- è¿½è¹¤æŒ‰éˆ•æ¨£å¼ --- */
.follow-btn {
    background: #fff;
    color: #000;
    border: none;
    padding: 6px 20px;
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
    font-family: var(--font-main);
    transition: all 0.2s;
    margin-left: auto; /* è‡ªå‹•æ¨åˆ°å³é‚Š */
}
.follow-btn:hover { background: #e0e0e0; }

/* å·²è¿½è¹¤ç‹€æ…‹ (æ¨£å¼è®Šæš—) */
.follow-btn.following {
    background: transparent;
    color: #fff;
    border: 1px solid var(--border-color);
}
.follow-btn.following:hover {
    border-color: #ff4d4d;
    color: #ff4d4d;
    background: rgba(255, 77, 77, 0.1);
}
        .main-container { height: 100vh; position: relative; overflow: hidden; }
        .pulse-container {
                  width: 100%;
                  height: 100%; 
                  background: var(--bg-body); 
                  overflow: hidden; /* â˜… ä¿®æ”¹ï¼šç¦æ­¢å¤–å±¤æ²å‹•ï¼Œæ”¹ç‚ºå…§éƒ¨ç¨ç«‹æ²å‹• */
                  display: flex; 
                  justify-content: center;
         }
        .pulse-layout {
            width: 1400px; max-width: 98%; height: 100%;
            display: grid; grid-template-columns: 260px 1fr 320px; 
            gap: 20px; padding: 20px 0;
        }

        /* Pulse Sidebar Left */
        .pulse-sidebar-left { 
            /* position: sticky;  <-- é€™è¡Œå¯ä»¥åˆªé™¤ï¼Œå› ç‚ºå¤–å±¤ä¸å‹•äº†ï¼Œå®ƒè‡ªç„¶æœƒå›ºå®š */
            /* top: 0;            <-- é€™è¡Œå¯ä»¥åˆªé™¤ */
            height: 100%;         /* æ”¹ç‚ºå¡«æ»¿é«˜åº¦ */
           overflow-y: auto;     /* å¦‚æœè¢å¹•å¤ªçŸ®ï¼Œå…è¨±å·¦å´å–®ç¨æ²å‹• */
           display: flex; 
           flex-direction: column; 
           gap: 10px; 
           padding-top: 15px;
         }

        .pulse-sidebar-right {
         height: 100%;
         padding-top: 15px;
    
          /* â˜… é—œéµä¿®æ­£ï¼šåŠ å…¥é€™å…©è¡Œä¾†å•Ÿç”¨å½ˆæ€§æ’ç‰ˆ */
         display: flex;          
         flex-direction: column; 
    
         overflow-y: auto;     /* å…§å®¹éå¤šæ™‚ä¿ç•™æ²å‹•åŠŸèƒ½ */
         padding-bottom: 20px; /* åº•éƒ¨ç•™ä¸€é»ç©ºé–“æ¯”è¼ƒå¥½çœ‹ */
        }

        
        .pulse-logo-area { padding: 10px 0 20px 10px; }
        .pulse-logo-svg { height: 40px; width: auto; }
        .pulse-logo-svg path { stroke: var(--accent-main); }

        .pulse-nav-btn {
            display: flex; align-items: center; gap: 15px; padding: 12px 20px;
            border-radius: 30px; color: var(--text-primary); text-decoration: none;
            font-size: 1.1em; font-weight: 500; transition: all 0.2s;
            cursor: pointer; border: 1px solid transparent;
        }
        .pulse-nav-btn:hover { background: rgba(255, 102, 0, 0.1); color: var(--accent-hover); }
        .pulse-nav-btn.active { color: var(--accent-main); font-weight: bold; }
        .pulse-nav-icon { width: 24px; height: 24px; stroke-width: 2px; }

        .pulse-lang-toggle, .pulse-theme-toggle {
            margin-top: 10px; display: flex; align-items: center; gap: 10px; padding: 10px 20px;
            cursor: pointer; color: var(--text-secondary); transition: color 0.3s;
        }
        .pulse-lang-toggle:hover, .pulse-theme-toggle:hover { color: var(--text-primary); }
        
        /* Pulse Center Feed */
       .pulse-feed-container { 
                display: flex;
                flex-direction: column; 
                gap: 20px; 
                min-width: 0; 
                padding-bottom: 50px; 
    
               /* â˜… æ–°å¢ä»¥ä¸‹ä¸‰è¡Œ */
                height: 100%;         /* å¼·åˆ¶å¡«æ»¿é«˜åº¦ */
                overflow-y: auto;     /* åªæœ‰é€™å€‹å€å¡Šæœƒç”¢ç”Ÿç›´å‘æ²è»¸ */
                padding-right: 5px;   /* é¿å…æ²è»¸è“‹ä½å…§å®¹ (é¸ç”¨) */
             }
        .pulse-feed-container::-webkit-scrollbar {display: none;}

        
        .pulse-create-box {
            background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px;
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            position: relative; 
        }
        .user-avatar-circle {
            width: 48px; height: 48px; border-radius: 50%; background: #222; 
            border: 2px solid var(--accent-main); overflow: hidden; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .user-avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .quick-input {
               flex: 1;
               background: transparent; 
               border: none; 
               font-size: 1.1em; 
               color: var(--text-primary);
               outline: none; 
               resize: none; 
               padding: 10px 0; 
               font-family: var(--font-main);
                 /* â˜… åŠ å…¥æˆ–ç¢ºèªé€™å…©è¡Œ */
               white-space: pre-wrap;     /* è¼¸å…¥æ™‚ä¿ç•™æ ¼å¼ */
               overflow-wrap: break-word; /* è¼¸å…¥é•·å­—ä¸²æ™‚è‡ªå‹•æŠ˜è¡Œ */
           }
        .create-top {
              display: flex;           /* å•Ÿç”¨å½ˆæ€§æ’ç‰ˆ */
              gap: 15px;               /* è¨­å®šé ­åƒèˆ‡è¼¸å…¥æ¡†çš„é–“è· */
              align-items: flex-start; /* è®“å…§å®¹é ä¸Šå°é½Š */
              width: 100%;             /* ç¢ºä¿å®¹å™¨å¯¬åº¦å¡«æ»¿ */
          }

        .create-actions { 
              border-top: 1px solid rgba(255,255,255,0.1); 
              padding-top: 15px;
              display: flex;               /* å•Ÿç”¨å½ˆæ€§æ’ç‰ˆ */
              justify-content: space-between; /* é‡é»ï¼šå·¦å³åˆ†æ•£å°é½Š (åœ–ç¤ºå·¦ï¼ŒæŒ‰éˆ•å³) */
              align-items: center;         /* å‚ç›´ç½®ä¸­å°é½Š */
         }
        .action-icons { color: var(--accent-main); }
        .post-btn {
            background: var(--accent-main); color: #000; border: none; padding: 8px 24px;
            border-radius: 20px; font-weight: bold; cursor: pointer; font-family: var(--font-display);
        }
        .post-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 102, 0, 0.4); }

        /* Disabled Post Box Overlay */
        .post-disabled-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            font-size: 1.2em; color: #ddd; cursor: not-allowed; z-index: 10;
            padding-bottom: 20px; 
        }
        .post-disabled-overlay .login-cta-btn {
            margin-top: 15px; 
            background: var(--accent-main);
            color: #000; border: none; padding: 10px 30px;
            border-radius: 20px; font-weight: bold; cursor: pointer;
            font-family: var(--font-display); font-size: 0.9em;
            pointer-events: auto; 
        }
        .post-disabled-overlay .login-cta-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.4);
        }

        /* --- è²¼æ–‡è¨­è¨ˆèª¿æ•´ (Post Design Adjustments) --- */
        .pulse-post {
            background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px;
            padding: 20px; margin-bottom: 20px; animation: fadeIn 0.5s ease;
        }

        /* --- è²¼æ–‡å³ä¸Šè§’åˆªé™¤æŒ‰éˆ• (SVG) --- */
.delete-post-btn {
    background: none;
    border: none;
    color: var(--text-secondary); /* é è¨­ä½¿ç”¨æ¬¡è¦æ–‡å­—é¡è‰² (ç°è‰²) */
    cursor: pointer;
    margin-left: auto;            /* æ ¸å¿ƒé—œéµï¼šå°‡æŒ‰éˆ•æ¨åˆ°æœ€å³å´ */
    padding: 8px;
    border-radius: 50%;           /* åœ“å½¢èƒŒæ™¯ */
    transition: all 0.2s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
}

.delete-post-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;         /* åœ–ç¤ºé¡è‰²è·Ÿéš¨æ–‡å­—é¡è‰² */
}

/* æ‡¸åœç‰¹æ•ˆï¼šè®Šç´…è‰² */
.delete-post-btn:hover {
    background: rgba(255, 0, 0, 0.1); /* æ·¡æ·¡çš„ç´…è‰²èƒŒæ™¯ */
    color: #ff4d4d;                   /* åœ–ç¤ºè®Šæˆç´…è‰² */
    transform: scale(1.1);            /* è¼•å¾®æ”¾å¤§ */
}


         /* --- è²¼æ–‡åº•éƒ¨äº’å‹•å€ (æ™‚å°šç‰ˆ) --- */
        .post-stats {
            display: flex;
            align-items: center;
            gap: 25px;                    /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.08); /* æ¥µç´°çš„åˆ†éš”ç·š */
            color: var(--text-secondary); /* é è¨­ç‚ºæ¬¡è¦æ–‡å­—é¡è‰² (ç°è‰²) */
         }

        .stat-item {
           display: flex;
           align-items: center;
           gap: 8px;                     /* åœ–ç¤ºèˆ‡æ•¸å­—çš„è·é›¢ */
           cursor: pointer;
           font-size: 0.9em;
           transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å½ˆæ€§éæ¸¡æ•ˆæœ */
           padding: 5px 10px;
           border-radius: 20px;          /* åœ“è§’èƒŒæ™¯ */
         }

       .stat-item svg {
          width: 20px;
          height: 20px;
          fill: none;
          stroke: currentColor;         /* è·Ÿéš¨æ–‡å­—é¡è‰² */
          stroke-width: 2;
          stroke-linecap: round;
          stroke-linejoin: round;
          transition: fill 0.3s;
        }

/* --- æ‡¸åœäº’å‹•ç‰¹æ•ˆ --- */

/* 1. æ„›å¿ƒ (Like) - æ‡¸åœè®Šç´… */
       .stat-item.like:hover {
         color: #f91880;               /* é®®è±”çš„æ´‹ç´…è‰²/ç´…è‰² */
         background: rgba(249, 24, 128, 0.1);
     }
       .stat-item.like:hover svg {
         fill: #f91880;                /* åœ–ç¤ºå¡«æ»¿é¡è‰² */
     }

/* 2. ç•™è¨€ (Comment) - æ‡¸åœè®Šä¸»é¡Œè‰² */
       .stat-item.comment:hover {
          color: var(--accent-main);
          background: rgba(255, 255, 255, 0.05);
    }
  
    /* 3. è½‰æ¨/åˆ†äº« (Retweet) - æ‡¸åœè®Šç¶ è‰² */
      .stat-item.repost:hover {
        color: #00ba7c;               /* é¡ä¼¼ X (Twitter) çš„è½‰æ¨ç¶  */
        background: rgba(0, 186, 124, 0.1);
    }

        .post-content {
            white-space: pre-wrap;       /* â˜… æ ¸å¿ƒè¨­å®šï¼šä¿ç•™ç©ºç™½èˆ‡æ›è¡Œç¬¦è™Ÿ */
            word-break: break-word;      /* â˜… è‡ªå‹•æŠ˜è¡Œï¼šç¢ºä¿é•·å–®å­—æˆ–ç¶²å€ä¸æœƒæ’é–‹ç‰ˆé¢ */
            line-height: 1.6;            /* å¢åŠ è¡Œé«˜ï¼Œè®“å¤šè¡Œæ–‡å­—é–±è®€æ›´èˆ’é© */
            margin-top: 10px;            /* èˆ‡ä¸Šæ–¹ä½œè€…è³‡è¨Šä¿æŒè·é›¢ */
           font-size: 1em;              /* è¨­å®šå­—é«”å¤§å° */
           color: var(--text-primary);  /* ç¢ºä¿æ–‡å­—é¡è‰²æ­£ç¢º */
        }
        .post-header { 
            display: flex; 
            align-items: center; /* å‚ç›´ç½®ä¸­ */
            gap: 12px; 
            margin-bottom: 10px; 
        }
        
        .post-meta-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.2;
        }
        
        .post-author-name {
            font-weight: bold;
            color: #fff;
            font-size: 1.1em; /* æ”¾å¤§åç¨± */
            margin-bottom: 2px;
        }
/* --- ä½œè€…åç¨±å¯é»æ“Šæ¨£å¼ --- */
.post-author-name {
    font-weight: bold;
    color: #fff;
    font-size: 1.1em;
    margin-bottom: 2px;
    cursor: pointer;           /* â˜… è®“æ»‘é¼ è®Šæˆæ‰‹æŒ‡å½¢ç‹€ */
    transition: color 0.2s;
    width: fit-content;        /* è®“é»æ“Šç¯„åœå‰›å¥½åŒ…ä½æ–‡å­— */
}
.post-author-name:hover {
    color: var(--accent-main); /* â˜… æ»‘é¼ æ‡¸åœæ™‚è®Šè‰² */
    text-decoration: underline;
}

        
        /* --- ç®¡ç†å“¡æ¨™ç±¤æ¨£å¼ --- */
    .admin-badge {
    background: var(--accent-main); /* ä½¿ç”¨ä¸»é¡Œè‰² (ä¾‹å¦‚æ©˜è‰²) */
    color: #000;                    /* é»‘å­—å°æ¯”æ¯”è¼ƒé«˜ */
    font-size: 0.7em;               /* å­—é«”å°ä¸€é» */
    padding: 2px 8px;
    border-radius: 4px;             /* åœ“è§’ */
    margin-left: 8px;               /* èˆ‡åå­—ä¿æŒè·é›¢ */
    vertical-align: middle;         /* å‚ç›´ç½®ä¸­ */
    font-weight: 800;               /* ç‰¹ç²—é«” */
    letter-spacing: 0.5px;
    display: inline-block;
    box-shadow: 0 0 10px rgba(255, 102, 0, 0.4); /* æ·¡æ·¡çš„ç™¼å…‰æ•ˆæœ */
    }
        .post-time {
            font-size: 0.8em; /* ç¶­æŒå¤§å° */
            color: #a0a0a0; /* æ”¹ç‚ºæ·ºç°è‰² (æ¬¡è¦) */
        }
        /* --- End Post Design Adjustments --- */
        
        
        .widget-box {
            background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px;
            overflow: hidden; display: flex; flex-direction: column;
        }
        .widget-title {
            padding: 10px 15px; background: rgba(255, 102, 0, 0.1); color: var(--accent-main);
            font-weight: bold; border-bottom: 1px solid var(--border-color); font-size: 0.9em; letter-spacing: 1px;
        }
        .news-item:hover { background: rgba(255,255,255,0.05); }

        /* --- Auth Button & Dropdown Menu --- */
        #auth-container { position: fixed; top: 10px; right: 20px; z-index: 100; }
        
        /* New App Switcher Button Style */
        #app-switcher-btn {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: var(--font-display);
        }
        #app-switcher-btn:hover {
            border-color: var(--accent-main);
            background: rgba(255, 102, 0, 0.1);
            color: var(--accent-main);
        }

        #profile-menu {
            position: absolute; top: 50px; right: 0; background: var(--bg-panel);
            border: 1px solid var(--accent-main); border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); min-width: 240px; z-index: 99;
            padding: 10px 0; display: none; animation: slideIn 0.3s ease-out;
        }
        .menu-item { display: flex; align-items: center; padding: 12px 15px; font-size: 1em; color: var(--text-primary); cursor: pointer; transition: background 0.2s; }
        .menu-item:hover { background: rgba(255, 102, 0, 0.15); color: var(--accent-main); }
        .menu-item-icon { width: 20px; height: 20px; margin-right: 15px; stroke: currentColor; fill: none; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-main); }
        /* --- å»ºç«‹è²¼æ–‡æ¨¡æ…‹è¦–çª— (Create Post Modal) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 1000;
            display: none; /* é è¨­éš±è— */
            align-items: center; justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        .modal-box {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 600px; max-width: 95%;
            padding: 20px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .modal-title { font-size: 1.2em; font-weight: bold; color: var(--text-primary); }
        .modal-close-btn {
            background: none; border: none; color: var(--text-secondary);
            font-size: 1.5em; cursor: pointer; padding: 5px;
        }
        .modal-body { display: flex; flex-direction: column; gap: 15px; }
        .modal-input-area {
            display: flex; gap: 15px; align-items: flex-start;
        }
        .modal-textarea {
            flex: 1; background: transparent; border: none;
            font-size: 1.1em; color: var(--text-primary); outline: none; resize: none;
            font-family: var(--font-main); min-height: 100px;
        }
        /* åœ–ç‰‡é è¦½å€ */
        #image-preview-container {
            display: none; /* æœ‰åœ–ç‰‡æ™‚æ‰é¡¯ç¤º */
            margin-top: 10px;
            position: relative;
            width: fit-content;
        }
        #image-preview {
            max-width: 100%; max-height: 300px; border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .remove-image-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.7); color: #fff;
            border: none; border-radius: 50%; width: 30px; height: 30px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        
        .modal-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 20px; padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .upload-icon-btn {
            color: var(--accent-main); cursor: pointer;
            padding: 8px; border-radius: 50%;
            transition: background 0.2s;
        }
        .upload-icon-btn:hover { background: rgba(255, 102, 0, 0.1); }
/* --- å€‹äººè³‡æ–™é é¢æ¨£å¼ (éœ¸æ°£ç‰ˆ) --- */
.profile-header-card {
    background: var(--bg-panel);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 25px;
    position: relative;
    box-shadow: 0 15px 50px rgba(0,0,0,0.6);
    min-height: auto; /* â˜… å¼·åˆ¶æœ€å°é«˜åº¦ï¼Œé¿å…å¡Œé™· */
    flex-shrink: 0;    /* â˜… ç¦æ­¢è¢« Flex å®¹å™¨å£“ç¸® */
}

.profile-cover {
    height: 200px;
    background: linear-gradient(45deg, #000000, var(--accent-main));
    opacity: 0.4;
}

.profile-info-section {
    padding: 30px 40px;
    margin-top: -100px;
    position: relative;
    display: flex;
    flex-direction: column;
}

.profile-avatar-big {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 8px solid var(--bg-panel);
    background: #000;
    overflow: hidden;
    margin-bottom: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}

.profile-avatar-big img { 
    width: 100%; height: 100%; object-fit: cover; 
}

.profile-name-large {
    font-size: 2.5em;
    font-weight: 900;
    color: #fff;
    font-family: var(--font-display);
    margin-bottom: 5px;
    letter-spacing: 1px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

.profile-email { 
    color: var(--text-secondary); 
    margin-bottom: 35px; 
    font-size: 1.3em;
    opacity: 0.8;
}

.profile-stats-row {
    display: flex;
    gap: 50px;
    padding-top: 25px;
    border-top: 1px solid rgba(255,255,255,0.15);
}

.p-stat-box { 
    font-size: 1.2em;
    color: var(--text-secondary); 
    display: flex;
    align-items: baseline;
    gap: 10px;
    cursor: pointer;
    transition: color 0.2s;
}
.p-stat-box:hover { color: var(--accent-main); }

.p-stat-num { 
    color: #fff; 
    font-weight: 900; 
    font-size: 2em;
    font-family: var(--font-display);
    line-height: 1;
}
/* --- è‡ªæˆ‘ä»‹ç´¹èˆ‡ç·¨è¼¯æŒ‰éˆ• --- */
.profile-bio {
    color: var(--text-primary);
    margin-bottom: 20px;
    line-height: 1.6;
    font-size: 1.1em;
    white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
}

.edit-profile-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: transparent;
    border: 1px solid var(--text-secondary);
    color: var(--text-primary);
    padding: 5px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
}

.edit-profile-btn:hover {
    border-color: var(--accent-main);
    color: var(--accent-main);
    background: rgba(255, 255, 255, 0.05);
}

        
/* --- å¼·åˆ¶ä¿®æ­£ TradingView è·‘é¦¬ç‡ˆé«˜åº¦ --- */
.tradingview-widget-container {
    width: 100% !important;
    height: 100% !important;
}
.tradingview-widget-container__widget {
    width: 100% !important;
    height: 100% !important;
}
/* å¼·åˆ¶ iframe å¡«æ»¿ï¼Œè§£æ±ºè®Šä¸€æ¢ç·šçš„å•é¡Œ */
.tradingview-widget-container iframe {
    width: 100% !important;
    height: 100% !important;
    display: block !important;
}
/* --- é»è®šæ¨£å¼ --- */
.stat-item.liked svg {
    fill: #f91880;
    stroke: #f91880;
}
.stat-item.liked {
    color: #f91880;
}

/* --- ç•™è¨€æ¨¡æ…‹è¦–çª— (ç¹¼æ‰¿éƒ¨åˆ† modal æ¨£å¼) --- */
#comment-modal .modal-body {
    max-height: 70vh;
    overflow-y: auto;
}
.comment-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}
.comment-item {
    display: flex;
    gap: 12px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.comment-content-box {
    flex: 1;
}
.comment-header {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    margin-bottom: 5px;
}
.comment-author { font-weight: bold; color: #fff; }
.comment-time { color: var(--text-secondary); font-size: 0.8em; }
.comment-text { color: var(--text-primary); line-height: 1.4; white-space: pre-wrap; }
        
    </style>
</head>
<body onload="initApp()" data-theme-mode="pulseorange">

    <!-- Right-aligned Auth/Profile Button and Dropdown Menu -->
    <div id="auth-container">
        <!-- Button/Avatar injected here by JS -->
    </div>
    
    <div id="profile-menu">
        <!-- Menu items injected here by JS -->
    </div>

    <!-- Main Content Area (Full Height) -->
    <div class="main-container" id="main-app">
        <!-- PulseStreet Container -->
        <div class="pulse-container" id="pulse-app">
            <!-- Content injected by JS -->
        </div>
    </div>

    <!-- External Libraries -->
 <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, where, deleteDoc, getDoc, updateDoc, increment, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // â˜… æ–°å¢ï¼šå¼•å…¥ Storage ç›¸é—œåŠŸèƒ½
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Firebase Configuration (Please replace with your actual configuration)
        const firebaseConfig = {
            apiKey: "AIzaSyAIwisA_UnOiNRVwYE6tJV47Sp3_1i19IM",
            authDomain: "brooklyn-terminal.firebaseapp.com",
            projectId: "brooklyn-terminal",
            storageBucket: "brooklyn-terminal.firebasestorage.app",
            messagingSenderId: "438411734316",
            appId: "1:438411734316:web:649051890cf381eb0fd089"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // â˜… æ–°å¢ï¼šåˆå§‹åŒ– Storage
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        window.db = db;
        // â˜… æ–°å¢ï¼šå°‡ storage åŠŸèƒ½æ›è¼‰åˆ° window
        window.storage = { ref, uploadBytes, getDownloadURL, storageInstance: storage };
        window.fs = { collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, updateProfile, where, deleteDoc, getDoc, updateDoc, increment, getDocs, limit };
        window.appAuth = auth;
        window.currentUser = null;

        // --- Theme Management ---
        const THEMES = ['pulseorange', 'techbusiness', 'cyberpunk', 'terminal'];
        let currentThemeIndex = 0;

        window.toggleNextTheme = function() {
            currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
            const newTheme = THEMES[currentThemeIndex];
            document.body.setAttribute('data-theme-mode', newTheme);
            localStorage.setItem('pulsestreet_theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const themeToggle = document.getElementById('theme-toggle-label');
            if (themeToggle) {
                const currentTheme = document.body.getAttribute('data-theme-mode');
                const t = i18n[pulseLang];
                themeToggle.querySelector('span').innerText = t[currentTheme] || currentTheme.toUpperCase();
            }
        }

       // --- App Switcher / Auth Menu Logic ---

        // 1. ä¿®æ”¹ç™»å…¥ï¼šåŠ å…¥åƒæ•¸ï¼Œå¼·åˆ¶ä¸‹æ¬¡ç™»å…¥æ™‚è·³å‡ºå¸³è™Ÿé¸æ“‡è¦–çª—
        window.performLogin = () => {
            // â˜… é—œéµï¼šé€™è¡Œæœƒè®“ Google æ¯æ¬¡éƒ½è·³å‡ºã€Œé¸æ“‡å¸³è™Ÿã€çš„ç•«é¢ï¼Œè€Œä¸æ˜¯è‡ªå‹•ç™»å…¥
            provider.setCustomParameters({ prompt: 'select_account' });
            
            signInWithPopup(window.appAuth, provider)
                .then(() => {
                    // ç™»å…¥æˆåŠŸå¾Œï¼Œé‡æ–°æ•´ç†é é¢æˆ–æ›´æ–° UI
                    if(window.renderPulseStreet) window.renderPulseStreet();
                })
                .catch(e => alert("ç™»å…¥å¤±æ•—: " + e.message));
        };

        // 2. æ–°å¢ç™»å‡ºï¼šå»ºç«‹å…¨åŸŸç™»å‡ºå‡½å¼
        window.performLogout = () => {
            if (!confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) return;

            signOut(window.appAuth)
                .then(() => {
                    alert("å·²æˆåŠŸç™»å‡º");
                    // â˜… ç™»å‡ºå¾Œé‡æ–°è¼‰å…¥é é¢ï¼Œç¢ºä¿æ¸…é™¤æ‰€æœ‰æš«å­˜ç‹€æ…‹
                    window.location.reload(); 
                })
                .catch((e) => {
                    alert("ç™»å‡ºç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
                });
        };
        
        window.toggleProfileMenu = function() {
        const menu = document.getElementById('profile-menu');
        if (!menu) return;
 
        const cur = menu.style.display;
        if (!cur || cur === 'none') {
         menu.style.display = 'block';
        } else {
         menu.style.display = 'none';
         }
        };
        
        document.addEventListener('click', (event) => {
            const menu = document.getElementById('profile-menu');
            const authContainer = document.getElementById('auth-container');
            
            if (menu && authContainer && menu.style.display === 'block') {
                if (!menu.contains(event.target) && !authContainer.contains(event.target)) {
                    menu.style.display = 'none';
                }
            }
        });

        window.viewProfile = function(name) {
            alert(`æ­£åœ¨è¼‰å…¥ ${name} çš„å€‹äººè³‡æ–™é é¢...`);
            window.toggleProfileMenu(); 
        }
        
        window.switchApp = function(appId) {
            window.toggleProfileMenu(); // é—œé–‰é¸å–®
            let msg = '';
            
            if (appId === 'workspace') {
                window.location.href = 'app.html';
            } else if (appId === 'nodex') {
                window.location.href = 'nodex.html';
            } else if (appId === 'pulse') {
                 msg = 'å·²è¿”å› PulseStreetã€‚';
            }
            alert(msg);
        }

        const updateAuthUI = (user) => {
            const authContainer = document.getElementById('auth-container');
            const profileMenu = document.getElementById('profile-menu');

            if (!authContainer) return;
            authContainer.innerHTML = ''; 
            profileMenu.innerHTML = '';
            
            // 1. Render App Switcher Button
            const avatarHtml = user 
                ? `<img src="${user.photoURL}" alt="Avatar" style="width:24px; height:24px; border-radius:50%; margin-left:8px;">`
                : '';

            authContainer.innerHTML = `
                <button id="app-switcher-btn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    åˆ‡æ›
                    ${avatarHtml}
                </button>`;
            document.getElementById('app-switcher-btn').onclick = window.toggleProfileMenu;

            // 2. Render Menu Content
            
            // App Switcher Section
            profileMenu.innerHTML += `
                <div class="menu-item" onclick="window.switchApp('pulse')">
                    <svg class="menu-item-icon" viewBox="0 0 24 24" stroke="var(--accent-main)"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    PulseStreet 
                </div>
                <div class="menu-item" onclick="window.switchApp('workspace')">
                    <svg class="menu-item-icon" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L12 19.25L14.25 17M12 19.25V4M5.75 12H18.25"/></svg>
                    WorkSpace 
                </div>
                <div class="menu-item" onclick="window.switchApp('nodex')">
                    <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12c0 5.52 4.48 10 10 10s10-4.48 10-10c0-5.52-4.48-10-10-10zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 6c-3.31 0-6 2.69-6 6h2c0-2.21 1.79-4 4-4s4 1.79 4 4h2c0-3.31-2.69-6-6-6z"/></svg>
                    NodeX 
                </div>
                <div style="border-top: 1px solid var(--border-color); margin: 10px 0;"></div>
            `;


            // Auth Section
            if (user) {
                profileMenu.innerHTML += `
                    <div class="menu-item" style="border-bottom: 1px solid var(--border-color); cursor: default;">
                         <img src="${user.photoURL}" alt="Avatar" style="width:20px; height:20px; border-radius:50%; margin-right:15px;">
                        <div style="font-weight: bold;">${user.displayName}</div>
                    </div>
                    <div class="menu-item" onclick="window.navigateToProfile()">
                        <svg class="menu-item-icon" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        å€‹äººè³‡æ–™
                    </div>
                   <div class="menu-item" onclick="window.performLogout()">
                        <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M10 22H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h5"></path><polyline points="17 16 21 12 17 8"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        ç™»å‡º (Logout)
                    </div>`;

            } else {
                profileMenu.innerHTML += `
                    <div class="menu-item" onclick="performLogin()" style="color: var(--accent-main); font-weight: bold;">
                        <svg class="menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                        Google ç™»å…¥
                    </div>`;
            }
        }

        // --- Initialization & State Change Listener ---
        onAuthStateChanged(auth, user => {
            window.currentUser = user;
            updateAuthUI(user);
            if(window.initApp) window.initApp(); 
        });

        // --- Core Application Logic (Outside Auth) ---

        const i18n = {
            zh: {
                home: "é¦–é ", profile: "å€‹äººè³‡æ–™", notify: "é€šçŸ¥", create: "å»ºç«‹è²¼æ–‡", mail: "ä¿¡ç®±",
                admin: "ç®¡ç†å“¡",  
                quickPh: "åˆ†äº«æ‚¨çš„å¸‚å ´è§€é»ã€‚", post: "ç™¼ä½ˆ",
                techNews: "è‚¡å¸‚æ’è¡Œæ¦œ", market: "é ­æ¢æ–°è",
                loginReq: "è«‹å…ˆç™»å…¥ä»¥ç™¼æ–‡",
                pulseorange: "è„ˆè¡—ç¶“å…¸", techbusiness: "ç§‘æŠ€å•†å‹™", cyberpunk: "è³½åšé¾å…‹", terminal: "çµ‚ç«¯æ©Ÿ"
            },
            en: {
                home: "Home", profile: "Profile", notify: "Notifications", create: "Create Post", mail: "Mailbox",
                admin: "Admin", 
                quickPh: "Share your market insights...", post: "Post",
                techNews: "Stock Market", market: "News",
                loginReq: "Please login to post",
                pulseorange: "Orange Signature", techbusiness: "Tech Business", cyberpunk: "Cyberpunk", terminal: "Terminal"
            }
        };
        
        // â˜… ä¿®æ­£ï¼šå°‡ icons ç§»è‡³å…¨åŸŸä½œç”¨åŸŸ
        const icons = {
            home: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>`,
            profile: `<svg class="menu-item-icon" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>`, // Used in dropdown
            notify: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>`,
            create: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>`,
            mail: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>`,
            earth: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>`,
            admin: `<svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>`,
            /* æ‰¾åˆ° icons ç‰©ä»¶ä¸­çš„ logo å±¬æ€§ä¸¦æ›¿æ›æ•´è¡Œ */
           logo: `<svg class="pulse-logo-svg" viewBox="0 0 240 60" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
           <path d="M10 30 L30 30 L40 10 L50 50 L60 20 L70 30 L90 30" stroke="var(--accent-main)" />
           <text x="100" y="38" font-family="Orbitron" font-size="25" fill="#fff" stroke="none" font-weight="900">PulseStreet</text>
           </svg>`
        };

        let pulseLang = 'zh';

        window.togglePulseLanguage = function() {
            pulseLang = pulseLang === 'zh' ? 'en' : 'zh';
            renderPulseStreet();
        }

      window.renderPulseStreet = function() {
            const container = document.getElementById('pulse-app');
            const t = i18n[pulseLang];
            const user = window.currentUser;
            const photo = user ? user.photoURL : ''; 
            const isLoggedIn = !!user;
            
            // å®‰å…¨è¨­å®šï¼šä½¿ç”¨ UID ä¾†åˆ¤æ–·ç®¡ç†å“¡
            const ADMIN_UID = "1EALL0fq7nUzEi8B96qwXZuyG7h1"; 
            const isAdmin = user && user.uid === ADMIN_UID;

            const htmlContent = `
                <div class="pulse-layout">
                    <div class="pulse-sidebar-left">
                        <div class="pulse-logo-area">${icons.logo}</div>
                        
                        <a class="pulse-nav-btn active" id="nav-home" onclick="window.renderPulseStreet()">
                             ${icons.home} <span>${t.home}</span>
                        </a>
                        
                        <a class="pulse-nav-btn" id="nav-profile" onclick="window.navigateToProfile()">
                            ${icons.profile} <span>${t.profile}</span>
                        </a>
                        
                        <a class="pulse-nav-btn">${icons.notify} <span>${t.notify}</span></a>
                        <a class="pulse-nav-btn" onclick="window.openCreatePostModal()">
                            ${icons.create} <span>${t.create}</span>
                        </a>
                        <a class="pulse-nav-btn" id="nav-mail" onclick="window.renderMailbox()">
                           ${icons.mail} <span>${t.mail}</span>
                          </a>

                        ${isAdmin ? `
                            <a class="pulse-nav-btn" onclick="alert('ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨')" style="color: var(--accent-main); border: 1px solid rgba(255, 102, 0, 0.3); margin-top: 5px;">
                                ${icons.admin || 'ğŸ›¡ï¸'} <span>${t.admin}</span>
                            </a>
                        ` : ''}

                        <div style="border-top: 1px solid var(--border-color); margin-top: 20px; padding-top: 10px;"></div>

                        <a class="pulse-lang-toggle" onclick="window.togglePulseLanguage()">
                            ${icons.earth} <span>${pulseLang === 'zh' ? 'English' : 'ç¹é«”ä¸­æ–‡'}</span>
                        </a>

                        <a class="pulse-theme-toggle" id="theme-toggle-label" onclick="window.toggleNextTheme()">
                            <svg class="pulse-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 2.5px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a2 2 0 01-2-2v-4a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2H7z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 14h.01M17 10h.01M17 6h.01M17 2h.01M13 2h.01M9 2h.01M5 2h.01"></path>
                                <path d="M17 18a2 2 0 002-2v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4a2 2 0 002 2h4z"></path>
                            </svg>
                            <span>${t[document.body.getAttribute('data-theme-mode')] || document.body.getAttribute('data-theme-mode').toUpperCase()}</span>
                        </a>
                    </div>

                    <div class="pulse-feed-container">
                        <div style="height: 76px; min-height: 76px; width: 100%; flex-shrink: 0; overflow: hidden; border-radius: 12px; border: 1px solid var(--border-color); position: relative; z-index: 1;">
                            <div class="tradingview-widget-container">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                                {
                                "symbols": [
                                    {"proName": "FOREXCOM:SPXUSD", "title": "S&P 500"},
                                    {"proName": "FOREXCOM:NSXUSD", "title": "US 100"},
                                    {"proName": "BITSTAMP:BTCUSD", "title": "Bitcoin"},
                                    {"proName": "NASDAQ:NVDA", "title": "NVIDIA"},
                                    {"proName": "NASDAQ:TSLA", "title": "Tesla"}
                                ],
                                "showSymbolLogo": true,
                                "colorTheme": "dark",
                                "isTransparent": true,
                                "displayMode": "adaptive",
                                "locale": "${pulseLang === 'zh' ? 'zh_TW' : 'en'}"
                                }
                                <\/script>
                            </div>
                        </div>

                        <div class="pulse-create-box">
                            ${!isLoggedIn ? `
                                <div class="post-disabled-overlay">
                                    <span style="margin-bottom: 15px;">${t.loginReq}</span>
                                    <button class="login-cta-btn" onclick="performLogin()">LOGIN</button>
                                </div>
                            ` : ''}

                            <div class="create-top">
                                <div class="user-avatar-circle">
                                    ${photo ? `<img src="${photo}" alt="Avatar">` : 'ğŸ‘¤'}
                                </div>
                                <textarea id="pulse-input" class="quick-input" rows="2" placeholder="${t.quickPh}" ${!isLoggedIn ? 'disabled' : ''}></textarea>
                            </div>
                            <div class="create-actions">
                                <div class="action-icons" style="${!isLoggedIn ? 'opacity:0.5; cursor:not-allowed;' : ''}">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                </div>
                                <button class="post-btn" onclick="window.submitPost()" ${!isLoggedIn ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>${t.post}</button>
                            </div>
                        </div>

                        <div id="feed-stream">
                            <div style="text-align:center; padding:40px; color:#666;">
                                Connecting to Pulse Network...
                            </div>
                        </div>
                    </div>

                    <div class="pulse-sidebar-right">
                        <div class="widget-box" style="height: 550px;">
                            <div class="widget-title">${t.techNews}</div>
                            <div class="tradingview-widget-container" style="width: 100%; height: 100%;">
                                <div class="tradingview-widget-container__widget" style="width: 100%; height: 100%;"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-hotlists.js" async>
                                {
                                    "exchange": "US", "colorTheme": "dark", "dateRange": "12M",
                                    "showChart": true, "locale": "${pulseLang === 'zh' ? 'zh_TW' : 'en'}",
                                    "largeChartUrl": "", "isTransparent": true, "showSymbolLogo": false,
                                    "showFloatingTooltip": false, "plotLineColorGrowing": "rgba(41, 98, 255, 1)",
                                    "plotLineColorFalling": "rgba(41, 98, 255, 1)", "gridLineColor": "rgba(240, 243, 250, 0)",
                                    "scaleFontColor": "#DBDBDB", "belowLineFillColorGrowing": "rgba(41, 98, 255, 0.12)",
                                    "belowLineFillColorFalling": "rgba(41, 98, 255, 0.12)", "belowLineFillColorGrowingBottom": "rgba(41, 98, 255, 0)",
                                    "belowLineFillColorFallingBottom": "rgba(41, 98, 255, 0)", "symbolActiveColor": "rgba(41, 98, 255, 0.12)",
                                    "width": "100%", "height": "100%"
                                }
                                <\/script>
                            </div>
                        </div>

                        <div class="widget-box" style="flex:1; min-height:400px; margin-top:16px;">
                            <div class="widget-title">${t.market}</div>
                            <div class="tradingview-widget-container" style="height:100%; width:100%">
                                <div class="tradingview-widget-container__widget" style="height:100%; width:100%"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                                {
                                "feedMode": "market", "market": "crypto", "colorTheme": "dark",
                                "isTransparent": true, "displayMode": "regular", "width": "100%",
                                "height": "100%", "locale": "${pulseLang === 'zh' ? 'zh_TW' : 'en'}"
                                }
                                <\/script>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = htmlContent;

            const scripts = container.querySelectorAll("script");
            scripts.forEach(oldScript => {
                const newScript = document.createElement("script");
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });

            document.body.style.setProperty('--accent-main', getComputedStyle(document.body).getPropertyValue('--accent-main'));
            loadFeed();
            updateThemeIcon(); 
            updateAuthUI(user); 
        };


        const ADMIN_UID = "1EALL0fq7nUzEi8B96qwXZuyG7h1";
       function loadFeed() {
            if(!window.fs || !window.db) return;
            const { collection, query, orderBy, onSnapshot } = window.fs;
            const q = query(collection(window.db, "posts"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const feedEl = document.getElementById('feed-stream');
                if(!feedEl) return;
                
                let html = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const date = p.timestamp ? p.timestamp.toDate() : new Date();
                    
                    // æ™‚é–“æ ¼å¼è¨­å®š (å¹´/æœˆ/æ—¥ æ™‚:åˆ†)
                    const timeStr = date.toLocaleString('zh-TW', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', hour12: false 
                    });

                    const user = window.currentUser;
                    const isAdmin = user && user.uid === ADMIN_UID;
                    const isOwner = user && user.uid === p.uid; 
                    const canDelete = isOwner || isAdmin; 
                    const isPostAuthorAdmin = p.uid === ADMIN_UID;
                    const adminBadge = isPostAuthorAdmin ? `<span class="admin-badge">å¹³å°ç®¡ç†å“¡</span>` : '';
                    const postUserAvatar = p.avatar ? `<img src="${p.avatar}" alt="Avatar">` : 'ğŸ‘¤';

                    html += `
                        <div class="pulse-post">
                            <div class="post-header">
                                <div class="user-avatar-circle" style="width:40px; height:40px; border-width:1px;">
                                    ${postUserAvatar}
                                </div>
                                <div class="post-meta-container">
                                    <div class="post-author-name" onclick="window.viewUserProfile('${p.uid}', '${p.name || 'Anonymous'}', '${p.avatar || ''}')">
                                        ${p.name || 'Anonymous'}
                                        ${adminBadge}
                                    </div>
                                    <div class="post-time">${timeStr}</div>
                                </div>
                                
                                ${canDelete ? `
                                    <button class="delete-post-btn" onclick="window.deletePost('${doc.id}')" title="åˆªé™¤è²¼æ–‡">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                            <div class="post-content">${p.content}</div>
                            
                            ${p.imageUrl ? `
                                <div style="margin-top: 15px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);">
                                    <img src="${p.imageUrl}" alt="Post Image" style="width: 100%; height: auto; display: block;">
                                </div>
                            ` : ''}

                            <div class="post-stats"> 
                                <div class="stat-item like" id="like-btn-${doc.id}" onclick="window.toggleLike('${doc.id}', this)">
                                    <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                    <span>${p.likes || 0}</span>
                                </div>

                                <div class="stat-item comment" onclick="window.openCommentModal('${doc.id}')">
                                    <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                    <span>${p.comments || 0}</span>
                                </div>

                                <div class="stat-item repost">
                                    <svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                                    <span>è½‰æ¨</span>
                                </div>
                            </div>
                        </div>
                    `; 
                });
                
                // 1. å…ˆå°‡ HTML æ”¾é€²å»
                feedEl.innerHTML = html;

                // 2. â˜… ä¿®æ­£ï¼šåœ¨ HTML æ”¾å…¥å¾Œï¼Œæ‰ç”¨ JS è¿´åœˆæª¢æŸ¥æ¯å€‹è²¼æ–‡çš„æŒ‰è®šç‹€æ…‹
                // é€™æ¨£å°±ä¸éœ€è¦æŠŠ <script> æ¨™ç±¤å¡é€²å­—ä¸²è£¡ï¼Œé¿å…èªæ³•éŒ¯èª¤
                snapshot.forEach(doc => {
                    if(window.checkLikeStatus) {
                        window.checkLikeStatus(doc.id, `like-btn-${doc.id}`);
                    }
                });
            });
        }

        // â˜… ä¿®æ­£ 2: æ–°å¢ deletePost å‡½å¼ï¼Œè®“åˆªé™¤æŒ‰éˆ•çœŸçš„æœ‰ä½œç”¨
        window.deletePost = async function(postId) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™å‰‡è²¼æ–‡å—ï¼Ÿ(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)")) return;
            
            try {
                // å¾ window.fs ä¸­å–å‡º deleteDoc å’Œ doc
                const { deleteDoc, doc } = window.fs;
                // åŸ·è¡Œåˆªé™¤
                await deleteDoc(doc(window.db, "posts", postId));
                // æˆåŠŸå¾Œä¸éœ€è¦æ‰‹å‹•æ›´æ–°ç•«é¢ï¼Œå› ç‚º onSnapshot æœƒè‡ªå‹•ç›£è½ä¸¦é‡ç¹ª
            } catch(e) {
                console.error(e);
                alert("åˆªé™¤å¤±æ•—: " + e.message + "\n(è«‹ç¢ºèªæ‚¨æ˜¯å¦æœ‰æ¬Šé™æˆ–å·²ç™»å…¥)");
            }
        }

        window.submitPost = async function() {
            if(!window.currentUser) {
                alert(i18n[pulseLang].loginReq);
                return;
            }
            const input = document.getElementById('pulse-input');
            const val = input.value.trim();
            if(!val) return;

            try {
                const { addDoc, collection, serverTimestamp } = window.fs;
                await addDoc(collection(window.db, "posts"), {
                    content: val,
                    name: window.currentUser.displayName,
                    avatar: window.currentUser.photoURL,
                    uid: window.currentUser.uid,
                    timestamp: serverTimestamp(),
                    likes: 0
                });
                input.value = '';
            } catch(e) { alert("Error: " + e.message); }
        }
  // --- å€‹äººè³‡æ–™é é¢é‚è¼¯ ---

       window.navigateToProfile = async function() {
            const user = window.currentUser;
            if (!user) {
                alert(i18n[pulseLang].loginReq); // [cite: 345]
                performLogin();
                return;
            }

            // 1. åˆ‡æ›é¸å–®ç‹€æ…‹
            document.querySelectorAll('.pulse-nav-btn').forEach(btn => btn.classList.remove('active'));
            const profileBtn = document.getElementById('nav-profile');
            if(profileBtn) profileBtn.classList.add('active'); // [cite: 347]

            const centerCol = document.querySelector('.pulse-feed-container');
            if (!centerCol) return;

            // 2. æº–å‚™é¡¯ç¤ºè³‡æ–™
            const photo = user.photoURL || '';
            const shortEmail = user.email ? `@${user.email.split('@')[0]}` : `@${user.uid.slice(0,8)}...`;
            
            // â˜… ç®¡ç†å“¡åˆ¤æ–·
            const ADMIN_UID = "1EALL0fq7nUzEi8B96qwXZuyG7h1";
            const isAdmin = user.uid === ADMIN_UID;
            const adminBadge = isAdmin ?
                `<span class="admin-badge" style="font-size: 0.4em; vertical-align: middle; margin-left: 10px;">å¹³å°ç®¡ç†å“¡</span>` : '';

            // â˜… å¾è³‡æ–™åº«è®€å–è‡ªæˆ‘ä»‹ç´¹ (Bio)
            let bioText = "é€™å‚¢ä¼™å¾ˆæ‡¶ï¼Œä»€éº¼éƒ½æ²’å¯«...";
            try {
                const { doc, getDoc } = window.fs;
                const userDocRef = doc(window.db, "users", user.uid);
                const userSnap = await getDoc(userDocRef);
                if (userSnap.exists() && userSnap.data().bio) {
                    bioText = userSnap.data().bio; // [cite: 355]
                }
            } catch (e) {
                console.error("è®€å– Bio å¤±æ•—", e);
            }

            // 3. æ¸²æŸ“ç•«é¢ (â˜… ä¿®æ­£é‡é»ï¼šåŠ ä¸Š id="p-following-count" èˆ‡ id="p-followers-count")
            centerCol.innerHTML = `
                <div class="profile-header-card">
                    <div class="profile-cover"></div>
                    
                    <button class="edit-profile-btn" onclick="window.editProfile()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        ç·¨è¼¯å€‹äººæª”
                    </button>

                    <div class="profile-info-section">
                        <div class="profile-avatar-big">
                            ${photo ? `<img src="${photo}" alt="Avatar">` : ''}
                        </div>
                        
                        <div class="profile-name-large">
                             ${user.displayName || 'User'}
                            ${adminBadge} </div>
                        <div class="profile-email">${shortEmail}</div>
                        
                         <div class="profile-bio" id="user-bio-display">${bioText}</div>
                        
                        <div class="profile-stats-row">
                            <span class="p-stat-box"><span class="p-stat-num" id="p-post-count">0</span> Posts</span>
                            
                            <span class="p-stat-box"><span class="p-stat-num" id="p-following-count">0</span> Following</span>
                            <span class="p-stat-box"><span class="p-stat-num" id="p-followers-count">0</span> Followers</span>
                            </div>
                    </div>
                </div>

                <h3 style="margin: 10px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">æˆ‘çš„è²¼æ–‡</h3>
                <div id="profile-feed-stream">
                    <div style="text-align:center; padding:20px; color:#666;">Loading your posts...</div>
                </div>
            `;

            loadProfileFeed(user.uid);
            
            // â˜… æ–°å¢é€™è¡Œï¼šè¼‰å…¥è¿½è¹¤æ•¸æ“š
            loadFollowStats(user.uid); 
        }
     // â˜… æ–°å¢ï¼šç·¨è¼¯è‡ªæˆ‘ä»‹ç´¹åŠŸèƒ½
        window.editProfile = async function() {
            const currentBio = document.getElementById('user-bio-display').innerText;
            // é€™è£¡ç°¡å–®ä½¿ç”¨ promptï¼Œæœªä¾†æ‚¨å¯ä»¥æ”¹æˆæ¼‚äº®çš„æ¨¡æ…‹è¦–çª—
            const newBio = prompt("è«‹è¼¸å…¥æ‚¨çš„è‡ªæˆ‘ä»‹ç´¹ï¼š", currentBio === "é€™å‚¢ä¼™å¾ˆæ‡¶ï¼Œä»€éº¼éƒ½æ²’å¯«..." ? "" : currentBio);
            
            if (newBio !== null) { // ä½¿ç”¨è€…æ²’æœ‰æŒ‰å–æ¶ˆ
                try {
                    const { doc, setDoc } = window.fs; // ä½¿ç”¨ setDoc (merge: true) ä¾†æ›´æ–°æˆ–å»ºç«‹
                    const user = window.currentUser;
                    
                    // æ›´æ–°è³‡æ–™åº«
                    await setDoc(doc(window.db, "users", user.uid), {
                        bio: newBio,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        lastSeen: new Date()
                    }, { merge: true }); // merge: true ç¢ºä¿ä¸æœƒè¦†è“‹æ‰å…¶ä»–æ¬„ä½

                    // æ›´æ–°ç•«é¢
                    document.getElementById('user-bio-display').innerText = newBio;
                } catch (e) {
                    alert("æ›´æ–°å¤±æ•—ï¼š" + e.message);
                }
            }
        }
     
        function loadProfileFeed(targetUid) {
            if(!window.fs || !window.db) return;
            const { collection, query, orderBy, onSnapshot, where } = window.fs;
            
            const q = query(
                collection(window.db, "posts"), 
                where("uid", "==", targetUid),
                orderBy("timestamp", "desc")
            );
            
            onSnapshot(q, (snapshot) => {
                const feedEl = document.getElementById('profile-feed-stream');
                const countEl = document.getElementById('p-post-count');
                if(!feedEl) return;
                
                if(countEl) countEl.innerText = snapshot.size;

                if (snapshot.empty) {
                    feedEl.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">å°šæœªç™¼å¸ƒä»»ä½•è²¼æ–‡ã€‚</div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const date = p.timestamp ? p.timestamp.toDate() : new Date();
                    const timeStr = date.toLocaleString('zh-TW', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', hour12: false 
                    });
                    const user = window.currentUser;
                    
                    const isAdmin = user && user.uid === ADMIN_UID;
                    const isOwner = user && user.uid === p.uid; 
                    const canDelete = isOwner || isAdmin;
                    const isPostAuthorAdmin = p.uid === ADMIN_UID;
                    const adminBadge = isPostAuthorAdmin ? `<span class="admin-badge">å¹³å°ç®¡ç†å“¡</span>` : '';
                    const postUserAvatar = p.avatar ? `<img src="${p.avatar}" alt="Avatar">` : 'ğŸ‘¤';

                    html += `
                        <div class="pulse-post">
                            <div class="post-header">
                                <div class="user-avatar-circle" style="width:40px; height:40px; border-width:1px;">
                                    ${postUserAvatar}
                                </div>
                                <div class="post-meta-container">
                                    <div class="post-author-name" onclick="window.viewUserProfile('${p.uid}', '${p.name || 'Anonymous'}', '${p.avatar || ''}')">
                                        ${p.name || 'Anonymous'}
                                        ${adminBadge}
                                    </div>
                                    <div class="post-time">${timeStr}</div>
                                </div>
                                ${canDelete ? `
                                    <button class="delete-post-btn" onclick="window.deletePost('${doc.id}')" title="åˆªé™¤è²¼æ–‡">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                            <div class="post-content">${p.content}</div>
                            ${p.imageUrl ? `<div style="margin-top: 15px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);"><img src="${p.imageUrl}" alt="Post Image" style="width: 100%; height: auto; display: block;"></div>` : ''}
                            
                            <div class="post-stats"> 
                                <div class="stat-item like" id="profile-like-btn-${doc.id}" onclick="window.toggleLike('${doc.id}', this)">
                                    <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                    <span>${p.likes || 0}</span>
                                </div>
                                <div class="stat-item comment" onclick="window.openCommentModal('${doc.id}')">
                                    <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                    <span>${p.comments || 0}</span>
                                </div>
                                <div class="stat-item repost"><svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg><span>è½‰æ¨</span></div>
                            </div>
                        </div>
                    `; 
                });
                feedEl.innerHTML = html;

                // â˜… å€‹äººé é¢ä¹Ÿè¦æª¢æŸ¥æŒ‰è®š
                snapshot.forEach(doc => {
                    window.checkLikeStatus(doc.id, `profile-like-btn-${doc.id}`);
                });
            });
        }
  // =========================================
        // â˜… æ–°å¢ï¼šå»ºç«‹è²¼æ–‡æ¨¡æ…‹è¦–çª—é‚è¼¯
        // =========================================
        let selectedImageFile = null; // ç”¨ä¾†æš«å­˜ä½¿ç”¨è€…é¸æ“‡çš„åœ–ç‰‡æª”æ¡ˆ

        // 1. é–‹å•Ÿæ¨¡æ…‹è¦–çª—
        window.openCreatePostModal = function() {
            if (!window.currentUser) {
                alert(i18n[pulseLang].loginReq);
                performLogin();
                return;
            }
            // è¨­å®šè¦–çª—å…§çš„é ­åƒ
            const avatarEl = document.getElementById('modal-user-avatar');
            const photo = window.currentUser.photoURL;
            avatarEl.innerHTML = photo ? `<img src="${photo}" alt="Avatar">` : 'ğŸ‘¤';
            
            // é¡¯ç¤ºè¦–çª—
            document.getElementById('create-post-modal').style.display = 'flex';
            document.getElementById('modal-post-input').focus();
        }

        // 2. é—œé–‰æ¨¡æ…‹è¦–çª—ä¸¦æ¸…ç†è³‡æ–™
        window.closeCreatePostModal = function() {
            document.getElementById('create-post-modal').style.display = 'none';
            document.getElementById('modal-post-input').value = '';
            removeSelectedImage(); // æ¸…é™¤å·²é¸åœ–ç‰‡
        }

        // 3. è™•ç†æª”æ¡ˆé¸æ“‡èˆ‡é è¦½
        window.handleFileSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ (JPG, PNG, GIF ç­‰)ã€‚');
                return;
            }

            selectedImageFile = file; // æš«å­˜æª”æ¡ˆç‰©ä»¶

            // è®€å–ä¸¦é¡¯ç¤ºé è¦½åœ–
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // 4. ç§»é™¤å·²é¸åœ–ç‰‡
        window.removeSelectedImage = function() {
            selectedImageFile = null;
            document.getElementById('file-input').value = ''; // æ¸…ç©º input
            document.getElementById('image-preview').src = '';
            document.getElementById('image-preview-container').style.display = 'none';
        }

        // 5. æäº¤è²¼æ–‡ (åŒ…å«ä¸Šå‚³åœ–ç‰‡æµç¨‹)
        window.submitModalPost = async function() {
            const input = document.getElementById('modal-post-input');
            const val = input.value.trim();
            // å¦‚æœæ²’è¼¸å…¥æ–‡å­—ä¹Ÿæ²’é¸åœ–ç‰‡ï¼Œå°±ä¸æº–ç™¼æ–‡
            if (!val && !selectedImageFile) {
                alert("è«‹è¼¸å…¥å…§å®¹æˆ–é¸æ“‡åœ–ç‰‡ã€‚");
                return;
            }

            const postBtn = document.getElementById('modal-post-btn');
            postBtn.disabled = true;
            postBtn.innerText = 'ç™¼ä½ˆä¸­...';

            try {
                const { addDoc, collection, serverTimestamp } = window.fs;
                const { ref, uploadBytes, getDownloadURL, storageInstance } = window.storage;
                const user = window.currentUser;
                
                let imageUrl = null;

                // â˜… å¦‚æœæœ‰é¸æ“‡åœ–ç‰‡ï¼Œå…ˆåŸ·è¡Œä¸Šå‚³
                if (selectedImageFile) {
                    // å»ºç«‹ä¸€å€‹ç¨ç‰¹çš„æª”æ¡ˆè·¯å¾‘: posts/ä½¿ç”¨è€…ID/æ™‚é–“æˆ³è¨˜_æª”å
                    const filename = `${Date.now()}_${selectedImageFile.name}`;
                    const storageRef = ref(storageInstance, `posts/${user.uid}/${filename}`);
                    
                    // ä¸Šå‚³æª”æ¡ˆ
                    const snapshot = await uploadBytes(storageRef, selectedImageFile);
                    // å–å¾—å…¬é–‹ä¸‹è¼‰é€£çµ
                    imageUrl = await getDownloadURL(snapshot.ref);
                }

                // å»ºç«‹è²¼æ–‡è³‡æ–™ç‰©ä»¶
                const postData = {
                    content: val,
                    name: user.displayName,
                    avatar: user.photoURL,
                    uid: user.uid,
                    timestamp: serverTimestamp(),
                    likes: 0,
                    comments: 0
                };
                // å¦‚æœæœ‰åœ–ç‰‡é€£çµï¼Œå°±åŠ å…¥è³‡æ–™ä¸­
                if (imageUrl) {
                    postData.imageUrl = imageUrl;
                }

                // å¯«å…¥ Firestore è³‡æ–™åº«
                await addDoc(collection(window.db, "posts"), postData);

                closeCreatePostModal(); // æˆåŠŸå¾Œé—œé–‰è¦–çª—

            } catch (e) {
                console.error("ç™¼æ–‡å¤±æ•—:", e);
                alert("ç™¼ä½ˆå¤±æ•—: " + e.message);
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                postBtn.disabled = false;
                postBtn.innerText = i18n[pulseLang].post;
            }
        }
// --- æŸ¥çœ‹ä»–äººå€‹äººè³‡æ–™é‚è¼¯ (å®Œæ•´ä¿®å¾©ç‰ˆï¼šæ”¯æ´ç®¡ç†å“¡æ¨™ç¤ºã€ç·¨è¼¯æŒ‰éˆ•ã€è‡ªå‹•æŠ“å– Bio) ---
        window.viewUserProfile = async function(uid, name, avatar) {
            // 1. åŸºæœ¬é˜²å‘†èˆ‡ UI åˆ‡æ›
            const currentUser = window.currentUser;
            if (!currentUser) { alert("è«‹å…ˆç™»å…¥"); performLogin(); return; }

            document.querySelectorAll('.pulse-nav-btn').forEach(btn => btn.classList.remove('active'));
            const centerCol = document.querySelector('.pulse-feed-container');
            if (!centerCol) return;

            // 2. å®šç¾©è®Šæ•¸
            // â˜… åˆ¤æ–·æ˜¯å¦ç‚ºç®¡ç†å“¡ (è¢«æŸ¥çœ‹çš„äººæ˜¯å¦ç‚ºç®¡ç†å“¡)
            const ADMIN_UID = "1EALL0fq7nUzEi8B96qwXZuyG7h1"; 
            const isTargetAdmin = (uid === ADMIN_UID);
            
            // â˜… åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå·± (æ±ºå®šé¡¯ç¤º "ç·¨è¼¯" é‚„æ˜¯ "è¿½è¹¤")
            const isMe = (currentUser.uid === uid);

            // 3. æº–å‚™é¡¯ç¤ºå…§å®¹
            const adminBadge = isTargetAdmin ? 
                `<span class="admin-badge" style="font-size: 0.4em; vertical-align: middle; margin-left: 10px;">å¹³å°ç®¡ç†å“¡</span>` : '';
            
            // é è¨­é¡¯ç¤º (å…ˆç”¨ UID åˆ‡å‰²ç•¶ä½œ ID)
            let displayHandle = `@${uid.slice(0,8)}...`;
            let bioText = "è¼‰å…¥ä¸­..."; 
            
            const photoHtml = avatar && avatar !== 'null' && avatar !== 'undefined' ? 
                              `<img src="${avatar}" alt="Avatar">` : '';

            // â˜… æ ¹æ“šèº«åˆ†æ±ºå®šæŒ‰éˆ• (è‡ªå·±->ç·¨è¼¯ / åˆ¥äºº->è¿½è¹¤)
            let actionBtnHtml = '';
            if (isMe) {
                actionBtnHtml = `
                    <button class="edit-profile-btn" onclick="window.editProfile()" style="position: static; margin-left: auto;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        ç·¨è¼¯å€‹äººæª”
                    </button>
                `;
            } else {
                actionBtnHtml = `
                    <button id="follow-btn" class="follow-btn" onclick="window.toggleFollow('${uid}')">è¿½è¹¤</button>
                `;
            }

            // 4. æ¸²æŸ“ HTML
            centerCol.innerHTML = `
                <div class="profile-header-card">
                    <div class="profile-cover"></div>
                    <div class="profile-info-section">
                        <div class="profile-avatar-big">
                             ${photoHtml}
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div class="profile-name-large" style="margin-bottom: 0;">
                                ${name}
                                ${adminBadge} </div>
                            
                            ${actionBtnHtml} </div>

                        <div class="profile-email" id="target-user-handle">${displayHandle}</div>
                        
                        <div class="profile-bio" id="target-user-bio">${bioText}</div>
                        
                        <div class="profile-stats-row">
                            <span class="p-stat-box"><span class="p-stat-num" id="p-post-count">0</span> Posts</span>
                            <span class="p-stat-box"><span class="p-stat-num" id="p-following-count">0</span> Following</span>
                            <span class="p-stat-box"><span class="p-stat-num" id="p-followers-count">0</span> Followers</span>
                        </div>
                    </div>
                </div>

                <h3 style="margin: 10px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">${name} çš„è²¼æ–‡</h3>
                
                <div id="profile-feed-stream">
                    <div style="text-align:center; padding:20px; color:#666;">Loading posts...</div>
                </div>
            `;

            // 5. åŸ·è¡Œå¾ŒçºŒè¼‰å…¥
            loadProfileFeed(uid);
            
            // å¦‚æœæ˜¯çœ‹åˆ¥äººï¼Œæ‰éœ€è¦æª¢æŸ¥è¿½è¹¤ç‹€æ…‹ï¼›çœ‹è‡ªå·±å°±ä¸éœ€è¦
            if (!isMe) {
                checkFollowStatus(uid);
            }
            
            // è¼‰å…¥ç²‰çµ²æ•¸æ“š
            loadFollowStats(uid);
            
            // â˜… å»è³‡æ–™åº«æŠ“å–è©²ç”¨æˆ¶çš„çœŸå¯¦ Email èˆ‡ Bio
            try {
                const { doc, getDoc } = window.fs;
                const userDocRef = doc(window.db, "users", uid);
                const userSnap = await getDoc(userDocRef);
                
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    
                    if (data.email) {
                        const emailPrefix = data.email.split('@')[0];
                        const handleEl = document.getElementById('target-user-handle');
                        if(handleEl) handleEl.innerText = `@${emailPrefix}`;
                    }
                    
                    const bioEl = document.getElementById('target-user-bio');
                    if (bioEl) {
                        bioEl.innerText = data.bio || "é€™å‚¢ä¼™å¾ˆæ‡¶ï¼Œä»€éº¼éƒ½æ²’å¯«...";
                    }
                } else {
                     const bioEl = document.getElementById('target-user-bio');
                     if(bioEl) bioEl.innerText = "é€™å‚¢ä¼™å¾ˆæ‡¶ï¼Œä»€éº¼éƒ½æ²’å¯«...";
                }
            } catch (e) {
                console.error("è®€å–ç”¨æˆ¶è©³ç´°è³‡æ–™å¤±æ•—", e);
            }
        }
// =========================================
        // â˜… æ–°å¢ï¼šè¿½è¹¤ç³»çµ±æ ¸å¿ƒé‚è¼¯
        // =========================================

        // 1. åˆ‡æ›è¿½è¹¤ç‹€æ…‹ (è¿½è¹¤ / å–æ¶ˆè¿½è¹¤)
        window.toggleFollow = async function(targetUid) {
            const user = window.currentUser;
            if (!user) { alert("è«‹å…ˆç™»å…¥"); performLogin(); return; }
            if (user.uid === targetUid) return; // ä¸èƒ½è¿½è¹¤è‡ªå·±

            const btn = document.getElementById('follow-btn');
            if(btn) btn.disabled = true; // é˜²æ­¢é€£é»

            try {
                const { collection, addDoc, query, where, getDocs, deleteDoc, doc } = window.fs;
                const relRef = collection(window.db, "relationships");
                
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¿½è¹¤
                const q = query(relRef, 
                    where("followerId", "==", user.uid),
                    where("followingId", "==", targetUid)
                );
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    // --- å·²ç¶“è¿½è¹¤ -> åŸ·è¡Œã€Œå–æ¶ˆè¿½è¹¤ã€ ---
                    const docId = snapshot.docs[0].id;
                    await deleteDoc(doc(window.db, "relationships", docId));
                    if(btn) {
                        btn.innerText = "è¿½è¹¤";
                        btn.classList.remove('following');
                    }
                    updateFollowCounts(targetUid, -1); // ç²‰çµ²æ•¸ -1
                } else {
                    // --- å°šæœªè¿½è¹¤ -> åŸ·è¡Œã€Œè¿½è¹¤ã€ ---
                    await addDoc(relRef, {
                        followerId: user.uid,
                        followingId: targetUid,
                        timestamp: new Date()
                    });
                    if(btn) {
                        btn.innerText = "å·²è¿½è¹¤";
                        btn.classList.add('following');
                    }
                    updateFollowCounts(targetUid, 1); // ç²‰çµ²æ•¸ +1
                }
            } catch (e) {
                console.error("è¿½è¹¤å¤±æ•—", e);
                alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            } finally {
                if(btn) btn.disabled = false;
            }
        }

        // 2. æª¢æŸ¥è¿½è¹¤ç‹€æ…‹ (ç”¨æ–¼åˆå§‹åŒ–æŒ‰éˆ•)
        async function checkFollowStatus(targetUid) {
            const user = window.currentUser;
            if (!user || user.uid === targetUid) return; // è‡ªå·±ä¸ç”¨æª¢æŸ¥

            const { collection, query, where, getDocs } = window.fs;
            const q = query(collection(window.db, "relationships"), 
                where("followerId", "==", user.uid),
                where("followingId", "==", targetUid)
            );
            const snapshot = await getDocs(q);
            
            const btn = document.getElementById('follow-btn');
            if (btn && !snapshot.empty) {
                btn.innerText = "å·²è¿½è¹¤";
                btn.classList.add('following');
                
                // æ»‘é¼ ç§»ä¸Šå»è®Šæˆ "å–æ¶ˆè¿½è¹¤"
                btn.onmouseover = () => btn.innerText = "å–æ¶ˆè¿½è¹¤";
                btn.onmouseout = () => btn.innerText = "å·²è¿½è¹¤";
            }
        }

        // 3. æ›´æ–°ä»‹é¢ä¸Šçš„æ•¸å­—
        function updateFollowCounts(targetUid, change = 0) {
            // é€™è£¡ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘å…ˆç”¨å‰ç«¯å‡è£åŠ æ¸›æ•¸å­—
            // å¯¦éš›å°ˆæ¡ˆé€šå¸¸æœƒè®€å–è³‡æ–™åº«çš„ countï¼Œæˆ–è€…ä½¿ç”¨ Firebase Functions
            const followerEl = document.getElementById('p-followers-count');
            if(followerEl) {
                let current = parseInt(followerEl.innerText) || 0;
                followerEl.innerText = Math.max(0, current + change);
            }
        }

        // 4. è®€å–çœŸå¯¦çš„ç²‰çµ²æ•¸æ“š (Count)
        async function loadFollowStats(targetUid) {
            const { collection, query, where, getCountFromServer } = window.fs; // éœ€è¦å¼•å…¥ getCountFromServer (é¸ç”¨ï¼Œè‹¥æ²’å¼•å…¥å¯ç”¨ getDocs.size)
            // ç°¡å–®ç‰ˆï¼šç›´æ¥ç”¨ getDocs (é‡å¤§æ™‚è¼ƒæ…¢ï¼Œä½†ç›®å‰å¤ ç”¨)
            const { getDocs } = window.fs;
            
            // æŸ¥ç²‰çµ²æ•¸ (èª°è¿½è¹¤äº† target)
            const followersQ = query(collection(window.db, "relationships"), where("followingId", "==", targetUid));
            const followersSnap = await getDocs(followersQ);
            document.getElementById('p-followers-count').innerText = followersSnap.size;

            // æŸ¥è¿½è¹¤ä¸­ (target è¿½è¹¤äº†èª°)
            const followingQ = query(collection(window.db, "relationships"), where("followerId", "==", targetUid));
            const followingSnap = await getDocs(followingQ);
            document.getElementById('p-following-count').innerText = followingSnap.size;
        }
// =========================================
        // â˜… æ–°å¢ï¼šé»è®šèˆ‡ç•™è¨€ç³»çµ±
        // =========================================
        
        let currentPostIdForComment = null; // è¨˜éŒ„ç›®å‰æ­£åœ¨ç•™è¨€å“ªä¸€ç¯‡è²¼æ–‡

        // --- 1. é»è®šåŠŸèƒ½ (Toggle Like) ---
        window.toggleLike = async function(postId, btnElement) {
            const user = window.currentUser;
            if (!user) { alert("è«‹å…ˆç™»å…¥"); performLogin(); return; }

            // ç‚ºäº†è®“é«”é©—æ›´å¥½ï¼Œå…ˆåœ¨å‰ç«¯åˆ‡æ›æ¨£å¼ (Optimistic UI)
            const iconContainer = btnElement.closest('.stat-item');
            const countSpan = iconContainer.querySelector('span');
            let currentCount = parseInt(countSpan.innerText) || 0;
            const isLiked = iconContainer.classList.contains('liked');

            // åˆ‡æ›æ¨£å¼
            if (isLiked) {
                iconContainer.classList.remove('liked');
                countSpan.innerText = Math.max(0, currentCount - 1);
            } else {
                iconContainer.classList.add('liked');
                countSpan.innerText = currentCount + 1;
            }

            try {
                const { doc, getDoc, setDoc, deleteDoc, updateDoc, increment } = window.fs;
                const postRef = doc(window.db, "posts", postId);
                const likeRef = doc(window.db, "posts", postId, "likes", user.uid);

                const likeSnap = await getDoc(likeRef);

                if (likeSnap.exists()) {
                    // å·²ç¶“è®šé -> å–æ¶ˆè®š
                    await deleteDoc(likeRef);
                    await updateDoc(postRef, { likes: increment(-1) });
                } else {
                    // é‚„æ²’è®šé -> æŒ‰è®š
                    await setDoc(likeRef, { uid: user.uid, timestamp: new Date() });
                    await updateDoc(postRef, { likes: increment(1) });
                }
            } catch (e) {
                console.error("é»è®šå¤±æ•—", e);
                // å¤±æ•—æ™‚å›å¾©æ¨£å¼ (ç•¥)
            }
        }

      // --- æª¢æŸ¥è²¼æ–‡æ˜¯å¦å·²æŒ‰è®š (ä¿æŒæ„›å¿ƒäº®è‘—çš„é—œéµ) ---
        window.checkLikeStatus = async function(postId, elementId) {
            const user = window.currentUser;
            if (!user) return; // æ²’ç™»å…¥å°±ä¸æª¢æŸ¥
            
            try {
                const { doc, getDoc } = window.fs;
                // è®€å–è·¯å¾‘: posts -> [è²¼æ–‡ID] -> likes -> [ä½¿ç”¨è€…ID]
                const likeSnap = await getDoc(doc(window.db, "posts", postId, "likes", user.uid));
                
                // å¦‚æœé€™ä»½æ–‡ä»¶å­˜åœ¨ï¼Œä»£è¡¨æŒ‰éè®š
                if (likeSnap.exists()) {
                    const el = document.getElementById(elementId);
                    if (el) {
                        el.classList.add('liked'); // â˜… é€™è¡Œæœƒè®“æ„›å¿ƒè®Šç´…
                    }
                }
            } catch(e) {
                console.error("æª¢æŸ¥æŒ‰è®šç‹€æ…‹å¤±æ•—", e);
            }
        }

        // --- 3. é–‹å•Ÿç•™è¨€è¦–çª— ---
        window.openCommentModal = function(postId) {
            currentPostIdForComment = postId;
            document.getElementById('comment-modal').style.display = 'flex';
            document.getElementById('comment-list-container').innerHTML = '<div style="text-align:center; padding:20px; color:#666;">è¼‰å…¥ç•™è¨€ä¸­...</div>';
            loadComments(postId);
        }

        window.closeCommentModal = function() {
            document.getElementById('comment-modal').style.display = 'none';
            currentPostIdForComment = null;
        }

        // --- 4. è¼‰å…¥ç•™è¨€åˆ—è¡¨ ---
        function loadComments(postId) {
            const { collection, query, orderBy, onSnapshot } = window.fs;
            const commentsRef = collection(window.db, "posts", postId, "comments");
            const q = query(commentsRef, orderBy("timestamp", "asc"));

            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('comment-list-container');
                if (!list) return;
                
                if (snapshot.empty) {
                    list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">é‚„æ²’æœ‰äººç•™è¨€ï¼Œæ¶é ­é¦™ï¼</div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const date = c.timestamp ? c.timestamp.toDate() : new Date();
                    const timeStr = date.toLocaleString('zh-TW', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
                    const avatar = c.avatar || '';

                    html += `
                        <div class="comment-item">
                            <div class="user-avatar-circle" style="width:32px; height:32px; border-width:1px;">
                                ${avatar ? `<img src="${avatar}" alt="Avatar">` : 'ğŸ‘¤'}
                            </div>
                            <div class="comment-content-box">
                                <div class="comment-header">
                                    <span class="comment-author">${c.name}</span>
                                    <span class="comment-time">${timeStr}</span>
                                </div>
                                <div class="comment-text">${c.content}</div>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
                list.scrollTop = list.scrollHeight; // è‡ªå‹•æ²åˆ°åº•éƒ¨
            });
        }

        // --- 5. ç™¼é€ç•™è¨€ ---
        window.submitComment = async function() {
            const input = document.getElementById('comment-input');
            const val = input.value.trim();
            if (!val || !currentPostIdForComment || !window.currentUser) return;

            try {
                const { addDoc, collection, serverTimestamp, doc, updateDoc, increment } = window.fs;
                const user = window.currentUser;
                
                // 1. æ–°å¢ç•™è¨€åˆ°å­é›†åˆ
                await addDoc(collection(window.db, "posts", currentPostIdForComment, "comments"), {
                    content: val,
                    uid: user.uid,
                    name: user.displayName,
                    avatar: user.photoURL,
                    timestamp: serverTimestamp()
                });

                // 2. æ›´æ–°è²¼æ–‡çš„ç•™è¨€è¨ˆæ•¸
                const postRef = doc(window.db, "posts", currentPostIdForComment);
                await updateDoc(postRef, { comments: increment(1) });

                input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            } catch (e) {
                alert("ç•™è¨€å¤±æ•—: " + e.message);
            }
        }
        // =========================================
        // â˜… æ–°å¢ï¼šä¿¡ç®± (Mailbox) - æ”¶ä»¶åŒ£åˆ—è¡¨ç‰ˆ
        // =========================================
        
        let currentChatUnsubscribe = null; 

        // 1. æ¸²æŸ“ä¿¡ç®±ä¸»ç•«é¢ (å·¦å³å…©æ¬„å¼è¨­è¨ˆ)
        window.renderMailbox = async function() {
            const user = window.currentUser;
            if (!user) { alert(i18n[pulseLang].loginReq); performLogin(); return; }

            // UI åˆ‡æ›
            document.querySelectorAll('.pulse-nav-btn').forEach(btn => btn.classList.remove('active'));
            const mailBtn = document.getElementById('nav-mail');
            if(mailBtn) mailBtn.classList.add('active');

            const centerCol = document.querySelector('.pulse-feed-container');
            if (!centerCol) return;

            // å–å¾—ä»Šæ—¥é¡åº¦
            const { used, limit, isAdmin } = await checkDailyQuota(user.uid);
            const limitDisplay = isAdmin ? "ç„¡é™ (ç®¡ç†å“¡)" : `${used} / ${limit}`;

            centerCol.innerHTML = `
                <div class="pulse-create-box" style="padding-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h2 style="margin:0; color:var(--text-primary); font-size:1.5em;">
                            ${icons.mail} ä¿¡ç®±ä¸­å¿ƒ
                        </h2>
                        <div style="font-size:0.9em; color:var(--text-secondary);">
                            ä»Šæ—¥é¡åº¦: <span style="color:var(--accent-main); font-weight:bold;">${limitDisplay}</span>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" id="new-chat-uid" class="quick-input" 
                               style="border:1px solid var(--border-color); padding:8px 15px; border-radius:20px; font-size:0.9em;" 
                               placeholder="è¼¸å…¥å°æ–¹ UID é–‹å•Ÿæ–°å°è©±...">
                        <button class="post-btn" onclick="window.startNewChat()" style="padding:5px 15px; font-size:0.9em;">
                            é–‹å•Ÿ
                        </button>
                    </div>
                </div>

                <div style="display:flex; gap:15px; height: 600px; margin-top:15px;">
                    
                    <div id="inbox-list" style="
                        width: 30%; 
                        background:var(--bg-panel); 
                        border:1px solid var(--border-color); 
                        border-radius:12px; 
                        overflow-y:auto;
                        padding:10px;
                        display:flex; flex-direction:column; gap:5px;
                    ">
                        <div style="text-align:center; padding:20px; color:#666;">è¼‰å…¥åˆ—è¡¨...</div>
                    </div>

                    <div style="
                        flex:1; 
                        display:flex; flex-direction:column; 
                        background:var(--bg-panel); 
                        border:1px solid var(--border-color); 
                        border-radius:12px; 
                        overflow:hidden;
                    ">
                        <div id="chat-header" style="
                            padding:15px; 
                            border-bottom:1px solid var(--border-color); 
                            font-weight:bold; 
                            background:rgba(255,255,255,0.02);
                        ">
                            å°šæœªé¸æ“‡å°è©±
                        </div>

                        <div id="mailbox-chat-area" style="
                            flex:1; 
                            padding:20px; 
                            overflow-y:auto; 
                            display:flex; flex-direction:column; gap:15px;
                        ">
                            <div style="text-align:center; color:#666; margin-top:50px;">
                                ğŸ‘ˆ è«‹å¾å·¦å´é¸æ“‡è¯çµ¡äºº
                            </div>
                        </div>

                        <div style="padding:15px; border-top:1px solid var(--border-color); display:flex; gap:10px;">
                            <input type="text" id="mail-content" class="quick-input" 
                                   style="flex:1; border:1px solid var(--border-color); padding:10px; border-radius:8px;" 
                                   placeholder="è¼¸å…¥è¨Šæ¯..." disabled>
                            <button id="mail-send-btn" class="post-btn" onclick="window.sendDirectMessage()" disabled>
                                ç™¼é€
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // è¼‰å…¥å·¦å´ã€Œæˆ‘çš„å°è©±åˆ—è¡¨ã€
            loadInboxList(user.uid);
        }

        // 2. è¼‰å…¥æ”¶ä»¶åŒ£åˆ—è¡¨ (åˆ—å‡ºæ‰€æœ‰åƒèˆ‡éçš„å°è©±)
        async function loadInboxList(uid) {
            const listEl = document.getElementById('inbox-list');
            if(!listEl) return;

            try {
                const { collection, query, where, getDocs, orderBy } = window.fs;
                // æŸ¥è©¢ï¼šparticipants é™£åˆ—ä¸­åŒ…å«æˆ‘çš„ UID
                const q = query(
                    collection(window.db, "chats"), 
                    where("participants", "array-contains", uid),
                    orderBy("lastUpdated", "desc") // ä¾ç…§æœ€å¾Œæ›´æ–°æ™‚é–“æ’åº
                );

                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#666; font-size:0.9em;">å°šç„¡å°è©±è¨˜éŒ„</div>';
                    return;
                }

                let html = '';
                // é€™è£¡æˆ‘å€‘éœ€è¦ä¸€é»å°æŠ€å·§ä¾†é¡¯ç¤ºã€Œå°æ–¹çš„åå­—ã€
                // å› ç‚º chat æ–‡ä»¶åªæœ‰ participants UIDï¼Œæˆ‘å€‘é€šå¸¸éœ€è¦å» users é›†åˆæŸ¥åå­—
                // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å…ˆé¡¯ç¤ºå°æ–¹çš„ UID æˆ–é è¦½æ–‡å­—
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const otherUid = data.participants.find(id => id !== uid) || "æœªçŸ¥";
                    const shortUid = otherUid.slice(0, 6); 
                    // æª¢æŸ¥æœ€å¾Œä¸€å‰‡è¨Šæ¯
                    const lastMsg = data.lastMessage ? (data.lastMessage.length > 10 ? data.lastMessage.slice(0,10)+'...' : data.lastMessage) : 'ç„¡è¨Šæ¯';
                    
                    // ç”¢ç”Ÿåˆ—è¡¨é …ç›® (é»æ“Šå¾Œè¼‰å…¥è©²èŠå¤©å®¤)
                    html += `
                        <div onclick="window.selectChat('${doc.id}', '${otherUid}')" style="
                            padding:12px; 
                            border-radius:8px; 
                            cursor:pointer; 
                            transition:0.2s;
                            border:1px solid transparent;
                            background:rgba(255,255,255,0.03);
                        " onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.03)'">
                            
                            <div style="font-weight:bold; color:var(--text-primary); font-size:0.95em;">User: ${shortUid}..</div>
                            <div style="font-size:0.85em; color:var(--text-secondary); margin-top:4px;">${lastMsg}</div>
                        </div>
                    `;
                });

                listEl.innerHTML = html;

            } catch (e) {
                console.error("è¼‰å…¥åˆ—è¡¨å¤±æ•—", e);
                listEl.innerHTML = `<div style="color:red; font-size:0.8em; padding:10px;">è¼‰å…¥å¤±æ•—: ${e.message}</div>`;
            }
        }

        // 3. é¸æ“‡ä¸¦é–‹å•ŸæŸå€‹å°è©±
        window.currentActiveChatId = null; // å…¨åŸŸè®Šæ•¸ï¼šè¨˜éŒ„ç•¶å‰èŠå¤©å®¤ ID
        window.currentActiveTargetUid = null; // å…¨åŸŸè®Šæ•¸ï¼šè¨˜éŒ„ç•¶å‰å°è±¡ UID

        window.selectChat = function(chatId, targetUid) {
            window.currentActiveChatId = chatId;
            window.currentActiveTargetUid = targetUid;

            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('chat-header').innerHTML = `èˆ‡ <span style="color:var(--accent-main)">${targetUid}</span> çš„å°è©±`;
            
            // å•Ÿç”¨è¼¸å…¥æ¡†
            document.getElementById('mail-content').disabled = false;
            document.getElementById('mail-send-btn').disabled = false;

            // è¼‰å…¥è¨Šæ¯å…§å®¹
            loadChatRoom(chatId, window.currentUser.uid);
        }

        // 4. æ‰‹å‹•è¼¸å…¥ UID é–‹å•Ÿæ–°å°è©±
        window.startNewChat = function() {
            const uidInput = document.getElementById('new-chat-uid');
            const targetUid = uidInput.value.trim();
            if(!targetUid) return;
            
            const user = window.currentUser;
            if(targetUid === user.uid) { alert("ä¸èƒ½è·Ÿè‡ªå·±èŠå¤©"); return; }

            // è¨ˆç®— Chat ID
            const participants = [user.uid, targetUid].sort();
            const chatId = participants.join('_');

            // ç›´æ¥é¸ä¸­é€™å€‹èŠå¤©å®¤ (å¦‚æœä¹‹å‰æ²’èŠéï¼Œæœƒåœ¨ç™¼é€ç¬¬ä¸€å‰‡è¨Šæ¯æ™‚è‡ªå‹•å»ºç«‹)
            window.selectChat(chatId, targetUid);
            uidInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
        }

        // 5. ä¿®æ”¹å¾Œçš„ç™¼é€å‡½å¼ (é©æ‡‰æ–° UI)
        window.sendDirectMessage = async function() {
            const user = window.currentUser;
            const contentInput = document.getElementById('mail-content');
            const content = contentInput.value.trim();
            
            // å¾å…¨åŸŸè®Šæ•¸å–å¾—ç•¶å‰å°è±¡
            const chatId = window.currentActiveChatId;
            const targetUid = window.currentActiveTargetUid;

            if (!chatId || !targetUid) { alert("è«‹å…ˆé¸æ“‡å°è©±å°è±¡"); return; }
            if (!content) return;

            // A. æª¢æŸ¥é¡åº¦
            const { used, limit, isAdmin } = await checkDailyQuota(user.uid);
            if (!isAdmin && used >= limit) {
                alert(`ä»Šæ—¥é¡åº¦å·²æ»¿ (${used}/${limit})ã€‚`);
                return;
            }

            try {
                const { doc, setDoc, addDoc, collection, serverTimestamp, increment } = window.fs;
                
                // 1. ç¢ºä¿èŠå¤©å®¤æ–‡ä»¶å­˜åœ¨ (æ›´æ–° lastMessage)
                const chatRef = doc(window.db, "chats", chatId);
                const participants = [user.uid, targetUid].sort();

                await setDoc(chatRef, {
                    participants: participants,
                    lastMessage: content,
                    lastUpdated: serverTimestamp()
                }, { merge: true });

                // 2. å¯«å…¥è¨Šæ¯
                await addDoc(collection(window.db, "chats", chatId, "messages"), {
                    content: content,
                    senderId: user.uid,
                    timestamp: serverTimestamp()
                });

                // 3. æ›´æ–°é¡åº¦
                if (!isAdmin) {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const statsRef = doc(window.db, "users", user.uid, "dailyStats", todayStr);
                    await setDoc(statsRef, { sentCount: increment(1) }, { merge: true });
                }

                contentInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                
                // 4. é‡æ–°æ•´ç†å·¦å´åˆ—è¡¨ (è®“æœ€æ–°çš„è¨Šæ¯æ’åˆ°ä¸Šé¢)
                loadInboxList(user.uid);

            } catch (e) {
                console.error(e);
                alert("ç™¼é€å¤±æ•—: " + e.message);
            }
        }
// 6. æª¢æŸ¥æ¯æ—¥é¡åº¦ (è£œä¸Šé€™å€‹å‡½å¼ï¼Œå¦å‰‡æœƒå ±éŒ¯)
        async function checkDailyQuota(uid) {
            const ADMIN_UID = "1EALL0fq7nUzEi8B96qwXZuyG7h1";
            const isAdmin = (uid === ADMIN_UID);
            
            if (isAdmin) return { used: 0, limit: 9999, isAdmin: true };

            const todayStr = new Date().toISOString().split('T')[0]; // æ ¼å¼: 2025-11-28
            let used = 0;

            try {
                const { doc, getDoc } = window.fs;
                const statsRef = doc(window.db, "users", uid, "dailyStats", todayStr);
                const snap = await getDoc(statsRef);
                
                if (snap.exists()) {
                    used = snap.data().sentCount || 0;
                }
            } catch (e) {
                console.error("è®€å–é¡åº¦å¤±æ•—", e);
            }

            return { used, limit: 20, isAdmin: false };
        }

        // 7. è¼‰å…¥ä¸¦ç›£è½èŠå¤©å®¤è¨Šæ¯ (é€™æ˜¯æ‚¨åŸæœ¬éºæ¼çš„ç¬¬ä¸‰æ­¥)
        function loadChatRoom(chatId, currentUid) {
            const chatArea = document.getElementById('mailbox-chat-area');
            if(!chatArea) return;

            // åˆ‡æ›èŠå¤©å®¤æ™‚ï¼Œå…ˆå–æ¶ˆä¸Šä¸€å€‹èŠå¤©å®¤çš„ç›£è½ï¼Œé¿å…é‡è¤‡æ”¶åˆ°è¨Šæ¯
            if (currentChatUnsubscribe) {
                currentChatUnsubscribe();
            }

            const { collection, query, orderBy, onSnapshot, limit } = window.fs;
            
            // æŸ¥è©¢è©²èŠå¤©å®¤åº•ä¸‹çš„ messagesï¼Œä¾æ™‚é–“æ’åºï¼ŒåªæŠ“æœ€å¾Œ 50 ç­†
            const q = query(
                collection(window.db, "chats", chatId, "messages"), 
                orderBy("timestamp", "asc"),
                limit(50) 
            );

            // è¨­ç½®å³æ™‚ç›£è½
            currentChatUnsubscribe = onSnapshot(q, (snapshot) => {
                let html = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = (msg.senderId === currentUid);
                    
                    // æ™‚é–“æ ¼å¼åŒ–
                    const date = msg.timestamp ? msg.timestamp.toDate() : new Date();
                    const timeStr = date.toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit' });

                    // ç”¢ç”Ÿè¨Šæ¯æ°£æ³¡ (å³é‚Šæ˜¯è‡ªå·±ï¼Œå·¦é‚Šæ˜¯å°æ–¹)
                    html += `
                        <div style="
                            display:flex; 
                            justify-content: ${isMe ? 'flex-end' : 'flex-start'};
                            margin-bottom: 10px;
                            animation: fadeIn 0.3s ease;
                        ">
                            <div style="
                                max-width: 70%;
                                background: ${isMe ? 'var(--accent-main)' : 'rgba(255,255,255,0.1)'};
                                color: ${isMe ? '#000' : 'var(--text-primary)'};
                                padding: 8px 15px;
                                border-radius: 18px;
                                border-bottom-${isMe ? 'right' : 'left'}-radius: 4px;
                                position: relative;
                            ">
                                <div style="font-size:0.95em; white-space: pre-wrap; word-break: break-word;">${msg.content}</div>
                                <div style="font-size:0.7em; text-align:right; margin-top:5px; opacity:0.6;">
                                    ${timeStr}
                                </div>
                            </div>
                        </div>
                    `;
                });

                if (html === '') {
                    html = '<div style="text-align:center; padding:20px; color:#666;">é–‹å§‹æ–°çš„å°è©±...</div>';
                }

                chatArea.innerHTML = html;
                chatArea.scrollTop = chatArea.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
            });
        }


     
        window.initApp = window.renderPulseStreet;

    </script>
<div id="create-post-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">å»ºç«‹æ–°è²¼æ–‡</div>
                <button class="modal-close-btn" onclick="closeCreatePostModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="modal-input-area">
                    <div class="user-avatar-circle" id="modal-user-avatar">
                        </div>
                    <textarea id="modal-post-input" class="modal-textarea" placeholder="åˆ†äº«æ‚¨çš„å¸‚å ´è§€é»..."></textarea>
                </div>
                
                <div id="image-preview-container">
                    <img id="image-preview" src="" alt="Image Preview">
                    <button class="remove-image-btn" onclick="removeSelectedImage()">Ã—</button>
                </div>
            </div>
            <div class="modal-footer">
                <div>
                    <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                    <div class="upload-icon-btn" onclick="document.getElementById('file-input').click()" title="ä¸Šå‚³ç…§ç‰‡">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                </div>
                <button class="post-btn" id="modal-post-btn" onclick="submitModalPost()">ç™¼ä½ˆ</button>
            </div>
        </div>
    </div>
<div id="comment-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">ç•™è¨€</div>
                <button class="modal-close-btn" onclick="closeCommentModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="comment-list-container" class="comment-list">
                    <div style="text-align:center; padding:20px; color:#666;">è¼‰å…¥ç•™è¨€ä¸­...</div>
                </div>
            </div>
            <div class="modal-footer" style="display:block; border-top: 1px solid var(--border-color); padding-top:15px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="comment-input" class="modal-textarea" style="min-height: 40px; height:40px; border: 1px solid var(--border-color); border-radius: 20px; padding: 0 15px;" placeholder="ç™¼ä½ˆä½ çš„å›è¦†...">
                    <button class="post-btn" onclick="submitComment()">å›è¦†</button>
                </div>
            </div>
        </div>
    </div>

    
</body>
</html>
