<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NodeX</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300ffcc' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 5l14 14'/%3E%3Cpath d='M19 5l-14 14'/%3E%3Ccircle cx='12' cy='12' r='2' fill='%2300ffcc' stroke='none'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;700&family=Courier+New&display=swap" rel="stylesheet">
    
    <style>
                    /* [æ–°å¢] æ¨¡æ…‹æ¡† CSS */
            .nx-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
                z-index: 9999; display: none; align-items: center; justify-content: center;
                animation: fadeIn 0.2s;
            }
            .nx-modal-content {
                background: var(--nx-sidebar); border: 1px solid var(--nx-border);
                width: 90%; max-width: 500px; height: 60vh;
                border-radius: 12px; display: flex; flex-direction: column;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            }
            .nx-modal-header {
                padding: 15px; border-bottom: 1px solid var(--nx-border);
                display: flex; justify-content: space-between; align-items: center;
                background: var(--nx-card-bg); border-radius: 12px 12px 0 0;
            }
        /* --- CSS è®Šæ•¸ç³»çµ± (æ ¸å¿ƒ) --- */
        :root {
            /* é è¨­ç‚º Tech é¢¨æ ¼ */
            --nx-bg: #050505;
            --nx-sidebar: #0a0a0a;
            --nx-text: #e0e0e0;
            --nx-text-muted: #888;
            --nx-accent: #00ffcc;
            --nx-border: #333;
            --nx-card-bg: rgba(255,255,255,0.05);
            --nx-input-bg: #141414;
            --nx-radius: 12px;
            --nx-font: 'Inter', sans-serif;
            --nx-glow: 0 0 15px rgba(0, 255, 204, 0.1);
            --nx-hover-bg: rgba(255,255,255,0.1);
            --nx-btn-active-bg: rgba(0, 255, 204, 0.15);
        }

        /* å•†å‹™é¢¨æ ¼ (Business) */
        [data-theme="business"] {
            --nx-bg: #f8f9fa;
            --nx-sidebar: #ffffff;
            --nx-text: #2d3748;
            --nx-text-muted: #718096;
            --nx-accent: #2b6cb0; /* å°ˆæ¥­è— */
            --nx-border: #e2e8f0;
            --nx-card-bg: #ffffff;
            --nx-input-bg: #ffffff;
            --nx-radius: 8px;
            --nx-glow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --nx-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --nx-hover-bg: #f7fafc;
            --nx-btn-active-bg: #ebf8ff;
        }

        /* çµ‚ç«¯æ©Ÿé¢¨æ ¼ (Terminal) */
        [data-theme="terminal"] {
            --nx-bg: #000000;
            --nx-sidebar: #000000;
            --nx-text: #33ff00; /* ç¶“å…¸ç¶  */
            --nx-text-muted: #008800;
            --nx-accent: #33ff00;
            --nx-border: #004400;
            --nx-card-bg: #000000;
            --nx-input-bg: #000000;
            --nx-radius: 0px;
            --nx-font: 'Courier New', monospace;
            --nx-glow: none;
            --nx-hover-bg: #002200;
            --nx-btn-active-bg: #003300;
        }

        /* åŸºç¤é‡ç½® */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: var(--nx-bg); 
            color: var(--nx-text); 
            font-family: var(--nx-font); 
            height: 100vh; 
            display: flex; 
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* çµ‚ç«¯æ©Ÿæƒæç·šç‰¹æ•ˆ */
        [data-theme="terminal"] body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        /* --- å´é‚Šæ¬„ --- */
        .nx-sidebar {
            width: 260px;
            background: var(--nx-sidebar);
            border-right: 1px solid var(--nx-border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
            transition: all 0.3s;
        }

        /* Logo (NodeX) */
        .nx-brand {
            display: flex; align-items: center; gap: 10px; margin-bottom: 30px;
            color: var(--nx-text); font-weight: 900; font-size: 1.4rem; letter-spacing: 1px;
            cursor: pointer; font-family: 'Orbitron', sans-serif;
        }
        .nx-logo-svg { width: 36px; height: 36px; fill: none; stroke: var(--nx-accent); stroke-width: 2; }

        /* æ–°å°è©±æŒ‰éˆ• */
        .nx-btn-new {
            background: var(--nx-card-bg);
            border: 1px solid var(--nx-border);
            color: var(--nx-text);
            padding: 10px;
            border-radius: var(--nx-radius);
            cursor: pointer;
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 20px;
            transition: all 0.2s;
            box-shadow: var(--nx-glow);
            font-weight: 600;
        }
        .nx-btn-new:hover { 
            border-color: var(--nx-accent); 
            color: var(--nx-accent); 
            transform: translateY(-1px);
        }

        /* é¸å–®ç¾¤çµ„ */
        .nx-menu-group { margin-bottom: 20px; }
        .nx-menu-title { 
            font-size: 0.75em; 
            color: var(--nx-text-muted); 
            margin-bottom: 10px; 
            padding-left: 10px; 
            font-weight: bold; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .nx-menu-item {
            padding: 8px 12px; 
            cursor: pointer; 
            border-radius: var(--nx-radius); 
            color: var(--nx-text);
            display: flex; align-items: center; gap: 10px; 
            font-size: 0.95em; 
            opacity: 0.8; 
            transition: all 0.2s;
            text-decoration: none; 
        }
        .nx-menu-item:hover, .nx-menu-item.active { 
            background: var(--nx-hover-bg);
            opacity: 1; 
            color: var(--nx-accent); 
        }
        .nx-icon { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; }

        /* å´é‚Šæ¬„åº•éƒ¨ */
        .nx-sidebar-footer { 
            margin-top: auto; 
            border-top: 1px solid var(--nx-border); 
            padding-top: 15px; 
        }
        .nx-tool-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }

        /* åº•éƒ¨æŒ‰éˆ•æ¨£å¼ (èªè¨€/é¢¨æ ¼) */
        .nx-footer-btn {
            background: transparent; 
            border: 1px solid var(--nx-border); 
            color: var(--nx-text-muted);
            width: 32px; height: 32px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; 
            transition: all 0.3s;
            position: relative; /* ç‚ºäº†å®šä½é¸å–® */
        }
        .nx-footer-btn:hover, .nx-footer-btn.active { color: var(--nx-accent); border-color: var(--nx-accent); }

        /* é€šç”¨å½ˆå‡ºé¸å–® (Dropdown) */
        .nx-dropdown-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--nx-sidebar);
            border: 1px solid var(--nx-border);
            border-radius: var(--nx-radius);
            padding: 5px;
            display: none;
            flex-direction: column;
            min-width: 140px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            z-index: 100;
            margin-bottom: 10px;
        }
        .nx-dropdown-menu.show { display: flex; animation: fadeIn 0.2s; }
        
        .nx-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85em;
            color: var(--nx-text);
            border-radius: 4px;
            transition: background 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .nx-dropdown-item:hover { background: var(--nx-hover-bg); color: var(--nx-accent); }
        .nx-dropdown-item.active { color: var(--nx-accent); font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ä½¿ç”¨è€…é ­åƒ */
        .nx-user-profile {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            padding: 8px; border-radius: var(--nx-radius);
        }
        .nx-user-profile:hover { background: var(--nx-hover-bg); }
        .nx-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #333; }
        .nx-username { font-size: 0.9em; font-weight: bold; }

        /* --- ä¸»å…§å®¹å€ --- */
        .nx-main {
            flex: 1; 
            position: relative; 
            display: flex; 
            flex-direction: column;
            background: var(--nx-bg);
        }

        /* èŠå¤©é¡¯ç¤ºå€ */
        .nx-chat-area { 
            flex: 1;
            overflow-y: auto; 
            padding: 40px; 
            /* [æ–°å¢] åº•éƒ¨ç•™ç™½ï¼Œé¿å…æœ€å¾Œä¸€å‰‡è¨Šæ¯è¢«æ‡¸æµ®è¼¸å…¥æ¡†æ“‹ä½ */
            padding-bottom: 140px; 
            
            display: flex; 
            flex-direction: column; 
            align-items: center;
        }
        
        /* æ­¡è¿ç•«é¢ */
        .nx-welcome { text-align: center; margin-top: 10vh; max-width: 700px; width: 100%; }
        .nx-welcome h1 { 
            font-size: 2.5rem; 
            margin-bottom: 30px; 
            font-weight: 300; 
            line-height: 1.2;
        }
        .nx-welcome span { 
            color: var(--nx-accent); 
            font-weight: 700; 
            /* çµ‚ç«¯æ©Ÿé¢¨æ ¼ä¸ä½¿ç”¨æ¼¸å±¤æ–‡å­— */
            [data-theme="business"] &, [data-theme="tech"] & {
                background: linear-gradient(90deg, var(--nx-text), var(--nx-accent));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
        }

        /* å»ºè­°å¡ç‰‡ç¶²æ ¼ */
        .nx-suggestion-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            width: 100%; 
            margin-top: 40px;
        }
        .nx-suggestion-card {
            background: var(--nx-card-bg); 
            border: 1px solid var(--nx-border); 
            padding: 15px 20px;
            border-radius: var(--nx-radius); 
            cursor: pointer; 
            text-align: left; 
            font-size: 0.95em;
            transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nx-suggestion-card:hover { 
            border-color: var(--nx-accent); 
            transform: translateY(-2px); 
            box-shadow: var(--nx-glow);
        }
        .nx-sug-arrow { opacity: 0.5; font-size: 0.8em; }

       /* --- æ–°ç‰ˆè¼¸å…¥æ¡†æ¨£å¼ (å›ºå®šåº•éƒ¨æ‡¸æµ®ç‰ˆ) --- */
        .nx-input-container {
            width: 100%;
            max-width: 800px;
            /* æ”¹ç”¨çµ•å°å®šä½ï¼Œå¼·åˆ¶å›ºå®šåœ¨çˆ¶å®¹å™¨ (.nx-main) çš„åº•éƒ¨ */
            position: absolute; 
            bottom: 30px;       /* è·é›¢åº•éƒ¨ç•™ä¸€äº›ç©ºé–“ */
            left: 50%;          /* è¨­å®šå·¦å´ä½ç½®åœ¨ 50% */
            transform: translateX(-50%); /* å‘å·¦å›æ¨è‡ªèº«å¯¬åº¦çš„ä¸€åŠï¼Œé”æˆå®Œç¾ç½®ä¸­ */
            
            padding: 0 20px;
            z-index: 50;        /* å±¤ç´šèª¿é«˜ï¼Œç¢ºä¿æµ®åœ¨æ–‡å­—ä¸Šæ–¹ */
            margin: 0;          /* ç§»é™¤åŸæœ¬çš„ margin è¨­å®š */
        }
        
        .nx-input-wrapper {
            background: var(--nx-input-bg); 
            border: 1px solid var(--nx-border); 
            border-radius: 16px; /* ç¨å¾®æ–¹ä¸€é»çš„åœ“è§’ */
            padding: 12px 16px; 
            display: flex; 
            flex-direction: column; /* ä¸Šä¸‹æ’åˆ— */
            gap: 8px;
            box-shadow: var(--nx-glow);
            transition: border-color 0.3s;
        }
        
        /* çµ‚ç«¯æ©Ÿè¼¸å…¥æ¡†æ¨£å¼èª¿æ•´ */
        [data-theme="terminal"] .nx-input-wrapper { border-radius: 0; border: 2px solid var(--nx-border); box-shadow: none; }
        .nx-input-wrapper:focus-within { border-color: var(--nx-accent); }
        
        /* ä¸Šå±¤ï¼šè¼¸å…¥å€ */
        .nx-textarea {
            width: 100%; 
            background: transparent; 
            border: none; 
            color: var(--nx-text);
            font-size: 1rem; 
            resize: none; 
            max-height: 200px; 
            min-height: 24px;
            outline: none; 
            font-family: inherit; 
            line-height: 1.5;
            padding: 0;
        }

        /* ä¸‹å±¤ï¼šå·¥å…·åˆ— */
        .nx-input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }

        .nx-input-left, .nx-input-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* åº•éƒ¨å·¥å…·æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .nx-tool-btn {
            background: transparent;
            border: none;
            color: var(--nx-text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .nx-tool-btn:hover {
            color: var(--nx-accent);
            background: var(--nx-hover-bg);
        }
        
        /* è† å›Šç‹€æŒ‰éˆ• (å·¦å´åŠŸèƒ½) */
        .nx-pill-btn {
            border: 1px solid transparent;
            background: rgba(255,255,255,0.03);
            border-radius: 20px;
            padding: 4px 10px;
        }
        .nx-pill-btn:hover, .nx-pill-btn.active {
            border-color: var(--nx-accent);
            color: var(--nx-accent);
            background: var(--nx-btn-active-bg);
        }

        /* ç™¼é€æŒ‰éˆ• */
        .nx-send-btn {
            background: var(--nx-accent); 
            color: #000; 
            border: none; 
            width: 32px; height: 32px;
            border-radius: 8px; /* æ–¹åœ“å½¢ */
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .nx-send-btn:hover { transform: scale(1.05); opacity: 0.9; }
        [data-theme="terminal"] .nx-send-btn { border-radius: 0; background: var(--nx-text); }

        /* å›é¦–é æŒ‰éˆ• (Dropdown æ¨£å¼) */
        .back-to-home-container {
            position: absolute; top: 20px; right: 20px; z-index: 50;
        }
        .back-to-home-btn {
            color: var(--nx-text-muted); 
            text-decoration: none;
            font-size: 0.8em; 
            border: 1px solid var(--nx-border);
            padding: 6px 14px; 
            border-radius: var(--nx-radius);
            transition: all 0.2s;
            background: var(--nx-card-bg);
            cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }
        .back-to-home-btn:hover { border-color: var(--nx-accent); color: var(--nx-accent); }
        
        .home-dropdown {
            position: absolute; top: 110%; right: 0;
            background: var(--nx-sidebar);
            border: 1px solid var(--nx-border);
            border-radius: var(--nx-radius);
            width: 160px;
            display: none;
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            padding: 5px;
        }
        .home-dropdown.show { display: flex; }

        /* RWD */
        @media (max-width: 768px) {
            .nx-sidebar { display: none; } /* æ‰‹æ©Ÿç‰ˆæš«æ™‚éš±è—å´æ¬„ */
            .nx-welcome h1 { font-size: 1.8rem; }
            .nx-suggestion-grid { grid-template-columns: 1fr; }
        }
        /* --- è‡¨æ™‚å°è©±æ¡† (Central Spotlight Style) --- */
.nx-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); /* èƒŒæ™¯è®Šæš— */
    backdrop-filter: blur(5px);      /* èƒŒæ™¯æ¨¡ç³Šï¼Œå‡¸é¡¯å‰æ™¯ */
    z-index: 9999; 
    display: none; 
    align-items: center; justify-content: center; /* ä¸Šä¸‹å·¦å³ç½®ä¸­é—œéµ */
    opacity: 0;
    transition: opacity 0.3s ease;
}

.nx-modal-overlay.show {
    opacity: 1;
}

.nx-modal-content {
    background: var(--nx-sidebar);
    width: 90%; 
    max-width: 650px;    /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œåƒ ChatGPT é‚£æ¨£ */
    height: 70vh;        /* é«˜åº¦é©ä¸­ */
    border-radius: 16px; 
    border: 1px solid var(--nx-border);
    box-shadow: 0 20px 50px rgba(0,0,0,0.5); /* å¼·çƒˆçš„é™°å½±è®“å®ƒçœ‹èµ·ä¾†æ‡¸æµ® */
    display: flex; 
    flex-direction: column;
    overflow: hidden;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.nx-modal-overlay.show .nx-modal-content {
    transform: scale(1);
}

/* æ¨™é¡Œåˆ— */
.nx-modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--nx-border);
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.02);
}

/* å°è©±æ­·å²å€ */
#temp-chat-history {
    flex: 1; 
    overflow-y: auto; 
    padding: 20px;
    scroll-behavior: smooth;
}

/* åº•éƒ¨è¼¸å…¥å€ (æ¨¡ä»¿ä½ çš„æˆªåœ–) */
.nx-modal-input-area {
    padding: 20px;
    background: var(--nx-sidebar);
    border-top: 1px solid var(--nx-border);
}

.nx-modal-input-wrapper {
    display: flex; 
    align-items: center; 
    gap: 10px;
    background: var(--nx-input-bg);
    border: 1px solid var(--nx-border);
    border-radius: 12px;
    padding: 8px 15px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

.nx-modal-input-wrapper:focus-within {
    border-color: var(--nx-accent);
    box-shadow: 0 0 10px var(--nx-glow);
}
        /* --- å´é‚Šæ¬„æ”¶åˆæ¨¡å¼ (Mini Sidebar) --- */
        
        /* 1. åŸºç¤è½‰å ´è¨­å®š (è®“ç¸®æ”¾å¾ˆå¹³æ»‘) */
        .nx-sidebar {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden; /* é˜²æ­¢æ–‡å­—åœ¨ç¸®å°éç¨‹ä¸­çªå‡ºå» */
            width: 260px;     /* é è¨­å¯¬åº¦ */
        }

        /* 2. æ”¶åˆç‹€æ…‹ (.collapsed) */
        .nx-sidebar.collapsed {
            width: 80px; /* ç¸®å°å¾Œçš„å¯¬åº¦ */
        }

        /* 3. æ”¶åˆæ™‚éš±è—æ–‡å­—èˆ‡æ¨™é¡Œ */
        .nx-sidebar.collapsed .nav-text,     /* Logo æ–‡å­— */
        .nx-sidebar.collapsed .nx-menu-item span, /* é¸å–®æ–‡å­— */
        .nx-sidebar.collapsed .nx-btn-new span,   /* æŒ‰éˆ•æ–‡å­— */
        .nx-sidebar.collapsed .nx-menu-title,     /* åˆ†é¡æ¨™é¡Œ */
        .nx-sidebar.collapsed .nx-username,       /* ä½¿ç”¨è€…åç¨± */
        .nx-sidebar.collapsed .nx-sug-arrow {     /* å…¶ä»–å°åœ–ç¤º */
            display: none !important;
        }

        /* 4. æ”¶åˆæ™‚çš„æ’ç‰ˆèª¿æ•´ (è®“ icon å±…ä¸­) */
        .nx-sidebar.collapsed .nx-brand,
        .nx-sidebar.collapsed .nx-menu-item,
        .nx-sidebar.collapsed .nx-btn-new,
        .nx-sidebar.collapsed .nx-user-profile {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }
        
        .nx-sidebar.collapsed .nx-btn-new {
            width: 40px; 
            height: 40px; 
            border-radius: 50%; /* è®Šæˆåœ“å½¢æŒ‰éˆ•æ¯”è¼ƒå¥½çœ‹ */
            margin: 0 auto 20px auto; /* æ°´å¹³å±…ä¸­ */
        }

        .nx-sidebar.collapsed .nx-menu-group {
            margin-bottom: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        .markdown-body { line-height: 1.6; font-size: 0.95em; color: var(--nx-text); }
        .markdown-body h1, .markdown-body h2 { color: var(--nx-accent); border-bottom: 1px solid var(--nx-border); margin-top: 1em; padding-bottom: 0.3em; }
        .markdown-body code { background: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'Courier New', monospace; color: #ff79c6; }
        .markdown-body pre { background: #111; padding: 1em; border-radius: 8px; overflow-x: auto; margin: 1em 0; border: 1px solid var(--nx-border); }
        .markdown-body pre code { background: transparent; padding: 0; color: #f8f8f2; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .markdown-body th, .markdown-body td { border: 1px solid var(--nx-border); padding: 8px; }
        .markdown-body th { color: var(--nx-accent); background: rgba(255,255,255,0.05); }
        .markdown-body blockquote { border-left: 3px solid var(--nx-accent); padding-left: 1em; color: var(--nx-text-muted); margin: 0; }

        /* --- æ–°å°è©±ï¼šç½®ä¸­æ¨¡å¼æ¨£å¼ --- */
        
        /* ç•¶å•Ÿç”¨ç½®ä¸­æ¨¡å¼æ™‚ï¼Œè¼¸å…¥æ¡†ç§»åˆ°ç•«é¢æ­£ä¸­å¤® */
        .nx-main.centered-mode .nx-input-container {
            bottom: auto;           /* å–æ¶ˆåº•éƒ¨çš„é»è‘— */
            top: 50%;               /* ç§»å‹•åˆ°å‚ç›´ 50% */
            transform: translate(-50%, 0); /* ä¿æŒæ°´å¹³ç½®ä¸­ï¼Œå‚ç›´ä½ç½®ç”± margin å¾®èª¿ */
            max-width: 700px;       /* å¯ä»¥ç¨å¾®çª„ä¸€é»ï¼Œæ¯”è¼ƒç²¾ç·» */
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); /* å¹³æ»‘éæ¸¡å‹•ç•« */
        }

        /* ç‚ºäº†é¿é–‹æ¨™é¡Œæ–‡å­—ï¼Œç¨å¾®å¾€ä¸‹æ¨ä¸€é» */
        .nx-main.centered-mode .nx-input-container {
            margin-top: 60px; 
        }

        /* ç•¶è™•æ–¼ç½®ä¸­æ¨¡å¼æ™‚ï¼Œéš±è—èŠå¤©ç´€éŒ„å€ (ç¢ºä¿èƒŒæ™¯ä¹¾æ·¨) */
        .nx-main.centered-mode .nx-chat-area {
            display: none !important;
        }
        
        /* è¼¸å…¥æ¡†æœ¬èº«çš„æ¨£å¼å¾®èª¿ (è®“å®ƒåœ¨ä¸­é–“æ™‚çœ‹èµ·ä¾†æ›´åƒæœå°‹æ¡†) */
        .nx-main.centered-mode .nx-input-wrapper {
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); /* åŠ å¼·é™°å½± */
            border-color: var(--nx-border);
        }
    </style>
</head>
<body data-theme="tech"><div class="nx-sidebar"> <!-- é è¨­ä¸»é¡Œ -->

    <!-- å·¦å´å°èˆªæ¬„ -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px;">
        <div class="nx-brand" onclick="window.location.reload()" style="margin-bottom: 0;">
            <svg class="nx-logo-svg" viewBox="0 0 24 24">
                <path d="M4 4l16 16" stroke-linecap="round"/>
                <path d="M20 4l-16 16" stroke-linecap="round"/>
                <circle cx="4" cy="4" r="2.5" fill="currentColor" stroke="none"/>
                <circle cx="20" cy="20" r="2.5" fill="currentColor" stroke="none"/>
                <circle cx="20" cy="4" r="2.5" fill="currentColor" stroke="none"/>
                <circle cx="4" cy="20" r="2.5" fill="currentColor" stroke="none"/>
                <circle cx="12" cy="12" r="1.5" fill="var(--nx-accent)" stroke="none"/>
            </svg>
            <span class="nav-text">NodeX</span>
        </div>

        <button class="nx-tool-btn" onclick="toggleSidebar()" title="Toggle Sidebar">
            <svg class="nx-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
        </button>
    </div>
    
    <div class="nx-menu-group">
        <div class="nx-menu-item active" id="menu-home" onclick="switchView('home')">
            <svg class="nx-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span style="font-weight:600;">é¦–é </span>
        </div>
    </div>

        <button class="nx-btn-new" onclick="startNewChat()" style="margin-bottom: 20px; width: 100%;">
        <svg class="nx-icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        <span id="txt-newChat">æ–°å°è©±</span>
    </button>

        <div class="nx-menu-item" onclick="openTempChat()" style="margin-bottom: 20px; border: 1px dashed var(--nx-border); justify-content: center;">
            <svg class="nx-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            <span style="font-size:0.9em;">è‡¨æ™‚å°è©±</span>
        </div>
        
    <div class="nx-menu-group">
        <div class="nx-menu-title">EXPLORE</div>
        <div class="nx-menu-item" onclick="switchView('dashboard')">
            <svg class="nx-icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            <span id="txt-finance">é‡‘è</span>
        </div>
        <div class="nx-menu-item">
            <svg class="nx-icon" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
            <span id="txt-tech">ç§‘æŠ€</span>
        </div>
   
        <div class="nx-menu-item">
        <svg class="nx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3a9 9 0 0 0 2.5 2.8z"></path>
        </svg>
       <span id="txt-trending">è¶¨å‹¢</span>
       </div>
    </div>

    <div class="nx-menu-group">
        <div class="nx-menu-item" style="color:var(--nx-text-muted);">
            <svg class="nx-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <span id="txt-search">æœå°‹å°è©±</span>
        </div>
    </div>

    <div class="nx-menu-group" style="flex:1;">
        <div class="nx-menu-title" id="txt-history">æ­·å²ç´€éŒ„</div>
        <div class="nx-menu-item" style="font-size:0.85em;"> AAPL vs MSFT Analysis</div>
        <div class="nx-menu-item" style="font-size:0.85em;"> Crypto Market Cap</div>
    </div>

    <div class="nx-menu-group">
        <div class="nx-menu-item" style="color:var(--nx-accent); border:1px dashed var(--nx-border);">
            <svg class="nx-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="14" x2="23" y2="14"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="14" x2="4" y2="14"></line></svg>
            <span id="txt-createAgent">å‰µå»º AI Agent</span>
        </div>
    </div>



        <!-- åº•éƒ¨å·¥å…·åˆ— -->
        <div class="nx-sidebar-footer">
            <div class="nx-tool-row">
                <!-- åœ°çƒèªè¨€åˆ‡æ› -->
                <div style="position:relative;">
                    <button class="nx-footer-btn" onclick="toggleMenu('lang-menu')" title="Switch Language">
                        <svg class="nx-icon" style="width:20px;height:20px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    </button>
                    <!-- èªè¨€é¸å–® -->
                    <div class="nx-dropdown-menu" id="lang-menu" style="bottom: 110%; left: 0;">
                        <div class="nx-dropdown-item active" onclick="setLanguage('zh-TW')">ç¹é«”ä¸­æ–‡</div>
                        <div class="nx-dropdown-item" onclick="setLanguage('en')">English</div>
                    </div>
                </div>

                <!-- é¢¨æ ¼åˆ‡æ› -->
                <div style="position:relative;">
                    <button class="nx-footer-btn" onclick="toggleMenu('theme-menu')" title="Switch Theme">
                        <svg class="nx-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    </button>
                    <!-- é¢¨æ ¼é¸å–® -->
                    <div class="nx-dropdown-menu" id="theme-menu" style="bottom: 110%; left: -50px;">
                        <div class="nx-dropdown-item" onclick="setTheme('business')">Business å•†å‹™</div>
                        <div class="nx-dropdown-item active" onclick="setTheme('tech')">Tech ç§‘å¹»</div>
                        <div class="nx-dropdown-item" onclick="setTheme('terminal')">Terminal çµ‚ç«¯</div>
                    </div>
                </div>
            </div>
            
            <!-- ä½¿ç”¨è€…è³‡è¨Š (éœ€è¦ Firebase) -->
            <div class="nx-user-profile" id="user-profile-section">
                <img src="" class="nx-avatar" id="nx-user-avatar" style="display:none;">
                <div class="nx-username" id="nx-user-name">GUEST</div>
            </div>
        </div>
    </div>

    <!-- å³å´ä¸»å€åŸŸ -->
    <div class="nx-main">
        
        <!-- å›é¦–é æŒ‰éˆ• (Dropdown) -->
        <div class="back-to-home-container">
            <button class="back-to-home-btn" onclick="toggleMenu('home-menu')">
                åˆ‡æ› â–¼
            </button>
            <div class="nx-dropdown-menu home-dropdown" id="home-menu" style="top: 110%; right: 0; left: auto; bottom: auto;">
            <div class="nx-dropdown-item" onclick="window.location.href='app.html#workspace'">Workspace</div>
            <div class="nx-dropdown-item" onclick="window.location.href='PulseStreet.html#pulse'">PulseStreet</div>
                </div>
        </div>

        <div class="nx-chat-area" id="nx-chat-history" style="display:none; flex-direction:column;"></div>
        
    
    <div id="view-home" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; opacity: 0; animation: fadeIn 0.5s forwards;">
        <svg viewBox="0 0 24 24" style="width: 120px; height: 120px; stroke: var(--nx-accent); fill: none; stroke-width: 0.5; margin-bottom: 20px;">
            <path d="M4 4l16 16" stroke-linecap="round"/>
            <path d="M20 4l-16 16" stroke-linecap="round"/>
            <circle cx="4" cy="4" r="2.5" fill="currentColor" stroke="none"/>
            <circle cx="20" cy="20" r="2.5" fill="currentColor" stroke="none"/>
            <circle cx="20" cy="4" r="2.5" fill="currentColor" stroke="none"/>
            <circle cx="4" cy="20" r="2.5" fill="currentColor" stroke="none"/>
            <circle cx="12" cy="12" r="1.5" fill="var(--nx-accent)" stroke="none"/>
        </svg>
        <h1 style="font-family: 'Orbitron', sans-serif; font-size: 3rem; letter-spacing: 4px; color: var(--nx-text);">NodeX</h1>
        <p style="color: var(--nx-text-muted); margin-top: 10px; font-size: 0.9em; letter-spacing: 1px;">Finance,Tech and best LLM.</p>
    </div>

        <div id="view-new-chat" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; position: absolute; top: -50px; z-index: 0;">
            <h2 style="font-size: 2rem; font-weight: 500; color: var(--nx-text); letter-spacing: 1px; margin-bottom: 20px;">
                æˆ‘å€‘è©²å¾å“ªè£¡é–‹å§‹ï¼Ÿ
            </h2>
        </div>

    <div id="view-dashboard" style="display: none; width: 100%; flex-direction: column; align-items: center;">
        <div class="nx-welcome">
            <h1 id="txt-welcome">æ—©å®‰ï¼Œ<br><span>é–‹å§‹æ‚¨è£½ä½œä¸€ä»½åˆ†æå ±å‘Šï¼Ÿ</span></h1>
            <div class="nx-suggestion-grid">
                <div class="nx-suggestion-card"><span id="txt-sug1">åˆ†æ NVDA è²¡å ±é‡é»</span> <span class="nx-sug-arrow">â†—</span></div>
                <div class="nx-suggestion-card"><span id="txt-sug2">æ¯”ç‰¹å¹£ä¸‹é€±èµ°å‹¢é æ¸¬</span> <span class="nx-sug-arrow">â†—</span></div>
                <div class="nx-suggestion-card"><span id="txt-sug3">åˆ¶å®šå°è‚¡ç•¶æ²–ç­–ç•¥</span> <span class="nx-sug-arrow">â†—</span></div>
                <div class="nx-suggestion-card"><span id="txt-sug4">ç¸½é«”ç¶“æ¿Ÿæ•¸æ“šè§£è®€</span> <span class="nx-sug-arrow">â†—</span></div>
            </div>
        </div>
    </div>

        <!-- å…¨æ–°è¨­è¨ˆçš„è¼¸å…¥æ¡†å€å¡Š -->
        <div class="nx-input-container">
            <div class="nx-input-wrapper">
                <!-- ç¬¬ä¸€å±¤ï¼šè¼¸å…¥å€ -->
                <textarea class="nx-textarea" id="nx-input" rows="1" placeholder="è©¢å•ä»»ä½•å•é¡Œã€‚è¼¸å…¥ @ ä»¥æåŠã€‚"></textarea>
                
                <!-- ç¬¬äºŒå±¤ï¼šå·¥å…·åˆ— -->
                <div class="nx-input-footer">
                    <!-- å·¦å´åŠŸèƒ½ï¼šæœå°‹ + æ¨¡å‹ -->
                    <div class="nx-input-left">
                        <button class="nx-tool-btn nx-pill-btn" title="ç¶²é æœå°‹ (Web Search)">
                            <svg class="nx-icon" style="width:16px;height:16px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                            <span style="font-size:0.8em; font-weight:600;">æœå°‹</span>
                        </button>
                        <button class="nx-tool-btn nx-pill-btn" title="åˆ‡æ›æ¨¡å‹ (Switch Model)">
                            <svg class="nx-icon" style="width:16px;height:16px;" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="14" x2="23" y2="14"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="14" x2="4" y2="14"></line></svg>
                            <span style="font-size:0.8em; font-weight:600;">æ·±åº¦æ€è€ƒ (R1)</span>
                        </button>
                    </div>

                    <!-- å³å´åŠŸèƒ½ï¼šé™„ä»¶ + èªéŸ³ + ç™¼é€ -->
                    <div class="nx-input-right">
                        <button class="nx-tool-btn" title="Attach File">
                            <svg class="nx-icon" viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                        </button>
                        <button class="nx-tool-btn" title="Voice Input">
                            <svg class="nx-icon" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                        </button>
                       <button class="nx-send-btn" id="nx-send-btn" title="Send Message">
                        <svg class="nx-icon" style="width:18px;height:18px;stroke:white;" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                    </div>
                </div>
            </div>
            <div style="text-align:center; font-size:0.7em; color:var(--nx-text-muted); margin-top:10px;">
                NodeX AI can make mistakes. Please verify important financial information.
            </div>
        </div>
    </div>

    <!-- Firebase SDK (ç”¨æ–¼åŒæ­¥ç™»å…¥ç‹€æ…‹) -->
   <script type="module">
       
        // --- [æ–°å¢] å´é‚Šæ¬„æ”¶åˆåˆ‡æ› ---
        window.toggleSidebar = function() {
            const sidebar = document.querySelector('.nx-sidebar');
            sidebar.classList.toggle('collapsed');
            
            // å¯é¸ï¼šç´€éŒ„ä½¿ç”¨è€…çš„åå¥½ï¼Œä¸‹æ¬¡é€²ä¾†ä¿æŒæ”¶åˆ
            // localStorage.setItem('sidebar_collapsed', sidebar.classList.contains('collapsed'));
        };
       // --- [æ–°å¢] å•Ÿå‹•æ–°å°è©±æ¨¡å¼ ---
        window.startNewChat = function() {
            // 1. æ¸…ç©ºèŠå¤©ç•«é¢
            const chatHistory = document.getElementById('nx-chat-history');
            if(chatHistory) chatHistory.innerHTML = ''; 
            
            // 2. åˆ‡æ› UI ç‹€æ…‹
            document.getElementById('view-home').style.display = 'none';      // éš±è— Logo é¦–é 
            document.getElementById('view-dashboard').style.display = 'none'; // éš±è—å„€è¡¨æ¿
            document.getElementById('view-new-chat').style.display = 'flex';  // é¡¯ç¤ºã€Œæˆ‘å€‘è©²å¾å“ªè£¡é–‹å§‹ï¼Ÿã€
            
            // 3. å•Ÿå‹• CSS ç½®ä¸­æ¨¡å¼
            document.querySelector('.nx-main').classList.add('centered-mode');
            
            // 4. é‡ç½®è¼¸å…¥æ¡†
            const input = document.getElementById('nx-input');
            input.value = '';
            input.focus();
            input.style.height = 'auto';
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // --- [è£œå¼·] å°‡ UI æ§åˆ¶å‡½å¼æ›è¼‰åˆ° window ä»¥ä¾¿ HTML å‘¼å« ---
        window.switchView = function(viewName) {
            document.getElementById('view-home').style.display = viewName === 'home' ? 'flex' : 'none';
            document.getElementById('view-dashboard').style.display = viewName === 'dashboard' ? 'flex' : 'none';
            // æ›´æ–°é¸å–®æ¿€æ´»ç‹€æ…‹ (ç°¡æ˜“ç‰ˆ)
            document.querySelectorAll('.nx-menu-item').forEach(el => el.classList.remove('active'));
            if(viewName === 'home') document.getElementById('menu-home').classList.add('active');
        };

        window.toggleMenu = function(menuId) {
            const menu = document.getElementById(menuId);
            const isShown = menu.style.display === 'flex';
            // é—œé–‰å…¶ä»–æ‰€æœ‰é¸å–®
            document.querySelectorAll('.nx-dropdown-menu').forEach(m => m.style.display = 'none');
            // åˆ‡æ›ç•¶å‰é¸å–®
            menu.style.display = isShown ? 'none' : 'flex';
        };

        window.setTheme = function(theme) {
            document.body.setAttribute('data-theme', theme);
            window.toggleMenu('theme-menu'); // é—œé–‰é¸å–®
        };
        
        // é»æ“Šé é¢å…¶ä»–åœ°æ–¹é—œé–‰ Dropdown
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nx-footer-btn') && !e.target.closest('.back-to-home-container')) {
                document.querySelectorAll('.nx-dropdown-menu').forEach(m => m.style.display = 'none');
            }
        });
        // 1. Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAIwisA_UnOiNRVwYE6tJV47Sp3_1i19IM",
            authDomain: "brooklyn-terminal.firebaseapp.com",
            projectId: "brooklyn-terminal",
            storageBucket: "brooklyn-terminal.firebasestorage.app",
            messagingSenderId: "438411734316",
            appId: "1:438411734316:web:649051890cf381eb0fd089",
            measurementId: "G-G0GMW0XHG1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // UI å…ƒç´ 
        const nameEl = document.getElementById('nx-user-name');
        const avatarEl = document.getElementById('nx-user-avatar');
        const userProfileSection = document.getElementById('user-profile-section');

        // 2. ç™»å…¥ç‹€æ…‹ç›£è½
        onAuthStateChanged(auth, (user) => {
            window.currentUser = user; // å­˜åˆ°å…¨åŸŸè®Šæ•¸ä¾› LLM ä½¿ç”¨
            if (user) {
                nameEl.innerText = user.displayName;
                if(user.photoURL) {
                    avatarEl.src = user.photoURL;
                    avatarEl.style.display = 'block';
                }
            } else {
                nameEl.innerText = "GUEST (é»æ“Šç™»å…¥)";
                avatarEl.style.display = 'none';
            }
        });

        // 3. é»æ“Šé ­åƒç™»å…¥/ç™»å‡º
        userProfileSection.addEventListener('click', () => {
            if (window.currentUser) {
                if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) signOut(auth);
            } else {
                signInWithPopup(auth, provider).catch((error) => alert("Login Error: " + error.message));
            }
        });
        
        // --- LLM æ ¸å¿ƒé‚è¼¯é–‹å§‹ ---
        
        const WORKER_URL = "https://nodex-proxy.coreinformation30.workers.dev"; 
        const DAILY_LIMIT = 20;

        const chatHistory = document.getElementById('nx-chat-history');
        const chatInput = document.getElementById('nx-input');
        const sendBtn = document.getElementById('nx-send-btn');
        const homeView = document.getElementById('view-home');
        const dashboardView = document.getElementById('view-dashboard');

        // --- [ä¿®æ”¹] æ¯æ—¥ç”¨é‡æª¢æŸ¥ (ç¶å®š Google User ID) ---
        
        // å–å¾—è©²å¸³è™Ÿä»Šæ—¥å·²ç”¨æ¬¡æ•¸
        function getDailyUsage(uid) {
            const today = new Date().toDateString();
            // é—œéµï¼šå„²å­˜çš„ Key åŠ ä¸Šäº† uidï¼Œç¢ºä¿æ¯å€‹å¸³è™Ÿåˆ†é–‹è¨ˆç®—
            const key = `nodex_usage_${uid}`; 
            
            const record = JSON.parse(localStorage.getItem(key) || '{}');
            
            // å¦‚æœæ—¥æœŸä¸æ˜¯ä»Šå¤©ï¼Œé‡ç½®ç‚º 0
            if (record.date !== today) {
                return { count: 0, date: today };
            }
            return record;
        }

        // å¢åŠ è©²å¸³è™Ÿçš„ä½¿ç”¨æ¬¡æ•¸
        function incrementUsage(uid) {
            const usage = getDailyUsage(uid);
            usage.count += 1;
            const key = `nodex_usage_${uid}`;
            localStorage.setItem(key, JSON.stringify(usage));
        }
        // ç™¼é€è¨Šæ¯ä¸»å‡½å¼
        // ç™¼é€è¨Šæ¯ä¸»å‡½å¼
        async function handleSendMessage() {
            // 1. [å¼·åˆ¶ç™»å…¥æª¢æŸ¥]
            if (!window.currentUser) {
                appendSystemMessage("ğŸ”’ å­˜å–è¢«æ‹’ï¼šè«‹å…ˆé»æ“Šå·¦ä¸‹è§’é ­åƒç™»å…¥ Google å¸³è™Ÿã€‚");
                // å¼·åˆ¶ä¸­æ–·ï¼Œä¸è®“æœªç™»å…¥è€…ç¹¼çºŒ
                return; 
            }
            
            // 2. [å–å¾— Google User ID]
            const uid = window.currentUser.uid;

            // 3. [æª¢æŸ¥è©²å¸³è™Ÿé¡åº¦]
            const usage = getDailyUsage(uid);
            
            if (usage.count >= DAILY_LIMIT) {
                appendSystemMessage(`âš ï¸ æ‚¨çš„ Google å¸³è™Ÿä»Šæ—¥é¡åº¦å·²é”ä¸Šé™ (${usage.count}/${DAILY_LIMIT})ã€‚è«‹æ˜å¤©å†ä¾†ï¼`);
                return;
            }

            const userText = chatInput.value.trim();
            if (!userText) return;

            // --- UI ç‹€æ…‹åˆ‡æ› (ä¿æŒä½ åŸæœ¬çš„è¨­å®š) ---
            document.querySelector('.nx-main').classList.remove('centered-mode');
            document.getElementById('view-new-chat').style.display = 'none';
            document.getElementById('view-home').style.display = 'none';
            document.getElementById('view-dashboard').style.display = 'none';
            
            const chatHistory = document.getElementById('nx-chat-history');
            if(chatHistory) {
                chatHistory.style.display = 'flex';
                chatHistory.style.flexDirection = 'column';
            }

            // é‡ç½®è¼¸å…¥æ¡†
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // é¡¯ç¤ºè¨Šæ¯ä¸¦æ‰£é™¤é¡åº¦
            appendUserMessage(userText);
            
            // [é—œéµ] æ‰£é™¤è©²ä½¿ç”¨è€…çš„é¡åº¦
            incrementUsage(uid);
            const loadingId = appendLoadingIndicator();

            try {
                const response = await fetch(WORKER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userText }] }] 
                    })
                });

                if (!response.ok) throw new Error("Worker Error: " + response.statusText);

                removeMessage(loadingId);
                const aiMsgContent = appendAiMessageStart();
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const matches = chunk.match(/"text":\s*"((?:[^"\\]|\\.)*)"/g);
                    
                    if (matches) {
                        matches.forEach(match => {
                            let textPart = match.replace(/"text":\s*"/, "").replace(/"$/, "");
                            try {
                                textPart = JSON.parse(`"${textPart}"`); 
                                fullText += textPart;
                                
                                // Markdown æ¸²æŸ“
                                aiMsgContent.innerHTML = marked.parse(fullText);
                                
                                chatHistory.scrollTop = chatHistory.scrollHeight;
                            } catch (e) { console.error("Parse error", e); }
                        });
                    }
                }

            } catch (error) {
                removeMessage(loadingId);
                appendSystemMessage(`âŒ ç³»çµ±éŒ¯èª¤: ${error.message}`);
            }
        }

        // --- UI è¼”åŠ©å‡½å¼ (é©é… NodeX é¢¨æ ¼) ---
        
       function appendUserMessage(text) {
            const div = document.createElement('div');
            // å¯¬åº¦é–å®šèˆ‡ç½®ä¸­è¨­å®š
            div.style.width = '100%';
            div.style.maxWidth = '800px'; 
            div.style.marginBottom = '20px';
            
            div.style.display = 'flex';
            div.style.flexDirection = 'column';
            div.style.alignItems = 'flex-end'; 

            // 1. å–å¾—ä½¿ç”¨è€…åç¨± (å¦‚æœæ²’ç™»å…¥é¡¯ç¤º GUEST)
            const userName = window.currentUser ? window.currentUser.displayName : 'GUEST';

            div.innerHTML = `
                <div style="font-size:0.8em; color:var(--nx-text-muted); margin-bottom:5px; text-transform: uppercase;">
                    ${userName}
                </div>
                
                <div style="background:var(--nx-card-bg); padding:12px 16px; border-radius:12px; border:1px solid var(--nx-border); color:var(--nx-text); text-align: left;">
                    ${text.replace(/\n/g, '<br>')}
                </div>
            `;
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function appendAiMessageStart() {
            const div = document.createElement('div');
            // [ç¶­æŒè¨­å®š] è®“å®¹å™¨å¯¬åº¦èˆ‡è¼¸å…¥æ¡†ä¸€è‡´ï¼Œä¸¦ç½®ä¸­
            div.style.width = '100%';
            div.style.maxWidth = '800px'; 
            div.style.marginBottom = '30px';
            
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <div style="width:28px; height:28px; background:rgba(0, 255, 204, 0.1); border-radius:6px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(0, 255, 204, 0.2);">
                        <svg style="width:18px; height:18px; stroke:var(--nx-accent); fill:none; stroke-width:3; stroke-linecap:round; stroke-linejoin:round;" viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </div>
                    
                    <span style="font-size:0.95em; font-weight:bold; color:var(--nx-accent); letter-spacing:0.5px;">NodeX AI</span>
                </div>
                
                <div class="ai-content markdown-body" style="padding-left:0;"></div> 
            `;
            chatHistory.appendChild(div);
            return div.querySelector('.ai-content');
        }

        function appendSystemMessage(text) {
            const div = document.createElement('div');
            div.style.width = '100%';
            div.style.textAlign = 'center';
            div.style.margin = '20px 0';
            div.innerHTML = `<span style="background:rgba(255,0,0,0.1); color:#ff6b6b; padding:5px 10px; border-radius:4px; font-size:0.8em; border:1px solid rgba(255,0,0,0.2);">${text}</span>`;
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

       function appendLoadingIndicator() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            
            // [ä¿®æ”¹] åŒæ¨£é–å®šå¯¬åº¦
            div.style.width = '100%';
            div.style.maxWidth = '800px';
            div.style.marginBottom = '20px';
            
            div.innerHTML = `<span style="color:var(--nx-text-muted); font-size:0.8em; animation: pulse 1s infinite; display:flex; align-items:center; gap:8px;">
                <svg class="nx-icon" style="width:14px;height:14px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Thinking...
            </span>`;
            chatHistory.appendChild(div);
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // ç¶å®šäº‹ä»¶
        sendBtn.addEventListener('click', handleSendMessage);
        // [å„ªåŒ–] ä¸»å°è©±æ¡† Enter ç™¼é€ (æ”¯æ´ Shift+Enter æ›è¡Œï¼Œä¸¦é˜²æ­¢è¼¸å…¥æ³•èª¤å‚³)
        chatInput.addEventListener('keydown', (e) => {
            // æª¢æŸ¥ï¼šæŒ‰ä¸‹ Enter + æ²’æœ‰æŒ‰ Shift + ä¸æ˜¯æ­£åœ¨é¸å­— (isComposing)
           chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
                e.preventDefault(); 
                handleSendMessage();
            }
        });
// ==========================================
        // [æ–°å¢] ä¸­å¤®è‡¨æ™‚å°è©±åŠŸèƒ½é‚è¼¯ (ä¿®å¾©ç‰ˆ)
        // ==========================================

        const tempModal = document.getElementById('temp-chat-modal');
        const tempInput = document.getElementById('temp-chat-input');
        const tempHistory = document.getElementById('temp-chat-history');
        const tempSendBtn = document.getElementById('temp-send-btn');

        // 1. é–‹å•Ÿè¦–çª— (æ›è¼‰åˆ° window ä¾› HTML ä½¿ç”¨)
        window.openTempChat = function() {
            tempModal.style.display = 'flex';
            // å°å»¶é²è®“å‹•ç•«é †æš¢
            setTimeout(() => {
                tempModal.classList.add('show');
                tempInput.focus(); // è‡ªå‹•èšç„¦è¼¸å…¥æ¡†
            }, 10);
        }

        // 2. é—œé–‰è¦–çª—
        window.closeTempChat = function() {
            tempModal.classList.remove('show');
            setTimeout(() => {
                tempModal.style.display = 'none';
            }, 300); // ç­‰å¾…å‹•ç•«çµæŸ
        }

        // é»æ“Šé®ç½©é—œé–‰
        tempModal.addEventListener('click', (e) => {
            if (e.target === tempModal) window.closeTempChat();
        });

        // æŒ‰ ESC é—œé–‰
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && tempModal.style.display === 'flex') {
                window.closeTempChat();
            }
        });

        // 3. ç™¼é€è¨Šæ¯é‚è¼¯
        async function handleTempSend() {
            const text = tempInput.value.trim();
            if (!text) return;

            // æ¸…ç©ºè¼¸å…¥æ¡†
            tempInput.value = '';

            // (A) é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            const userDiv = document.createElement('div');
            userDiv.style.alignSelf = 'flex-end';
            userDiv.style.background = 'var(--nx-accent)';
            userDiv.style.color = '#000'; // æ·±è‰²æ–‡å­—æ¯”è¼ƒæ¸…æ¥š
            userDiv.style.padding = '10px 16px';
            userDiv.style.borderRadius = '12px 12px 0 12px';
            userDiv.style.marginBottom = '15px';
            userDiv.style.maxWidth = '85%';
            userDiv.style.wordBreak = 'break-word';
            userDiv.innerText = text;
            tempHistory.appendChild(userDiv);
            tempHistory.scrollTop = tempHistory.scrollHeight;

            // (B) å»ºç«‹ AI å›è¦†çš„ä½”ä½å®¹å™¨
            const aiDiv = document.createElement('div');
            aiDiv.className = 'markdown-body'; // å¥—ç”¨ Markdown æ¨£å¼
            aiDiv.style.alignSelf = 'flex-start';
            aiDiv.style.background = 'var(--nx-card-bg)';
            aiDiv.style.border = '1px solid var(--nx-border)';
            aiDiv.style.padding = '12px 16px';
            aiDiv.style.borderRadius = '12px 12px 12px 0';
            aiDiv.style.marginBottom = '20px';
            aiDiv.style.maxWidth = '90%';
            aiDiv.innerHTML = '<span style="color:var(--nx-text-muted);">Thinking...</span>';
            tempHistory.appendChild(aiDiv);
            tempHistory.scrollTop = tempHistory.scrollHeight;

            try {
                // (C) å‘¼å« LLM API (ä½¿ç”¨èˆ‡ä¸»å°è©±ç›¸åŒçš„ Worker)
                const response = await fetch(WORKER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // æ³¨æ„: é€™è£¡ä¸æª¢æŸ¥ç™»å…¥ç‹€æ…‹ï¼Œæ–¹ä¾¿å¿«é€Ÿä½¿ç”¨
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: text }] }] 
                    })
                });

                if (!response.ok) throw new Error("API Error");

                // (D) è™•ç†ä¸²æµå›æ‡‰
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    // è§£æ SSE æ ¼å¼ (å‡è¨­ä½ çš„ Worker å›å‚³æ ¼å¼èˆ‡ä¸»å°è©±ç›¸åŒ)
                    const matches = chunk.match(/"text":\s*"((?:[^"\\]|\\.)*)"/g);

                    if (matches) {
                        matches.forEach(match => {
                            let textPart = match.replace(/"text":\s*"/, "").replace(/"$/, "");
                            try {
                                // è§£ç¢¼ JSON å­—ä¸²
                                textPart = JSON.parse(`"${textPart}"`);
                                fullText += textPart;
                                // å³æ™‚æ¸²æŸ“ Markdown
                                aiDiv.innerHTML = marked.parse(fullText);
                                tempHistory.scrollTop = tempHistory.scrollHeight;
                            } catch (e) {
                                // å¿½ç•¥è§£æéŒ¯èª¤
                            }
                        });
                    }
                }

            } catch (error) {
                aiDiv.innerHTML = `<span style="color:#ff6b6b;">Error: ${error.message}</span>`;
            }
        }

        // ç¶å®šç™¼é€äº‹ä»¶
        if(tempSendBtn) {
            tempSendBtn.addEventListener('click', handleTempSend);
        }

        // ç¶å®š Enter éµ
        tempInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.nativeEvent.isComposing) {
                handleTempSend();
            }
        });
    </script>
   <div id="temp-chat-modal" class="nx-modal-overlay">
    <div class="nx-modal-content">
        <div class="nx-modal-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <svg class="nx-icon" style="color:var(--nx-accent);" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <span style="font-weight:bold; letter-spacing:1px; font-size:0.9em;">TEMPORARY CHAT</span>
            </div>
            <button class="nx-tool-btn" onclick="closeTempChat()" title="Close (Esc)">âœ•</button>
        </div>
        
        <div id="temp-chat-history" class="nx-chat-area">
            <div style="text-align:center; color:var(--nx-text-muted); margin-top:60px; opacity:0.7;">
                <div style="font-size: 2em; margin-bottom: 10px;">âœ¨</div>
                <p>æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«ä½ çš„å—ï¼Ÿ</p>
                <p style="font-size:0.8em; margin-top:5px;">æ­¤è¦–çª—é—œé–‰å¾Œï¼Œå…§å®¹å¯èƒ½æœƒè¢«æ¸…é™¤ã€‚</p>
            </div>
        </div>

        <div class="nx-modal-input-area">
            <div class="nx-modal-input-wrapper">
                <input type="text" id="temp-chat-input" class="nx-textarea" 
                       style="height:40px; font-size:1rem; border:none; background:transparent; width:100%; outline:none; color:var(--nx-text);" 
                       placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
                
                <button class="nx-send-btn" id="temp-send-btn" style="width:36px; height:36px; flex-shrink:0;">
                    <svg class="nx-icon" style="stroke:black;" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
