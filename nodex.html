<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>NodeX</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300ffcc' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 5l14 14'/%3E%3Cpath d='M19 5l-14 14'/%3E%3Ccircle cx='12' cy='12' r='2' fill='%2300ffcc' stroke='none'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;700&family=Courier+New&display=swap" rel="stylesheet">
    
    <style>
                        /* 進度條樣式 */
                .usage-item {
                    font-size: 0.9em;
                }
                .usage-header {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 5px;
                    color: var(--nx-text-muted);
                }
                .progress-track {
                    width: 100%;
                    height: 6px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 10px;
                    overflow: hidden;
                }
                .progress-fill {
                    height: 100%;
                    background: var(--nx-accent);
                    width: 0%;
                    transition: width 0.5s ease;
                    border-radius: 10px;
                }
                /* 針對快用完的額度變色 */
                .progress-fill.warning { background: #ffcc00; }
                .progress-fill.danger { background: #ff6b6b; }

                    /* --- 歷史紀錄滾動條美化 --- */
            #history-container::-webkit-scrollbar {
                width: 4px; /* 極細滾動條 */
            }
            #history-container::-webkit-scrollbar-track {
                background: transparent; 
            }
            #history-container::-webkit-scrollbar-thumb {
                background: var(--nx-border); /* 預設為邊框色 */
                border-radius: 4px;
            }
            #history-container::-webkit-scrollbar-thumb:hover {
                background: var(--nx-accent); /* 滑鼠移過去變亮色 */
            }
                   
           /* --- Thinking 跳動圓點動畫  --- */
            .nx-typing-bubble {
                display: inline-flex;
                align-items: center;
                gap: 8px;          /* 稍微增加圓點之間的距離，讓它們散開一點 */
                width: fit-content;
                height: auto;      /* 高度自動，不再固定 */
                
                background: transparent; /* 背景透明 */
                border: none;            /* 移除邊框 */
                padding: 0;              /* 移除內距 */
                border-radius: 0;        /* 移除圓角 */
                box-shadow: none;        /* 確保沒有陰影 */
            
                /* --- 微調位置 --- */
                margin-top: 5px;   /* 與上方 "NodeX AI" 文字保持一點距離 */
                margin-left: 2px;  /* 稍微對齊上方的文字起始處 */
                opacity: 0.8;      /* 稍微降低一點透明度，看起來更柔和 */
            }
                        
            .nx-typing-dot {
                width: 8px;
                height: 8px;
                background-color: var(--nx-text-muted); /* 圓點顏色 */
                border-radius: 50%;
                animation: nx-bounce 1.4s infinite ease-in-out both;
            }
            
            /* 讓三個圓點依序跳動 (透過延遲時間) */
            .nx-typing-dot:nth-child(1) { animation-delay: -0.32s; }
            .nx-typing-dot:nth-child(2) { animation-delay: -0.16s; }
            .nx-typing-dot:nth-child(3) { animation-delay: 0s; }
            
            /* 定義跳動的關鍵影格 */
            @keyframes nx-bounce {
                0%, 80%, 100% { 
                    transform: scale(0.6); 
                    opacity: 0.6;
                }
                40% { 
                    transform: scale(1); 
                    opacity: 1;
                    background-color: var(--nx-accent); /* 跳起來時變亮色 */
                }
            }
                    /*  模態框 CSS */
            .nx-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
                z-index: 9999; display: none; align-items: center; justify-content: center;
                animation: fadeIn 0.2s;
            }
            .nx-modal-content {
                background: var(--nx-sidebar); border: 1px solid var(--nx-border);
                width: 90%; max-width: 500px; height: 60vh;
                border-radius: 12px; display: flex; flex-direction: column;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            }
            .nx-modal-header {
                padding: 15px; border-bottom: 1px solid var(--nx-border);
                display: flex; justify-content: space-between; align-items: center;
                background: var(--nx-card-bg); border-radius: 12px 12px 0 0;
            }
        /* --- CSS 變數系統 --- */
        :root {
            /* 預設為 Tech 風格 */
            --nx-bg: #050505;
            --nx-sidebar: #0a0a0a;
            --nx-text: #e0e0e0;
            --nx-text-muted: #888;
            --nx-accent: #00ffcc;
            --nx-border: #333;
            --nx-card-bg: rgba(255,255,255,0.05);
            --nx-input-bg: #141414;
            --nx-radius: 12px;
            --nx-font: 'Inter', sans-serif;
            --nx-glow: 0 0 15px rgba(0, 255, 204, 0.1);
            --nx-hover-bg: rgba(255,255,255,0.1);
            --nx-btn-active-bg: rgba(0, 255, 204, 0.15);
        }

        /* 商務風格 (Business) */
        [data-theme="business"] {
            --nx-bg: #f8f9fa;
            --nx-sidebar: #ffffff;
            --nx-text: #2d3748;
            --nx-text-muted: #718096;
            --nx-accent: #2b6cb0; /* 專業藍 */
            --nx-border: #e2e8f0;
            --nx-card-bg: #ffffff;
            --nx-input-bg: #ffffff;
            --nx-radius: 8px;
            --nx-glow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --nx-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --nx-hover-bg: #f7fafc;
            --nx-btn-active-bg: #ebf8ff;
        }

        /* 終端機風格 (Terminal) */
        [data-theme="terminal"] {
            --nx-bg: #000000;
            --nx-sidebar: #000000;
            --nx-text: #33ff00; /* 經典綠 */
            --nx-text-muted: #008800;
            --nx-accent: #33ff00;
            --nx-border: #004400;
            --nx-card-bg: #000000;
            --nx-input-bg: #000000;
            --nx-radius: 0px;
            --nx-font: 'Courier New', monospace;
            --nx-glow: none;
            --nx-hover-bg: #002200;
            --nx-btn-active-bg: #003300;
        }

        /* 基礎重置 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: var(--nx-bg); 
            color: var(--nx-text); 
            font-family: var(--nx-font); 
            height: 100vh; 
            display: flex; 
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* 終端機掃描線特效 */
        [data-theme="terminal"] body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        /* --- 側邊欄 --- */
        .nx-sidebar {
            width: 260px;
            background: var(--nx-sidebar);
            border-right: 1px solid var(--nx-border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
            transition: all 0.3s;
        }

        /* Logo (NodeX) */
        .nx-brand {
            display: flex; align-items: center; gap: 10px; margin-bottom: 30px;
            color: var(--nx-text); font-weight: 900; font-size: 1.4rem; letter-spacing: 1px;
            cursor: pointer; font-family: 'Orbitron', sans-serif;
        }
        .nx-logo-svg { width: 36px; height: 36px; fill: none; stroke: var(--nx-accent); stroke-width: 2; }

        /* 新對話按鈕 */
        .nx-btn-new {
            background: var(--nx-card-bg);
            border: 1px solid var(--nx-border);
            color: var(--nx-text);
            padding: 10px;
            border-radius: var(--nx-radius);
            cursor: pointer;
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 20px;
            transition: all 0.2s;
            box-shadow: var(--nx-glow);
            font-weight: 600;
        }
        .nx-btn-new:hover { 
            border-color: var(--nx-accent); 
            color: var(--nx-accent); 
            transform: translateY(-1px);
        }

        /* 選單群組 */
        .nx-menu-group { margin-bottom: 20px; }
        .nx-menu-title { 
            font-size: 0.75em; 
            color: var(--nx-text-muted); 
            margin-bottom: 10px; 
            padding-left: 10px; 
            font-weight: bold; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .nx-menu-item {
            padding: 8px 12px; 
            cursor: pointer; 
            border-radius: var(--nx-radius); 
            color: var(--nx-text);
            display: flex; align-items: center; gap: 10px; 
            font-size: 0.95em; 
            opacity: 0.8; 
            transition: all 0.2s;
            text-decoration: none; 
        }
        .nx-menu-item:hover, .nx-menu-item.active { 
            background: var(--nx-hover-bg);
            opacity: 1; 
            color: var(--nx-accent); 
        }
        .nx-icon { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; }

        /* 側邊欄底部 */
        .nx-sidebar-footer { 
            margin-top: auto;
            border-top: 1px solid var(--nx-border); 
            padding-top: 15px;
            /* 關鍵屬性 */
            position: relative;
            z-index: 1000; /* 確保層級最高 */
            background: var(--nx-sidebar); /* 防止背景透明看到後面的東西 */
        }
        .nx-tool-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }

        /* 底部按鈕樣式 (語言/風格) */
        .nx-footer-btn {
            background: transparent; 
            border: 1px solid var(--nx-border); 
            color: var(--nx-text-muted);
            width: 32px; height: 32px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; 
            transition: all 0.3s;
            position: relative; /* 為了定位選單 */
        }
        .nx-footer-btn:hover, .nx-footer-btn.active { color: var(--nx-accent); border-color: var(--nx-accent); }

        /* 通用彈出選單 (Dropdown) */
        .nx-dropdown-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--nx-sidebar);
            border: 1px solid var(--nx-border);
            border-radius: var(--nx-radius);
            padding: 5px;
            display: none;
            flex-direction: column;
            min-width: 140px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            z-index: 100;
            margin-bottom: 10px;
        }
        .nx-dropdown-menu.show { display: flex; animation: fadeIn 0.2s; }
        
        .nx-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85em;
            color: var(--nx-text);
            border-radius: 4px;
            transition: background 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .nx-dropdown-item:hover { background: var(--nx-hover-bg); color: var(--nx-accent); }
        .nx-dropdown-item.active { color: var(--nx-accent); font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }


        /* 使用者頭像 */
        .nx-user-profile {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            padding: 8px; border-radius: var(--nx-radius);
        }
        .nx-user-profile:hover { background: var(--nx-hover-bg); }
        .nx-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #333; }
        .nx-username { font-size: 0.9em; font-weight: bold; }

        /* --- 主內容區 --- */
        .nx-main {
            flex: 1; 
            position: relative; 
            display: flex; 
            flex-direction: column;
            background: var(--nx-bg);
        }

        /* 聊天顯示區 */
        .nx-chat-area { 
            flex: 1;
            overflow-y: auto; 
            padding: 40px; 
            /* [新增] 底部留白，避免最後一則訊息被懸浮輸入框擋住 */
            padding-bottom: 140px; 
            
            display: flex; 
            flex-direction: column; 
            align-items: center;
        }
        
        /* 歡迎畫面 */
        .nx-welcome { text-align: center; margin-top: 10vh; max-width: 700px; width: 100%; }
        .nx-welcome h1 { 
            font-size: 2.5rem; 
            margin-bottom: 30px; 
            font-weight: 300; 
            line-height: 1.2;
        }
               .nx-welcome span { 
            color: var(--nx-accent); 
            font-weight: 700; 
        }
        
        /* Business / Tech 主題時才加漸層文字 */
        [data-theme="business"] .nx-welcome span,
        [data-theme="tech"] .nx-welcome span {
            background: linear-gradient(90deg, var(--nx-text), var(--nx-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* 建議卡片網格 */
        .nx-suggestion-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            width: 100%; 
            margin-top: 40px;
        }
        .nx-suggestion-card {
            background: var(--nx-card-bg); 
            border: 1px solid var(--nx-border); 
            padding: 15px 20px;
            border-radius: var(--nx-radius); 
            cursor: pointer; 
            text-align: left; 
            font-size: 0.95em;
            transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nx-suggestion-card:hover { 
            border-color: var(--nx-accent); 
            transform: translateY(-2px); 
            box-shadow: var(--nx-glow);
        }
        .nx-sug-arrow { opacity: 0.5; font-size: 0.8em; }

       /* --- 新版輸入框樣式 (固定底部懸浮版) --- */
        .nx-input-container {
            width: 100%;
            max-width: 800px;
            /* 改用絕對定位，強制固定在父容器 (.nx-main) 的底部 */
            position: absolute; 
            bottom: 30px;       /* 距離底部留一些空間 */
            left: 50%;          /* 設定左側位置在 50% */
            transform: translateX(-50%); /* 向左回推自身寬度的一半，達成完美置中 */
            
            padding: 0 20px;
            z-index: 50;        /* 層級調高，確保浮在文字上方 */
            margin: 0;          /* 移除原本的 margin 設定 */
        }
        
        .nx-input-wrapper {
            background: var(--nx-input-bg); 
            border: 1px solid var(--nx-border); 
            border-radius: 16px; /* 稍微方一點的圓角 */
            padding: 12px 16px; 
            display: flex; 
            flex-direction: column; /* 上下排列 */
            gap: 8px;
            box-shadow: var(--nx-glow);
            transition: border-color 0.3s;
        }
        
        /* 終端機輸入框樣式調整 */
        [data-theme="terminal"] .nx-input-wrapper { border-radius: 0; border: 2px solid var(--nx-border); box-shadow: none; }
        .nx-input-wrapper:focus-within { border-color: var(--nx-accent); }
        
        /* 上層：輸入區 */
        .nx-textarea {
            width: 100%; 
            background: transparent; 
            border: none; 
            color: var(--nx-text);
            font-size: 1rem; 
            resize: none; 
            max-height: 200px; 
            min-height: 24px;
            outline: none; 
            font-family: inherit; 
            line-height: 1.5;
            padding: 0;
        }

        /* 下層：工具列 */
        .nx-input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }

        .nx-input-left, .nx-input-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 底部工具按鈕通用樣式 */
        .nx-tool-btn {
            background: transparent;
            border: none;
            color: var(--nx-text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .nx-tool-btn:hover {
            color: var(--nx-accent);
            background: var(--nx-hover-bg);
        }
        
        /* 膠囊狀按鈕 (左側功能) */
        .nx-pill-btn {
            border: 1px solid transparent;
            background: rgba(255,255,255,0.03);
            border-radius: 20px;
            padding: 4px 10px;
        }
        .nx-pill-btn:hover, .nx-pill-btn.active {
            border-color: var(--nx-accent);
            color: var(--nx-accent);
            background: var(--nx-btn-active-bg);
        }

        /* 發送按鈕 */
        .nx-send-btn {
            background: var(--nx-accent); 
            color: #000; 
            border: none; 
            width: 32px; height: 32px;
            border-radius: 8px; /* 方圓形 */
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .nx-send-btn:hover { transform: scale(1.05); opacity: 0.9; }
        [data-theme="terminal"] .nx-send-btn { border-radius: 0; background: var(--nx-text); }

        /* 回首頁按鈕 (Dropdown 樣式) */
        .back-to-home-container {
            position: absolute; top: 20px; right: 20px; z-index: 50;
        }
        .back-to-home-btn {
            color: var(--nx-text-muted); 
            text-decoration: none;
            font-size: 0.8em; 
            border: 1px solid var(--nx-border);
            padding: 6px 14px; 
            border-radius: var(--nx-radius);
            transition: all 0.2s;
            background: var(--nx-card-bg);
            cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }
        .back-to-home-btn:hover { border-color: var(--nx-accent); color: var(--nx-accent); }
        
        .home-dropdown {
            position: absolute; top: 110%; right: 0;
            background: var(--nx-sidebar);
            border: 1px solid var(--nx-border);
            border-radius: var(--nx-radius);
            width: 160px;
            display: none;
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            padding: 5px;
        }
        .home-dropdown.show { display: flex; }

        /* RWD */
        @media (max-width: 768px) {
            .nx-sidebar { display: none; } /* 手機版暫時隱藏側欄 */
            .nx-welcome h1 { font-size: 1.8rem; }
            .nx-suggestion-grid { grid-template-columns: 1fr; }
        }
        /* --- 臨時對話框 (Central Spotlight Style) --- */
.nx-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); /* 背景變暗 */
    backdrop-filter: blur(5px);      /* 背景模糊，凸顯前景 */
    z-index: 9999; 
    display: none; 
    align-items: center; justify-content: center; /* 上下左右置中關鍵 */
    opacity: 0;
    transition: opacity 0.3s ease;
}

.nx-modal-overlay.show {
    opacity: 1;
}

.nx-modal-content {
    background: var(--nx-sidebar);
    width: 90%; 
    max-width: 650px;    /* 限制最大寬度，像 ChatGPT 那樣 */
    height: 70vh;        /* 高度適中 */
    border-radius: 16px; 
    border: 1px solid var(--nx-border);
    box-shadow: 0 20px 50px rgba(0,0,0,0.5); /* 強烈的陰影讓它看起來懸浮 */
    display: flex; 
    flex-direction: column;
    overflow: hidden;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.nx-modal-overlay.show .nx-modal-content {
    transform: scale(1);
}

/* 標題列 */
.nx-modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--nx-border);
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.02);
}

/* 對話歷史區 */
#temp-chat-history {
    flex: 1; 
    overflow-y: auto; 
    padding: 20px;
    scroll-behavior: smooth;
}

/* 底部輸入區 (模仿你的截圖) */
.nx-modal-input-area {
    padding: 20px;
    background: var(--nx-sidebar);
    border-top: 1px solid var(--nx-border);
}

.nx-modal-input-wrapper {
    display: flex; 
    align-items: center; 
    gap: 10px;
    background: var(--nx-input-bg);
    border: 1px solid var(--nx-border);
    border-radius: 12px;
    padding: 8px 15px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

.nx-modal-input-wrapper:focus-within {
    border-color: var(--nx-accent);
    box-shadow: 0 0 10px var(--nx-glow);
}
        /* --- 側邊欄收合模式 (Mini Sidebar) --- */
        
        /* 1. 基礎轉場設定 (讓縮放很平滑) */
        .nx-sidebar {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible !important; /* 讓彈出選單可以超出邊界 */
            width: 260px;
            display: flex;
            flex-direction: column; /* 確保內容垂直排列 */
        }

        /* 2. 收合狀態 (.collapsed) */
        .nx-sidebar.collapsed {
            width: 80px; /* 縮小後的寬度 */
        }

        /* 3. 收合時隱藏文字與標題 */
        .nx-sidebar.collapsed .nav-text,     /* Logo 文字 */
        .nx-sidebar.collapsed .nx-menu-item span, /* 選單文字 */
        .nx-sidebar.collapsed .nx-btn-new span,   /* 按鈕文字 */
        .nx-sidebar.collapsed .nx-menu-title,     /* 分類標題 */
        .nx-sidebar.collapsed .nx-username,       /* 使用者名稱 */
        .nx-sidebar.collapsed .nx-sug-arrow {     /* 其他小圖示 */
            display: none !important;
        }

        /* 4. 收合時的排版調整 (讓 icon 居中) */
        .nx-sidebar.collapsed .nx-brand,
        .nx-sidebar.collapsed .nx-menu-item,
        .nx-sidebar.collapsed .nx-btn-new,
        .nx-sidebar.collapsed .nx-user-profile {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }
        
        .nx-sidebar.collapsed .nx-btn-new {
            width: 40px; 
            height: 40px; 
            border-radius: 50%; /* 變成圓形按鈕比較好看 */
            margin: 0 auto 20px auto; /* 水平居中 */
        }

        .nx-sidebar.collapsed .nx-menu-group {
            margin-bottom: 10px;
        }
/* --- [修正] 側邊欄收合模式的底部工具列優化 --- */
        
        /* 1. 讓地球和太陽按鈕變成「垂直排列」 */
        .nx-sidebar.collapsed .nx-tool-row {
            flex-direction: column !important;
            gap: 20px !important; /* 增加按鈕之間的距離 */
            margin-bottom: 20px;
        }

        /* 2. 解除「隱藏溢出」，讓選單可以彈出到側邊欄外面 */
        .nx-sidebar.collapsed {
            overflow: visible !important; 
        }

        /* 3. 修正選單彈出位置：改為顯示在按鈕的「右側」 */
        .nx-sidebar.collapsed .nx-dropdown-menu {
            bottom: 0 !important;      /* 對齊按鈕底部 */
            left: 50px !important;     /* 往右移，顯示在側邊欄外面 */
            top: auto !important;      
            
            /* 加上一個小箭頭或陰影讓它跟側邊欄分開 */
            box-shadow: 5px 5px 20px rgba(0,0,0,0.5) !important;
            border-left: 3px solid var(--nx-accent) !important;
        }

        /* 微調按鈕在收合時的置中 */
        .nx-sidebar.collapsed .nx-footer-btn {
            margin: 0 auto !important;
        }
        /* --- 歷史紀錄操作按鈕 --- */
        .nx-menu-item {
            position: relative;
            /* 讓文字過長時顯示 ... */
            overflow: hidden; 
        }
        
        /* 標題文字區域 */
        .nx-chat-title-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 操作按鈕容器 (預設隱藏) */
        .nx-chat-actions {
            display: none;
            align-items: center;
            gap: 5px;
            background: linear-gradient(90deg, transparent, var(--nx-sidebar) 20%);
            padding-left: 10px;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* 滑鼠移過去時顯示按鈕 */
        .nx-menu-item:hover .nx-chat-actions {
            display: flex;
        }

        /* 小按鈕樣式 */
        .nx-action-btn {
            background: transparent;
            border: none;
            color: var(--nx-text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .nx-action-btn:hover {
            background: var(--nx-hover-bg);
            color: var(--nx-accent);
        }
        .nx-action-btn.delete:hover {
            color: #ff6b6b; /* 刪除變紅色 */
        }
                    /* --- 歷史紀錄折疊動畫 --- */
            .nx-history-arrow {
                transition: transform 0.3s ease;
                display: inline-block;
                font-size: 0.8em;
            }
            /* 當折疊時，箭頭旋轉 -90度 */
            .nx-history-arrow.folded {
                transform: rotate(-90deg);
            }
        /* --- Logo 重新設計 (展開顯示大文字 / 收合顯示圖示) --- */
        
        /* 1. 展開狀態：隱藏圖示 SVG */
        .nx-sidebar:not(.collapsed) .nx-logo-svg {
            display: none !important;
        }

        /* 2. 展開狀態：放大 NodeX 文字 */
        .nx-sidebar:not(.collapsed) .nav-text {
            font-size: 1.8rem;      /* 字體放大 */
            font-weight: 800;       /* 字體加粗 */
            letter-spacing: 2px;    /* 增加字距 */
            background: linear-gradient(90deg, var(--nx-accent), var(--nx-text)); /* (選用) 文字漸層質感 */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            /* 修正文字漸層在某些瀏覽器的顯示問題，若不需要漸層可移除上面三行並設 color: var(--nx-text); */
        }

        /* 3. 展開狀態：調整 Header 排版 (讓文字靠左或置中，這裡設為靠左對齊) */
        .nx-sidebar:not(.collapsed) .nx-brand {
            justify-content: flex-start; /* 靠左對齊 */
            padding-left: 5px;           /* 稍微留點左邊距 */
            width: 100%;
        }

        /* 4. 收合狀態：確保圖示 SVG 顯示 (因為文字會被隱藏) */
        .nx-sidebar.collapsed .nx-logo-svg {
            display: block !important;
            width: 32px;
            height: 32px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <style>
        /* --- 專業版 Markdown & LaTeX 樣式優化 --- */
    .markdown-body { 
        line-height: 1.7; 
        font-size: 0.95rem; 
        color: var(--nx-text); 
        word-wrap: break-word;
        font-family: 'Inter', system-ui, sans-serif;
    
        /* 強制換行與斷字設定，防止跑版 */
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
        white-space: pre-wrap; /* 保留空白與換行格式 */
    }

    /* 標題優化 */
    .markdown-body h1, .markdown-body h2, .markdown-body h3 { 
        margin-top: 1.5em; 
        margin-bottom: 0.8em; 
        font-weight: 700; 
        line-height: 1.3;
        color: var(--nx-text);
    }
    .markdown-body h1 { font-size: 1.6em; border-bottom: 1px solid var(--nx-border); padding-bottom: 0.3em; color: var(--nx-accent); }
    .markdown-body h2 { font-size: 1.4em; color: var(--nx-accent); }
    .markdown-body h3 { font-size: 1.2em; }

    /* 列表優化 */
    .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin-bottom: 1em; }
    .markdown-body li { margin-bottom: 0.4em; }
    .markdown-body li::marker { color: var(--nx-accent); } /* 讓列表點點變色 */

    /* 程式碼區塊 */
    .markdown-body pre { 
        background: #1e1e1e; 
        padding: 12px; 
        border-radius: 8px; 
        overflow-x: auto; 
        margin: 1em 0; 
        border: 1px solid var(--nx-border);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    .markdown-body code { 
        font-family: 'Courier New', monospace; 
        font-size: 0.9em;
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 5px;
        border-radius: 4px;
        color: #ff79c6;
    }
    .markdown-body pre code { 
        background: transparent; 
        padding: 0; 
        color: #f8f8f2; 
    }

    /* 引用塊 */
    .markdown-body blockquote { 
        border-left: 4px solid var(--nx-accent); 
        padding: 4px 0 4px 16px; 
        margin: 1em 0; 
        background: rgba(255, 255, 255, 0.03);
        border-radius: 0 4px 4px 0;
        color: var(--nx-text-muted);
    }

    /* 表格 */
    .markdown-body table { width: 100%; border-collapse: collapse; margin: 1.5em 0; }
    .markdown-body th, .markdown-body td { 
        border: 1px solid var(--nx-border); 
        padding: 10px; 
        text-align: left; 
    }
    .markdown-body th { background: var(--nx-hover-bg); color: var(--nx-accent); }

    /* KaTeX 數學公式微調 */
    .katex { font-size: 1.1em !important; } /* 讓數學符號稍微大一點 */
    .katex-display { margin: 1em 0 !important; overflow-x: auto; overflow-y: hidden; }

        /* --- 新對話：置中模式樣式 --- */
        
        /* 當啟用置中模式時，輸入框移到畫面正中央 */
        .nx-main.centered-mode .nx-input-container {
            bottom: auto;           /* 取消底部的黏著 */
            top: 50%;               /* 移動到垂直 50% */
            transform: translate(-50%, 0); /* 保持水平置中，垂直位置由 margin 微調 */
            max-width: 700px;       /* 可以稍微窄一點，比較精緻 */
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); /* 平滑過渡動畫 */
        }

        /* 為了避開標題文字，稍微往下推一點 */
        .nx-main.centered-mode .nx-input-container {
            margin-top: 60px; 
        }

        /* 當處於置中模式時，隱藏聊天紀錄區 (確保背景乾淨) */
        .nx-main.centered-mode .nx-chat-area {
            display: none !important;
        }
        
        /* 輸入框本身的樣式微調 (讓它在中間時看起來更像搜尋框) */
        .nx-main.centered-mode .nx-input-wrapper {
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); /* 加強陰影 */
            border-color: var(--nx-border);
        }
        .nx-sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between; /* 展開時：左右分佈 */
            margin-bottom: 30px;
            height: 40px; /* 固定高度，避免切換時跳動 */
            position: relative; /* 讓絕對定位的按鈕參考此處 */
        }

        /* 2. 按鈕基礎設定 (讓它有點風格) */
        .sidebar-toggle-btn {
            transition: all 0.2s ease;
            opacity: 0;       /* 預設：完全透明 (隱藏) */
            transform: translateX(-10px); /* 微小位移特效 */
        }

        /* 3. [展開模式] Hover 效果 */
        /* 當滑鼠移入 Header 區域，按鈕顯現 */
        .nx-sidebar-header:hover .sidebar-toggle-btn {
            opacity: 1;
            transform: translateX(0);
        }

        /* ------------------------------------------------ */
        /* 4. [收合模式] 特殊處理 (關鍵修正) */
        /* ------------------------------------------------ */
        
        /* 收合時：內容強制置中 */
        .nx-sidebar.collapsed .nx-sidebar-header {
            justify-content: center;
        }

        /* 收合時：Logo 設定 */
        .nx-sidebar.collapsed .nx-brand {
            margin: 0;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.2s;
        }

        /* 收合時：按鈕改為「絕對定位」，疊在 Logo 上方 */
        .nx-sidebar.collapsed .sidebar-toggle-btn {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.8); /* 初始縮小 */
            opacity: 0; /* 預設隱藏 */
            background: var(--nx-sidebar); /* 加上背景色遮住下方的 Logo */
            border: 1px solid var(--nx-border); /* 加個邊框比較明顯 */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 5;
            display: flex; /* 確保它是 flex 佈局 */
        }

        /* 收合時 Hover：Logo 變淡，按鈕浮現 */
        .nx-sidebar.collapsed .nx-sidebar-header:hover .nx-brand {
            opacity: 0.1; /* Logo 幾乎隱藏 */
        }
        
        .nx-sidebar.collapsed .nx-sidebar-header:hover .sidebar-toggle-btn {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1); /* 放大回正常比例 */
        }
    </style>
</head>
<body data-theme="business"><div class="nx-sidebar"> <!-- 預設主題 -->

    <!-- 左側導航欄 -->
   <div class="nx-sidebar-header">
        <div class="nx-brand" onclick="toggleSidebar()" title="Toggle Sidebar">
            <svg class="nx-logo-svg" viewBox="0 0 24 24">
                <path d="M4 4l16 16" stroke-linecap="round"/>
                <path d="M20 4l-16 16" stroke-linecap="round"/>
                <circle cx="4" cy="4" r="2.5" fill="currentColor" stroke="none"/>
                <circle cx="20" cy="20" r="2.5" fill="currentColor" stroke="none"/>
                <circle cx="20" cy="4" r="2.5" fill="currentColor" stroke="none"/>
                <circle cx="4" cy="20" r="2.5" fill="currentColor" stroke="none"/>
                <circle cx="12" cy="12" r="1.5" fill="var(--nx-accent)" stroke="none"/>
            </svg>
            <span class="nav-text">NodeX</span>
        </div>

        <button class="nx-tool-btn sidebar-toggle-btn" onclick="toggleSidebar()">
            <svg class="nx-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
        </button>
    </div>
    
    <div class="nx-menu-group">
    </div>

        <button class="nx-btn-new" onclick="startNewChat()" style="margin-bottom: 20px; width: 100%;">
        <svg class="nx-icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        <span id="txt-newChat">新對話</span>
    </button>
        
   <div class="nx-menu-group">
        <div class="nx-menu-title">EXPLORE</div>

        <div class="nx-menu-item active" onclick="window.location.href='nodex.html'">
            <svg class="nx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
                <span id="txt-nodex">首頁</span>
        </div>
        
        <div class="nx-menu-item" onclick="window.location.href='finance.html'">
            <svg class="nx-icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            <span id="txt-finance">金融</span>
        </div>

        <div class="nx-menu-item" onclick="window.location.href='tech.html'">
            <svg class="nx-icon" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
            <span id="txt-tech">科技</span>
        </div>
   
        <div class="nx-menu-item" onclick="window.location.href='trends.html'">
            <svg class="nx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3a9 9 0 0 0 2.5 2.8z"></path>
            </svg>
            <span id="txt-trending">趨勢</span>
       </div>
    </div>

    <div class="nx-menu-group" id="history-container" style="flex:1; overflow-y: auto; min-height: 0; padding-right: 5px;">
       <div class="nx-menu-title" id="txt-history">歷史紀錄</div>
    </div>

        <!-- 底部工具列 -->
        <div class="nx-sidebar-footer">
            <div class="nx-tool-row">
                <!-- 地球語言切換 -->
                <div style="position:relative;">
                    <button class="nx-footer-btn" onclick="toggleMenu('lang-menu')" title="Switch Language">
                        <svg class="nx-icon" style="width:20px;height:20px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    </button>
                    <!-- 語言選單 -->
                    <div class="nx-dropdown-menu" id="lang-menu" style="bottom: 110%; left: 0;">
                        <div class="nx-dropdown-item active" onclick="setLanguage('zh-TW')">繁體中文</div>
                        <div class="nx-dropdown-item" onclick="setLanguage('en')">English</div>
                    </div>
                </div>

                <!-- 風格切換 -->
                <div style="position:relative;">
                    <button class="nx-footer-btn" onclick="toggleMenu('theme-menu')" title="Switch Theme">
                        <svg class="nx-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    </button>
                    <!-- 風格選單 -->
                   <div class="nx-dropdown-menu" id="theme-menu" style="bottom: 110%; left: -50px;">
                        <div class="nx-dropdown-item active" onclick="setTheme('business')">Business 商務</div>
                        <div class="nx-dropdown-item" onclick="setTheme('tech')">Tech 科幻</div>
                        <div class="nx-dropdown-item" onclick="setTheme('terminal')">Terminal 終端</div>
                    </div>
                </div>
            </div>
            
           <div id="admin-panel-btn" class="nx-menu-item" style="display:none; color: var(--nx-text); margin-bottom: 10px; border: 1px dashed var(--nx-text); justify-content: center; opacity: 0.8;" onclick="openAdminModal()">
                <svg class="nx-icon" style="color: var(--nx-text);" viewBox="0 0 24 24">
                    <path d="M12 2L3 7v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-9-5zm0 6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0 12c-2.33 0-4.31-1.46-5.11-3.64.03-1.71 3.41-2.65 5.11-2.65s5.07.94 5.11 2.65C16.31 18.54 14.33 20 12 20z"/>
                </svg>
                <span style="font-weight: 600;">管理員</span>
            </div>

            <div class="nx-user-profile" id="user-profile-section">
                <img src="" class="nx-avatar" id="nx-user-avatar" style="display:none;">
                <div class="nx-username" id="nx-user-name">訪客模式</div>
            </div>
        </div>
    </div>

    <!-- 右側主區域 -->
    <div class="nx-main">
        
        <!-- 回首頁按鈕 (Dropdown) -->
        <div class="back-to-home-container">
            <button class="back-to-home-btn" onclick="toggleMenu('home-menu')">
                切換 ▼
            </button>
            <div class="nx-dropdown-menu home-dropdown" id="home-menu" style="top: 110%; right: 0; left: auto; bottom: auto;">
            <div class="nx-dropdown-item" onclick="window.location.href='app.html#workspace'">Workspace</div>
            <div class="nx-dropdown-item" onclick="window.location.href='PulseStreet.html#pulse'">PulseStreet</div>
                </div>
        </div>

        <div class="nx-chat-area" id="nx-chat-history" style="display:none; flex-direction:column;"></div>
        
    
    <div id="view-home" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; opacity: 0; animation: fadeIn 0.5s forwards;">
        <svg viewBox="0 0 24 24" style="width: 120px; height: 120px; stroke: var(--nx-accent); fill: none; stroke-width: 0.5; margin-bottom: 20px;">
            <path d="M4 4l16 16" stroke-linecap="round"/>
            <path d="M20 4l-16 16" stroke-linecap="round"/>
            <circle cx="4" cy="4" r="2.5" fill="currentColor" stroke="none"/>
            <circle cx="20" cy="20" r="2.5" fill="currentColor" stroke="none"/>
            <circle cx="20" cy="4" r="2.5" fill="currentColor" stroke="none"/>
            <circle cx="4" cy="20" r="2.5" fill="currentColor" stroke="none"/>
            <circle cx="12" cy="12" r="1.5" fill="var(--nx-accent)" stroke="none"/>
        </svg>
        <h1 style="font-family: 'Orbitron', sans-serif; font-size: 3rem; letter-spacing: 4px; color: var(--nx-text);">NodeX</h1>
        <p style="color: var(--nx-text-muted); margin-top: 10px; font-size: 0.9em; letter-spacing: 1px;">Thinking in nodes, decisions with zero lag.</p>
    </div>

        <div id="view-new-chat" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; position: absolute; top: -50px; z-index: 0;">
           <h2 id="new-chat-title" style="font-size: 2rem; font-weight: 500; color: var(--nx-text); letter-spacing: 1px; margin-bottom: 20px;">
                我們該從哪裡開始？
            </h2>
        </div>

    <div id="view-dashboard" style="display: none; width: 100%; flex-direction: column; align-items: center;">
        <div class="nx-welcome">
            <h1 id="txt-welcome">早安，<br><span>開始您製作一份分析報告？</span></h1>
            <div class="nx-suggestion-grid">
                <div class="nx-suggestion-card"><span id="txt-sug1">分析 NVDA 財報重點</span> <span class="nx-sug-arrow">↗</span></div>
                <div class="nx-suggestion-card"><span id="txt-sug2">比特幣下週走勢預測</span> <span class="nx-sug-arrow">↗</span></div>
                <div class="nx-suggestion-card"><span id="txt-sug3">制定台股當沖策略</span> <span class="nx-sug-arrow">↗</span></div>
                <div class="nx-suggestion-card"><span id="txt-sug4">總體經濟數據解讀</span> <span class="nx-sug-arrow">↗</span></div>
            </div>
        </div>
    </div>

        <!-- 全新設計的輸入框區塊 -->
        <div class="nx-input-container">
            <div class="nx-input-wrapper">
                <!-- 第一層：輸入區 -->
                <textarea class="nx-textarea" id="nx-input" rows="1" placeholder="詢問任何問題。我相信你有很多疑問。"></textarea>
                
                <!-- 第二層：工具列 -->
                <div class="nx-input-footer">
                    <!-- 左側功能：搜尋 + 模型 -->
                    <div class="nx-input-left">
                       <button class="nx-tool-btn nx-pill-btn" id="btn-web-search" onclick="toggleSearch()" title="網頁搜尋 (Web Search)">
                        <svg class="nx-icon" style="width:16px;height:16px;" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        <span style="font-size:0.8em; font-weight:600;">搜尋</span>
                    </button>
                        
                       <div style="position:relative;">
                        <button class="nx-tool-btn nx-pill-btn" onclick="toggleMenu('model-menu')" id="model-selector-btn" title="切換模型 (Switch Model)">
                            <svg class="nx-icon" style="width:16px;height:16px;" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="14" x2="23" y2="14"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="14" x2="4" y2="14"></line></svg>
                            <span id="current-model-text" style="font-size:0.8em; font-weight:600;">gemini-2.5-flash</span>
                            <span style="font-size:0.7em; opacity:0.7;">▼</span>
                        </button>

                        <div class="nx-dropdown-menu" id="model-menu" style="bottom: 120%; left: 0; width: 220px;">
                            
                            <div class="nx-dropdown-item active" onclick="setModel('gemini-2.5-flash')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:var(--nx-accent);" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path>
                                </svg>
                                <span>Gemini-2.5-flash</span>
                            </div>

                             <div class="nx-dropdown-item" onclick="setModel('gemini-2.0-flash')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:var(--nx-accent);" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path>
                                </svg>
                                <span>Gemini-2.0-flash</span>
                            </div>
                            
                            <div class="nx-dropdown-item" onclick="setModel('gemini-2.5-flash-lite')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:var(--nx-accent);" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path>
                                </svg>
                                <span>Gemini-2.5-flash-lite</span>
                            </div>

                            <div class="nx-dropdown-item" onclick="setModel('gemini-2.0-flash-lite')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:var(--nx-accent);" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path>
                                </svg>
                                <span>Gemini-2.0-flash-lite</span>
                            </div>

                             <div class="nx-dropdown-item" onclick="setModel('gemini-2.5-pro')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:var(--nx-accent);" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path>
                                </svg>
                                <span>Gemini-2.5-pro</span>
                            </div>

                            <div class="nx-dropdown-item" onclick="setModel('gemini-2.0-flash-exp')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:var(--nx-accent);" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path>
                                </svg>
                                <span>Gemini-2.0-flash-exp</span>
                            </div>
                          <div class="nx-dropdown-item" onclick="setModel('llama-3.3-70b-versatile')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:#f64e03;" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"></path>
                                </svg>
                                <span>Llama 3.3 70B</span>
                            </div>
                            
                            <div class="nx-dropdown-item" onclick="setModel('llama-3.1-8b-instant')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:#f64e03;" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"></path>
                                </svg>
                                <span>Llama 3.1 8B</span>
                            </div>
                            
                            <div class="nx-dropdown-item" onclick="setModel('gpt-oss-120b')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:#663399;" viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="12" cy="12" r="10"></circle>
                                </svg>
                                <span>gpt-oss-120b</span>
                            </div>
                            
                            <div class="nx-dropdown-item" onclick="setModel('gpt-oss-20b')">
                                <svg class="nx-icon" style="width:16px; height:16px; margin-right:8px; color:#4285F4;" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path>
                                </svg>
                                <span>gpt-oss-20b</span>
                            </div>
                            

                        </div>
                    </div>
                    </div>

                    <!-- 右側功能：附件 + 語音 + 發送 -->
                    <div class="nx-input-right">
                        <button class="nx-tool-btn" title="Attach File">
                            <svg class="nx-icon" viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                        </button>
                        <button class="nx-tool-btn" title="Voice Input">
                            <svg class="nx-icon" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                        </button>
                       <button class="nx-send-btn" id="nx-send-btn" title="Send Message">
                        <svg class="nx-icon" style="width:18px;height:18px;stroke:white;" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                    </div>
                </div>
            </div>
            <div style="text-align:center; font-size:0.7em; color:var(--nx-text-muted); margin-top:10px;">
                NodeX AI can make mistakes. Please verify important information.
            </div>
        </div>
    </div>

    <!-- Firebase SDK (用於同步登入狀態) -->
   <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs,getDoc, doc, updateDoc, deleteDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // --- [新增] 側邊欄收合切換 ---
        window.toggleSidebar = function() {
            const sidebar = document.querySelector('.nx-sidebar');
            sidebar.classList.toggle('collapsed');
            
            // 可選：紀錄使用者的偏好，下次進來保持收合
            // localStorage.setItem('sidebar_collapsed', sidebar.classList.contains('collapsed'));
        };
       // --- [新增] 管理員更新全域關鍵字 ---
// --- [新功能] AI 翻譯輔助函式 ---
async function translateWithGemini(articles) {
    const contentToTranslate = articles.map((art, index) => ({
        id: index,
        title: art.title,
        description: art.description || "No description"
    }));

    const prompt = `
    你是一個專業的金融新聞翻譯員。請將以下 JSON 資料中的 "title" 和 "description" 翻譯成繁體中文（台灣用語）。
    請保持原本的 JSON 格式回傳，不要包含 markdown 標記 (如 \`\`\`json)，直接回傳純 JSON 字串。
    
    資料：
    ${JSON.stringify(contentToTranslate)}
    `;

    const response = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            model: "gemini-2.5-flash",
            stream: false,              // 🔴 告訴 Worker：我要非串流 JSON
            contents: [{ parts: [{ text: prompt }] }]
        })
    });

    if (!response.ok) {
        const text = await response.text();
        console.error("Gemini 呼叫失敗：", text);
        return null;
    }

    let result;
    try {
        result = await response.json();
        console.log("Gemini raw result:", result); // 除錯用，OK 後可刪
    } catch (err) {
        console.error("Gemini JSON 解析失敗:", err);
        return null;
    }

    // 🔐 先檢查有沒有 error
    if (result.error) {
        console.error("Gemini 回傳錯誤：", result);
        return null;
    }

    // ✅ 這裡才去讀 candidates
    try {
        let text = result.candidates[0].content.parts[0].text || "";
        text = text.replace(/```json/g, "").replace(/```/g, "").trim();
        return JSON.parse(text);
    } catch (e) {
        console.error("AI 解析失敗:", e, result);
        return null;
    }
}

// --- [修改版] 管理員更新全域關鍵字 (支援多關鍵字 + 翻譯 + 自動標記) ---
window.updateGlobalKeyword = async function() {
    const inputEl = document.getElementById('admin-news-keyword');
    const countEl = document.getElementById('admin-news-count'); 
    
    // 1. 取得輸入設定
    const rawKeywords = inputEl.value.trim();
    const articlesPerTopic = countEl ? (parseInt(countEl.value) || 3) : 3;

    if (!rawKeywords) return alert("請輸入關鍵字！");

    // 2. 處理關鍵字 (限制 8 個)
    let keywordList = rawKeywords.split(/[,，]/).map(k => k.trim()).filter(k => k);
    if (keywordList.length > 8) {
        alert(`關鍵字過多，系統將自動取前 8 個：\n${keywordList.slice(0, 8).join(', ')}`);
        keywordList = keywordList.slice(0, 8);
    }

    const btn = document.querySelector('button[onclick="updateGlobalKeyword()"]');
    const originalText = btn.innerText;
    btn.disabled = true;

    try {
        btn.innerText = `1/3 雙引擎啟動：搜尋 ${keywordList.length} 個主題...`;
        
        let aggregatedArticles = [];

        // 3. 定義雙引擎抓取函式
        const fetchTopic = async (key) => {
            // [引擎 A] News API (透過你的 Proxy)
            const apiPromise = fetch(`https://nodex-proxy.coreinformation30.workers.dev/news?q=${encodeURIComponent(key)}&sortBy=relevancy`)
                .then(res => res.json())
                .then(data => (data.status === "ok" ? data.articles : []))
                .catch(() => []); // 失敗就回傳空陣列

            // [引擎 B] Google News RSS (透過 rss2json 轉譯)
            const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(key)}&hl=zh-TW&gl=TW&ceid=TW:zh-Hant`;
            const rssPromise = fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok' && data.items) {
                        // 轉換 RSS 格式 -> News API 格式
                        return data.items.map(item => ({
                            title: item.title,
                            description: item.description || item.content || "",
                            url: item.link,
                            urlToImage: item.enclosure?.link || item.thumbnail || null, // 嘗試抓圖
                            publishedAt: item.pubDate,
                            source: { name: "Google News (RSS)" }, // 標記來源
                            _isRSS: true // 內部標記
                        }));
                    }
                    return [];
                })
                .catch(() => []);

            // 平行執行兩個請求
            const [apiArticles, rssArticles] = await Promise.all([apiPromise, rssPromise]);

            // [混合邏輯]
            // 1. 優先使用 API 新聞
            let combined = [...apiArticles];

            // 2. 如果 API 不夠 (例如少於目標數量)，用 RSS 補
            // 或者你想要混和，可以直接 push 進去
            // 這裡採用「去重複補強」策略：
            rssArticles.forEach(rssArt => {
                // 檢查標題是否太相似 (簡單防重複)
                const isDuplicate = combined.some(existing => 
                    existing.title.includes(rssArt.title) || rssArt.title.includes(existing.title)
                );
                if (!isDuplicate) {
                    combined.push(rssArt);
                }
            });

            // 3. 截取指定數量並標記 Tag
            return combined.slice(0, articlesPerTopic).map(art => ({
                ...art,
                _filterTag: key
            }));
        };

        // 4. 對所有關鍵字執行抓取
        const results = await Promise.all(keywordList.map(key => fetchTopic(key)));
        
        // 合併結果
        results.forEach(articles => {
            aggregatedArticles = [...aggregatedArticles, ...articles];
        });

        if (aggregatedArticles.length === 0) throw new Error("雙引擎皆無法取得資料");

        // 5. 翻譯 (選擇性：RSS 的摘要通常比較短，翻譯比較快)
        btn.innerText = `2/3 AI 智慧翻譯 (${aggregatedArticles.length} 篇)...`;
        
        // 為了節省 AI Token，我們可以只翻譯「非中文」的新聞
        // 這裡為了簡單，維持全部翻譯，但建議你監控 Token 用量
        const translatedData = await translateWithGemini(aggregatedArticles);

        let finalArticles = aggregatedArticles;
        if (translatedData) {
            finalArticles = aggregatedArticles.map((art, index) => {
                const trans = translatedData.find(t => t.id === index);
                if (trans) {
                    return { ...art, title: trans.title, description: trans.description };
                }
                return art;
            });
        }

        // 6. 寫入資料庫
        btn.innerText = "3/3 同步至全球節點...";
        
        await setDoc(doc(db, "system_settings", "public_news"), {
            keyword: keywordList.join(', '),
            tags: keywordList,
            articles: finalArticles, 
            updatedBy: window.currentUser ? window.currentUser.uid : 'admin',
            updatedAt: new Date()
        });

        alert(`✅ 混合模式完成！\n關鍵字：${keywordList.length} 個\n總新聞數：${finalArticles.length} 篇\n(含 API 與 RSS 來源)`);

    } catch (e) {
        console.error("Error:", e);
        alert("❌ 執行失敗: " + e.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};
       // --- [新增] 啟動新對話模式 ---
       window.startNewChat = function() {
           currentChatId = null;
            // 1. 定義歡迎語清單
            const titles = [
                "兩個人生日一樣的機率，比直覺高很多。（問問:生日悖論）",
                "讓電腦開始「讀懂人話」的那一刻。",
                "數獨其實是 NP 完全問題。",
                "圖靈機可以用超級「笨」的方式模擬任何電腦。",
                "網頁不是只有 HTML，還牽扯到不少協定數學",
                "當演算法開始參與你的決策流程。",
                "「3D 遊戲」畫面其實都是 2D 圖片堆出來的。",
                "隨機數產生器很多其實是「偽裝的」。",
                "「洗牌」如果用錯方法，其實不是真正隨機。",
                "人類開會三小時，模型三秒鐘說完。",
                "兩顆骰子相加為「7 點」其實最常見。",
                "你在懷疑人生，它在幫你產出下一份報告XD",
                "賭場可以「穩賺不賠」，不是靠運氣，是靠期望值。"
            ];

            // 2. 隨機挑選一個標題
            const randomTitle = titles[Math.floor(Math.random() * titles.length)];
            
            // 3. 更新畫面上的標題文字
            const titleEl = document.getElementById('new-chat-title');
            if (titleEl) titleEl.innerText = randomTitle;

            // 4. 清空聊天畫面
            const chatHistory = document.getElementById('nx-chat-history');
            if(chatHistory) chatHistory.innerHTML = ''; 
            
            // 5. 切換 UI 狀態
            document.getElementById('view-home').style.display = 'none';
            document.getElementById('view-dashboard').style.display = 'none';
            document.getElementById('view-new-chat').style.display = 'flex';
            
            // 6. 啟動 CSS 置中模式
            document.querySelector('.nx-main').classList.add('centered-mode');
            
            // 7. 重置輸入框
            const input = document.getElementById('nx-input');
            input.value = '';
            input.focus();
            input.style.height = 'auto';
        };
    
        // --- [補強] 將 UI 控制函式掛載到 window 以便 HTML 呼叫 ---
        window.switchView = function(viewName) {
            document.getElementById('view-home').style.display = viewName === 'home' ? 'flex' : 'none';
            document.getElementById('view-dashboard').style.display = viewName === 'dashboard' ? 'flex' : 'none';
            // 更新選單激活狀態 (簡易版)
            document.querySelectorAll('.nx-menu-item').forEach(el => el.classList.remove('active'));
            if(viewName === 'home') document.getElementById('menu-home').classList.add('active');
        };

        window.toggleMenu = function(menuId) {
            const menu = document.getElementById(menuId);
            const isShown = menu.style.display === 'flex';
            // 關閉其他所有選單
            document.querySelectorAll('.nx-dropdown-menu').forEach(m => m.style.display = 'none');
            // 切換當前選單
            menu.style.display = isShown ? 'none' : 'flex';
        };

        window.setTheme = function(theme) {
            document.body.setAttribute('data-theme', theme);
            window.toggleMenu('theme-menu'); // 關閉選單
        };

       // [新增] 語言切換函式
// [新增] 語言切換函式
window.setLanguage = function(lang) {
    // 1. 執行切換邏輯
    if (lang === 'en') {
        alert("Language switched to English (Demo)");
        // 在這裡加入介面文字更換的程式碼...
    } else {
        alert("已切換至繁體中文");
    }
    
    // 2. 更新選單的「勾選」狀態 (Visual Feedback)
    document.querySelectorAll('#lang-menu .nx-dropdown-item').forEach(item => {
        item.classList.remove('active');
        // 判斷當前語言並加亮對應選項
        if (item.innerText.includes(lang === 'en' ? 'English' : '繁體中文')) {
            item.classList.add('active');
        }
    });
    
    window.toggleMenu('lang-menu');
};
        
        // 點擊頁面其他地方關閉 Dropdown 
        document.addEventListener('click', (e) => {
            // 如果點擊的對象不是 Footer按鈕、不是回首頁按鈕、也不是模型切換按鈕
            if (!e.target.closest('.nx-footer-btn') && 
                !e.target.closest('.back-to-home-container') && 
                !e.target.closest('#model-selector-btn')) { // [新增] 排除模型按鈕
                
                document.querySelectorAll('.nx-dropdown-menu').forEach(m => m.style.display = 'none');
            }
        });
        // 1. Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyAIwisA_UnOiNRVwYE6tJV47Sp3_1i19IM",
            authDomain: "brooklyn-terminal.firebaseapp.com",
            projectId: "brooklyn-terminal",
            storageBucket: "brooklyn-terminal.firebasestorage.app",
            messagingSenderId: "438411734316",
            appId: "1:438411734316:web:649051890cf381eb0fd089",
            measurementId: "G-G0GMW0XHG1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        let currentChatId = null;
        
        // UI 元素
        const nameEl = document.getElementById('nx-user-name');
        const avatarEl = document.getElementById('nx-user-avatar');
        const userProfileSection = document.getElementById('user-profile-section');

        // 2. 登入狀態監聽
       // 2. 登入狀態監聽 (修復版)
        onAuthStateChanged(auth, async (user) => {
            window.currentUser = user;
            const adminBtn = document.getElementById('admin-panel-btn');
            // [修正] 改用 ID 抓取歷史紀錄容器，避免抓不到導致崩潰
            const historyContainer = document.getElementById('history-container'); 

            if (user) {
                // 登入時的 UI 更新
                if(nameEl) nameEl.innerText = user.displayName;
                if(user.photoURL && avatarEl) {
                    avatarEl.src = user.photoURL;
                    avatarEl.style.display = 'block';
                }
                
                // 載入歷史紀錄與檢查權限
                loadSidebarHistory(user.uid);
                checkAdminRole(user.uid);

            } else {
                // 登出時的 UI 更新
                if(nameEl) nameEl.innerText = "GUEST";
                if(avatarEl) avatarEl.style.display = 'none';
                
                // [修正] 安全地清空歷史紀錄
                if(historyContainer) {
                    historyContainer.innerHTML = '<div class="nx-menu-title" id="txt-history">歷史紀錄</div>';
                }
                
                currentChatId = null;
                if(adminBtn) adminBtn.style.display = 'none';
            }
        });

        // 3. 點擊頭像登入/登出 (已升級為個人檔案視窗)
    
    // --- 新增：用量規則設定 ---
   const MODEL_LIMITS = [
    { name: "Gemini 2.5 Flash", id: "gemini-2.5-flash", limit: 50 },
    { name: "Gemini 2.0 Flash", id: "gemini-2.0-flash", limit: Infinity },
    { name: "Gemini 2.5 Flash Lite", id: "gemini-2.5-flash-lite", limit: Infinity },
    { name: "Gemini 2.0 Flash Lite", id: "gemini-2.0-flash-lite", limit: Infinity },
    { name: "Gemini 2.5 Pro", id: "gemini-2.5-pro", limit: 50 },
   { name: "Gemini 3 Pro", id: "gemini-3-pro", limit: 10 }, 
    { name: "Gemini 2.0 Flash Exp", id: "gemini-2.0-flash-exp", limit: 10 },
    { name: "Llama 3.3 70B", id: "llama-3.3-70b-versatile", limit: 20},
    { name: "Llama 3.1 8B", id: "llama-3.1-8b-instant", limit: 20 },
    { name: "gpt-oss-120b", id: "gpt-oss-120b", limit: 20 }, 
    { name: "gpt-oss-20b", id: "gpt-oss-20b", limit: 20 }
];

    // --- 新增：開啟視窗函式 ---
    window.openProfileModal = async function() {
        const modal = document.getElementById('profile-modal');
        const user = window.currentUser;

        if (!user) return; 

        // 填入資料
        const avatarEl = document.getElementById('modal-avatar');
        if(user.photoURL) avatarEl.src = user.photoURL;
        
        document.getElementById('modal-username').innerText = user.displayName || "使用者";
        document.getElementById('modal-email').innerText = user.email || "";

        renderUsageStats();
        // [修改] 等待雲端數據讀取完畢
        const todayStats = await getTodayUsageStats(); 
        renderUsageStats(todayStats); // 把數據傳進去
        // 顯示
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
    };

    // --- 新增：關閉視窗函式 ---
    window.closeProfileModal = function() {
        const modal = document.getElementById('profile-modal');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    };

    // --- 新增：登出處理 ---
    window.handleLogout = function() {
        if(confirm("確定要登出嗎？")) {
            signOut(auth).then(() => {
                closeProfileModal();
                document.getElementById('nx-user-name').innerText = "GUEST";
                document.getElementById('nx-user-avatar').style.display = 'none';
                window.currentUser = null;
                // 清空歷史紀錄選單
                const historyContainer = document.getElementById('history-container');
                if(historyContainer) historyContainer.innerHTML = '<div class="nx-menu-title" id="txt-history">歷史紀錄</div>';
            });
        }
    };

    // --- 新增：渲染進度條 ---
    // [修正] 接收 stats 參數 (預設為空物件)
    function renderUsageStats(stats = {}) {
        const container = document.getElementById('usage-stats-container');
        if(!container) return;
        container.innerHTML = ''; 

        MODEL_LIMITS.forEach(model => {
            // [修正] 從傳入的 stats 物件中讀取該模型 ID 的次數
            // 如果找不到該 ID 的紀錄，預設為 0
            const dbKey = model.id.replace(/\./g, '_');
            const used = stats[dbKey] || 0;
            
            const isUnlimited = model.limit === Infinity;
            const percent = isUnlimited ? 0 : Math.min((used / model.limit) * 100, 100);
            
            let colorClass = '';
            if(percent > 80) colorClass = 'danger';
            else if(percent > 50) colorClass = 'warning';

            const item = document.createElement('div');
            item.className = 'usage-item';
            
            let statusText = isUnlimited ? 
                `<span style="color:var(--nx-accent);">∞ 無限制</span>` : 
                `<span>${used} / ${model.limit}</span>`;

            let barHtml = isUnlimited ? '' : `
                <div class="progress-track">
                    <div class="progress-fill ${colorClass}" style="width: ${percent}%"></div>
                </div>
            `;

            item.innerHTML = `
                <div class="usage-header">
                    <span style="font-weight:600;">${model.name}</span>
                    ${statusText}
                </div>
                ${barHtml}
            `;
            container.appendChild(item);
        });
    }

    // --- 修改：綁定新的點擊事件 ---
    userProfileSection.addEventListener('click', () => {
        if (window.currentUser) {
            openProfileModal(); // 已登入：開視窗
        } else {
            signInWithPopup(auth, provider).catch((error) => alert("Login Error: " + error.message)); // 未登入：登入
        }
    });

    // 點擊遮罩關閉視窗 (如果尚未綁定)
    const profileModal = document.getElementById('profile-modal');
    if(profileModal) {
        profileModal.addEventListener('click', (e) => {
            if (e.target.id === 'profile-modal') closeProfileModal();
        });
    }
        
        // --- LLM 核心邏輯開始 ---
        
        const WORKER_URL = "https://nodex-proxy.coreinformation30.workers.dev"; 
        const DAILY_LIMIT = 40;
        

        let currentModel = "gemini-2.5-flash";
       // 1. 定義搜尋狀態
        let isSearchEnabled = false;
        
        // 2. 切換搜尋功能的函式
        window.toggleSearch = function() {
            isSearchEnabled = !isSearchEnabled;
            const btn = document.getElementById('btn-web-search');
            
            // 切換視覺樣式
            if (isSearchEnabled) {
                btn.classList.add('active');
                // 視覺回饋
                btn.style.borderColor = 'var(--nx-accent)';
                btn.style.color = 'var(--nx-accent)';
            } else {
                btn.classList.remove('active');
                btn.style.borderColor = 'transparent';
                btn.style.color = 'var(--nx-text-muted)';
            }
        };
       window.setModel = function(modelName) {
            currentModel = modelName;
            
            // 1. 更新按鈕文字
            const textEl = document.getElementById('current-model-text');
            if(textEl) textEl.innerText = modelName;
            
            // 2. 更新選單的選中狀態 (Visual Feedback)
            document.querySelectorAll('#model-menu .nx-dropdown-item').forEach(item => {
                item.classList.remove('active');
                if(item.innerText.includes(modelName)) {
                    item.classList.add('active');
                }
            });
            
            // 3. 關閉選單
            window.toggleMenu('model-menu');
        };
        const chatHistory = document.getElementById('nx-chat-history');
        const chatInput = document.getElementById('nx-input');
        const sendBtn = document.getElementById('nx-send-btn');
        const homeView = document.getElementById('view-home');
        const dashboardView = document.getElementById('view-dashboard');

       // --- [升級版] Firestore 用量統計系統 ---

// 1. 取得今日日期字串 (作為文件的 ID)
function getTodayDateStr() {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}
// --- [新增] 檢查模型額度是否足夠 ---
async function checkModelAvailability(modelName) {
    // 1. 找到該模型的限制設定
    const config = MODEL_LIMITS.find(m => m.id === modelName);
    
    // 如果找不到設定，或是設為無限，直接通過
    if (!config || config.limit === Infinity) return true;

    // 2. 讀取今日用量
    const stats = await getTodayUsageStats();
    const dbKey = modelName.replace(/\./g, '_');
    const used = stats[dbKey] || 0;

    // 3. 比較用量
    if (used >= config.limit) {
        return false; // 額度已滿
    }
    return true; // 還有額度
}
// 2. [新] 增加用量 (寫入 Firestore)
async function incrementModelUsage(modelName) {
    if (!window.currentUser) return;
    const uid = window.currentUser.uid;
    const dateStr = getTodayDateStr();
    const usageRef = doc(db, "users", uid, "usage_records", dateStr);
    
    // 1. 處理 Key
    const dbKey = modelName.replace(/\./g, '_'); 

    try {
        // 2. 直接寫入 (原子操作)
        // merge: true 代表：如果文件不存在就建立；如果欄位不存在就新增；如果存在就 +1
        await setDoc(usageRef, {
            [dbKey]: increment(1), 
            lastUpdated: new Date()
        }, { merge: true });
        
        console.log(`Usage updated for ${modelName} -> ${dbKey}`);
    } catch (e) {
        console.error("Update Usage Error:", e);
    }
}

// 3. [新] 讀取今日用量 (讀取 Firestore)
async function getTodayUsageStats() {
    if (!window.currentUser) return {};
    
    const uid = window.currentUser.uid;
    const dateStr = getTodayDateStr();
    const usageRef = doc(db, "users", uid, "usage_records", dateStr);
    
    try {
        const docSnap = await getDoc(usageRef);
        if (docSnap.exists()) {
            return docSnap.data(); // 回傳 { "gemini-2.5-flash": 12, ... }
        }
    } catch (e) {
        console.error("Get Usage Error:", e);
    }
    return {}; // 如果沒資料回傳空物件
}

        // 發送訊息主函式
      async function handleSendMessage() {
    // 1. [強制登入檢查]
    if (!window.currentUser) {
        appendSystemMessage("請先點擊左下角登入 Google 帳號。");
        return;
    }
    const uid = window.currentUser.uid; // 取得 UID

    const userText = chatInput.value.trim();
    if (!userText) return;
    const isAvailable = await checkModelAvailability(currentModel);
    
    if (!isAvailable) {
        appendSystemMessage(`額度已滿：您今日的 ${currentModel} 用量已達上限。請切換至其他模型繼續使用。`);
        return; // 直接中斷，不發送請求，也不扣額度
    }
    marked.setOptions({
    breaks: true,  // <--- 將 \n 轉換為 <br>
    gfm: true,     // 啟用 GitHub 風格 Markdown (支援表格、刪除線)
    headerIds: false,
    mangle: false
});

    // 3. [UI 狀態切換]
    document.querySelector('.nx-main').classList.remove('centered-mode');
    document.getElementById('view-new-chat').style.display = 'none';
    document.getElementById('view-home').style.display = 'none';
    document.getElementById('view-dashboard').style.display = 'none';
    
    const chatHistory = document.getElementById('nx-chat-history');
    if (chatHistory) {
        chatHistory.style.display = 'flex';
        chatHistory.style.flexDirection = 'column';
    }

    chatInput.value = '';
    chatInput.style.height = 'auto';

    appendUserMessage(userText);
    incrementModelUsage(currentModel);

    // 🔹 先在外面宣告，讓 try / catch 都看得到
    let loadingId;

    // ----------------------------------------------------
    // 🚀 Firestore + 呼叫 LLM
    // ----------------------------------------------------
    try {
        // 1. 如果是新對話，先建立文件
        if (!currentChatId) {
            const chatRef = await addDoc(collection(db, "chats"), {
                userId: uid,
                title: userText.substring(0, 20) + "...", 
                createdAt: new Date(),
                lastMessage: new Date()
            });
            currentChatId = chatRef.id;
            loadSidebarHistory(uid); // 刷新側邊欄
        }

        // 2. 儲存使用者訊息
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            role: "user",
            content: userText,
            timestamp: new Date()
        });

        // 3. 呼叫 LLM
        loadingId = appendLoadingIndicator();  // ⬅️ 改成賦值，不用 const
                
        const response = await fetch(WORKER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                model: currentModel,
                useSearch: isSearchEnabled,
                contents: [{ parts: [{ text: userText }] }] })
        });

        if (!response.ok) throw new Error("Worker Error: " + response.statusText);

        const aiMsgContent = appendAiMessageStart();
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";
        let isFirstChunk = true;
        let fullTextBuffer = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            if (isFirstChunk && loadingId) {
        removeMessage(loadingId);
        isFirstChunk = false;
    }

            const chunk = decoder.decode(value, { stream: true });
            fullTextBuffer += chunk;
            const matches = chunk.match(/"text":\s*"((?:[^"\\]|\\.)*)"/g);
            
            if (matches) {
                matches.forEach(match => {
                    let textPart = match.replace(/"text":\s*"/, "").replace(/"$/, "");
                    try {
                       
                        textPart = JSON.parse(`"${textPart}"`); 
                        fullText += textPart;
                        
                        // Markdown + LaTeX 渲染
                        aiMsgContent.innerHTML = marked.parse(fullText);
                        if (window.renderMathInElement) {
                            renderMathInElement(aiMsgContent, {
                                delimiters: [
                                    {left: "$$", right: "$$", display: true},
                                    {left: "$", right: "$", display: false},
                                    {left: "\\(", right: "\\)", display: false},
                                    {left: "\\[", right: "\\]", display: true}
                                ],
                                throwOnError: false
                            });
                        }

                        if (chatHistory) {
                            chatHistory.scrollTop = chatHistory.scrollHeight;
                        }
                    } catch (e) {
                        // 這裡可以加 console.error(e) 方便除錯
                    }
                });
            }
        }

        // 4. 儲存 AI 回覆
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            role: "model",
            content: fullText,
            timestamp: new Date()
        });

    } catch (error) {
        // 避免 loadingId 還沒設好就硬移除
        if (loadingId) {
            removeMessage(loadingId);
        }
        appendSystemMessage(`❌ 系統錯誤: ${error.message}`);
        console.error(error);
    }
}

        // --- UI 輔助函式 (適配 NodeX 風格) ---
        
      function appendUserMessage(text) {
            const div = document.createElement('div');
            // 寬度鎖定與置中設定
            div.style.width = '100%';
            div.style.maxWidth = '800px'; 
            div.style.marginBottom = '20px';
            
            div.style.display = 'flex';
            div.style.flexDirection = 'column';
            div.style.alignItems = 'flex-end'; 

            // 1. 取得使用者名稱 (如果沒登入顯示 GUEST)
            const userName = window.currentUser ? window.currentUser.displayName : 'GUEST';

            div.innerHTML = `
                <div style="font-size:0.8em; color:var(--nx-text-muted); margin-bottom:5px; text-transform: uppercase;">
                    ${userName}
                </div>
                
                <div style="background:var(--nx-card-bg); padding:12px 16px; border-radius:12px; border:1px solid var(--nx-border); color:var(--nx-text); text-align: left;">
                    ${text.replace(/\n/g, '<br>')}
                </div>
            `;
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function appendAiMessageStart() {
            const div = document.createElement('div');
            // [維持設定] 讓容器寬度與輸入框一致，並置中
            div.style.width = '100%';
            div.style.maxWidth = '800px'; 
            div.style.marginBottom = '30px';
            
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <div style="width:28px; height:28px; background:rgba(0, 255, 204, 0.1); border-radius:6px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(0, 255, 204, 0.2);">
                        <svg style="width:18px; height:18px; stroke:var(--nx-accent); fill:none; stroke-width:3; stroke-linecap:round; stroke-linejoin:round;" viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </div>
                    
                    <span style="font-size:0.95em; font-weight:bold; color:var(--nx-accent); letter-spacing:0.5px;">NodeX AI</span>
                </div>
                
                <div class="ai-content markdown-body" style="padding-left:0;"></div> 
            `;
            chatHistory.appendChild(div);
            return div.querySelector('.ai-content');
        }
        function appendSystemMessage(text) {
            const div = document.createElement('div');
            div.style.width = '100%';
            div.style.textAlign = 'center';
            div.style.margin = '20px 0';
            div.innerHTML = `<span style="background:rgba(255,0,0,0.1); color:#ff6b6b; padding:5px 10px; border-radius:4px; font-size:0.8em; border:1px solid rgba(255,0,0,0.2);">${text}</span>`;
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

       function appendLoadingIndicator() {
    const id = 'loading-' + Date.now();
    const div = document.createElement('div');
    div.id = id;
    
    // 保持與 AI 回覆一致的排版寬度
    div.style.width = '100%';
    div.style.maxWidth = '800px';
    div.style.marginBottom = '30px';
    
    // 內層結構：上方是 AI 頭像資訊，下方是跳動圓點氣泡
    div.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            <div style="width:28px; height:28px; background:rgba(0, 255, 204, 0.1); border-radius:6px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(0, 255, 204, 0.2);">
                <svg style="width:18px; height:18px; stroke:var(--nx-accent); fill:none; stroke-width:3; stroke-linecap:round; stroke-linejoin:round;" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
            <span style="font-size:0.95em; font-weight:bold; color:var(--nx-accent); letter-spacing:0.5px;">NodeX AI</span>
        </div>
        
        <div class="nx-typing-bubble">
            <div class="nx-typing-dot"></div>
            <div class="nx-typing-dot"></div>
            <div class="nx-typing-dot"></div>
        </div>
    `;
    
    // 加入到對話紀錄
    const chatHistory = document.getElementById('nx-chat-history');
    if(chatHistory) {
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight; // 捲動到底部
    }
    
    return id;
}
        function removeMessage(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // 綁定事件
        sendBtn.addEventListener('click', handleSendMessage);
        // [優化] 主對話框 Enter 發送 (支援 Shift+Enter 換行，並防止輸入法誤傳)
        chatInput.addEventListener('keydown', (e) => {
            // [修正] 直接使用 e.isComposing 即可
            if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
                e.preventDefault(); // 阻止預設換行 (避免多出一個空行)
                handleSendMessage();
            }
        });
                   // --- [新增] 切換歷史紀錄折疊狀態 ---
            window.toggleHistoryList = function() {
                const list = document.getElementById('nx-history-list-content');
                const arrow = document.getElementById('nx-history-arrow-icon');
                
                if (list && arrow) {
                    if (list.style.display === 'none') {
                        list.style.display = 'block'; // 展開
                        arrow.classList.remove('folded');
                    } else {
                        list.style.display = 'none';  // 收合
                        arrow.classList.add('folded');
                    }
                }
            };



       
       // --- [修改版] 載入側邊欄歷史清單 (含折疊功能) ---
async function loadSidebarHistory(uid) {
    const historyContainer = document.getElementById('history-container');
    if(!historyContainer) return;
    
    // 1. 建立標題列 (包含點擊事件) 與 清單容器
    historyContainer.innerHTML = `
        <div class="nx-menu-title" onclick="toggleHistoryList()" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; user-select: none;">
            <span>歷史紀錄 (History)</span>
            <span id="nx-history-arrow-icon" class="nx-history-arrow">▼</span>
        </div>
        <div id="nx-history-list-content" style="display:block;">
            </div>
    `;
    
    const listContent = document.getElementById('nx-history-list-content');

    try {
        const q = query(collection(db, "chats"), where("userId", "==", uid), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            listContent.innerHTML = '<div style="padding:10px; color:var(--nx-text-muted); font-size:0.8em; text-align:center;">尚無紀錄</div>';
            return;
        }

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const chatId = docSnap.id;
            
            // 建立單個項目
            const item = document.createElement('div');
            item.className = 'nx-menu-item';
            item.style.fontSize = '0.85em';
            
            // 標題
            const titleSpan = document.createElement('span');
            titleSpan.className = 'nx-chat-title-text';
            titleSpan.innerText = data.title || '新對話';
            
            // 操作按鈕 (編輯/刪除)
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'nx-chat-actions';
            
            // (A) 重新命名
            const editBtn = document.createElement('button');
            editBtn.className = 'nx-action-btn';
            editBtn.title = '重新命名';
            editBtn.innerHTML = '<svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                renameChatSession(chatId, data.title);
            };

            // (B) 刪除
            const delBtn = document.createElement('button');
            delBtn.className = 'nx-action-btn delete';
            delBtn.title = '刪除對話';
            delBtn.innerHTML = '<svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                deleteChatSession(chatId);
            };

            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(delBtn);
            
            item.appendChild(titleSpan);
            item.appendChild(actionsDiv);

            // 點擊載入
            item.onclick = () => loadChatSession(chatId);
            
            // 注意：這裡是 append 到 listContent，而不是 historyContainer
            listContent.appendChild(item);
        });
    } catch(e) {
        console.error("Load History Error:", e);
        listContent.innerHTML = '<div style="color:red; font-size:0.8em; padding:10px;">載入失敗</div>';
    }
}

        // --- [新增] 重新命名對話 ---
        async function renameChatSession(chatId, oldTitle) {
            const newTitle = prompt("請輸入新的對話標題：", oldTitle);
            if (newTitle && newTitle.trim() !== "") {
                try {
                    const chatRef = doc(db, "chats", chatId);
                    await updateDoc(chatRef, {
                        title: newTitle.trim()
                    });
                    // 重新整理列表
                    if (window.currentUser) loadSidebarHistory(window.currentUser.uid);
                } catch (error) {
                    alert("重新命名失敗：" + error.message);
                }
            }
        }

        // --- [新增] 刪除對話 ---
        async function deleteChatSession(chatId) {
            if (confirm("確定要刪除此對話紀錄嗎？此動作無法復原。")) {
                try {
                    // 1. 刪除 Firestore 文件
                    await deleteDoc(doc(db, "chats", chatId));
                    
                    // 2. 如果刪除的是當前正在看的對話，清空畫面並回到「新對話」頁面
                    if (currentChatId === chatId) {
                        startNewChat();
                    }
                    
                    // 3. 重新整理列表
                    if (window.currentUser) loadSidebarHistory(window.currentUser.uid);
                    
                } catch (error) {
                    console.error("Delete Error:", error);
                    alert("刪除失敗 (可能是權限不足): " + error.message);
                }
            }
        }
        // --- [新增] 載入特定對話內容 ---
        async function loadChatSession(chatId) {
            currentChatId = chatId; // 設定當前 ID
            
            // 清空畫面
            document.getElementById('nx-chat-history').innerHTML = '';
            document.getElementById('view-home').style.display = 'none';
            document.getElementById('view-dashboard').style.display = 'none';
            document.getElementById('view-new-chat').style.display = 'none';
            document.getElementById('nx-chat-history').style.display = 'flex';
            document.querySelector('.nx-main').classList.remove('centered-mode');

            // 抓取該對話的所有訊息
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"));
            const querySnapshot = await getDocs(q);

            querySnapshot.forEach((doc) => {
                const msg = doc.data();
                if (msg.role === 'user') {
                    appendUserMessage(msg.content);
                } else {
                    // 這裡為了簡化，直接顯示 AI 訊息，不跑打字機動畫
                    const aiDiv = appendAiMessageStart(); 
                    aiDiv.innerHTML = marked.parse(msg.content);
                    // 如果有 LaTeX 記得在這裡也要 renderMathInElement
                }
            });
        }

                   // --- [新增] 檢查是否為管理員 ---
            async function checkAdminRole(uid) {
                const adminBtn = document.getElementById('admin-panel-btn');
                if (!adminBtn) return;
            
                try {
                    // 讀取 users/{uid} 文件
                    const userRef = doc(db, "users", uid);
                    const docSnap = await getDoc(userRef);
            
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // 判斷 role 欄位是否為 'admin'
                        if (data.role === 'admin') {
                            adminBtn.style.display = 'flex'; // 顯示按鈕
                            console.log("Admin access granted.");
                            return;
                        }
                    }
                } catch (e) {
                    console.error("Error checking admin role:", e);
                }
                
                // 若不是管理員或發生錯誤，確保隱藏
                adminBtn.style.display = 'none';
            }
            
            // --- [新增] 開啟/關閉管理員視窗 ---
            // 掛載到 window 以便 HTML onclick 呼叫
            window.openAdminModal = function() {
                const modal = document.getElementById('admin-modal');
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('show'), 10);
            };
            
            window.closeAdminModal = function() {
                const modal = document.getElementById('admin-modal');
                modal.classList.remove('show');
                setTimeout(() => modal.style.display = 'none', 300);
            };
            
            // 點擊遮罩關閉
            document.getElementById('admin-modal').addEventListener('click', (e) => {
                if (e.target.id === 'admin-modal') window.closeAdminModal();
            });
    </script>
 
<div id="profile-modal" class="nx-modal-overlay">
    <div class="nx-modal-content" style="height: auto; max-height: 85vh; width: 450px;">
        
        <div class="nx-modal-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <svg class="nx-icon" style="color:var(--nx-accent);" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span style="font-weight:bold; letter-spacing:1px;">帳戶資料</span>
            </div>
            <button class="nx-tool-btn" onclick="closeProfileModal()" title="關閉">✕</button>
        </div>

        <div style="padding: 25px; overflow-y: auto;">
            
            <div style="display:flex; align-items:center; gap:20px; margin-bottom: 30px;">
                <img id="modal-avatar" src="" style="width:70px; height:70px; border-radius:50%; object-fit:cover; border:2px solid var(--nx-accent); padding:2px;">
                <div>
                    <div id="modal-username" style="font-size:1.2em; font-weight:bold; color:var(--nx-text); margin-bottom:5px;">User Name</div>
                    <div id="modal-email" style="font-size:0.9em; color:var(--nx-text-muted); margin-bottom:8px;">email@example.com</div>
                    <div style="display:inline-block; background:rgba(0,255,204,0.1); color:var(--nx-accent); border:1px solid rgba(0,255,204,0.3); padding:2px 8px; border-radius:4px; font-size:0.75em; font-weight:bold;">
                        方案：免費版
                    </div>
                </div>
            </div>

            <hr style="border:0; border-top:1px solid var(--nx-border); margin-bottom:20px;">

            <h4 style="color:var(--nx-text); margin-bottom:15px; font-size:0.95em; text-transform:uppercase; letter-spacing:1px;">今日模型用量 (Daily Usage)</h4>
            
            <div id="usage-stats-container" style="display:flex; flex-direction:column; gap:15px;">
                </div>

        </div>

        <div style="padding:20px; border-top:1px solid var(--nx-border); display:flex; justify-content:flex-end;">
            <button onclick="handleLogout()" class="nx-btn-new" style="width:100%; justify-content:center; color:#ff6b6b; border-color:rgba(255,107,107,0.3); margin-bottom:0;">
                <svg class="nx-icon" style="stroke:#ff6b6b;" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                登出帳號
            </button>
        </div>
    </div>
</div>
<div id="admin-modal" class="nx-modal-overlay">
    <div class="nx-modal-content" style="border: 1px solid #ffcc00; box-shadow: 0 0 20px rgba(255, 204, 0, 0.2);">
        
        <div class="nx-modal-header" style="background: rgba(255, 204, 0, 0.05);">
            <div style="display:flex; align-items:center; gap:10px;">
                <svg class="nx-icon" style="color:#ffcc00;" viewBox="0 0 24 24">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                <span style="font-weight:bold; letter-spacing:1px; color:#ffcc00;">管理員系統</span>
            </div>
            <button class="nx-tool-btn" onclick="closeAdminModal()">✕</button>
        </div>

        <div style="padding: 25px; overflow-y: auto;">
            <p style="color: var(--nx-text-muted);">歡迎回到控制中心。</p>
            
            <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="nx-suggestion-card" style="border-color: #ffcc00;">
                    <span>查看使用者數據</span> 
                    <span class="nx-sug-arrow">→</span>
                </div>
                <div class="nx-suggestion-card" style="border-color: #ffcc00;">
                    <span>全站推播</span>
                    <span class="nx-sug-arrow">→</span>
                </div>
                    <div style="padding: 20px;">
                    <h3 style="color:var(--nx-accent); border-bottom:1px solid var(--nx-border); padding-bottom:10px; margin-bottom:15px;">
                        新聞推播控制
                    </h3>
                    
                    <label style="display:block; color:var(--nx-text-muted); font-size:0.85em; margin-bottom:5px;">
                        設定關鍵字 (用逗號分隔，例如: Bitcoin, AI, Apple，最多8個)
                    </label>
                    <div class="nx-input-wrapper" style="margin-bottom: 15px;">
                        <input type="text" id="admin-news-keyword" class="nx-textarea" 
                               placeholder="Bitcoin, AI, Nvidia..." 
                               style="height: 40px; padding: 10px;">
                    </div>
                
                    <label style="display:block; color:var(--nx-text-muted); font-size:0.85em; margin-bottom:5px;">
                        每個主題抓取篇數 (建議 3-5 篇，避免翻譯過久)
                    </label>
                    <div class="nx-input-wrapper" style="margin-bottom: 20px;">
                        <input type="number" id="admin-news-count" class="nx-textarea" 
                               value="3" min="1" max="10"
                               style="height: 40px; padding: 10px;">
                    </div>
                
                    <button onclick="updateGlobalKeyword()" class="nx-btn-new" 
                            style="width:100%; justify-content:center; border-color:var(--nx-accent); color:var(--nx-accent);">
                        更新推播
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

</body>
</html>
